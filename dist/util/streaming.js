import'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';function e(e='head'){const t=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>t.remove()}}function t(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const t=16*Math.random()|0;return('x'===e?t:3&t|8).toString(16)})}const s=Vue;function r(){return(0,s.readonly)((0,s.inject)('streaming_message_context'))}function n(r,n={}){const{host:i='iframe',filter:a,prefix:d=t()}=n,o=new Map;let c=!1;const m=e=>{const t=Number($('#chat > .mes').first().attr('mesid')),s=getLastMessageId();_.inRange(e,t,s+1)||o.get(e)?.destroy()},h=async(t,n)=>{if(c)return;m(t);const h=n??getChatMessages(t)[0].message??'';if(a&&!a(t,h))return void o.get(t)?.destroy();const p=$(`.mes[mesid='${t}']`),l=p.find('.mes_text').addClass('hidden!');p.find('.TH-streaming').addClass('hidden!');let f=p.find(`#${d}-${t}`);if(f.length>0){const e=o.get(t);if(e)return e.data.message=h,e.data.during_streaming=Boolean(n),void f.removeClass('hidden!')}o.get(t)?.destroy(),f.remove(),f=('iframe'===i?$('<iframe>').attr({script_id:getScriptId(),frameborder:0,srcdoc:'<head> <link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"> <script src="https://testingcf.jsdelivr.net/gh/n0vi028/JS-Slash-Runner/lib/tailwindcss.min.js"><\/script> <script src="https://testingcf.jsdelivr.net/npm/jquery"><\/script> <script src="https://testingcf.jsdelivr.net/npm/jquery-ui/dist/jquery-ui.min.js"><\/script> <link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/jquery-ui/themes/base/theme.min.css"/> <script src="https://testingcf.jsdelivr.net/npm/jquery-ui-touch-punch"><\/script> <script src="https://testingcf.jsdelivr.net/npm/lodash"><\/script> <script src="https://testingcf.jsdelivr.net/gh/n0vi028/JS-Slash-Runner/src/iframe/adjust_iframe_height.js"><\/script> <style>*,::after,::before{box-sizing:border-box}body,html{margin:0!important;padding:0;overflow:hidden!important;max-width:100%!important}</style> </head> '}):$('<div>').attr('script_id',getScriptId())).addClass('mes_streaming w-full').attr('id',`${d}-${t}`).insertBefore(p.find('.mes_media_wrapper'));const u=(0,s.reactive)({prefix:d,host_id:`${d}-${t}`,message_id:t,message:h,during_streaming:Boolean(n)}),g=r().provide('streaming_message_context',u);'iframe'===i?f.on('load',function(){e(this.contentDocument.head),g.mount(this.contentDocument.body)}):g.mount(f[0]);const v=new MutationObserver(()=>{$('#curEditTextarea').parent().is(l)&&(l.removeClass('hidden!'),f.addClass('hidden!'))});v.observe(l[0],{childList:!0,subtree:!0,characterData:!0}),o.set(t,{app:g,data:u,destroy:()=>{const e=p.find('.TH-streaming');e.length>0?e.removeClass('hidden!'):l.removeClass('hidden!'),g.unmount(),f.remove(),v.disconnect(),o.delete(t)}})},p=async()=>{c||(o.keys().forEach(e=>m(e)),await Promise.all($('#chat').children('.mes[is_user=\'false\'][is_system=\'false\']').map(async(e,t)=>{const s=Number($(t).attr('mesid')??'NaN');isNaN(s)||await h(s)})))},l=[],f=(e,t)=>{l.push(eventOn(e,errorCatched(t)).stop)};return f(tavern_events.CHAT_CHANGED,()=>p()),f(tavern_events.CHARACTER_MESSAGE_RENDERED,e=>h(e)),f(tavern_events.MESSAGE_UPDATED,e=>h(e)),f(tavern_events.MESSAGE_SWIPED,e=>{o.get(e)?.destroy(),h(e)}),f(tavern_events.MESSAGE_DELETED,()=>setTimeout(errorCatched(p),1e3)),f(tavern_events.STREAM_TOKEN_RECEIVED,e=>{const t=Number($('#chat').children('.mes.last_mes').attr('mesid')??'NaN');isNaN(t)||h(t,e)}),'div'===i&&l.push(e().destroy),p(),{unmount:()=>{$('.mes_text').removeClass('hidden!'),o.forEach(({destroy:e})=>e()),l.forEach(e=>e()),c=!0}}}export{r as injectStreamingMessageContext,n as mountStreamingMessages};
//# sourceMappingURL=streaming.js.map