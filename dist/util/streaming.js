import'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/json5/+esm';import'https://testingcf.jsdelivr.net/npm/jsonrepair/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';function e(e='head'){const t=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>t.remove()}}function t(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const t=16*Math.random()|0;return('x'===e?t:3&t|8).toString(16)})}const s=Vue;function n(){return(0,s.readonly)((0,s.inject)('streaming_message_context'))}function r(n,r={}){const{host:i='iframe',filter:a,prefix:d=t()}=r,o=new Map;let c=!1;const m=e=>{const t=Number($('#chat > .mes').first().attr('mesid'));return!_.inRange(e,t,SillyTavern.chat.length)&&(o.get(e)?.destroy(),!0)},h=()=>{o.keys().forEach(e=>m(e))},l=async(t,r)=>{if(c)return;if(m(t))return;const h=r??getChatMessages(t)[0].message??'';if(a&&!a(t,h))return void o.get(t)?.destroy();const l=$(`.mes[mesid='${t}']`),p=l.find('.mes_text').addClass('hidden!');l.find('.TH-streaming').addClass('hidden!');let g=l.find(`#${d}-${t}`);if(g.length>0){const e=o.get(t);if(e)return e.data.message=h,void(e.data.during_streaming=Boolean(r))}o.get(t)?.destroy(),g.remove();let f=l.find('.mes_streaming');0===f.length&&(f=$('<div class="mes_streaming">').css({'font-weight':'500','line-height':'calc(var(--mainFontSize) + .5rem)','max-width':'100%','overflow-wrap':'anywhere',padding:'calc(var(--mainFontSize) * 0.8) 0 0 0'}).insertAfter(p)),g=('iframe'===i?$('<iframe>').attr({script_id:getScriptId(),frameborder:0,srcdoc:'<head> <link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"> <script src="https://testingcf.jsdelivr.net/gh/n0vi028/JS-Slash-Runner/lib/tailwindcss.min.js"><\/script> <script src="https://testingcf.jsdelivr.net/npm/jquery"><\/script> <script src="https://testingcf.jsdelivr.net/npm/jquery-ui/dist/jquery-ui.min.js"><\/script> <link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/jquery-ui/themes/base/theme.min.css"/> <script src="https://testingcf.jsdelivr.net/npm/jquery-ui-touch-punch"><\/script> <script src="https://testingcf.jsdelivr.net/npm/lodash"><\/script> <script src="https://testingcf.jsdelivr.net/gh/n0vi028/JS-Slash-Runner/src/iframe/adjust_iframe_height.js"><\/script> <style>*,::after,::before{box-sizing:border-box}body,html{margin:0!important;padding:0;overflow:hidden!important;max-width:100%!important}</style> </head> '}).addClass('w-full'):$('<div>').attr('script_id',getScriptId())).attr('id',`${d}-${t}`).appendTo(f);const v=(0,s.reactive)({prefix:d,host_id:`${d}-${t}`,message_id:t,message:h,during_streaming:Boolean(r)}),u=n().provide('streaming_message_context',v);'iframe'===i?g.on('load',function(){e(this.contentDocument.head),u.mount(this.contentDocument.body)}):u.mount(g[0]);const x=new MutationObserver(()=>{const e=$('#chat').find('#curEditTextarea');e.parent().is(p)?(p.removeClass('hidden!'),g.addClass('hidden!')):0===e.length&&(p.addClass('hidden!'),l.find('.TH-streaming').addClass('hidden!'),g.removeClass('hidden!'))});x.observe(p[0],{childList:!0}),o.set(t,{app:u,data:v,destroy:()=>{const e=l.find('.TH-streaming');e.length>0?e.removeClass('hidden!'):p.removeClass('hidden!'),u.unmount(),g.remove(),0===f.children().length&&f.remove(),x.disconnect(),o.delete(t)}})},p=async(e={})=>{c||(e.destroy_all?o.forEach(({destroy:e})=>e()):h(),await Promise.all($('#chat').children('.mes[is_user=\'false\'][is_system=\'false\']').map(async(t,s)=>{const n=Number($(s).attr('mesid')??'NaN');isNaN(n)||(await l(n),e.trigger_event&&eventEmit(tavern_events.CHARACTER_MESSAGE_RENDERED,n,'rerender'))})))},g=[],f=(e,t,s)=>{g.push(s?eventMakeFirst(e,errorCatched(t)).stop:eventOn(e,errorCatched(t)).stop)};return f('chatLoaded',()=>{p({destroy_all:!0})}),f(tavern_events.CHARACTER_MESSAGE_RENDERED,e=>{h(),l(e)},!0),[tavern_events.MESSAGE_EDITED,tavern_events.MESSAGE_DELETED].forEach(e=>f(e,e=>{h(),o.get(e)?.destroy(),l(e)})),f(tavern_events.MESSAGE_DELETED,()=>setTimeout(errorCatched(p),1e3)),f(tavern_events.STREAM_TOKEN_RECEIVED,e=>{l(Number($('#chat').children('.mes.last_mes').attr('mesid')),e)}),'div'===i&&g.push(e().destroy),p({trigger_event:!0}),{unmount:()=>{const e=$('#chat').find('.TH-streaming');e.length>0?e.removeClass('hidden!'):$('chat').find('.mes_text').removeClass('hidden!'),o.forEach(({destroy:e})=>e()),g.forEach(e=>e()),c=!0}}}export{n as injectStreamingMessageContext,r as mountStreamingMessages};
//# sourceMappingURL=streaming.js.map