import'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';function e(e='head'){const t=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>t.remove()}}function t(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const t=16*Math.random()|0;return('x'===e?t:3&t|8).toString(16)})}const s=Vue;function n(){return(0,s.readonly)((0,s.inject)('streaming_message_context'))}function r(n,r={}){const{host:i='iframe',filter:a,prefix:d=t()}=r,o=new Map;let c=!1;const m=e=>{const t=Number($('#chat > .mes').first().attr('mesid')),s=getLastMessageId();_.inRange(e,t,s+1)||o.get(e)?.destroy()},h=async(t,r)=>{if(c)return;m(t);const h=r??getChatMessages(t)[0].message??'';if(a&&!a(t,h))return void o.get(t)?.destroy();const l=$(`.mes[mesid='${t}']`),p=l.find('.mes_text').addClass('hidden!');l.find('.TH-streaming').addClass('hidden!');let g=l.find(`#${d}-${t}`);if(g.length>0){const e=o.get(t);if(e)return e.data.message=h,e.data.during_streaming=Boolean(r),void g.removeClass('hidden!')}o.get(t)?.destroy(),g.remove();let f=l.find('.mes_streaming');0===f.length&&(f=$('<div class="mes_streaming">').css({'font-weight':'500','line-height':'calc(var(--mainFontSize) + .5rem)','max-width':'100%','overflow-wrap':'anywhere',padding:'calc(var(--mainFontSize) * 0.8) 0 0 0'}).insertAfter(p)),g=('iframe'===i?$('<iframe>').attr({script_id:getScriptId(),frameborder:0,srcdoc:'<head> <link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"> <script src="https://testingcf.jsdelivr.net/gh/n0vi028/JS-Slash-Runner/lib/tailwindcss.min.js"><\/script> <script src="https://testingcf.jsdelivr.net/npm/jquery"><\/script> <script src="https://testingcf.jsdelivr.net/npm/jquery-ui/dist/jquery-ui.min.js"><\/script> <link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/jquery-ui/themes/base/theme.min.css"/> <script src="https://testingcf.jsdelivr.net/npm/jquery-ui-touch-punch"><\/script> <script src="https://testingcf.jsdelivr.net/npm/lodash"><\/script> <script src="https://testingcf.jsdelivr.net/gh/n0vi028/JS-Slash-Runner/src/iframe/adjust_iframe_height.js"><\/script> <style>*,::after,::before{box-sizing:border-box}body,html{margin:0!important;padding:0;overflow:hidden!important;max-width:100%!important}</style> </head> '}).addClass('w-full'):$('<div>').attr('script_id',getScriptId())).attr('id',`${d}-${t}`).appendTo(f);const v=(0,s.reactive)({prefix:d,host_id:`${d}-${t}`,message_id:t,message:h,during_streaming:Boolean(r)}),u=n().provide('streaming_message_context',v);'iframe'===i?g.on('load',function(){e(this.contentDocument.head),u.mount(this.contentDocument.body)}):u.mount(g[0]);const x=new MutationObserver(()=>{$('#curEditTextarea').parent().is(p)&&(p.removeClass('hidden!'),g.addClass('hidden!'))});x.observe(p[0],{childList:!0,subtree:!0,characterData:!0}),o.set(t,{app:u,data:v,destroy:()=>{const e=l.find('.TH-streaming');e.length>0?e.removeClass('hidden!'):p.removeClass('hidden!'),u.unmount(),g.remove(),0===f.children().length&&f.remove(),x.disconnect(),o.delete(t)}})},l=async()=>{c||(o.keys().forEach(e=>m(e)),await Promise.all($('#chat').children('.mes[is_user=\'false\'][is_system=\'false\']').map(async(e,t)=>{const s=Number($(t).attr('mesid')??'NaN');isNaN(s)||await h(s)})))},p=[],g=(e,t)=>{p.push(eventOn(e,errorCatched(t)).stop)};return g(tavern_events.CHAT_CHANGED,()=>l()),g(tavern_events.CHARACTER_MESSAGE_RENDERED,e=>h(e)),g(tavern_events.MESSAGE_EDITED,e=>{o.get(e)?.destroy(),h(e)}),g(tavern_events.MESSAGE_UPDATED,e=>h(e)),g(tavern_events.MESSAGE_SWIPED,e=>{o.get(e)?.destroy(),h(e)}),g(tavern_events.MESSAGE_DELETED,()=>setTimeout(errorCatched(l),1e3)),g(tavern_events.STREAM_TOKEN_RECEIVED,e=>{const t=Number($('#chat').children('.mes.last_mes').attr('mesid')??'NaN');isNaN(t)||h(t,e)}),'div'===i&&p.push(e().destroy),l(),{unmount:()=>{$('.mes_text').removeClass('hidden!'),o.forEach(({destroy:e})=>e()),p.forEach(e=>e()),c=!0}}}export{n as injectStreamingMessageContext,r as mountStreamingMessages};
//# sourceMappingURL=streaming.js.map