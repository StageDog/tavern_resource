{"version":3,"file":"streaming.js","mappings":"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","sources":["src://tavern_helper_template/util/script.ts","src://tavern_helper_template/util/common.ts","src://tavern_helper_template/external var \"Vue\"","src://tavern_helper_template/util/streaming.ts","webpack://tavern_helper_template/util/iframe_srcdoc.html?c178"],"sourcesContent":["import iframe_srcdoc from './iframe_srcdoc.html';\n\nexport async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle(\n  append_to: JQuery.Selector | JQuery.htmlString | JQuery.TypeOrArray<Element | DocumentFragment> | JQuery = 'head',\n): { destroy: () => void } {\n  const $div = $(`<div>`)\n    .attr('script_id', getScriptId())\n    .append($(`head > style`, document).clone())\n    .appendTo(append_to);\n\n  return {\n    destroy: () => $div.remove(),\n  };\n}\n\nexport function createScriptIdIframe(): JQuery<HTMLIFrameElement> {\n  return $(`<iframe>`).attr({\n    script_id: getScriptId(),\n    frameborder: 0,\n    srcdoc: iframe_srcdoc,\n  }) as JQuery<HTMLIFrameElement>;\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, new_chat_id => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n","import { compare } from 'compare-versions';\nimport { toDotPath } from 'zod/v4/core';\n\nexport function assignInplace<T>(destination: T[], new_array: T[]): T[] {\n  destination.length = 0;\n  destination.push(...new_array);\n  return destination;\n}\n\nexport function chunkBy<T>(array: T[], predicate: (lhs: T, rhs: T) => boolean): T[][] {\n  if (array.length === 0) {\n    return [];\n  }\n\n  const chunks: T[][] = [[array[0]]];\n  for (const [lhs, rhs] of _.zip(_.dropRight(array), _.drop(array))) {\n    if (predicate(lhs!, rhs!)) {\n      chunks[chunks.length - 1].push(rhs!);\n    } else {\n      chunks.push([rhs!]);\n    }\n  }\n  return chunks;\n}\n\nexport function regexFromString(input: string): RegExp | null {\n  if (!input) {\n    return null;\n  }\n  try {\n    const match = input.match(/\\/(.+)\\/([a-z]*)/i);\n    if (!match) {\n      return new RegExp(_.escapeRegExp(input), 'i');\n    }\n    if (match[2] && !/^(?!.*?(.).*?\\1)[gmixXsuUAJ]+$/.test(match[3])) {\n      return new RegExp(input, 'i');\n    }\n    let flags = match[2] ?? '';\n    _.pull(flags, 'g');\n    if (flags.indexOf('i') === -1) {\n      flags = flags + 'i';\n    }\n    return new RegExp(match[1], flags);\n  } catch {\n    return null;\n  }\n}\n\nexport function uuidv4(): string {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nexport async function checkMinimumVersion(expected: string, title: string) {\n  if (compare(await getTavernHelperVersion(), expected, '<')) {\n    toastr.error(`'${title}' 需要酒馆助手版本 >= '${expected}'`, '版本不兼容');\n  }\n}\n\nexport function prettifyErrorWithInput(error: z.ZodError) {\n  return _([...error.issues])\n    .sortBy(issue => issue.path?.length ?? 0)\n    .flatMap(issue => {\n      const lines = [`✖ ${issue.message}`];\n      if (issue.path?.length) {\n        lines.push(`  → 路径: ${toDotPath(issue.path)}`);\n      }\n      if (issue.input !== undefined) {\n        lines.push(`  → 输入: ${JSON.stringify(issue.input)}`);\n      }\n      return lines;\n    })\n    .join('\\n');\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = Vue;","import { createScriptIdDiv, createScriptIdIframe, teleportStyle } from '@util/script';\nimport { uuidv4 } from './common';\nexport function injectStreamingMessageContext() {\n    return readonly(inject('streaming_message_context'));\n}\n/**\n * 将组件作为流式楼层界面挂载到酒馆各个楼层, 替换掉酒馆原生的楼层正文显示.\n *\n * 方案是隐藏酒馆原来的楼层文本, 而在它下方插入一个类名有 `mes_streaming` 的 DOM:\n *   - `options.host==='iframe'` 则插入的是 iframe, 其内 contentDocument.body 作为组件的挂载点\n *     - 样式将与酒馆原生界面隔离\n *     - 组件内可以使用 tailwindcss\n *   - `options.host==='div'` 则插入的是 div, 它直接作为组件的挂载点\n *     - 将会继承酒馆样式\n *     - 禁止使用 mes_text 类名, 它会让酒馆的编辑楼层功能不可用\n *     - 组件内不能使用 tailwindcss, 因为会影响酒馆其他部分的样式\n *     - 你也许会用到 `@types/function/displayed_message.d.ts` 中的 `formatAsDisplayedMessage` 函数来格式化消息内容\n *\n * @param creator 创建流式界面的组件, 函数内可以用 `.use` 安装依赖或执行其他逻辑\n * @param options 可选选项\n *   - `host`: 宿主, 默认为 `'iframe'`, 因为 `'iframe'` 能隔离样式, 更方便做复杂界面\n *   - `filter`: 楼层过滤器. 如果设置, 则只有符合条件的楼层才会被挂载流式楼层界面\n *   - `prefix`: 组件的唯一标识符, 默认随机生成一个. 函数产生的流式楼层界面会共享这个 `prefix`, 并将 `host` DOM 的 id 设置成 `${prefix}-${message_id}`.\n * @returns 卸载流式楼层界面的函数\n */\nexport function mountStreamingMessages(creator, options = {}) {\n    const { host = 'iframe', filter, prefix = uuidv4() } = options;\n    const states = new Map();\n    let has_stoped = false;\n    const destroyIfInvalid = (message_id) => {\n        const min_message_id = Number($('#chat > .mes').first().attr('mesid'));\n        const max_message_id = getLastMessageId();\n        if (!_.inRange(message_id, min_message_id, max_message_id + 1)) {\n            states.get(message_id)?.destroy();\n        }\n    };\n    const renderOneMessage = async (message_id, stream_message) => {\n        if (has_stoped) {\n            return;\n        }\n        destroyIfInvalid(message_id);\n        const message = stream_message ?? getChatMessages(message_id)[0].message ?? '';\n        if (filter && !filter(message_id, message)) {\n            states.get(message_id)?.destroy();\n            return;\n        }\n        const $message_element = $(`.mes[mesid='${message_id}']`);\n        const $mes_text = $message_element.find('.mes_text').addClass('hidden!');\n        $message_element.find('.TH-streaming').addClass('hidden!');\n        let $host = $message_element.find(`#${prefix}-${message_id}`);\n        if ($host.length > 0) {\n            const state = states.get(message_id);\n            if (state) {\n                state.data.message = message;\n                state.data.during_streaming = Boolean(stream_message);\n                $host.removeClass('hidden!');\n                return;\n            }\n        }\n        states.get(message_id)?.destroy();\n        $host.remove();\n        let $mes_streaming = $message_element.find('.mes_streaming');\n        if ($mes_streaming.length === 0) {\n            $mes_streaming = $('<div class=\"mes_streaming\">')\n                .css({\n                'font-weight': '500',\n                'line-height': 'calc(var(--mainFontSize) + .5rem)',\n                'max-width': '100%',\n                'overflow-wrap': 'anywhere',\n                padding: 'calc(var(--mainFontSize) * 0.8) 0 0 0',\n            })\n                .insertAfter($mes_text);\n        }\n        $host = (host === 'iframe' ? createScriptIdIframe().addClass('w-full') : createScriptIdDiv())\n            .attr('id', `${prefix}-${message_id}`)\n            .appendTo($mes_streaming);\n        const data = reactive({\n            prefix,\n            host_id: `${prefix}-${message_id}`,\n            message_id,\n            message,\n            during_streaming: Boolean(stream_message),\n        });\n        const app = creator().provide('streaming_message_context', data);\n        if (host === 'iframe') {\n            $host.on('load', function () {\n                teleportStyle(this.contentDocument.head);\n                app.mount(this.contentDocument.body);\n            });\n        }\n        else {\n            app.mount($host[0]);\n        }\n        const observer = new MutationObserver(() => {\n            const $edit_textarea = $('#curEditTextarea');\n            if ($edit_textarea.parent().is($mes_text)) {\n                $mes_text.removeClass('hidden!');\n                $host.addClass('hidden!');\n            }\n        });\n        observer.observe($mes_text[0], { childList: true, subtree: true, characterData: true });\n        states.set(message_id, {\n            app,\n            data,\n            destroy: () => {\n                const $th_streaming = $message_element.find('.TH-streaming');\n                if ($th_streaming.length > 0) {\n                    $th_streaming.removeClass('hidden!');\n                }\n                else {\n                    $mes_text.removeClass('hidden!');\n                }\n                app.unmount();\n                $host.remove();\n                if ($mes_streaming.children().length === 0) {\n                    $mes_streaming.remove();\n                }\n                observer.disconnect();\n                states.delete(message_id);\n            },\n        });\n    };\n    const renderAllMessage = async () => {\n        if (has_stoped) {\n            return;\n        }\n        states.keys().forEach(message_id => destroyIfInvalid(message_id));\n        await Promise.all($('#chat')\n            .children(\".mes[is_user='false'][is_system='false']\")\n            .map(async (_index, node) => {\n            const message_id = Number($(node).attr('mesid') ?? 'NaN');\n            if (!isNaN(message_id)) {\n                await renderOneMessage(message_id);\n            }\n        }));\n    };\n    const stop_list = [];\n    const scopedEventOn = (event, listener) => {\n        stop_list.push(eventOn(event, errorCatched(listener)).stop);\n    };\n    scopedEventOn(tavern_events.CHAT_CHANGED, () => renderAllMessage());\n    scopedEventOn(tavern_events.CHARACTER_MESSAGE_RENDERED, message_id => renderOneMessage(message_id));\n    scopedEventOn(tavern_events.MESSAGE_EDITED, message_id => {\n        states.get(message_id)?.destroy();\n        renderOneMessage(message_id);\n    });\n    scopedEventOn(tavern_events.MESSAGE_UPDATED, message_id => renderOneMessage(message_id));\n    scopedEventOn(tavern_events.MESSAGE_SWIPED, message_id => {\n        states.get(message_id)?.destroy();\n        renderOneMessage(message_id);\n    });\n    scopedEventOn(tavern_events.MESSAGE_DELETED, () => setTimeout(errorCatched(renderAllMessage), 1000));\n    scopedEventOn(tavern_events.STREAM_TOKEN_RECEIVED, message => {\n        const message_id = Number($('#chat').children('.mes.last_mes').attr('mesid') ?? 'NaN');\n        if (!isNaN(message_id)) {\n            renderOneMessage(message_id, message);\n        }\n    });\n    if (host === 'div') {\n        stop_list.push(teleportStyle().destroy);\n    }\n    renderAllMessage();\n    return {\n        unmount: () => {\n            $('.mes_text').removeClass('hidden!');\n            states.forEach(({ destroy }) => destroy());\n            stop_list.forEach(stop => stop());\n            has_stoped = true;\n        },\n    };\n}\n","// Module\nvar code = `<head> <link rel=\"stylesheet\" href=\"https://testingcf.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css\"> ${\"<\" + \"script\"} src=\"https://testingcf.jsdelivr.net/gh/n0vi028/JS-Slash-Runner/lib/tailwindcss.min.js\">${\"<\" + \"/script\"}> ${\"<\" + \"script\"} src=\"https://testingcf.jsdelivr.net/npm/jquery\">${\"<\" + \"/script\"}> ${\"<\" + \"script\"} src=\"https://testingcf.jsdelivr.net/npm/jquery-ui/dist/jquery-ui.min.js\">${\"<\" + \"/script\"}> <link rel=\"stylesheet\" href=\"https://testingcf.jsdelivr.net/npm/jquery-ui/themes/base/theme.min.css\"/> ${\"<\" + \"script\"} src=\"https://testingcf.jsdelivr.net/npm/jquery-ui-touch-punch\">${\"<\" + \"/script\"}> ${\"<\" + \"script\"} src=\"https://testingcf.jsdelivr.net/npm/lodash\">${\"<\" + \"/script\"}> ${\"<\" + \"script\"} src=\"https://testingcf.jsdelivr.net/gh/n0vi028/JS-Slash-Runner/src/iframe/adjust_iframe_height.js\">${\"<\" + \"/script\"}> <style>*,::after,::before{box-sizing:border-box}body,html{margin:0!important;padding:0;overflow:hidden!important;max-width:100%!important}</style> </head> `;\n// Exports\nexport default code;"],"names":["teleportStyle","append_to","$div","$","attr","getScriptId","append","document","clone","appendTo","destroy","remove","uuidv4","replace","c","r","Math","random","toString","Vue","injectStreamingMessageContext","readonly","inject","mountStreamingMessages","creator","options","host","filter","prefix","states","Map","has_stoped","destroyIfInvalid","message_id","min_message_id","Number","first","max_message_id","getLastMessageId","_","inRange","get","renderOneMessage","async","stream_message","message","getChatMessages","$message_element","$mes_text","find","addClass","$host","length","state","data","during_streaming","Boolean","removeClass","$mes_streaming","css","padding","insertAfter","script_id","frameborder","srcdoc","reactive","host_id","app","provide","on","this","contentDocument","head","mount","body","observer","MutationObserver","parent","is","observe","childList","subtree","characterData","set","$th_streaming","unmount","children","disconnect","delete","renderAllMessage","keys","forEach","Promise","all","map","_index","node","isNaN","stop_list","scopedEventOn","event","listener","push","eventOn","errorCatched","stop","tavern_events","CHAT_CHANGED","CHARACTER_MESSAGE_RENDERED","MESSAGE_EDITED","MESSAGE_UPDATED","MESSAGE_SWIPED","MESSAGE_DELETED","setTimeout","STREAM_TOKEN_RECEIVED"],"ignoreList":[],"sourceRoot":""}