{"version":3,"file":"mvu_zod.js","mappings":"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","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/util/mvu_zod.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","export function registerMvuSchema(schema) {\n    eventOn('mag_variable_initialized', (variables, swipe_id) => {\n        const result = schema.safeParse(variables);\n        if (result.error) {\n            toastr.error(z.prettifyError(result.error), `[MVU zod]第 ${swipe_id + 1} 条开场白的变量初始化失败`);\n        }\n    });\n    eventOn('mag_command_parsed', (variables, commands) => {\n        const notification_enabled = Boolean($('#mvu_notification_error').prop('checked'));\n        const check_and_apply = (data, command, should_toastr) => {\n            const result = schema.safeParse(data);\n            if (result.success) {\n                variables.stat_data = result.data;\n                return true;\n            }\n            if (notification_enabled && should_toastr) {\n                toastr.warning(z.prettifyError(result.error), `[MVU zod]发生变量更新错误，可能需要重Roll: ${command.full_match}`);\n            }\n            return false;\n        };\n        for (const command of commands) {\n            const data = klona(variables.stat_data);\n            const path = trimQuotesAndBackslashes(command.args[0]);\n            switch (command.type) {\n                case 'set': {\n                    if (command.args.length === 3) {\n                        command.args.splice(1, 1);\n                    }\n                    _.set(data, path, parseCommandValue(command.args[1]));\n                    check_and_apply(data, command, true);\n                    break;\n                }\n                case 'insert': {\n                    const key_or_index = parseCommandValue(command.args[1]);\n                    const value = parseCommandValue(command.args.at(-1));\n                    const insert = (data, should_toastr) => {\n                        const collection = _.get(data, path);\n                        const is_array = _.isArray(collection);\n                        if (command.args.length === 2) {\n                            if (is_array) {\n                                collection.push(value);\n                            }\n                            else {\n                                _.assign(collection, value);\n                            }\n                        }\n                        else if (is_array) {\n                            collection.splice(key_or_index, 0, value);\n                        }\n                        else {\n                            collection[String(key_or_index)] = value;\n                        }\n                        return check_and_apply(data, command, should_toastr);\n                    };\n                    const collection = _.get(data, path);\n                    const is_nil = _.isNil(collection);\n                    if (!is_nil && !_.isArray(collection) && !_.isPlainObject(collection)) {\n                        continue;\n                    }\n                    if (!is_nil) {\n                        insert(data, true);\n                        continue;\n                    }\n                    const filled = _(klona(data));\n                    if (!insert(filled.set(path, {}).value(), false)) {\n                        insert(filled.set(path, []).value(), true);\n                    }\n                    break;\n                }\n                case 'delete': {\n                    _.unset(data, command.args.map(trimQuotesAndBackslashes));\n                    check_and_apply(data, command, true);\n                    break;\n                }\n            }\n        }\n        commands.length = 0;\n    });\n}\nfunction trimQuotesAndBackslashes(string) {\n    return string.replace(/^[\\\\\"'` ]*(.*?)[\\\\\"'` ]*$/, '$1');\n}\nfunction parseCommandValue(string) {\n    const value = parseCommandValueImpl(string);\n    if (value instanceof Date) {\n        return value.toISOString();\n    }\n    if (Array.isArray(value)) {\n        return value.map(item => (item instanceof Date ? item.toISOString() : item));\n    }\n    return value;\n}\nfunction parseCommandValueImpl(string) {\n    const trimmed = string.trim();\n    if (trimmed === 'true') {\n        return true;\n    }\n    if (trimmed === 'false') {\n        return false;\n    }\n    if (trimmed === 'null') {\n        return null;\n    }\n    if (trimmed === 'undefined') {\n        return undefined;\n    }\n    try {\n        return JSON.parse(trimmed);\n    }\n    catch (e) {\n        if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || (trimmed.startsWith('[') && trimmed.endsWith(']'))) {\n            try {\n                const result = new Function(`return ${trimmed};`)();\n                if (_.isObject(result) || Array.isArray(result)) {\n                    return result;\n                }\n            }\n            catch (err) {\n                // 如果解析失败，说明它可能是一个未加引号的字符串，继续往下走\n            }\n        }\n    }\n    try {\n        return YAML.parse(trimmed);\n    }\n    catch (e) {\n        /** empty */\n    }\n    return trimQuotesAndBackslashes(string);\n}\n"],"names":["z","registerMvuSchema","schema","eventOn","variables","swipe_id","result","safeParse","error","toastr","prettifyError","commands","notification_enabled","Boolean","$","prop","check_and_apply","data","command","should_toastr","success","stat_data","warning","full_match","path","trimQuotesAndBackslashes","args","type","length","splice","_","set","parseCommandValue","key_or_index","value","at","insert","collection","get","is_array","isArray","push","assign","String","is_nil","isNil","isPlainObject","filled","unset","map","string","replace","trimmed","trim","JSON","parse","e","startsWith","endsWith","Function","isObject","Array","err","YAML","parseCommandValueImpl","Date","toISOString","item"],"ignoreList":[],"sourceRoot":""}