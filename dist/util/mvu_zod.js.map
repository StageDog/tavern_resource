{"version":3,"file":"mvu_zod.js","mappings":"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","sources":["src://tavern_helper_template/webpack/bootstrap","src://tavern_helper_template/webpack/runtime/define property getters","src://tavern_helper_template/webpack/runtime/hasOwnProperty shorthand","src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/util/mvu_zod.ts","src://tavern_helper_template/src/util/common.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = z;","import { prettifyErrorWithInput } from '@/util/common';\nexport function registerMvuSchema(input) {\n    if (typeof registerVariableSchema === 'function') {\n        registerVariableSchema(z.object({ stat_data: typeof input === 'function' ? input() : input }), { type: 'message' });\n    }\n    const unwrapSchema = () => {\n        if (typeof input === 'function') {\n            const schema = input();\n            if (typeof registerVariableSchema === 'function') {\n                registerVariableSchema(z.object({ stat_data: schema }), { type: 'message' });\n            }\n            return schema;\n        }\n        return input;\n    };\n    eventOn('mag_variable_initialized', (variables, swipe_id) => {\n        const schema = unwrapSchema();\n        try {\n            const result = schema.safeParse(_.get(variables, 'stat_data', {}));\n            if (result.error) {\n                reportError('warn', z.prettifyError(result.error), `第 ${swipe_id + 1} 条开场白的变量初始化失败`);\n            }\n        }\n        catch (e) {\n            const error = e;\n            reportError('error', error.stack ? error.stack : error.name + ': ' + error.message, `第 ${swipe_id + 1} 条开场白的变量初始化失败`);\n        }\n    });\n    eventOn('mag_command_parsed', (variables, commands) => {\n        const schema = unwrapSchema();\n        const notification_enabled = Boolean($('#mvu_notification_error').prop('checked'));\n        const check_and_apply = (data, command, should_toastr) => {\n            try {\n                const result = schema.safeParse(data, { reportInput: true });\n                if (result.success) {\n                    variables.stat_data = result.data;\n                    return true;\n                }\n                if (notification_enabled && should_toastr) {\n                    reportError('warn', prettifyErrorWithInput(result.error), `发生变量更新错误，可能需要重Roll: ${command.full_match}`);\n                }\n            }\n            catch (e) {\n                const error = e;\n                reportError('error', error.stack ? error.stack : error.name + ': ' + error.message, `发生变量更新错误，可能需要重Roll: ${command.full_match}`);\n            }\n            return false;\n        };\n        for (const command of commands) {\n            let data = klona(variables.stat_data);\n            const path = trimQuotesAndBackslashes(command.args[0]);\n            switch (command.type) {\n                case 'set': {\n                    if (command.args.length === 3) {\n                        command.args.splice(1, 1);\n                    }\n                    if (path) {\n                        _.set(data, path, parseCommandValue(command.args[1]));\n                    }\n                    else {\n                        data = parseCommandValue(command.args[1]);\n                    }\n                    check_and_apply(data, command, true);\n                    break;\n                }\n                case 'insert': {\n                    const key_or_index = parseCommandValue(command.args[1]);\n                    const value = parseCommandValue(command.args.at(-1));\n                    const insert = (data, should_toastr) => {\n                        const collection = path === '' ? data : _.get(data, path);\n                        const is_array = _.isArray(collection);\n                        if (command.args.length === 2) {\n                            if (is_array) {\n                                collection.push(value);\n                            }\n                            else {\n                                _.assign(collection, value);\n                            }\n                        }\n                        else if (is_array) {\n                            collection.splice(key_or_index, 0, value);\n                        }\n                        else {\n                            collection[String(key_or_index)] = value;\n                        }\n                        return check_and_apply(data, command, should_toastr);\n                    };\n                    const collection = path === '' ? data : _.get(data, path);\n                    const is_nil = _.isNil(collection);\n                    if (!is_nil && !_.isArray(collection) && !_.isPlainObject(collection)) {\n                        continue;\n                    }\n                    if (!is_nil) {\n                        insert(data, true);\n                        continue;\n                    }\n                    const filled = _(klona(data));\n                    if (!insert(filled.set(path, {}).value(), false)) {\n                        insert(filled.set(path, []).value(), true);\n                    }\n                    break;\n                }\n                case 'delete': {\n                    const path = command.args.map(trimQuotesAndBackslashes).join('.');\n                    const path_array = _(path).toPath().value();\n                    const parent_path = _(path_array).dropRight().join('.');\n                    if (_.isArray(_.get(data, parent_path))) {\n                        _.pullAt(_.get(data, parent_path), Number(_(path_array).last()));\n                    }\n                    else {\n                        _.unset(data, path);\n                    }\n                    check_and_apply(data, command, true);\n                    break;\n                }\n            }\n        }\n        commands.length = 0;\n    });\n    console.info('变量结构注册成功');\n}\nfunction reportError(level, content, title) {\n    toastr[level === 'warn' ? 'warning' : 'error'](content.replaceAll('\\n', '<br>'), `[MVU zod]` + title, {\n        escapeHtml: false,\n    });\n    console[level](`${title} ${content}`);\n}\nfunction trimQuotesAndBackslashes(string) {\n    return string.replace(/^[\\\\\"'` ]*(.*?)[\\\\\"'` ]*$/, '$1');\n}\nfunction parseCommandValue(string) {\n    const value = parseCommandValueImpl(string);\n    if (value instanceof Date) {\n        return value.toISOString();\n    }\n    if (Array.isArray(value)) {\n        return value.map(item => (item instanceof Date ? item.toISOString() : item));\n    }\n    return value;\n}\nfunction parseCommandValueImpl(string) {\n    const trimmed = string.trim();\n    if (trimmed === 'true') {\n        return true;\n    }\n    if (trimmed === 'false') {\n        return false;\n    }\n    if (trimmed === 'null') {\n        return null;\n    }\n    if (trimmed === 'undefined') {\n        return undefined;\n    }\n    try {\n        return JSON.parse(trimmed);\n    }\n    catch (e) {\n        if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || (trimmed.startsWith('[') && trimmed.endsWith(']'))) {\n            try {\n                const result = new Function(`return ${trimmed};`)();\n                if (_.isObject(result) || Array.isArray(result)) {\n                    return result;\n                }\n            }\n            catch (err) {\n                // 如果解析失败，说明它可能是一个未加引号的字符串，继续往下走\n            }\n        }\n    }\n    try {\n        return YAML.parse(trimmed);\n    }\n    catch (e) {\n        /** empty */\n    }\n    return trimQuotesAndBackslashes(string);\n}\n","import { compare } from 'compare-versions';\nimport { toDotPath } from 'zod/v4/core';\n\nexport function assignInplace<T>(destination: T[], new_array: T[]): T[] {\n  destination.length = 0;\n  destination.push(...new_array);\n  return destination;\n}\n\nexport function chunkBy<T>(array: T[], predicate: (lhs: T, rhs: T) => boolean): T[][] {\n  if (array.length === 0) {\n    return [];\n  }\n\n  const chunks: T[][] = [[array[0]]];\n  for (const [lhs, rhs] of _.zip(_.dropRight(array), _.drop(array))) {\n    if (predicate(lhs!, rhs!)) {\n      chunks[chunks.length - 1].push(rhs!);\n    } else {\n      chunks.push([rhs!]);\n    }\n  }\n  return chunks;\n}\n\nexport function regexFromString(input: string): RegExp | null {\n  if (!input) {\n    return null;\n  }\n  try {\n    const match = input.match(/\\/(.+)\\/([a-z]*)/i);\n    if (!match) {\n      return new RegExp(_.escapeRegExp(input), 'gi');\n    }\n    if (match[3] && !/^(?!.*?(.).*?\\1)[gmixXsuUAJ]+$/.test(match[3])) {\n      return new RegExp(input, 'gi');\n    }\n    let flags = match[3];\n    if (flags.indexOf('g') === -1) {\n      flags = flags + 'g';\n    }\n    if (flags.indexOf('i') === -1) {\n      flags = flags + 'i';\n    }\n    return new RegExp(match[2], flags);\n  } catch {\n    return null;\n  }\n}\n\nexport function uuidv4(): string {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nexport async function checkMinimumVersion(expected: string, title: string) {\n  if (compare(await getTavernHelperVersion(), expected, '<')) {\n    toastr.error(`'${title}' 需要酒馆助手版本 >= '${expected}'`, '版本不兼容');\n  }\n}\n\nexport function prettifyErrorWithInput(error: z.ZodError) {\n  return _([...error.issues])\n    .sortBy(issue => issue.path?.length ?? 0)\n    .flatMap(issue => {\n      const lines = [`✖ ${issue.message}`];\n      if (issue.path?.length) {\n        lines.push(`  → 路径: ${toDotPath(issue.path)}`);\n      }\n      if (issue.input !== undefined) {\n        lines.push(`  → 输入: ${JSON.stringify(issue.input)}`);\n      }\n      return lines;\n    })\n    .join('\\n');\n}\n"],"names":["__webpack_require__","d","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","z","registerMvuSchema","input","registerVariableSchema","object","stat_data","type","unwrapSchema","schema","eventOn","variables","swipe_id","result","safeParse","_","error","reportError","prettifyError","e","stack","name","message","commands","notification_enabled","Boolean","$","check_and_apply","data","command","should_toastr","reportInput","success","issues","sortBy","issue","path","length","flatMap","lines","push","undefined","JSON","stringify","join","full_match","trimQuotesAndBackslashes","args","splice","set","parseCommandValue","key_or_index","value","at","insert","collection","is_array","isArray","assign","String","is_nil","isNil","isPlainObject","filled","map","path_array","toPath","parent_path","dropRight","pullAt","Number","last","unset","console","info","level","content","title","toastr","replaceAll","escapeHtml","string","replace","trimmed","trim","parse","startsWith","endsWith","Function","isObject","Array","err","YAML","parseCommandValueImpl","Date","toISOString","item"],"ignoreList":[],"sourceRoot":""}