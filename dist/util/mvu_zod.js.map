{"version":3,"file":"mvu_zod.js","mappings":"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","sources":["src://tavern_helper_template/webpack/bootstrap","src://tavern_helper_template/webpack/runtime/define property getters","src://tavern_helper_template/webpack/runtime/hasOwnProperty shorthand","src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/util/mvu_zod.ts","src://tavern_helper_template/util/common.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = z;","import { prettifyErrorWithInput } from '@util/common';\nexport function registerMvuSchema(input) {\n    const unwrapSchema = () => {\n        const original_schema = typeof input === 'function' ? input() : input;\n        const schema = original_schema instanceof z.ZodObject ? z.looseObject(original_schema.shape) : original_schema;\n        if (typeof registerVariableSchema === 'function') {\n            registerVariableSchema(z.object({ stat_data: schema }), { type: 'message' });\n        }\n        return schema;\n    };\n    unwrapSchema();\n    eventOn('mag_variable_initialized', (variables, swipe_id) => {\n        const schema = unwrapSchema();\n        try {\n            const result = schema.safeParse(_.get(variables, 'stat_data', {}), { reportInput: true });\n            if (result.success) {\n                variables.stat_data = { ...variables.stat_data, ...result.data };\n                return;\n            }\n            reportError('error', z.prettifyError(result.error), `开局 '${swipe_id + 1}' 变量初始化失败`);\n        }\n        catch (e) {\n            const error = e;\n            reportError('error', error.stack ? error.stack : error.name + ': ' + error.message, `第 ${swipe_id + 1} 条开场白的变量初始化失败`);\n        }\n    });\n    eventOn('mag_command_parsed_for_zod', (variables, commands) => {\n        const schema = unwrapSchema();\n        const notification_enabled = Boolean($('#mvu_notification_error').prop('checked'));\n        const checkSchema = (data, command, should_toastr) => {\n            let error_message = '';\n            try {\n                const result = schema.safeParse(data, { reportInput: true });\n                if (result.success) {\n                    return result.data;\n                }\n                error_message = prettifyErrorWithInput(result.error);\n            }\n            catch (e) {\n                const error = e;\n                error_message = error.stack ? error.stack : error.name + ': ' + error.message;\n            }\n            if (notification_enabled && should_toastr) {\n                reportError('warn', error_message, `发生变量更新错误, 可能需要重Roll: ${command.full_match}`);\n            }\n            return null;\n        };\n        const applyCommand = (data, command) => {\n            switch (command.type) {\n                case 'set': {\n                    if (command.args.length === 3) {\n                        command.args.splice(1, 1);\n                    }\n                    const path = parsePath(command.args[0]);\n                    if (path) {\n                        _.set(data, path, parseCommandValue(command.args[1]));\n                    }\n                    else {\n                        data = parseCommandValue(command.args[1]);\n                    }\n                    return checkSchema(data, command, true);\n                }\n                case 'add': {\n                    const path = parsePath(command.args[0]);\n                    if (!path) {\n                        return null;\n                    }\n                    const old_value = _.get(data, path);\n                    const old_value_type = typeof old_value;\n                    if (old_value_type !== 'number') {\n                        if (notification_enabled) {\n                            reportError('warn', [\n                                `✖ 不能对非数字类型 '${old_value_type}' 进行加减运算`,\n                                `  → 路径: ${path}`,\n                                `  → 原值: ${JSON.stringify(old_value)}`,\n                            ].join('\\n'), `发生变量更新错误, 可能需要重Roll: ${command.full_match}`);\n                        }\n                        return null;\n                    }\n                    const delta_value = parseCommandValue(command.args[1]);\n                    _.update(data, path, value => value + Number(delta_value));\n                    return checkSchema(data, command, true);\n                }\n                case 'insert': {\n                    const path = parsePath(command.args[0]);\n                    const key_or_index = parseCommandValue(command.args[1]);\n                    const value = parseCommandValue(command.args.at(-1));\n                    const insert = (data, should_toastr) => {\n                        const collection = path === '' ? data : _.get(data, path);\n                        const is_array = _.isArray(collection);\n                        if (command.args.length === 2) {\n                            if (is_array) {\n                                collection.push(value);\n                            }\n                            else {\n                                _.assign(collection, value);\n                            }\n                        }\n                        else if (is_array) {\n                            collection.splice(key_or_index === '-' ? collection.length : key_or_index, 0, value);\n                        }\n                        else {\n                            collection[String(key_or_index)] = value;\n                        }\n                        return checkSchema(data, command, should_toastr);\n                    };\n                    const collection = path === '' ? data : _.get(data, path);\n                    const is_nil = _.isNil(collection);\n                    if (!is_nil && !_.isArray(collection) && !_.isPlainObject(collection)) {\n                        return null;\n                    }\n                    if (!is_nil) {\n                        return insert(data, true);\n                    }\n                    const filled = _(klona(data));\n                    const result_as_object = insert(filled.set(path, {}).value(), false);\n                    if (result_as_object) {\n                        return result_as_object;\n                    }\n                    return insert(filled.set(path, []).value(), true);\n                }\n                case 'delete': {\n                    const path = command.args.map(parsePath).join('.');\n                    const path_array = _(path).toPath().value();\n                    const parent_path = _(path_array).dropRight().join('.');\n                    if (_.isArray(_.get(data, parent_path))) {\n                        _.pullAt(_.get(data, parent_path), Number(_(path_array).last()));\n                    }\n                    else {\n                        _.unset(data, path);\n                    }\n                    return checkSchema(data, command, true);\n                }\n            }\n        };\n        const old_data = klona(variables.stat_data);\n        for (const command of commands) {\n            let data = klona(variables.stat_data);\n            if (command.type === 'move') {\n                const from_path = parsePath(command.args[0]);\n                if (!_.has(data, from_path)) {\n                    if (notification_enabled) {\n                        reportError('warn', `移动源路径不存在: ${from_path}`, `发生变量更新错误，可能需要重Roll: ${command.full_match}`);\n                    }\n                    continue;\n                }\n                const value = _.get(data, from_path);\n                const to_path = parsePath(command.args[1]);\n                data = applyCommand(data, { ...command, type: 'delete', args: [from_path] });\n                data = applyCommand(data, { ...command, type: 'set', args: [to_path, value] });\n            }\n            else {\n                data = applyCommand(data, command);\n            }\n            if (data !== null) {\n                variables.stat_data = { ...variables.stat_data, ...data };\n            }\n        }\n        function keepReadonly(new_data, old_data) {\n            function traverse(obj, path = []) {\n                if (!_.isObjectLike(obj)) {\n                    return;\n                }\n                _.forOwn(obj, (value, key) => {\n                    const current_path = [...path, key];\n                    if (key.startsWith('_')) {\n                        const rhs_value = _.get(old_data, current_path);\n                        if (rhs_value !== undefined) {\n                            _.set(new_data, current_path, rhs_value);\n                        }\n                    }\n                    if (_.isObjectLike(value)) {\n                        traverse(value, current_path);\n                    }\n                });\n            }\n            traverse(new_data);\n        }\n        keepReadonly(variables.stat_data, old_data);\n        commands.length = 0;\n    });\n    eventOn('mag_command_parsed_ended_for_zod', (_variables, commands) => {\n        commands.length = 0;\n    });\n    eventOn('mag_variable_update_ended_for_zod', variables => {\n        _.set(variables, 'schema', '没有用别管这个');\n        _.unset(variables, 'display_data');\n        _.unset(variables, 'delta_data');\n    });\n    console.info('变量结构注册成功');\n}\nfunction reportError(level, content, title) {\n    toastr[level === 'warn' ? 'warning' : 'error'](content.replaceAll('\\n', '<br>'), `[MVU zod]` + title, {\n        escapeHtml: false,\n    });\n    console[level](`${title}\\n${content}`);\n}\nfunction trimQuotesAndBackslashes(string) {\n    return string.replace(/^[\\\\\"'` ]*(.*?)[\\\\\"'` ]*$/, '$1');\n}\nfunction parsePath(string) {\n    return (trimQuotesAndBackslashes(string)\n        // 一些错误提示词写法会导致 AI 在更新变量时带上 `stat_data.` 或 `status_current_variables.` 前缀, 这里将它去掉\n        .replace(/^(?:stat_data|status_current_variables)\\./, ''));\n}\nfunction parseCommandValue(string) {\n    const value = parseCommandValueImpl(string);\n    if (value instanceof Date) {\n        return value.toISOString();\n    }\n    if (Array.isArray(value)) {\n        return value.map(item => (item instanceof Date ? item.toISOString() : item));\n    }\n    return value;\n}\nfunction parseCommandValueImpl(string) {\n    const trimmed = string.trim();\n    if (trimmed === 'true') {\n        return true;\n    }\n    if (trimmed === 'false') {\n        return false;\n    }\n    if (trimmed === 'null') {\n        return null;\n    }\n    if (trimmed === 'undefined') {\n        return undefined;\n    }\n    try {\n        return JSON.parse(trimmed);\n    }\n    catch (e) {\n        if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || (trimmed.startsWith('[') && trimmed.endsWith(']'))) {\n            try {\n                const result = new Function(`return ${trimmed};`)();\n                if (_.isObject(result) || Array.isArray(result)) {\n                    return result;\n                }\n            }\n            catch (err) {\n                // 如果解析失败，说明它可能是一个未加引号的字符串，继续往下走\n            }\n        }\n    }\n    try {\n        return YAML.parse(trimmed);\n    }\n    catch (e) {\n        /** empty */\n    }\n    return trimQuotesAndBackslashes(string);\n}\n","import { compare } from 'compare-versions';\nimport JSON5 from 'json5';\nimport { jsonrepair } from 'jsonrepair';\nimport { toDotPath } from 'zod/v4/core';\n\nexport function assignInplace<T>(destination: T[], new_array: T[]): T[] {\n  destination.length = 0;\n  destination.push(...new_array);\n  return destination;\n}\n\n// 修正 _.merge 对数组的合并逻辑, [1, 2, 3] 和 [4, 5] 合并后变成 [4, 5] 而不是 [4, 5, 3]\nexport function correctlyMerge<TObject, TSource>(lhs: TObject, rhs: TSource): TObject & TSource {\n    return _.mergeWith(lhs, rhs, (_lhs, rhs) => (_.isArray(rhs) ? rhs : undefined));\n}\n\nexport function chunkBy<T>(array: T[], predicate: (lhs: T, rhs: T) => boolean): T[][] {\n  if (array.length === 0) {\n    return [];\n  }\n\n  const chunks: T[][] = [[array[0]]];\n  for (const [lhs, rhs] of _.zip(_.dropRight(array), _.drop(array))) {\n    if (predicate(lhs!, rhs!)) {\n      chunks[chunks.length - 1].push(rhs!);\n    } else {\n      chunks.push([rhs!]);\n    }\n  }\n  return chunks;\n}\n\nexport function regexFromString(input: string, replace_macros?: boolean): RegExp | null {\n  if (!input) {\n    return null;\n  }\n  const makeRegex = (pattern: string, flags: string) => {\n    if (replace_macros) {\n      pattern = substitudeMacros(pattern);\n    }\n    return new RegExp(pattern, flags);\n  };\n  try {\n    const match = input.match(/\\/(.+)\\/([a-z]*)/i);\n    if (!match) {\n      return makeRegex(_.escapeRegExp(input), 'i');\n    }\n    if (match[2] && !/^(?!.*?(.).*?\\1)[gmixXsuUAJ]+$/.test(match[3])) {\n      return makeRegex(input, 'i');\n    }\n    let flags = match[2] ?? '';\n    _.pull(flags, 'g');\n    if (flags.indexOf('i') === -1) {\n      flags = flags + 'i';\n    }\n    return makeRegex(match[1], flags);\n  } catch {\n    return null;\n  }\n}\n\nexport function uuidv4(): string {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nexport async function checkMinimumVersion(expected: string, title: string) {\n  if (compare(await getTavernHelperVersion(), expected, '<')) {\n    toastr.error(`'${title}' 需要酒馆助手版本 >= '${expected}'`, '版本不兼容');\n  }\n}\n\nexport function prettifyErrorWithInput(error: z.ZodError) {\n  return _([...error.issues])\n    .sortBy(issue => issue.path?.length ?? 0)\n    .flatMap(issue => {\n      const lines = [`✖ ${issue.message}`];\n      if (issue.path?.length) {\n        lines.push(`  → 路径: ${toDotPath(issue.path)}`);\n      }\n      if (issue.input !== undefined) {\n        lines.push(`  → 输入: ${JSON.stringify(issue.input)}`);\n      }\n      return lines;\n    })\n    .join('\\n');\n}\n\nexport function literalYamlify(value: any) {\n  return YAML.stringify(value, { blockQuote: 'literal' });\n}\n\nexport function parseString(content: string): any {\n  let parsed: unknown;\n  try {\n    parsed = YAML.parseDocument(content, { merge: true }).toJS();\n  } catch (yaml_error) {\n    try {\n      // eslint-disable-next-line import-x/no-named-as-default-member\n      parsed = JSON5.parse(content);\n    } catch (json5_error) {\n      try {\n        parsed = JSON.parse(jsonrepair(content));\n      } catch (json_error) {\n        const toError = (error: unknown) => (error instanceof Error ? error.message : String(error));\n        throw new Error(\n          literalYamlify({\n            ['要解析的字符串不是有效的 YAML/JSON 格式']: {\n              字符串内容: content,\n              YAML错误信息: toError(yaml_error),\n              JSON5错误信息: toError(json5_error),\n              尝试修复JSON时的错误信息: toError(json_error),\n            },\n          }),\n        );\n      }\n    }\n  }\n  return parsed;\n}\n\nexport function getComplementString(string: string) {\n  const encoder = new TextEncoder();\n  const bytes = encoder.encode(string);\n\n  const complemented = new Uint8Array(bytes.length);\n  for (let i = 0; i < bytes.length; i++) {\n    complemented[i] = 0xff - bytes[i];\n  }\n\n  let hex = '';\n  for (let i = 0; i < complemented.length; i++) {\n    const h = complemented[i].toString(16).padStart(2, '0');\n    hex += h;\n  }\n  return hex;\n}\n\nexport async function checkAndUpdateCharacter(name: string, latest_version: string, png_url: string): Promise<void> {\n  const current_version = (await getCharacter(name)).version.trim() || '0.0.0';\n  if (compare(current_version, latest_version, '>=')) {\n    return;\n  }\n  await importRawCharacter(name, await fetch(png_url).then(response => response.blob()));\n  replaceCharacter(name, { version: latest_version });\n  toastr.success(\n    `角色卡已自动更新到 '${latest_version.startsWith('v') ? latest_version : `v${latest_version}`}'`,\n    name,\n  );\n}\n"],"names":["__webpack_require__","d","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","z","registerMvuSchema","input","unwrapSchema","original_schema","schema","ZodObject","looseObject","shape","registerVariableSchema","object","stat_data","type","eventOn","variables","swipe_id","result","safeParse","_","reportInput","success","data","reportError","prettifyError","error","e","stack","name","message","commands","notification_enabled","Boolean","$","checkSchema","command","should_toastr","error_message","issues","sortBy","issue","path","length","flatMap","lines","push","undefined","JSON","stringify","join","full_match","applyCommand","args","splice","parsePath","set","parseCommandValue","old_value","old_value_type","delta_value","update","value","Number","key_or_index","at","insert","collection","is_array","isArray","assign","String","is_nil","isNil","isPlainObject","filled","result_as_object","map","path_array","toPath","parent_path","dropRight","pullAt","last","unset","old_data","from_path","has","to_path","new_data","traverse","isObjectLike","forOwn","current_path","startsWith","rhs_value","keepReadonly","_variables","console","info","level","content","title","toastr","replaceAll","escapeHtml","trimQuotesAndBackslashes","string","replace","trimmed","trim","parse","endsWith","Function","isObject","Array","err","YAML","parseCommandValueImpl","Date","toISOString","item"],"sourceRoot":""}