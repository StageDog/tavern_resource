import'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import{toDotPath as t}from'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';import{klona as e}from'https://testingcf.jsdelivr.net/npm/klona/+esm';var a={};a.d=(t,e)=>{for(var r in e)a.o(e,r)&&!a.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);const r=z;function s(a){const s=()=>{const t='function'==typeof a?a():a,e=t instanceof r.z.ZodObject?r.z.looseObject(t.shape):t;return'function'==typeof registerVariableSchema&&registerVariableSchema(r.z.object({stat_data:e}),{type:'message'}),e};s(),eventOn('mag_variable_initialized',(t,e)=>{const a=s();try{const s=a.safeParse(_.get(t,'stat_data',{}),{reportInput:!0});if(s.success)return void(t.stat_data={...t.stat_data,...s.data});n('warn',r.z.prettifyError(s.error),`第 ${e+1} 条开场白的变量初始化失败`)}catch(t){const a=t;n('error',a.stack?a.stack:a.name+': '+a.message,`第 ${e+1} 条开场白的变量初始化失败`)}}),eventOn('mag_command_parsed_for_zod',(a,r)=>{const c=s(),l=Boolean($('#mvu_notification_error').prop('checked')),u=(e,r,s)=>{try{const i=c.safeParse(e,{reportInput:!0});if(i.success)return a.stat_data={...a.stat_data,...i.data},!0;l&&s&&n('warn',(o=i.error,_([...o.issues]).sortBy(t=>t.path?.length??0).flatMap(e=>{const a=[`✖ ${e.message}`];return e.path?.length&&a.push(`  → 路径: ${t(e.path)}`),void 0!==e.input&&a.push(`  → 输入: ${JSON.stringify(e.input)}`),a}).join('\n')),`发生变量更新错误，可能需要重Roll: ${r.full_match}`)}catch(t){const e=t;n('error',e.stack?e.stack:e.name+': '+e.message,`发生变量更新错误，可能需要重Roll: ${r.full_match}`)}var o;return!1},p=e(a.stat_data);for(const t of r){let r=e(a.stat_data);const s=o(t.args[0]).replace(/^stat_data\./,'');switch(t.type){case'set':3===t.args.length&&t.args.splice(1,1),s?_.set(r,s,i(t.args[1])):r=i(t.args[1]),u(r,t,!0);break;case'add':{if(!s)break;const e=_.get(r,s),a=i(t.args[1]);typeof e!=typeof a||'number'!=typeof e&&'string'!=typeof e||(_.update(r,s,t=>t+a),u(r,t,!0));break}case'insert':{const a=i(t.args[1]),n=i(t.args.at(-1)),o=(e,r)=>{const o=''===s?e:_.get(e,s),i=_.isArray(o);return 2===t.args.length?i?o.push(n):_.assign(o,n):i?o.splice('-'===a?o.length:a,0,n):o[String(a)]=n,u(e,t,r)},c=''===s?r:_.get(r,s),l=_.isNil(c);if(!l&&!_.isArray(c)&&!_.isPlainObject(c))continue;if(!l){o(r,!0);continue}const p=_(e(r));o(p.set(s,{}).value(),!1)||o(p.set(s,[]).value(),!0);break}case'delete':{const e=t.args.map(o).join('.').replace(/^stat_data\./,''),a=_(e).toPath().value(),s=_(a).dropRight().join('.');_.isArray(_.get(r,s))?_.pullAt(_.get(r,s),Number(_(a).last())):_.unset(r,e),u(r,t,!0);break}}}!function(t,e){!function a(r,s=[]){_.isObjectLike(r)&&_.forOwn(r,(r,n)=>{const o=[...s,n];if(n.startsWith('_')){const a=_.get(e,o);void 0!==a&&_.set(t,o,a)}_.isObjectLike(r)&&a(r,o)})}(t)}(a.stat_data,p),r.length=0}),eventOn('mag_variable_update_ended_for_zod',t=>{_.set(t,'schema','没有用别管这个'),_.unset(t,'display_data'),_.unset(t,'delta_data')}),console.info('变量结构注册成功')}function n(t,e,a){toastr['warn'===t?'warning':'error'](e.replaceAll('\n','<br>'),'[MVU zod]'+a,{escapeHtml:!1}),console[t](`${a}\n${e}`)}function o(t){return t.replace(/^[\\"'` ]*(.*?)[\\"'` ]*$/,'$1')}function i(t){const e=function(t){const e=t.trim();if('true'===e)return!0;if('false'===e)return!1;if('null'===e)return null;if('undefined'===e)return;try{return JSON.parse(e)}catch(t){if(e.startsWith('{')&&e.endsWith('}')||e.startsWith('[')&&e.endsWith(']'))try{const t=new Function(`return ${e};`)();if(_.isObject(t)||Array.isArray(t))return t}catch(t){}}try{return YAML.parse(e)}catch(t){}return o(t)}(t);return e instanceof Date?e.toISOString():Array.isArray(e)?e.map(t=>t instanceof Date?t.toISOString():t):e}export{s as registerMvuSchema};
//# sourceMappingURL=mvu_zod.js.map