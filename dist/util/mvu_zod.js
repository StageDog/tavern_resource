import'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/jsonrepair/+esm';import{toDotPath as t}from'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';import{klona as e}from'https://testingcf.jsdelivr.net/npm/klona/+esm';var r={};r.d=(t,e)=>{for(var n in e)r.o(e,n)&&!r.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);const n=z;function a(r){const a=()=>{const t='function'==typeof r?r():r,e=t instanceof n.z.ZodObject?n.z.looseObject(t.shape):t;return'function'==typeof registerVariableSchema&&registerVariableSchema(n.z.object({stat_data:e}),{type:'message'}),e};a(),eventOn('mag_variable_initialized',(t,e)=>{const r=a();try{const a=r.safeParse(_.get(t,'stat_data',{}),{reportInput:!0});if(a.success)return void(t.stat_data={...t.stat_data,...a.data});s('error',n.z.prettifyError(a.error),`开局 '${e+1}' 变量初始化失败`)}catch(t){const r=t;s('error',r.stack?r.stack:r.name+': '+r.message,`第 ${e+1} 条开场白的变量初始化失败`)}}),eventOn('mag_command_parsed_for_zod',(r,n)=>{const o=a(),l=Boolean($('#mvu_notification_error').prop('checked')),u=(e,r,n)=>{let a='';try{const r=o.safeParse(e,{reportInput:!0});if(r.success)return r.data;i=r.error,a=_([...i.issues]).sortBy(t=>t.path?.length??0).flatMap(e=>{const r=[`✖ ${e.message}`];return e.path?.length&&r.push(`  → 路径: ${t(e.path)}`),void 0!==e.input&&r.push(`  → 输入: ${JSON.stringify(e.input)}`),r}).join('\n')}catch(t){const e=t;a=e.stack?e.stack:e.name+': '+e.message}var i;return l&&n&&s('warn',a,`发生变量更新错误, 可能需要重Roll: ${r.full_match}`),null},p=t=>('string'==typeof t&&(t=_.toPath(t)),t.some(t=>t.startsWith('_'))),f=(t,r)=>{switch(r.type){case'set':{3===r.args.length&&r.args.splice(1,1);const e=i(r.args[0]);return p(e)?null:(e?_.set(t,e,c(r.args[1])):t=c(r.args[1]),u(t,r,!0))}case'add':{const e=i(r.args[0]);if(!e||p(e))return null;const n=_.get(t,e),a=typeof n;if('number'!==a)return l&&s('warn',[`✖ 不能对非数字类型 '${a}' 进行加减运算`,`  → 路径: ${e}`,`  → 原值: ${JSON.stringify(n)}`].join('\n'),`发生变量更新错误, 可能需要重Roll: ${r.full_match}`),null;const o=c(r.args[1]);return _.update(t,e,t=>t+Number(o)),u(t,r,!0)}case'insert':{const n=i(r.args[0]);if(p(n))return null;const a=c(r.args[1]),s=c(r.args.at(-1)),o=(t,e)=>{const o=''===n?t:_.get(t,n),i=_.isArray(o);return 2===r.args.length?i?o.push(s):_.assign(o,s):i?o.splice('-'===a?o.length:a,0,s):o[String(a)]=s,u(t,r,e)},l=''===n?t:_.get(t,n),f=_.isNil(l);if(!f&&!_.isArray(l)&&!_.isPlainObject(l))return null;if(!f)return o(t,!0);const d=_(e(t)),g=o(d.set(n,{}).value(),!1);return g||o(d.set(n,[]).value(),!0)}case'delete':{const e=r.args.map(i).join('.'),n=_.toPath(e);if(p(n))return null;const a=_.dropRight(n).join('.');return _.isArray(_.get(t,a))?_.pullAt(_.get(t,a),Number(_(n).last())):_.unset(t,e),u(t,r,!0)}}return null},d=[];n.forEach((t,n)=>{let a=e(r.stat_data);if('move'===t.type){const e=i(t.args[0]);if(!_.has(a,e))return void(l&&s('warn',`移动源路径不存在: ${e}`,`发生变量更新错误，可能需要重Roll: ${t.full_match}`));const r=_.get(a,e),n=i(t.args[1]);a=f(a,{...t,type:'delete',args:[e]}),a=f(a,{...t,type:'set',args:[n,r]})}else a=f(a,t);null===a||_.isEqual(a,_.pick(r.stat_data,Object.keys(a)))||(r.stat_data={...r.stat_data,...a},d.push(n))}),_.pullAt(n,d)}),eventOn('mag_command_parsedended_for_zod',(t,e)=>{e.length=0}),eventOn('mag_command_parsed_ended_for_zod',(t,e)=>{e.length=0}),eventOn('mag_variable_update_ended_for_zod',t=>{_.set(t,'schema','没有用别管这个'),_.unset(t,'display_data'),_.unset(t,'delta_data')}),console.info('变量结构注册成功')}function s(t,e,r){toastr['warn'===t?'warning':'error'](e.replaceAll('\n','<br>'),'[MVU zod]'+r,{escapeHtml:!1}),console[t](`${r}\n${e}`)}function o(t){return t.replace(/^[\\"'` ]*(.*?)[\\"'` ]*$/,'$1')}function i(t){return o(t).replace(/^(?:stat_data|status_current_variables)\./,'')}function c(t){if('string'!=typeof t)return t;const e=function(t){const e=t.trim();if('true'===e)return!0;if('false'===e)return!1;if('null'===e)return null;if('undefined'===e)return;try{return JSON.parse(e)}catch(t){if(e.startsWith('{')&&e.endsWith('}')||e.startsWith('[')&&e.endsWith(']'))try{const t=new Function(`return ${e};`)();if(_.isObject(t)||Array.isArray(t))return t}catch(t){}}try{return YAML.parse(e)}catch(t){}return o(t)}(t);return e instanceof Date?e.toISOString():Array.isArray(e)?e.map(t=>t instanceof Date?t.toISOString():t):e}export{a as registerMvuSchema};
//# sourceMappingURL=mvu_zod.js.map