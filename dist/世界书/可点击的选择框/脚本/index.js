import{createPinia as e,defineStore as t,setActivePinia as n}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';const o=Vue,a='【可点击的选择框】',r='<roleplay_options>',i=/<(roleplay_options)>\s*(?:```.*\n)?((?:(?!<\1>)[\s\S])*?)(?:\n```)?\s*<\/\1>/im,s=z,l=s.z.object({输入方式:s.z.enum(['直接发送','覆盖输入','尾附输入']).prefault('直接发送'),样式:s.z.string().prefault('.roleplay_options_back{background:linear-gradient(160deg,rgba(45,45,45,0.75),rgba(35,35,35,0.85));border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.15),0 3px 10px rgba(0,0,0,.12);padding:16px 18px;display:flex;flex-direction:column;gap:10px;border:1px solid hsla(0,0%,100%,.06);max-width:100%;margin:20px 0}.roleplay_options_title{font-size:.94em;font-weight:600;color:#f0f0f0;padding-right:12px;letter-spacing:.02em;text-align:left;margin-bottom:4px}.roleplay_options_content{font-size:.94em;line-height:1.55;color:#c6c6c6;font-weight:normal;transition:color .25s ease;text-align:left;flex:1;letter-spacing:.015em;overflow-wrap:anywhere}.roleplay_options_content:not(:empty):not(.short-content)~.roleplay_options_title{width:100%;margin-bottom:8px;border-bottom:1px solid hsla(0,0%,100%,.08);padding-bottom:6px}.roleplay_options_content.short-content{flex:1}.roleplay_options_hr{display:none}.roleplay_options_item{position:relative;background:rgba(50,50,50,.65);border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.1);padding:14px 16px;cursor:default;border:1px solid hsla(0,0%,100%,.04);transition:all .25s cubic-bezier(0.25,0.8,0.25,1);overflow:hidden;display:flex;flex-wrap:wrap;align-items:flex-start;z-index:1;margin:2px 0;color:#d8d8d8;font-weight:400;line-height:1.5}.roleplay_options_item::after{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(90,90,90,0.06) 0%,transparent 70%);opacity:0;transition:opacity .3s ease;z-index:-1}.roleplay_options_item:before{content:"";position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(to bottom,rgba(160,160,160,0.6),rgba(180,180,180,0.3));transform:scaleY(0);transform-origin:top;transition:transform .3s cubic-bezier(0.4,0,0.2,1)}.last_mes .roleplay_options_item{cursor:pointer}.last_mes .roleplay_options_item:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.15);background:rgba(58,58,58,.75);border-color:rgba(200,200,200,.12)}.last_mes .roleplay_options_item:hover::after{opacity:1}.last_mes .roleplay_options_item:hover .roleplay_options_content{color:#e2e2e2}.last_mes .roleplay_options_item:active{transform:translateY(-1px);box-shadow:0 3px 8px rgba(0,0,0,.12)}.last_mes .roleplay_options_item:hover:before{transform:scaleY(1)}@media (max-width:768px){.roleplay_options_back{padding:14px;gap:8px}.roleplay_options_item{padding:12px 14px}.roleplay_options_title{font-size:.9em;padding-right:10px}.roleplay_options_content{font-size:.9em;line-height:1.5}}@media (prefers-reduced-motion:reduce){.roleplay_options_item{transition:none}.roleplay_options_item::before,.roleplay_options_item::after{transition:none}.roleplay_options_content,.roleplay_options_title{transition:none}}')}),p=t('config',errorCatched(()=>{const e=(0,o.ref)(l.parse({})),t=async()=>{const t=await getWorldbook(a),n=e.value;return e.value=l.parse({输入方式:_(t).filter(e=>e.enabled&&e.name.startsWith('设置-')).map(e=>e.name.replace('设置-','')).first(),样式:_(t).filter(e=>e.enabled&&e.name.startsWith('样式-')).map(e=>e.content.replace('<style>','').replace('</style>','')).first()}),!_.isEqual(e,n)},n=t();return eventOn(tavern_events.WORLDINFO_UPDATED,errorCatched(async e=>{e===a&&await t()})),{config:(0,o.readonly)(e),_wait_init:n}})),c={class:'roleplay_options'},d={class:'roleplay_options_back'},g=['onClick'],m={class:'roleplay_options_title'},h={class:'roleplay_options_content'},f=(0,o.defineComponent)({__name:'RoleplayOptions',props:{messageId:{},options:{}},setup(e){const t=e,n=p();return(a,r)=>((0,o.openBlock)(),(0,o.createElementBlock)('div',c,[(0,o.createElementVNode)('div',d,[((0,o.openBlock)(!0),(0,o.createElementBlock)(o.Fragment,null,(0,o.renderList)(e.options,e=>((0,o.openBlock)(),(0,o.createElementBlock)('div',{key:e.title,class:'roleplay_options_item',tabindex:'1',onClick:o=>async function(e){if(getLastMessageId()===t.messageId)switch(n.config.输入方式){case'直接发送':triggerSlash(`/send ${e.content} || /trigger`);break;case'覆盖输入':triggerSlash(`/setinput ${e.content}`);break;case'尾附输入':$('#send_textarea').val([String($('#send_textarea').val()),e.content].filter(e=>''===e.trim()).join('\n')||'')[0].dispatchEvent(new Event('input',{bubbles:!0}))}}(e)},[(0,o.createElementVNode)('span',m,[(0,o.createElementVNode)('strong',null,(0,o.toDisplayString)(e.title),1)]),r[0]||(r[0]=(0,o.createElementVNode)('hr',{class:'roleplay_options_hr'},null,-1)),(0,o.createElementVNode)('span',h,(0,o.toDisplayString)(e.content),1)],8,g))),128))])]))}});const y=new Map,b=e();async function x(e){const t=getChatMessages(e);if(0===t.length)return;const n=(t[0].message??'').match(i);if(!n)return;const a=Number(e);y.get(a)?.unmount();const s=retrieveDisplayedMessage(a),l=s.find(`pre:contains("${r}")`);if(l.length>0){const e=l.parent('.TH-render');e.length>0?e.addClass('hidden!'):l.addClass('hidden!');const t=(0,o.createApp)(f,{messageId:a,options:[...n[2].matchAll(/(.+?)[:：]\s*(.+)/gm)].map(e=>({title:e[1],content:e[2].replace(/^\$\{(.+)\}$/,'$1').replace(/^「(.+)」$/,'$1')}))}).use(b);y.set(a,t);const r=s.find(`div[script_id="${getScriptId()}"]`);t.mount(r.length>0?r[0]:$('<div>').attr('script_id',getScriptId()).appendTo(s)[0])}}async function u(){y.forEach(e=>{e.unmount()}),y.clear(),$('#chat').children('.mes[is_user=\'false\'][is_system=\'false\']').each((e,t)=>{const n=$(t).attr('mesid');try{n&&x(parseInt(n))}catch(e){}})}n(b),$(async()=>{await p()._wait_init;const{stop:e}=function(){const e=p();$('<div>').attr('script_id',getScriptId()).append(`<style>${e.config.样式}</style>`).appendTo('head');const t=(0,o.watch)(()=>e.config.样式,e=>{$(`head > div[script_id="${getScriptId()}"]`).find('style').text(e)});return{stop:()=>{t(),$(`head > div[script_id="${getScriptId()}"]`).remove()}}}();await u(),eventOn(tavern_events.CHAT_CHANGED,errorCatched(u)),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,errorCatched(x)),eventOn(tavern_events.MESSAGE_UPDATED,errorCatched(x)),eventOn(tavern_events.MESSAGE_SWIPED,errorCatched(x)),eventOn(tavern_events.MESSAGE_DELETED,()=>setTimeout(errorCatched(u),1e3)),$(window).on('pagehide',()=>{$(`pre:contains("${r}")`).each(function(){const e=$(this).parent('.TH-render');e.length>0?e.removeClass('hidden!'):$(this).removeClass('hidden!')}),y.forEach(e=>{e?.unmount()}),e()})});
//# sourceMappingURL=index.js.map