import{createPinia as e,defineStore as t,setActivePinia as n}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as o}from'https://testingcf.jsdelivr.net/npm/klona/+esm';const a=Vue,r=z,i='【可点击的选择框】',s=r.z.object({输入方式:r.z.enum(['直接发送','覆盖输入','尾附输入']).prefault('直接发送'),样式:r.z.string().prefault('.roleplay_options_back{background:linear-gradient(160deg,rgba(45,45,45,0.75),rgba(35,35,35,0.85));border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.15),0 3px 10px rgba(0,0,0,.12);padding:16px 18px;display:flex;flex-direction:column;gap:10px;border:1px solid hsla(0,0%,100%,.06);max-width:100%;margin:20px 0}.roleplay_options_title{font-size:.94em;font-weight:600;color:#f0f0f0;padding-right:12px;letter-spacing:.02em;text-align:left;margin-bottom:4px}.roleplay_options_content{font-size:.94em;line-height:1.55;color:#c6c6c6;font-weight:normal;transition:color .25s ease;text-align:left;flex:1;letter-spacing:.015em;overflow-wrap:anywhere}.roleplay_options_content:not(:empty):not(.short-content)~.roleplay_options_title{width:100%;margin-bottom:8px;border-bottom:1px solid hsla(0,0%,100%,.08);padding-bottom:6px}.roleplay_options_content.short-content{flex:1}.roleplay_options_hr{display:none}.roleplay_options_item{position:relative;background:rgba(50,50,50,.65);border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.1);padding:14px 16px;cursor:default;border:1px solid hsla(0,0%,100%,.04);transition:all .25s cubic-bezier(0.25,0.8,0.25,1);overflow:hidden;display:flex;flex-wrap:wrap;align-items:flex-start;z-index:1;margin:2px 0;color:#d8d8d8;font-weight:400;line-height:1.5}.roleplay_options_item::after{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(90,90,90,0.06) 0%,transparent 70%);opacity:0;transition:opacity .3s ease;z-index:-1}.roleplay_options_item:before{content:"";position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(to bottom,rgba(160,160,160,0.6),rgba(180,180,180,0.3));transform:scaleY(0);transform-origin:top;transition:transform .3s cubic-bezier(0.4,0,0.2,1)}.last_mes .roleplay_options_item{cursor:pointer}.last_mes .roleplay_options_item:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.15);background:rgba(58,58,58,.75);border-color:rgba(200,200,200,.12)}.last_mes .roleplay_options_item:hover::after{opacity:1}.last_mes .roleplay_options_item:hover .roleplay_options_content{color:#e2e2e2}.last_mes .roleplay_options_item:active{transform:translateY(-1px);box-shadow:0 3px 8px rgba(0,0,0,.12)}.last_mes .roleplay_options_item:hover:before{transform:scaleY(1)}@media (max-width:768px){.roleplay_options_back{padding:14px;gap:8px}.roleplay_options_item{padding:12px 14px}.roleplay_options_title{font-size:.9em;padding-right:10px}.roleplay_options_content{font-size:.9em;line-height:1.5}}@media (prefers-reduced-motion:reduce){.roleplay_options_item{transition:none}.roleplay_options_item::before,.roleplay_options_item::after{transition:none}.roleplay_options_content,.roleplay_options_title{transition:none}}')}),l=t('config',errorCatched(()=>{const e=(0,a.ref)(s.parse({})),t=async()=>{const t=await getWorldbook(i),n=e.value,a=s.parse({输入方式:_(t).filter(e=>e.enabled&&e.name.startsWith('设置-')).map(e=>e.name.replace('设置-','')).first(),样式:_(t).filter(e=>e.enabled&&e.name.startsWith('样式-')).map(e=>e.content.replace('<style>','').replace('</style>','')).first()});_.isEqual(a,n)||(e.value=o(a))},n=t();return eventOn(tavern_events.WORLDINFO_UPDATED,errorCatched(async e=>{e===i&&await t()})),{config:(0,a.readonly)(e),_wait_init:n}})),p={class:'roleplay_options'},c={class:'roleplay_options_back'},d=['onClick'],m={class:'roleplay_options_title'},g={class:'roleplay_options_content'},h=(0,a.defineComponent)({__name:'App',props:{messageId:{},options:{}},setup(e){const t=e,n=l();return(o,r)=>((0,a.openBlock)(),(0,a.createElementBlock)('div',p,[(0,a.createElementVNode)('div',c,[((0,a.openBlock)(!0),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)(e.options,e=>((0,a.openBlock)(),(0,a.createElementBlock)('div',{key:e.title,class:'roleplay_options_item',tabindex:'1',onClick:o=>async function(e){if(getLastMessageId()===t.messageId)switch(n.config.输入方式){case'直接发送':triggerSlash(`/send ${e.content} || /trigger`);break;case'覆盖输入':triggerSlash(`/setinput ${e.content}`);break;case'尾附输入':$('#send_textarea').val([String($('#send_textarea').val()),e.content].filter(e=>''!==e.trim()).join('\n')||'')[0].dispatchEvent(new Event('input',{bubbles:!0}))}}(e)},[(0,a.createElementVNode)('span',m,[(0,a.createElementVNode)('strong',null,(0,a.toDisplayString)(e.title),1)]),r[0]||(r[0]=(0,a.createElementVNode)('hr',{class:'roleplay_options_hr'},null,-1)),(0,a.createElementVNode)('span',g,(0,a.toDisplayString)(e.content),1)],8,d))),128))])]))}});const f=new Map,y=e();n(y);const b='<roleplay_options>',x=/<(roleplay_options)>\s*(?:```.*\n)?((?:(?!<\1>)[\s\S])*?)(?:\n```)?\s*<\/\1>/im;async function u(e){const t=getChatMessages(e);if(0===t.length)return;const n=(t[0].message??'').match(x);if(!n)return;f.get(e)?.unmount(),f.delete(e);const o=retrieveDisplayedMessage(e),r=o.find(`pre:contains("${b}")`);if(r.length>0){const t=r.parent('.TH-render');t.length>0?t.addClass('hidden!'):r.addClass('hidden!');const i=(0,a.createApp)(h,{messageId:e,options:[...n[2].matchAll(/(.+?)[:：]\s*(.+)/gm)].map(e=>({title:e[1],content:e[2].replace(/^\$\{(.+)\}$/,'$1').replace(/^「(.+)」$/,'$1')}))}).use(y);f.set(e,i);const s=o.find(`div[script_id="${getScriptId()}"]`);i.mount(s.length>0?s[0]:$('<div>').attr('script_id',getScriptId()).appendTo(o)[0])}}async function v(){f.forEach(e=>{e.unmount()}),f.clear(),$('#chat').children('.mes[is_user=\'false\'][is_system=\'false\']').each((e,t)=>{const n=Number($(t).attr('mesid')??'NaN');isNaN(n)||u(n)})}$(async()=>{await l()._wait_init;const{stop:e}=function(){const e=l();$('<div>').attr('script_id',getScriptId()).append(`<style>${e.config.样式}</style>`).appendTo('head');const t=(0,a.watch)(()=>e.config.样式,e=>{$(`head > div[script_id="${getScriptId()}"]`).find('style').text(e)});return{stop:()=>{t(),$(`head > div[script_id="${getScriptId()}"]`).remove()}}}();await v(),eventOn(tavern_events.CHAT_CHANGED,errorCatched(v)),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,errorCatched(u)),eventOn(tavern_events.MESSAGE_UPDATED,errorCatched(u)),eventOn(tavern_events.MESSAGE_SWIPED,errorCatched(u)),eventOn(tavern_events.MESSAGE_DELETED,()=>setTimeout(errorCatched(v),1e3)),$(window).on('pagehide',()=>{$(`pre:contains("${b}")`).each(function(){const e=$(this).parent('.TH-render');e.length>0?e.removeClass('hidden!'):$(this).removeClass('hidden!')}),f.forEach(e=>{e?.unmount()}),f.clear(),e()})});
//# sourceMappingURL=index.js.map