{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"Vue\"","src://tavern_helper_template/src/世界书/可点击的选择框/脚本/constant.ts","src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/世界书/可点击的选择框/脚本/store.ts","src://tavern_helper_template/src/世界书/可点击的选择框/脚本/RoleplayOptions.vue","webpack://tavern_helper_template/src/世界书/可点击的选择框/脚本/RoleplayOptions.vue?1fc9","src://tavern_helper_template/src/世界书/可点击的选择框/脚本/index.ts","src://tavern_helper_template/src/世界书/可点击的选择框/脚本/style.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = Vue;","export const LOREBOOK_NAME = '【可点击的选择框】' as const;\n// TODO: 更加拆分这里\nexport const TAG = '<roleplay_options>' as const;\nexport const REGEX = /<(roleplay_options)>\\s*(?:```.*\\n)?((?:(?!<\\1>)[\\s\\S])*?)(?:\\n```)?\\s*<\\/\\1>/im;\n","const __WEBPACK_NAMESPACE_OBJECT__ = z;","import { LOREBOOK_NAME } from './constant';\nimport default_css from './络络扁平化暗色紧凑列表.scss?raw';\nconst Config = z.object({\n    输入方式: z.enum(['直接发送', '覆盖输入', '尾附输入']).prefault('直接发送'),\n    样式: z.string().prefault(default_css),\n});\nexport const useConfigStore = defineStore('config', errorCatched(() => {\n    const config = ref(Config.parse({}));\n    const reloadConfig = async () => {\n        const worldbook = await getWorldbook(LOREBOOK_NAME);\n        const old_confg = config.value;\n        config.value = Config.parse({\n            输入方式: _(worldbook)\n                .filter(entry => entry.enabled && entry.name.startsWith('设置-'))\n                .map(entry => entry.name.replace('设置-', ''))\n                .first(),\n            样式: _(worldbook)\n                .filter(entry => entry.enabled && entry.name.startsWith('样式-'))\n                .map(entry => entry.content.replace('<style>', '').replace('</style>', ''))\n                .first(),\n        });\n        return !_.isEqual(config, old_confg);\n    };\n    const _wait_init = reloadConfig();\n    eventOn(tavern_events.WORLDINFO_UPDATED, errorCatched(async (lorebook) => {\n        if (lorebook === LOREBOOK_NAME) {\n            await reloadConfig();\n        }\n    }));\n    return { config: readonly(config), _wait_init };\n}));\n","import { defineComponent as _defineComponent } from 'vue';\nimport { renderList as _renderList, Fragment as _Fragment, openBlock as _openBlock, createElementBlock as _createElementBlock, toDisplayString as _toDisplayString, createElementVNode as _createElementVNode } from \"vue\";\nconst _hoisted_1 = { class: \"roleplay_options\" };\nconst _hoisted_2 = { class: \"roleplay_options_back\" };\nconst _hoisted_3 = [\"onClick\"];\nconst _hoisted_4 = { class: \"roleplay_options_title\" };\nconst _hoisted_5 = { class: \"roleplay_options_content\" };\nimport { useConfigStore } from './store';\nexport default /*@__PURE__*/ _defineComponent({\n    __name: 'RoleplayOptions',\n    props: {\n        messageId: {},\n        options: {}\n    },\n    setup(__props) {\n        const props = __props;\n        const store = useConfigStore();\n        async function handleClick(item) {\n            if (getLastMessageId() !== props.messageId) {\n                return;\n            }\n            switch (store.config.输入方式) {\n                case '直接发送':\n                    triggerSlash(`/send ${item.content} || /trigger`);\n                    break;\n                case '覆盖输入':\n                    triggerSlash(`/setinput ${item.content}`);\n                    break;\n                case '尾附输入':\n                    $('#send_textarea')\n                        .val([String($('#send_textarea').val()), item.content].filter(string => string.trim() === '').join('\\n') || '')[0]\n                        .dispatchEvent(new Event('input', { bubbles: true }));\n                    break;\n            }\n        }\n        return (_ctx, _cache) => {\n            return (_openBlock(), _createElementBlock(\"div\", _hoisted_1, [\n                _createElementVNode(\"div\", _hoisted_2, [\n                    (_openBlock(true), _createElementBlock(_Fragment, null, _renderList(__props.options, (option) => {\n                        return (_openBlock(), _createElementBlock(\"div\", {\n                            key: option.title,\n                            class: \"roleplay_options_item\",\n                            tabindex: \"1\",\n                            onClick: ($event) => (handleClick(option))\n                        }, [\n                            _createElementVNode(\"span\", _hoisted_4, [\n                                _createElementVNode(\"strong\", null, _toDisplayString(option.title), 1 /* TEXT */)\n                            ]),\n                            _cache[0] || (_cache[0] = _createElementVNode(\"hr\", { class: \"roleplay_options_hr\" }, null, -1 /* CACHED */)),\n                            _createElementVNode(\"span\", _hoisted_5, _toDisplayString(option.content), 1 /* TEXT */)\n                        ], 8 /* PROPS */, _hoisted_3));\n                    }), 128 /* KEYED_FRAGMENT */))\n                ])\n            ]));\n        };\n    }\n});\n","/* unplugin-vue-components disabled */import script from \"./RoleplayOptions.vue?vue&type=script&setup=true&lang=ts\"\nexport * from \"./RoleplayOptions.vue?vue&type=script&setup=true&lang=ts\"\n\nconst __exports__ = script;\n\nexport default __exports__","import RoleplayOptions from './RoleplayOptions.vue';\nimport { REGEX, TAG } from './constant';\nimport { useConfigStore } from './store';\nimport { injectStyle } from './style';\nconst apps = new Map();\nconst pinia = createPinia();\nsetActivePinia(pinia);\nasync function renderOneMessage(message_id) {\n    const chat_messages = getChatMessages(message_id);\n    if (chat_messages.length === 0) {\n        return;\n    }\n    const message = chat_messages[0].message ?? '';\n    const match = message.match(REGEX);\n    if (!match) {\n        return;\n    }\n    const numbered_message_id = Number(message_id);\n    apps.get(numbered_message_id)?.unmount();\n    const $mes_text = retrieveDisplayedMessage(numbered_message_id);\n    const $to_render = $mes_text.find(`.roleplay_options, pre:contains(\"${TAG}\")`);\n    if ($to_render.length > 0) {\n        $to_render.parent('.TH-render').remove();\n        $to_render.remove();\n        const app = createApp(RoleplayOptions, {\n            messageId: numbered_message_id,\n            options: [...match[2].matchAll(/(.+?)[:：]\\s*(.+)/gm)].map(match => ({\n                title: match[1],\n                content: match[2].replace(/^\\$\\{(.+)\\}$/, '$1').replace(/^「(.+)」$/, '$1'),\n            })),\n        }).use(pinia);\n        apps.set(numbered_message_id, app);\n        app.mount($mes_text[0]);\n    }\n}\nasync function renderAllMessage() {\n    apps.forEach(app => {\n        app.unmount();\n    });\n    apps.clear();\n    $('#chat')\n        .children(\".mes[is_user='false'][is_system='false']\")\n        .each((_index, node) => {\n        const message_id = $(node).attr('mesid');\n        try {\n            if (message_id) {\n                renderOneMessage(parseInt(message_id));\n            }\n        }\n        catch (error) {\n            /** empty */\n        }\n    });\n}\n$(async () => {\n    await useConfigStore()._wait_init;\n    const { stop } = injectStyle();\n    await renderAllMessage();\n    eventOn(tavern_events.CHAT_CHANGED, errorCatched(renderAllMessage));\n    eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED, errorCatched(renderOneMessage));\n    eventOn(tavern_events.MESSAGE_UPDATED, errorCatched(renderOneMessage));\n    eventOn(tavern_events.MESSAGE_SWIPED, errorCatched(renderOneMessage));\n    eventOn(tavern_events.MESSAGE_DELETED, () => setTimeout(errorCatched(renderAllMessage), 1000));\n    $(window).on('pagehide', () => {\n        apps.forEach(app => {\n            app.unmount();\n        });\n        apps.clear();\n        stop();\n    });\n});\n","import { useConfigStore } from './store';\nexport function injectStyle() {\n    const store = useConfigStore();\n    $(`<div>`).attr('script_id', getScriptId()).append(`<style>${store.config.样式}</style>`).appendTo('head');\n    const stop = watch(() => store.config.样式, style => {\n        $(`head > div[script_id=\"${getScriptId()}\"]`).find('style').text(style);\n    });\n    return {\n        stop: () => {\n            stop();\n            $(`head > div[script_id=\"${getScriptId()}\"]`).remove();\n        },\n    };\n}\n"],"names":["Vue","LOREBOOK_NAME","REGEX","z","Config","object","enum","prefault","string","useConfigStore","errorCatched","config","ref","parse","reloadConfig","async","worldbook","getWorldbook","old_confg","value","_","filter","entry","enabled","name","startsWith","map","replace","first","content","isEqual","_wait_init","eventOn","tavern_events","WORLDINFO_UPDATED","lorebook","readonly","_hoisted_1","class","_hoisted_2","_hoisted_3","_hoisted_4","_hoisted_5","__name","props","messageId","options","setup","__props","store","_ctx","_cache","option","key","title","tabindex","onClick","$event","item","getLastMessageId","triggerSlash","$","val","String","trim","join","dispatchEvent","Event","bubbles","apps","Map","pinia","renderOneMessage","message_id","chat_messages","getChatMessages","length","match","message","numbered_message_id","Number","get","unmount","$mes_text","retrieveDisplayedMessage","$to_render","find","parent","remove","app","createApp","RoleplayOptions","matchAll","use","set","mount","renderAllMessage","forEach","clear","children","each","_index","node","attr","parseInt","error","stop","getScriptId","append","appendTo","watch","style","text","injectStyle","CHAT_CHANGED","CHARACTER_MESSAGE_RENDERED","MESSAGE_UPDATED","MESSAGE_SWIPED","MESSAGE_DELETED","setTimeout","window","on"],"ignoreList":[],"sourceRoot":""}