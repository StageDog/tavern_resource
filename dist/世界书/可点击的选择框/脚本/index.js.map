{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/世界书/可点击的选择框/脚本/index.ts"],"sourcesContent":["import default_css from './络络扁平化暗色紧凑列表.scss?raw';\n\nconst lorebook_name = '【可点击的选择框】' as const;\nconst roleplay_options_tag = '<roleplay_options>' as const;\nconst roleplay_options_regex = /<(roleplay_options)>\\s*(?:```.*\\n)?((?:(?!<\\1>)[\\s\\S])*?)(?:\\n```)?\\s*<\\/\\1>/im;\n\n//----------------------------------------------------------------------------------------------------------------------\nnamespace option_section {\n  interface Option {\n    input_mode: '直接发送' | '覆盖输入' | '尾附输入' | '自动推进';\n  }\n  const default_option: Option = {\n    input_mode: '直接发送',\n  };\n\n  export let option: Option;\n\n  async function parse_option(): Promise<Option> {\n    const options: Record<string, string> = _.merge(\n      {},\n      ...(await getLorebookEntries(lorebook_name))\n        .filter(entry => entry.comment.startsWith('设置-') && entry.enabled)\n        .map(entry => {\n          const value = entry.comment.replace('设置-', '');\n          return { [value]: entry.content };\n        }),\n    );\n\n    const result = default_option;\n    if (_.has(options, '直接发送')) {\n      result.input_mode = '直接发送';\n    } else if (_.has(options, '覆盖输入')) {\n      result.input_mode = '覆盖输入';\n    } else if (_.has(options, '尾附输入')) {\n      result.input_mode = '尾附输入';\n    }\n    return result;\n  }\n\n  export async function update(): Promise<boolean> {\n    const old_option = option;\n    option = await parse_option();\n    return !_.isEqual(option, old_option);\n  }\n}\n\n//----------------------------------------------------------------------------------------------------------------------\nnamespace render_section {\n  async function divclick($element: JQuery<HTMLDivElement>) {\n    if ($element.parents('.last_mes').length > 0) {\n      const content = $element.find('.roleplay_options_content').text().trim();\n      if (option_section.option.input_mode === '直接发送') {\n        triggerSlash(`/send ${content} || /trigger`);\n      } else if (option_section.option.input_mode === '覆盖输入') {\n        triggerSlash(`/setinput ${content}`);\n      } else if (option_section.option.input_mode === '尾附输入') {\n        const old_content = $('#send_textarea').val();\n        $('#send_textarea')\n          .val([old_content, content].join('\\n') || '')[0]\n          .dispatchEvent(new Event('input', { bubbles: true }));\n      }\n    }\n  }\n\n  let style: string;\n\n  async function extract_style(): Promise<string> {\n    const entries = (await getLorebookEntries(lorebook_name)).filter(\n      entry => entry.comment.startsWith('样式-') && entry.enabled,\n    );\n    if (entries.length === 0) {\n      return `<style>${default_css}</style>`;\n    }\n    return entries[0].content;\n  }\n\n  export async function update(): Promise<boolean> {\n    const old_style = style;\n    style = await extract_style();\n    return !_.isEqual(style, old_style);\n  }\n\n  export function extract_roleplay_options_element(text: string): JQuery<HTMLDivElement> {\n    const $div = $('<div class=\"roleplay_options\">') as JQuery<HTMLDivElement>;\n    $div.append(style);\n    $div.append(\n      ($('<div class=\"roleplay_options_back\">') as JQuery<HTMLDivElement>).append(\n        [...text.matchAll(/(.+?)[:：]\\s*(.+)/gm)]\n          .map(match => ({\n            title: match[1],\n            content: match[2].replace(/^\\$\\{(.+)\\}$/, '$1').replace(/^「(.+)」$/, '$1'),\n          }))\n          .map(({ title, content }) =>\n            $('<div class=\"roleplay_options_item\" tabindex=\"1\">')\n              .on('click', function (this: HTMLDivElement) {\n                divclick($(this));\n              })\n              .append(`<span class=\"roleplay_options_title\"><strong>${title}</strong></span>`)\n              .append('<hr class=\"roleplay_options_hr\">')\n              .append(`<span class=\"roleplay_options_content\">${content}</span>`),\n          ),\n      ),\n    );\n    return $div;\n  }\n}\n\n//----------------------------------------------------------------------------------------------------------------------\nasync function renderOneMessage(message_id: number | string) {\n  const message: string = getChatMessages(message_id)[0].message;\n  const match = message.match(roleplay_options_regex);\n  if (!match) {\n    return;\n  }\n  const $roleplay_options_element = render_section.extract_roleplay_options_element(match[2]);\n\n  const $mes_text = retrieveDisplayedMessage(Number(message_id));\n  const $to_render = $mes_text.find(`.roleplay_options, pre:contains(\"${roleplay_options_tag}\")`);\n  if ($to_render.length > 0) {\n    $to_render.parent('.TH-render').remove();\n    $to_render.remove();\n    $mes_text.append($roleplay_options_element);\n  }\n}\n\nasync function renderAllMessage() {\n  $('#chat')\n    .children(\".mes[is_user='false'][is_system='false']\")\n    .each((_index, node) => {\n      const message_id = $(node).attr('mesid');\n      try {\n        if (message_id) {\n          renderOneMessage(parseInt(message_id));\n        }\n      } catch (error) {\n        /** empty */\n      }\n    });\n}\n\n$(async () => {\n  await errorCatched(option_section.update)();\n  await errorCatched(render_section.update)();\n  await renderAllMessage();\n  eventOn(tavern_events.CHAT_CHANGED, errorCatched(renderAllMessage));\n  eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED, errorCatched(renderOneMessage));\n  eventOn(tavern_events.MESSAGE_UPDATED, errorCatched(renderOneMessage));\n  eventOn(tavern_events.MESSAGE_SWIPED, errorCatched(renderOneMessage));\n  eventOn(tavern_events.MESSAGE_DELETED, () => setTimeout(errorCatched(renderAllMessage), 1000));\n  eventOn(\n    tavern_events.WORLDINFO_UPDATED,\n    errorCatched(async lorebook => {\n      if (lorebook !== lorebook_name) {\n        return;\n      }\n      if (!(await option_section.update()) && !(await render_section.update())) {\n        return;\n      }\n      await renderAllMessage();\n    }),\n  );\n});\n\nfunction promoteOnce() {\n  const contents = $('.mes[is_user=\"false\"][is_system=\"false\"]')\n    .last()\n    .find('.roleplay_options_content')\n    .map((_index, element) => $(element).text().trim())\n    .toArray();\n  triggerSlash(`/send ${contents.length === 0 ? '继续推进' : _.sample(contents)} || /trigger`);\n}\nconst promoteOnceDelayed = () =>\n  setTimeout(promoteOnce, _.get(getVariables({ type: 'global' }), [lorebook_name, '自动推进发送间隔'], 3000));\n\nlet current_loop_times: number | null = null;\nfunction LoopOnce() {\n  if (current_loop_times === null) {\n    return;\n  }\n  if ($('.last_mes').attr('is_user') === 'true') {\n    return;\n  }\n  promoteOnceDelayed();\n\n  ++current_loop_times;\n  if (current_loop_times === _.get(getVariables({ type: 'global' }), [lorebook_name, '自动推进循环次数'], -1)) {\n    StopLoop();\n  }\n}\nfunction StopLoop() {\n  eventRemoveListener(tavern_events.CHARACTER_MESSAGE_RENDERED, LoopOnce);\n  current_loop_times = null;\n  toastr.success('已停止自动推进', lorebook_name);\n}\n\n$(async () => {\n  eventOnButton('设置循环次数', async () => {\n    const result = Number(\n      await SillyTavern.callGenericPopup(\n        `设置循环次数 (-1 为直到按下 '停止自动推进')`,\n        SillyTavern.POPUP_TYPE.INPUT,\n        _.get(getVariables({ type: 'global' }), [lorebook_name, '自动推进循环次数'], '-1'),\n      ),\n    );\n    if (result !== -1 && result <= 0) {\n      toastr.error('循环次数要么是 -1, 要么是大于 0 的整数');\n      return;\n    }\n    insertOrAssignVariables({ [lorebook_name]: { 自动推进循环次数: result } }, { type: 'global' });\n    if (result === -1) {\n      toastr.success('已设置推进次数为 -1, 即直到按下 \"停止自动推进\" 才会停止', lorebook_name);\n    } else {\n      toastr.success(`已设置推进次数为 ${result} 次`, lorebook_name);\n    }\n  });\n\n  eventOnButton('设置发送间隔', async () => {\n    const result = Number(\n      await SillyTavern.callGenericPopup(\n        `设置发送间隔 (单位: 毫秒)`,\n        SillyTavern.POPUP_TYPE.INPUT,\n        _.get(getVariables({ type: 'global' }), [lorebook_name, '自动推进发送间隔'], '3000'),\n      ),\n    );\n    if (result <= 0) {\n      toastr.error('发送间隔必须大于 0');\n      return;\n    }\n    insertOrAssignVariables({ [lorebook_name]: { 自动推进发送间隔: result } }, { type: 'global' });\n    toastr.success(`已设置发送间隔为 ${result} 毫秒`, lorebook_name);\n  });\n\n  eventOnButton('启动自动推进', () => {\n    if (current_loop_times !== null) {\n      toastr.error('自动推进在之前已开启, 请先停止自动推进');\n      return;\n    }\n    current_loop_times = 0;\n    LoopOnce();\n    eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED, LoopOnce);\n    toastr.success('已开启自动推进', lorebook_name);\n  });\n\n  eventOnButton('停止自动推进', StopLoop);\n});\n"],"names":["lorebook_name","roleplay_options_regex","option_section","render_section","async","renderOneMessage","message_id","match","getChatMessages","message","$roleplay_options_element","extract_roleplay_options_element","$mes_text","retrieveDisplayedMessage","Number","$to_render","find","length","parent","remove","append","renderAllMessage","$","children","each","_index","node","attr","parseInt","error","promoteOnce","contents","last","map","element","text","trim","toArray","triggerSlash","_","sample","default_option","input_mode","update","old_option","option","options","merge","getLorebookEntries","filter","entry","comment","startsWith","enabled","value","replace","content","result","has","parse_option","isEqual","style","old_style","entries","extract_style","$div","matchAll","title","on","$element","parents","old_content","val","join","dispatchEvent","Event","bubbles","divclick","this","errorCatched","eventOn","tavern_events","CHAT_CHANGED","CHARACTER_MESSAGE_RENDERED","MESSAGE_UPDATED","MESSAGE_SWIPED","MESSAGE_DELETED","setTimeout","WORLDINFO_UPDATED","lorebook","current_loop_times","LoopOnce","get","getVariables","type","StopLoop","eventRemoveListener","toastr","success","eventOnButton","SillyTavern","callGenericPopup","POPUP_TYPE","INPUT","insertOrAssignVariables"],"ignoreList":[],"sourceRoot":""}