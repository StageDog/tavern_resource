{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"Vue\"","src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/世界书/可点击的选择框/脚本/store.ts","src://tavern_helper_template/src/世界书/可点击的选择框/脚本/App.vue","webpack://tavern_helper_template/src/世界书/可点击的选择框/脚本/App.vue?5186","src://tavern_helper_template/src/世界书/可点击的选择框/脚本/index.ts","src://tavern_helper_template/src/世界书/可点击的选择框/脚本/style.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = Vue;","const __WEBPACK_NAMESPACE_OBJECT__ = z;","import default_css from './络络扁平化暗色紧凑列表.scss?raw';\nexport const LOREBOOK_NAME = '【可点击的选择框】';\nconst Config = z.object({\n    输入方式: z.enum(['直接发送', '覆盖输入', '尾附输入']).prefault('直接发送'),\n    样式: z.string().prefault(default_css),\n});\nexport const useConfigStore = defineStore('可点击的选择框', errorCatched(() => {\n    const config = ref(Config.parse({}));\n    const reloadConfig = async () => {\n        const worldbook = await getWorldbook(LOREBOOK_NAME);\n        const old_confg = config.value;\n        const new_config = Config.parse({\n            输入方式: _(worldbook)\n                .filter(entry => entry.enabled && entry.name.startsWith('设置-'))\n                .map(entry => entry.name.replace('设置-', ''))\n                .first(),\n            样式: _(worldbook)\n                .filter(entry => entry.enabled && entry.name.startsWith('样式-'))\n                .map(entry => entry.content.replace('<style>', '').replace('</style>', ''))\n                .first(),\n        });\n        if (!_.isEqual(new_config, old_confg)) {\n            config.value = klona(new_config);\n        }\n    };\n    const _wait_init = reloadConfig();\n    eventOn(tavern_events.WORLDINFO_UPDATED, errorCatched(async (lorebook) => {\n        if (lorebook === LOREBOOK_NAME) {\n            await reloadConfig();\n        }\n    }));\n    return { config: readonly(config), _wait_init };\n}));\n","import { defineComponent as _defineComponent } from 'vue';\nimport { renderList as _renderList, Fragment as _Fragment, openBlock as _openBlock, createElementBlock as _createElementBlock, toDisplayString as _toDisplayString, createElementVNode as _createElementVNode } from \"vue\";\nconst _hoisted_1 = { class: \"roleplay_options\" };\nconst _hoisted_2 = { class: \"roleplay_options_back\" };\nconst _hoisted_3 = [\"onClick\"];\nconst _hoisted_4 = { class: \"roleplay_options_title\" };\nconst _hoisted_5 = { class: \"roleplay_options_content\" };\nimport { useConfigStore } from './store';\nexport default /*@__PURE__*/ _defineComponent({\n    __name: 'App',\n    props: {\n        messageId: {},\n        options: {}\n    },\n    setup(__props) {\n        const props = __props;\n        const store = useConfigStore();\n        async function handleClick(item) {\n            if (getLastMessageId() !== props.messageId) {\n                return;\n            }\n            switch (store.config.输入方式) {\n                case '直接发送':\n                    triggerSlash(`/send ${item.content} || /trigger`);\n                    break;\n                case '覆盖输入':\n                    triggerSlash(`/setinput ${item.content}`);\n                    break;\n                case '尾附输入':\n                    $('#send_textarea')\n                        .val([String($('#send_textarea').val()), item.content].filter(string => string.trim() !== '').join('\\n') || '')[0]\n                        .dispatchEvent(new Event('input', { bubbles: true }));\n                    break;\n            }\n        }\n        return (_ctx, _cache) => {\n            return (_openBlock(), _createElementBlock(\"div\", _hoisted_1, [\n                _createElementVNode(\"div\", _hoisted_2, [\n                    (_openBlock(true), _createElementBlock(_Fragment, null, _renderList(__props.options, (option) => {\n                        return (_openBlock(), _createElementBlock(\"div\", {\n                            key: option.title,\n                            class: \"roleplay_options_item\",\n                            tabindex: \"1\",\n                            onClick: ($event) => (handleClick(option))\n                        }, [\n                            _createElementVNode(\"span\", _hoisted_4, [\n                                _createElementVNode(\"strong\", null, _toDisplayString(option.title), 1 /* TEXT */)\n                            ]),\n                            _cache[0] || (_cache[0] = _createElementVNode(\"hr\", { class: \"roleplay_options_hr\" }, null, -1 /* CACHED */)),\n                            _createElementVNode(\"span\", _hoisted_5, _toDisplayString(option.content), 1 /* TEXT */)\n                        ], 8 /* PROPS */, _hoisted_3));\n                    }), 128 /* KEYED_FRAGMENT */))\n                ])\n            ]));\n        };\n    }\n});\n","/* unplugin-vue-components disabled */import script from \"./App.vue?vue&type=script&setup=true&lang=ts\"\nexport * from \"./App.vue?vue&type=script&setup=true&lang=ts\"\n\nconst __exports__ = script;\n\nexport default __exports__","import App from './App.vue';\nimport { useConfigStore } from './store';\nimport { injectStyle } from './style';\nconst apps = new Map();\nsetActivePinia(getActivePinia() ?? createPinia());\nconst TAG = '<roleplay_options>';\nconst REGEX = /<(roleplay_options)>\\s*(?:```.*\\n)?((?:(?!<\\1>)[\\s\\S])*?)(?:\\n```)?\\s*<\\/\\1>/im;\nasync function renderOneMessage(message_id) {\n    const chat_messages = getChatMessages(message_id);\n    if (chat_messages.length === 0) {\n        return;\n    }\n    const message = chat_messages[0].message ?? '';\n    const match = message.match(REGEX);\n    if (!match) {\n        return;\n    }\n    apps.get(message_id)?.unmount();\n    apps.delete(message_id);\n    const $mes_text = retrieveDisplayedMessage(message_id);\n    const $to_render = $mes_text.find(`pre:contains(\"${TAG}\")`);\n    if ($to_render.length > 0) {\n        const $th_render = $to_render.parent('.TH-render');\n        if ($th_render.length > 0) {\n            $th_render.addClass('hidden!');\n        }\n        else {\n            $to_render.addClass('hidden!');\n        }\n        const app = createApp(App, {\n            messageId: message_id,\n            options: [...match[2].matchAll(/(.+?)[:：]\\s*(.+)/gm)].map(match => ({\n                title: match[1],\n                content: match[2].replace(/^\\$\\{(.+)\\}$/, '$1').replace(/^「(.+)」$/, '$1'),\n            })),\n        }).use(pinia);\n        apps.set(message_id, app);\n        const possible_div = $mes_text.find(`div[script_id=\"${getScriptId()}\"]`);\n        app.mount(possible_div.length > 0 ? possible_div[0] : $('<div>').attr('script_id', getScriptId()).appendTo($mes_text)[0]);\n    }\n}\nasync function renderAllMessage() {\n    apps.forEach(app => {\n        app.unmount();\n    });\n    apps.clear();\n    $('#chat')\n        .children(\".mes[is_user='false'][is_system='false']\")\n        .each((_index, node) => {\n        const message_id = Number($(node).attr('mesid') ?? 'NaN');\n        if (!isNaN(message_id)) {\n            renderOneMessage(message_id);\n        }\n    });\n}\n$(async () => {\n    await useConfigStore()._wait_init;\n    const { stop } = injectStyle();\n    await renderAllMessage();\n    eventOn(tavern_events.CHAT_CHANGED, errorCatched(renderAllMessage));\n    eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED, errorCatched(renderOneMessage));\n    eventOn(tavern_events.MESSAGE_UPDATED, errorCatched(renderOneMessage));\n    eventOn(tavern_events.MESSAGE_SWIPED, errorCatched(renderOneMessage));\n    [tavern_events.MORE_MESSAGES_LOADED, tavern_events.MESSAGE_DELETED].forEach(event => eventOn(event, () => setTimeout(errorCatched(renderAllMessage), 1000)));\n    $(window).on('pagehide', () => {\n        $(`pre:contains(\"${TAG}\")`).each(function () {\n            const $th_render = $(this).parent('.TH-render');\n            if ($th_render.length > 0) {\n                $th_render.removeClass('hidden!');\n            }\n            else {\n                $(this).removeClass('hidden!');\n            }\n        });\n        apps.forEach(app => {\n            app?.unmount();\n        });\n        apps.clear();\n        stop();\n    });\n});\n","import { useConfigStore } from './store';\nexport function injectStyle() {\n    const store = useConfigStore();\n    $(`<div>`).attr('script_id', getScriptId()).append(`<style>${store.config.样式}</style>`).appendTo('head');\n    const stop = watch(() => store.config.样式, style => {\n        $(`head > div[script_id=\"${getScriptId()}\"]`).find('style').text(style);\n    });\n    return {\n        stop: () => {\n            stop();\n            $(`head > div[script_id=\"${getScriptId()}\"]`).remove();\n        },\n    };\n}\n"],"names":["Vue","z","LOREBOOK_NAME","Config","object","enum","prefault","string","useConfigStore","errorCatched","config","ref","parse","reloadConfig","async","worldbook","getWorldbook","old_confg","value","new_config","_","filter","entry","enabled","name","startsWith","map","replace","first","content","isEqual","_wait_init","eventOn","tavern_events","WORLDINFO_UPDATED","lorebook","readonly","_hoisted_1","class","_hoisted_2","_hoisted_3","_hoisted_4","_hoisted_5","__name","props","messageId","options","setup","__props","store","_ctx","_cache","option","key","title","tabindex","onClick","$event","item","getLastMessageId","triggerSlash","$","val","String","trim","join","dispatchEvent","Event","bubbles","apps","Map","TAG","REGEX","renderOneMessage","message_id","chat_messages","getChatMessages","length","match","message","get","unmount","delete","$mes_text","retrieveDisplayedMessage","$to_render","find","$th_render","parent","addClass","app","createApp","App","matchAll","use","pinia","set","possible_div","getScriptId","mount","attr","appendTo","renderAllMessage","forEach","clear","children","each","_index","node","Number","isNaN","stop","append","watch","style","text","remove","injectStyle","CHAT_CHANGED","CHARACTER_MESSAGE_RENDERED","MESSAGE_UPDATED","MESSAGE_SWIPED","MORE_MESSAGES_LOADED","MESSAGE_DELETED","event","setTimeout","window","on","this","removeClass"],"sourceRoot":""}