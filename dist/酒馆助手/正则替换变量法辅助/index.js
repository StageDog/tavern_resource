const e=_.debounce(function(){const e=2e6,a=SillyTavern.chatCompletionSettings;!0===a.max_context_unlocked&&a.openai_max_context===e||($('#oai_max_context_unlocked').prop('checked',!0).trigger('input'),$('#openai_max_context_counter').val(e),$('#openai_max_context').val(e).trigger('input'))},1e3);$(()=>{eventOn(tavern_events.SETTINGS_UPDATED,e)});const a=/@\s*([^@\n]*?)\s*@?\s*=\s*(?:.*?⇒)?'?([^@\n]*?)'?\s*((@$)|(?=@))/gm;function t(e){return`${Object.entries(e).map(([e,a])=>`@${e}=${a}@`).join('\n')}`}async function n(e){await async function(e,a){const n=await getChatMessages(e);if(n.length<=0)return;const s=n[0].message;await setChatMessage({message:s+`\n<UpdateVariable>\n${t(a)}\n</UpdateVariable>`},e,{refresh:'none'})}(SillyTavern.chat.length-1,e)}async function s(){const e=SillyTavern.chat.at(-1);if(!e)return;const n=e=>_.pickBy(_.mapKeys(e,(e,a)=>a.replaceAll('@','').trim()),(e,a)=>a.startsWith('变量.')),s=_.merge({},n(SillyTavern.chatMetadata?.variables),...SillyTavern.chat.slice(-2).map(e=>{return n((t=e.mes,_.merge({},...[...t.matchAll(a)].map(e=>({[e[1]]:e[2]})))));var t})),i=e.mes.replace(/(?:\n<UpdateVariable>\n<FullUpdateVariable>.*?<\/FullUpdateVariable>\n<\/UpdateVariable>)|$/s,`\n<UpdateVariable>\n<FullUpdateVariable>\n${t(s)}\n</FullUpdateVariable>\n</UpdateVariable>`);e.swipes&&e.swipe_id&&(e.swipes[e.swipe_id]=i),e.mes=i,await SillyTavern.saveChat()}$(()=>{eventOn('在最新楼层更新变量',n),eventOn(tavern_events.MESSAGE_SENT,s),eventOn(tavern_events.MESSAGE_RECEIVED,s)}),$(()=>{!async function(){const e={scan_depth:2,context_percentage:100,budget_cap:0,min_activations:0,max_depth:0,max_recursion_steps:0,insertion_strategy:'character_first',include_names:!1,recursive:!0,case_sensitive:!1,match_whole_words:!1,use_group_scoring:!1,overflow_alert:!1},a=await getLorebookSettings();_.isEqual(_.merge({},a,e),a)||setLorebookSettings(e)}()});