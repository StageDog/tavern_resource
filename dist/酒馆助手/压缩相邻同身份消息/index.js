import{createApp as s,createElementBlock as t,createElementVNode as e,openBlock as n}from'https://testingcf.jsdelivr.net/npm/vue/+esm';var r={372:(s,t)=>{t.A=(s,t)=>{const e=s.__vccOpts||s;for(const[s,n]of t)e[s]=n;return e}}},i={};const a='{【{【聊天记录开头】}】}',o='{【{【聊天记录结尾】}】}',u=[{id:'\0',position:'in_chat',depth:9999,role:'assistant',content:a},{id:'􏿿',position:'in_chat',depth:0,role:'assistant',content:o}];const c={class:'clickdiv',tabindex:'1'};var l=function s(t){var e=i[t];if(void 0!==e)return e.exports;var n=i[t]={exports:{}};return r[t](n,n.exports,s),n.exports}(372);const f={},p=(0,l.A)(f,[['render',function(s,r){return n(),t('div',c,[...r[0]||(r[0]=[e('span',{class:'message-content font-bold underline'},null,-1)])])}]]);const d=z.object({seperator:z.object({type:z.enum(['space','newline','double newline','custom']).default('double newline'),value:z.string().default('\n\n')}).default({type:'double newline',value:'\n\n'}).transform(s=>{switch(s.type){case'space':s.value=' ';break;case'newline':s.value='\n';break;case'double newline':s.value='\n\n'}return s}),squash_chat_history:z.object({enable:z.boolean().default(!0),squash_role:z.enum(['user','assistant','system']).default('assistant'),user_prefix:z.string().default('user: '),user_suffix:z.string().default(''),assistant_prefix:z.string().default('assistant: '),assistant_suffix:z.string().default(''),system_prefix:z.string().default(''),system_suffix:z.string().default('')}).default({enable:!0,squash_role:'assistant',user_prefix:'user: ',user_suffix:'',assistant_prefix:'assistant: ',assistant_suffix:'',system_prefix:'',system_suffix:''})});let h;function m(){return h||(h=d.parse(getVariables({type:'script',script_id:getScriptId()})),insertVariables(h,{type:'script',script_id:getScriptId()})),h}function x(s){return function(s,t){if(0===s.length)return[];const e=[[s[0]]];for(const[n,r]of _.zip(_.drop(s),_.dropRight(s)))console.info(n,r),t(n,r)?e[e.length-1].push(n):e.push([n]);return e}(s,(s,t)=>s.role===t.role).map(s=>({role:s[0].role,content:s.map(({content:s})=>s.trim()).join(m().seperator.value)}))}$(()=>{$('#extensions_settings2').append('<div id="squash_nearby_same_role_messages_settings"></div>'),s(p).mount('#squash_nearby_same_role_messages_settings'),injectPrompts(u),eventMakeLast(tavern_events.GENERATE_AFTER_DATA,({prompt:s})=>{const t=function(s){const t=s.findIndex(({content:s})=>s.includes(a)),e=s.findIndex(({content:s})=>s.includes(o));return-1===t||-1===e?null:(s[t].content=s[t].content.replace(new RegExp(`${a}\n?`),'').trim(),s[e].content=s[e].content.replace(new RegExp(`\n?${o}`),'').trim(),{head:s.slice(0,t),chat_history:s.slice(t,e+1),tail:s.slice(e+1)})}(s)??{head:[],chat_history:[],tail:[]};if(!t)return;const{head:e,chat_history:n,tail:r}=t;var i,u,c;console.info(e,n,r),i=s,u=[...x(e),(c=n,{role:m().squash_chat_history.squash_role,content:_(c).reject(({content:s})=>''===s.trim()).map(({role:s,content:t})=>{switch(s){case'system':return substitudeMacros(m().squash_chat_history.system_prefix)+t.trim()+substitudeMacros(m().squash_chat_history.system_suffix);case'assistant':return substitudeMacros(m().squash_chat_history.assistant_prefix)+t.trim()+substitudeMacros(m().squash_chat_history.assistant_suffix);case'user':return substitudeMacros(m().squash_chat_history.user_prefix)+t.trim()+substitudeMacros(m().squash_chat_history.user_suffix)}}).join(m().seperator.value)}),...x(r)],i.length=0,i.push(...u)})}),$(window).on('pagehide',()=>{$('#extensions_settings2').find('#squash_nearby_same_role_messages_settings').remove(),uninjectPrompts(u.map(({id:s})=>s))});