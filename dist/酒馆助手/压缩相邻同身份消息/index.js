import{compare as e}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import{createApp as s,createCommentVNode as t,createElementBlock as a,createElementVNode as i,defineComponent as n,openBlock as l,reactive as o,vModelCheckbox as r,vModelSelect as u,vModelText as c,watch as f,withDirectives as p}from'https://testingcf.jsdelivr.net/npm/vue/+esm';const h='{【{【聊天记录开头】}】}',d='{【{【聊天记录结尾】}】}',x=[{id:'\0',position:'in_chat',depth:9999,role:'assistant',content:h},{id:'􏿿',position:'in_chat',depth:0,role:'assistant',content:d}];const m=z.object({seperator:z.object({type:z.enum(['space','newline','double newline','custom']).default('double newline'),value:z.string().default('\n\n')}).default({type:'double newline',value:'\n\n'}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),squash_chat_history:z.object({enable:z.boolean().default(!0),squash_role:z.enum(['user','assistant','system']).default('assistant'),user_prefix:z.string().default('{{user}}: '),user_suffix:z.string().default(''),assistant_prefix:z.string().default('剧情: '),assistant_suffix:z.string().default(''),system_prefix:z.string().default(''),system_suffix:z.string().default('')}).default({enable:!0,squash_role:'assistant',user_prefix:'{{user}}: ',user_suffix:'',assistant_prefix:'剧情: ',assistant_suffix:'',system_prefix:'',system_suffix:''})});let y;function v(){return y||(y=m.parse(getVariables({type:'script',script_id:getScriptId()})),insertVariables(y,{type:'script',script_id:getScriptId()})),y}function b(e){y=e,insertOrAssignVariables(y,{type:'script',script_id:getScriptId()})}const q={class:'inline-drawer'},w={class:'inline-drawer-content'},g={class:'flex-container flexFlowColumn'},V={key:0,class:'flex-container flexFlowColumn'},j={class:'flex-container',title:'启用压缩聊天历史'},F={key:1,class:'flex-container flexFlowColumn'},U={key:2},C={class:'flex-container flexFlowColumn',title:'用户消息前缀'},k={class:'flex-container flexFlowColumn',title:'用户消息后缀'},E={class:'flex-container flexFlowColumn',title:'助手消息前缀'},M={class:'flex-container flexFlowColumn',title:'助手消息后缀'},A={class:'flex-container flexFlowColumn',title:'系统消息前缀'},I={class:'flex-container flexFlowColumn',title:'系统消息后缀'},R=n({__name:'panel',setup(e){const s=o(v());return f(()=>_.cloneDeep(s),e=>{b(e)},{deep:!0}),(e,n)=>(l(),a('div',q,[n[23]||(n[23]=i('div',{class:'inline-drawer-toggle inline-drawer-header'},[i('b',null,'压缩相邻同身份消息'),i('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),i('div',w,[t(' 分隔符设置 '),i('div',g,[n[11]||(n[11]=i('label',{for:'squash_separator_type'},'消息分隔符',-1)),p(i('select',{'onUpdate:modelValue':n[0]||(n[0]=e=>s.seperator.type=e),id:'squash_separator_type',class:'text_pole'},[...n[10]||(n[10]=[i('option',{value:'space'},'空格',-1),i('option',{value:'newline'},'换行',-1),i('option',{value:'double newline'},'双换行',-1),i('option',{value:'custom'},'自定义',-1)])],512),[[u,s.seperator.type]])]),'custom'===s.seperator.type?(l(),a('div',V,[n[12]||(n[12]=i('label',{for:'squash_separator_value'},'自定义分隔符',-1)),p(i('input',{'onUpdate:modelValue':n[1]||(n[1]=e=>s.seperator.value=e),id:'squash_separator_value',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,s.seperator.value]])])):t('v-if',!0),n[22]||(n[22]=i('hr',null,null,-1)),t(' 压缩聊天历史设置 '),i('div',j,[p(i('input',{'onUpdate:modelValue':n[2]||(n[2]=e=>s.squash_chat_history.enable=e),type:'checkbox',id:'squash_chat_history_enable'},null,512),[[r,s.squash_chat_history.enable]]),n[13]||(n[13]=i('span',null,'启用压缩聊天历史',-1))]),s.squash_chat_history.enable?(l(),a('div',F,[n[15]||(n[15]=i('label',{for:'squash_role'},'压缩角色',-1)),p(i('select',{'onUpdate:modelValue':n[3]||(n[3]=e=>s.squash_chat_history.squash_role=e),id:'squash_role',class:'text_pole'},[...n[14]||(n[14]=[i('option',{value:'system'},'系统',-1),i('option',{value:'user'},'用户',-1),i('option',{value:'assistant'},'助手',-1)])],512),[[u,s.squash_chat_history.squash_role]])])):t('v-if',!0),s.squash_chat_history.enable?(l(),a('div',U,[t(' 用户前缀后缀 '),i('div',C,[n[16]||(n[16]=i('label',{for:'user_prefix'},'用户前缀',-1)),p(i('input',{'onUpdate:modelValue':n[4]||(n[4]=e=>s.squash_chat_history.user_prefix=e),id:'user_prefix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,s.squash_chat_history.user_prefix]])]),i('div',k,[n[17]||(n[17]=i('label',{for:'user_suffix'},'用户后缀',-1)),p(i('input',{'onUpdate:modelValue':n[5]||(n[5]=e=>s.squash_chat_history.user_suffix=e),id:'user_suffix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,s.squash_chat_history.user_suffix]])]),t(' 助手前缀后缀 '),i('div',E,[n[18]||(n[18]=i('label',{for:'assistant_prefix'},'助手前缀',-1)),p(i('input',{'onUpdate:modelValue':n[6]||(n[6]=e=>s.squash_chat_history.assistant_prefix=e),id:'assistant_prefix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,s.squash_chat_history.assistant_prefix]])]),i('div',M,[n[19]||(n[19]=i('label',{for:'assistant_suffix'},'助手后缀',-1)),p(i('input',{'onUpdate:modelValue':n[7]||(n[7]=e=>s.squash_chat_history.assistant_suffix=e),id:'assistant_suffix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,s.squash_chat_history.assistant_suffix]])]),t(' 系统前缀后缀 '),i('div',A,[n[20]||(n[20]=i('label',{for:'system_prefix'},'系统前缀',-1)),p(i('input',{'onUpdate:modelValue':n[8]||(n[8]=e=>s.squash_chat_history.system_prefix=e),id:'system_prefix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,s.squash_chat_history.system_prefix]])]),i('div',I,[n[21]||(n[21]=i('label',{for:'system_suffix'},'系统后缀',-1)),p(i('input',{'onUpdate:modelValue':n[9]||(n[9]=e=>s.squash_chat_history.system_suffix=e),id:'system_suffix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,s.squash_chat_history.system_suffix]])])])):t('v-if',!0)])]))}}),S=R;function D(e){return e.filter(({content:e})=>''!==e.trim())}function T(e){return function(e,s){if(0===e.length)return[];const t=[[e[0]]];for(const[a,i]of _.zip(_.drop(e),_.dropRight(e)))s(a,i)?t[t.length-1].push(a):t.push([a]);return t}(D(e),(e,s)=>e.role===s.role).map(e=>({role:e[0].role,content:e.map(({content:e})=>e.trim()).join(v().seperator.value)}))}$(()=>{!async function(s,t){e(await getTavernHelperVersion(),s,'<')&&toastr.error(`'${t}' 需要酒馆助手版本 >= '${s}'`,'版本不兼容')}('3.4.15','压缩相邻同身份消息'),async function(e){const s=await fetch(e);if(!s.ok)return!1;const t=await s.text();replaceScriptInfo(t)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/压缩相邻同身份消息/README.md'),$('#extensions_settings2').append('<div id="squash_nearby_same_role_messages_settings"></div>'),s(S).mount($('#squash_nearby_same_role_messages_settings')[0]),injectPrompts(x),eventMakeLast(tavern_events.GENERATE_AFTER_DATA,({prompt:e})=>{const s=function(e){const s=e.findIndex(({content:e})=>e.includes(h)),t=e.findIndex(({content:e})=>e.includes(d));return-1===s||-1===t?null:(e[s].content=e[s].content.replace(new RegExp(`${h}\n?`),'').trim(),e[t].content=e[t].content.replace(new RegExp(`\n?${d}`),'').trim(),{head:e.slice(0,s),chat_history:e.slice(s,t+1),tail:e.slice(t+1)})}(e)??{head:[],chat_history:[],tail:[]};if(!s)return;const{head:t,chat_history:a,tail:i}=s;var n,l,o;n=e,l=[...T(t),...v().squash_chat_history.enable?[(o=a,{role:v().squash_chat_history.squash_role,content:_(D(o)).map(({role:e,content:s})=>{switch(e){case'system':return substitudeMacros(v().squash_chat_history.system_prefix)+s.trim()+substitudeMacros(v().squash_chat_history.system_suffix);case'assistant':return substitudeMacros(v().squash_chat_history.assistant_prefix)+s.trim()+substitudeMacros(v().squash_chat_history.assistant_suffix);case'user':return substitudeMacros(v().squash_chat_history.user_prefix)+s.trim()+substitudeMacros(v().squash_chat_history.user_suffix)}}).join(v().seperator.value)})]:[...T(a)],...T(i)],n.length=0,n.push(...l)})}),$(window).on('pagehide',()=>{$('#extensions_settings2').find('#squash_nearby_same_role_messages_settings').remove(),uninjectPrompts(x.map(({id:e})=>e))});