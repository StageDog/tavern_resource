{"version":3,"file":"index.js","mappings":"AAGA,MCHM,EAA+BA,ECE/BC,EAAW,EAAAD,EACZE,OAAO,CACR,SAAU,EAAAF,EAAEG,SAASC,QAAQ,OAE5BC,SAAS,CAAC,GACf,IAAIC,EACJ,SAASC,IAKL,OAJKD,IACDA,EAAWL,EAASO,MAAMC,aAAa,CAAEC,KAAM,SAAUC,UAAWC,iBACpEC,gBAAgBP,EAAU,CAAEI,KAAM,SAAUC,UAAWC,iBAEpDN,CACX,CACA,MAAMQ,EAAsB,EAAGC,aAC3BC,WAAWC,UAEP,MAKMC,SALeC,QAAQC,IAAIL,EAC5BM,OAAON,GAAoC,iBAAnBA,EAAOO,SAC/BC,IAAIN,MAAOF,SACCS,YAAYC,mBAAmBV,EAAOO,YAE3BI,OAAO,CAACC,EAAQC,IAAYD,EAASC,EAAS,GACtEV,EAAeX,IAAc,UAC7BsB,OAAOC,QAAQ,0DAAyD,YAAYZ,YAAuBX,IAAc,YAAa,CAClIwB,aAAc,IACdC,YAAY,EACZC,QAAS,KACLT,YAAYU,iBF5BrB,oME4B2CV,YAAYW,WAAWC,KAAM,GAAI,CAC/DC,0BAA0B,EAC1BC,WAAW,UAOnCC,EAAE,KACEhC,ICrCGU,eAA0BuB,GAC/B,MAAMC,QAAeC,MAAMF,GAC3B,IAAKC,EAAOE,GACV,OAAO,EAET,MAAMC,QAAoBH,EAAOI,OACjCC,kBAAkBF,EAEpB,CD8BIG,CAAW,4FACXC,QAAQC,cAAcC,oBAAqBC,EAAEC,SAAStC,EAAqB,IAAM,CAAEuC,SAAS,EAAMC,UAAU","sources":["webpack://tavern_helper_template/src/酒馆助手/token数过多提醒/tip.md?ae23","src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/酒馆助手/token数过多提醒/index.ts","src://tavern_helper_template/util/script.ts"],"sourcesContent":["// Module\nvar code = `<h2>聊天 token 数过多</h2> <p>这会让 AI 变笨、抽风、重复内容, 因此建议你减少聊天 token 数, 你可以:</p> <ul> <li>自行要求 AI 总结前面的楼层, 然后在聊天框输入 <code>/hide 开始楼层号-结束楼层号</code> 隐藏前面的楼层</li> <li>去社区寻找合适的带总结功能预设、总结世界书、总结插件</li> </ul> `;\n// Exports\nexport default code;","const __WEBPACK_NAMESPACE_OBJECT__ = z;","import { loadReadme } from '@util/script';\nimport tip from './tip.md';\nconst Settings = z\n    .object({\n    token数阈值: z.number().default(80000),\n})\n    .prefault({});\nlet settings;\nfunction getSettings() {\n    if (!settings) {\n        settings = Settings.parse(getVariables({ type: 'script', script_id: getScriptId() }));\n        insertVariables(settings, { type: 'script', script_id: getScriptId() });\n    }\n    return settings;\n}\nconst onGenerateAfterData = ({ prompt }) => {\n    setTimeout(async () => {\n        // 依次计算 token 从而利用酒馆对 token 的缓存\n        const tokens = await Promise.all(prompt\n            .filter(prompt => typeof prompt.content === 'string')\n            .map(async (prompt) => {\n            return await SillyTavern.getTokenCountAsync(prompt.content);\n        }));\n        const total_tokens = tokens.reduce((result, current) => result + current, 0);\n        if (total_tokens > getSettings().token数阈值) {\n            toastr.warning(`<u>点击查看如何减少 token</u><br>如果不想被提醒，请通过 '酒馆助手-工具箱' 关闭此功能`, `token 数 (${total_tokens}) 超过建议 (${getSettings().token数阈值})`, {\n                showDuration: 1000,\n                escapeHtml: false,\n                onclick: () => {\n                    SillyTavern.callGenericPopup(tip, SillyTavern.POPUP_TYPE.TEXT, '', {\n                        allowHorizontalScrolling: true,\n                        leftAlign: true,\n                    });\n                },\n            });\n        }\n    });\n};\n$(() => {\n    getSettings();\n    loadReadme('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/token数过多提醒/README.md');\n    eventOn(tavern_events.GENERATE_AFTER_DATA, _.debounce(onGenerateAfterData, 1000, { leading: true, trailing: false }));\n});\n","import iframe_srcdoc from './iframe_srcdoc.html';\n\nexport async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle(\n  append_to: JQuery.Selector | JQuery.htmlString | JQuery.TypeOrArray<Element | DocumentFragment> | JQuery = 'head',\n): { destroy: () => void } {\n  const $div = $(`<div>`)\n    .attr('script_id', getScriptId())\n    .append($(`head > style`, document).clone())\n    .appendTo(append_to);\n\n  return {\n    destroy: () => $div.remove(),\n  };\n}\n\nexport function createScriptIdIframe(): JQuery<HTMLIFrameElement> {\n  return $(`<iframe>`).attr({\n    script_id: getScriptId(),\n    frameborder: 0,\n    srcdoc: iframe_srcdoc,\n  }) as JQuery<HTMLIFrameElement>;\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, new_chat_id => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n\nexport function registerAsUniqueScript(id: string): {\n  unregister: () => void;\n  getPreferredScriptId: () => string | undefined;\n  listenPreferenceState: (callback: (perferred_script_id: string) => void) => EventOnReturn;\n} {\n  const script_id = getScriptId();\n  const path = `th_unique_check.${id}`;\n\n  const getPreferredScriptId = () => {\n    const registered_scripts = _.get(window.parent, path, new Set<string>());\n    return _($('#tavern_helper').find('div[data-script-id]').toArray())\n      .map(element => String($(element).attr('data-script-id')))\n      .filter(element => registered_scripts.has(element))\n      .last();\n  };\n\n  _.update(window.parent, path, (value: Set<string> | undefined) => {\n    if (value === undefined) {\n      return new Set([script_id]);\n    }\n    value.add(script_id);\n    return value;\n  });\n  eventEmit(path, getPreferredScriptId());\n\n  return {\n    unregister: () => {\n      _.update(window.parent, path, (value: Set<string> | undefined) => {\n        if (value !== undefined) {\n          value.delete(script_id);\n        }\n        return value;\n      });\n      eventEmit(path, getPreferredScriptId());\n    },\n    getPreferredScriptId,\n    listenPreferenceState: (callback: (enabled_script_id: string) => void) => eventOn(path, callback),\n  };\n}\n"],"names":["z","Settings","object","number","default","prefault","settings","getSettings","parse","getVariables","type","script_id","getScriptId","insertVariables","onGenerateAfterData","prompt","setTimeout","async","total_tokens","Promise","all","filter","content","map","SillyTavern","getTokenCountAsync","reduce","result","current","toastr","warning","showDuration","escapeHtml","onclick","callGenericPopup","POPUP_TYPE","TEXT","allowHorizontalScrolling","leftAlign","$","url","readme","fetch","ok","readme_text","text","replaceScriptInfo","loadReadme","eventOn","tavern_events","GENERATE_AFTER_DATA","_","debounce","leading","trailing"],"sourceRoot":""}