const e=["ModeA","ModeB","ModeO","ModeT"],t=["允许AI抢话","禁止AI抢话"];async function o(){return _.pick(getVariables({type:"chat"}),["mode","step"])}async function r(e){await insertOrAssignVariables(e)}async function n(){const e=await o(),t=$("<div>");t.append($("<p>").text(`当前模式: ${e.mode??"未选择"}`)),t.append($("<p>").text(`当前步骤: ${e.step??"请先选择模式"}`)),triggerSlash(`/popup okButton="确认" ${t.html()}`)}var a;async function s(){const o=await triggerSlash(`/buttons labels=${JSON.stringify(e)}`),r=await triggerSlash(`/buttons labels=${JSON.stringify(t)}`);o&&r&&a.choose_mode(o,r)}async function i(){await a.set_step_by_offset(-1)}async function c(){await a.set_step_by_offset(1)}!function(t){t.choose_mode=async function(t,o){const n=await getCurrentCharPrimaryLorebook();if(!n)return void triggerSlash("/echo severity=error 未找到 A.U.T.O 世界书, 你是否忘了导入它?");let a=await getOrCreateChatLorebook();if((await getLorebookEntries(a)).length>0){if("0"===await triggerSlash('/popup cancelButton="取消" okButton="确认" result=true 检测到本聊天文件绑定的世界书非空, 你确定要清空它重新选择模式吗?'))return}await deleteLorebook(a),a=await getOrCreateChatLorebook();const s=_.reject(await getLorebookEntries(n),(o=>_.reject(e,(e=>e===t)).some((e=>o.comment.includes(e)))));for(const e of s)await createLorebookEntry(a,{...e,enabled:!!(e.comment.match(/\D1\D/)||e.comment.includes("基础概念")||e.comment.includes(`写卡模式-${o}`))});r({mode:t,step:1}),triggerSlash(`/echo severity=success 成功将 '${t}' 提取到聊天世界书 '${a}' 中!`)},t.set_step_by_offset=async function(e){const t=await o();if(null==t.mode||null==t.step)return void triggerSlash("/echo severity=error 你必须先选择模式!");if("ModeT"===t.mode)return void triggerSlash("/echo severity=error ModeT不支持切换步骤, 请手动开关!");const n=await getOrCreateChatLorebook(),a=await getLorebookEntries(n),{min:s,max:i}=await async function(e){return{min:1,max:_.max([...e.reduce(((e,t)=>e+t.comment),"").matchAll(/\d+/g)].map((e=>Number(e.toString()))))}}(a),c=t.step+e;if(c<s||c>i)return void triggerSlash(`/echo severity=error 设置的步骤 '${c}' 超出了范围 '${s}-${i}'!`);const u=e=>Number(e.comment.match(/(?<=\D)\d+(?=\D)/)[0]);a.filter((e=>e.comment.includes("Step"))).forEach((e=>e.enabled=u(e)===c)),a.filter((e=>e.comment.includes("Part"))).forEach((e=>e.enabled=u(e)<=c)),setLorebookEntries(n,a),r({step:c}),triggerSlash(`/echo severity=success 成功将 '${t.mode}' 设置为步骤 '${c}'`)}}(a||(a={})),$((()=>{eventOnButton("查看状态",n),eventOnButton("选择模式",s),eventOnButton("上一步",i),eventOnButton("下一步",c)}));