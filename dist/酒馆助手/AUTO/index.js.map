{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/酒馆助手/AUTO/index.ts"],"sourcesContent":["export {};\n\nconst modes = ['ModeA', 'ModeB', 'ModeO', 'ModeT'];\nconst take_overs = ['允许AI抢话', '禁止AI抢话'];\n\ninterface Variables {\n  mode?: string;\n  step?: number;\n}\n\nasync function get_variables(): Promise<Variables> {\n  return _.pick(getVariables({ type: 'chat' }), ['mode', 'step']);\n}\n\nasync function set_variables(variables: Variables): Promise<void> {\n  await insertOrAssignVariables(variables);\n}\n\n//----------------------------------------------------------------------------------------------------------------------\nasync function get_status(): Promise<void> {\n  const variables = await get_variables();\n\n  const display = $('<div>');\n  display.append($('<p>').text(`当前模式: ${variables.mode ?? '未选择'}`));\n  display.append($('<p>').text(`当前步骤: ${variables.step ?? '请先选择模式'}`));\n\n  triggerSlash(`/popup okButton=\"确认\" ${display.html()}`);\n}\n\nnamespace detail {\n  export async function choose_mode_impl(chosen_mode: string, take_over: string): Promise<void> {\n    const char_lorebook = getCurrentCharPrimaryLorebook();\n    if (!char_lorebook) {\n      triggerSlash('/echo severity=error 未找到 A.U.T.O 世界书, 你是否忘了导入它?');\n      return;\n    }\n\n    let chat_lorebook = await getOrCreateChatLorebook();\n    if ((await getLorebookEntries(chat_lorebook)).length > 0) {\n      const confirm_result = await triggerSlash(\n        '/popup cancelButton=\"取消\" okButton=\"确认\" result=true 检测到本聊天文件绑定的世界书非空, 你确定要清空它重新选择模式吗?',\n      );\n      if (confirm_result === '0') {\n        return;\n      }\n    }\n    await deleteLorebook(chat_lorebook);\n    chat_lorebook = await getOrCreateChatLorebook();\n\n    const entries = _.reject(await getLorebookEntries(char_lorebook), entry =>\n      _.reject(modes, mode => mode === chosen_mode).some(mode => entry.comment.includes(mode)),\n    );\n    await createLorebookEntries(\n      chat_lorebook,\n      entries.map(entry => ({\n        ...entry,\n        enabled:\n          entry.comment.match(/\\D1\\D/) ||\n          entry.comment.includes('基础概念') ||\n          entry.comment.includes(`写卡模式-${take_over}`)\n            ? true\n            : false,\n      })),\n    );\n\n    set_variables({ mode: chosen_mode, step: 1 });\n    triggerSlash(`/echo severity=success 成功将 '${chosen_mode}' 提取到聊天世界书 '${chat_lorebook}' 中!`);\n  }\n\n  async function get_step_range(entries: LorebookEntry[]): Promise<{ min: number; max: number }> {\n    return {\n      min: 1,\n      max: _.max(\n        [\n          ...entries\n            .reduce((result, entry) => {\n              return result + entry.comment;\n            }, '')\n            .matchAll(/\\d+/g),\n        ].map(match => Number(match.toString())),\n      ) as number,\n    };\n  }\n\n  export async function set_step_by_offset(offset: number): Promise<void> {\n    const variables = await get_variables();\n    if (variables.mode == null || variables.step == null) {\n      triggerSlash(`/echo severity=error 你必须先选择模式!`);\n      return;\n    }\n    if (variables.mode === 'ModeT') {\n      triggerSlash(`/echo severity=error ModeT不支持切换步骤, 请手动开关!`);\n      return;\n    }\n\n    const lorebook = await getOrCreateChatLorebook();\n    const entries = await getLorebookEntries(lorebook);\n    const { min, max } = await get_step_range(entries);\n\n    const new_step = variables.step + offset;\n    if (new_step < min || new_step > max) {\n      triggerSlash(`/echo severity=error 设置的步骤 '${new_step}' 超出了范围 '${min}-${max}'!`);\n      return;\n    }\n\n    const get_index = (entry: LorebookEntry) => {\n      return Number((entry.comment.match(/(?<=\\D)\\d+(?=\\D)/) as RegExpMatchArray)[0]);\n    };\n    entries\n      .filter(entry => entry.comment.includes('Step'))\n      .forEach(entry => (entry.enabled = get_index(entry) === new_step ? true : false));\n    entries\n      .filter(entry => entry.comment.includes('Part'))\n      .forEach(entry => (entry.enabled = get_index(entry) <= new_step ? true : false));\n    setLorebookEntries(lorebook, entries);\n\n    set_variables({ step: new_step });\n    triggerSlash(`/echo severity=success 成功将 '${variables.mode}' 设置为步骤 '${new_step}'`);\n  }\n}\n\nasync function choose_mode(): Promise<void> {\n  const chosen_mode = await triggerSlash(`/buttons labels=${JSON.stringify(modes)}`);\n  const take_over = await triggerSlash(`/buttons labels=${JSON.stringify(take_overs)}`);\n  if (chosen_mode && take_over) {\n    detail.choose_mode_impl(chosen_mode, take_over);\n  }\n}\n\nasync function decrease_step(): Promise<void> {\n  await detail.set_step_by_offset(-1);\n}\nasync function increase_step(): Promise<void> {\n  await detail.set_step_by_offset(1);\n}\n\n//----------------------------------------------------------------------------------------------------------------------\n$(() => {\n  eventOnButton('查看状态', get_status);\n  eventOnButton('选择模式', choose_mode);\n  eventOnButton('上一步', decrease_step);\n  eventOnButton('下一步', increase_step);\n});\n"],"names":["modes","take_overs","async","get_variables","_","pick","getVariables","type","set_variables","variables","insertOrAssignVariables","get_status","display","$","append","text","mode","step","triggerSlash","html","detail","choose_mode","chosen_mode","JSON","stringify","take_over","choose_mode_impl","decrease_step","set_step_by_offset","increase_step","char_lorebook","getCurrentCharPrimaryLorebook","chat_lorebook","getOrCreateChatLorebook","getLorebookEntries","length","deleteLorebook","entries","reject","entry","some","comment","includes","createLorebookEntries","map","enabled","match","offset","lorebook","min","max","reduce","result","matchAll","Number","toString","get_step_range","new_step","get_index","filter","forEach","setLorebookEntries","eventOnButton"],"sourceRoot":""}