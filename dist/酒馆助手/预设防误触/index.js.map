{"version":3,"file":"index.js","mappings":"mFAEA,SAASA,EAAKC,GACZC,EAAE,8BAA8BC,KAAK,WAAYF,GACjDC,EAAE,6CAA6CC,KAAK,WAAYF,GAChEC,EAAE,kBAAkBC,KAAK,YAAY,GACrCD,EAAE,yBAAyBC,KAAK,YAAY,EAC9C,CCJAD,EAAEE,UAEA,GAAI,QAAcC,yBAA0B,QAAS,MACnD,OAKF,SAASC,IACP,MAAMC,EAAc,IACdC,EAAWC,YAAYC,wBACS,IAAlCF,EAASG,sBAAiCH,EAASI,qBAAuBL,IAI9EL,EAAE,6BAA6BC,KAAK,WAAW,GAAMU,QAAQ,SAC7DX,EAAE,+BAA+BY,IAAIP,GACrCL,EAAE,uBAAuBY,IAAIP,GAAaM,QAAQ,SACpD,ECnBKT,eAA0BW,GAC/B,MAAMC,QAAeC,MAAMF,GAC3B,IAAKC,EAAOE,GACV,OAAO,EAET,MAAMC,QAAoBH,EAAOI,OACjCC,kBAAkBF,EAEpB,CDDEG,CAAW,4FAcXhB,IACAiB,QAAQC,cAAcC,yBAA0B,KAC9CnB,MAGF,MAAMoB,EAAUxB,EAAE,+EAClBwB,EAAQvB,KAAK,YAAY,GACzBD,EAAEyB,QAAQC,GAAG,WAAY,KACvBF,EAAQvB,KAAK,YAAY,ODtB7BD,EAAE,KACA,MAAM2B,EACJ3B,EAAE,8NAGG0B,GAAG,QAAS,WACX1B,EAAE4B,MAAMC,KAAK,YAAYC,GAAG,aAC9B9B,EAAE4B,MAAMG,IAAI,QAAS,IACrBjC,GAAK,KAELE,EAAE4B,MAAMG,IAAI,QAAS,iBACrBjC,GAAK,IAEPE,EAAE4B,MAAMC,KAAK,YAAYG,YAAY,WACrChC,EAAE4B,MAAMC,KAAK,cAAcG,YAAY,UACzC,GAEFlC,GAAK,GACLE,EAAE,sBAAsBiC,SAASC,QAAQP,GAEzC3B,EAAEyB,QAAQC,GAAG,WAAY,KACvBC,EAAMQ,SACNrC,GAAK","sources":["src://tavern_helper_template/src/酒馆助手/预设防误触/index.ts","src://tavern_helper_template/src/酒馆助手/最大化预设上下文长度/index.ts","src://tavern_helper_template/util/script.ts"],"sourcesContent":["import '@/酒馆助手/最大化预设上下文长度/index';\n\nfunction lock(enable: boolean) {\n  $('#range_block_openai :input').prop('disabled', enable);\n  $('#openai_settings > div:first-child :input').prop('disabled', enable);\n  $('#stream_toggle').prop('disabled', false);\n  $('#openai_show_thoughts').prop('disabled', false);\n}\n\n$(() => {\n  const $lock =\n    $(`<div class=\"margin0 menu_button menu_button_icon interactable\" tabindex=\"0\" role=\"button\" style=\"color: var(--active);\">\n<i class=\"fa-fw fa-solid fa-lock\"></i>\n<i class=\"fa-fw fa-solid fa-unlock hidden!\"></i>\n</div>`).on('click', function () {\n      if ($(this).find('.fa-lock').is(':visible')) {\n        $(this).css('color', '');\n        lock(false);\n      } else {\n        $(this).css('color', 'var(--active)');\n        lock(true);\n      }\n      $(this).find('.fa-lock').toggleClass('hidden!');\n      $(this).find('.fa-unlock').toggleClass('hidden!');\n    });\n\n  lock(true);\n  $('#import_oai_preset').parent().prepend($lock);\n\n  $(window).on('pagehide', () => {\n    $lock.remove();\n    lock(false);\n  });\n});\n","import { loadReadme } from '@util/script';\nimport { compare } from 'compare-versions';\n\n$(async () => {\n  // 酒馆助手 4.7.0+ 已经将本脚本作为了体验优化选项, 则本脚本不生效, 直接返回\n  if (compare(await getTavernHelperVersion(), '4.7.0', '>=')) {\n    return;\n  }\n\n  loadReadme('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/最大化预设上下文长度/README.md');\n\n  function unlock_token_length() {\n    const MAX_CONTEXT = 2000000;\n    const settings = SillyTavern.chatCompletionSettings;\n    if (settings.max_context_unlocked === true && settings.openai_max_context === MAX_CONTEXT) {\n      return;\n    }\n\n    $('#oai_max_context_unlocked').prop('checked', true).trigger('input');\n    $('#openai_max_context_counter').val(MAX_CONTEXT);\n    $('#openai_max_context').val(MAX_CONTEXT).trigger('input');\n  }\n\n  unlock_token_length();\n  eventOn(tavern_events.OAI_PRESET_CHANGED_AFTER, () => {\n    unlock_token_length();\n  });\n\n  const $inputs = $('#oai_max_context_unlocked, #openai_max_context, #openai_max_context_counter');\n  $inputs.prop('disabled', true);\n  $(window).on('pagehide', () => {\n    $inputs.prop('disabled', false);\n  });\n});\n","import iframe_srcdoc from './iframe_srcdoc.html';\n\nexport async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle(\n  append_to: JQuery.Selector | JQuery.htmlString | JQuery.TypeOrArray<Element | DocumentFragment> | JQuery = 'head',\n): { destroy: () => void } {\n  const $div = $(`<div>`)\n    .attr('script_id', getScriptId())\n    .append($(`head > style`, document).clone())\n    .appendTo(append_to);\n\n  return {\n    destroy: () => $div.remove(),\n  };\n}\n\nexport function createScriptIdIframe(): JQuery<HTMLIFrameElement> {\n  return $(`<iframe>`).attr({\n    script_id: getScriptId(),\n    frameborder: 0,\n    srcdoc: iframe_srcdoc,\n  }) as JQuery<HTMLIFrameElement>;\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, new_chat_id => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n\nexport function registerAsUniqueScript(id: string): {\n  unregister: () => void;\n  getPreferredScriptId: () => string | undefined;\n  listenPreferenceState: (callback: (perferred_script_id: string) => void) => EventOnReturn;\n} {\n  const script_id = getScriptId();\n  const path = `th_unique_check.${id}`;\n\n  const getPreferredScriptId = () => {\n    const registered_scripts = _.get(window.parent, path, new Set<string>());\n    return _($('#tavern_helper').find('div[data-script-id]').toArray())\n      .map(element => String($(element).attr('data-script-id')))\n      .filter(element => registered_scripts.has(element))\n      .last();\n  };\n\n  _.update(window.parent, path, (value: Set<string> | undefined) => {\n    if (value === undefined) {\n      return new Set([script_id]);\n    }\n    value.add(script_id);\n    return value;\n  });\n  eventEmit(path, getPreferredScriptId());\n\n  return {\n    unregister: () => {\n      _.update(window.parent, path, (value: Set<string> | undefined) => {\n        if (value !== undefined) {\n          value.delete(script_id);\n        }\n        return value;\n      });\n      eventEmit(path, getPreferredScriptId());\n    },\n    getPreferredScriptId,\n    listenPreferenceState: (callback: (enabled_script_id: string) => void) => eventOn(path, callback),\n  };\n}\n"],"names":["lock","enable","$","prop","async","getTavernHelperVersion","unlock_token_length","MAX_CONTEXT","settings","SillyTavern","chatCompletionSettings","max_context_unlocked","openai_max_context","trigger","val","url","readme","fetch","ok","readme_text","text","replaceScriptInfo","loadReadme","eventOn","tavern_events","OAI_PRESET_CHANGED_AFTER","$inputs","window","on","$lock","this","find","is","css","toggleClass","parent","prepend","remove"],"sourceRoot":""}