import{compare as t}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/json5/+esm';import'https://testingcf.jsdelivr.net/npm/jsonrepair/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';import{marked as e}from'https://testingcf.jsdelivr.net/npm/marked/+esm';const n=z,r=n.z.object({角色卡名称:n.z.string().default('未填写'),角色卡链接:n.z.string().default('未填写'),更新日志链接:n.z.string().default('未填写')}).prefault({});function a(t){return{name:`更新角色卡: ${t.name}${t.version}`,function:async()=>{const e=getCharWorldbookNames('current').primary;if(e){const t=await SillyTavern.callGenericPopup('更新角色卡将会覆盖掉现在的世界书, 你需要备份吗?',SillyTavern.POPUP_TYPE.CONFIRM,'',{leftAlign:!0,customButtons:['备份并更新'],okButton:'仅更新',cancelButton:'取消',wide:!0});if(!t)return;if(2===t){const t=`${e} (备份)`;await createOrReplaceWorldbook(t,await getWorldbook(e))&&toastr.success(`已将世界书备份为 '${t}'`)}}await importRawCharacter(t.name,t.content)?(replaceCharacter(t.name,{version:t.version}),toastr.success(`更新角色卡 '${t.name}' 成功`)):toastr.error('更新角色卡失败, 请刷新重试')}}}function o(t){return{name:'更新日志',function:()=>{e.parse(t.changelog,{async:!0,breaks:!0}).then(t=>{SillyTavern.callGenericPopup(t,SillyTavern.POPUP_TYPE.TEXT,'',{leftAlign:!0,wider:!0,allowVerticalScrolling:!0})})}}}async function s(t,e){const n=await fetch(t,{cache:'no-cache'});if(n.ok)return'text'===e?n.text():n.blob();throw new Error(`(${n.status}) ${await n.text()}`)}$(errorCatched(async()=>{!async function(e,n){t(await getTavernHelperVersion(),e,'<')&&toastr.error(`'${n}' 需要酒馆助手版本 >= '${e}'`,'版本不兼容')}('4.6.5','自动更新角色卡'),async function(t){const e=await fetch(t);if(!e.ok)return!1;const n=await e.text();replaceScriptInfo(n)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/自动更新角色卡/README.md');const e=r.parse(getVariables({type:'script'}));if(replaceVariables(e,{type:'script'}),Object.values(e).some(t=>!t||'未填写'===t))return;const n=await s(e.更新日志链接,'text'),c={name:e.角色卡名称,version:n.match(/^##\s*(.*)\s*$/m)?.[1]??'',content:await s(e.角色卡链接,'blob'),changelog:n};var i;i=await async function(e){const n=await getCharacter(e.name).then(t=>t.version.trim()||'0.0.0').catch(()=>'0.0.0');let r=!1;try{r=n!==e.version||t(n,e.version,'<')}catch(t){}return r?[a(e),o(e)]:[]}(c),i.forEach(t=>{eventClearEvent(getButtonEvent(t.name)),eventOn(getButtonEvent(t.name),t.function)}),replaceScriptButtons(i.map(t=>({name:t.name,visible:!0})))}));
//# sourceMappingURL=index.js.map