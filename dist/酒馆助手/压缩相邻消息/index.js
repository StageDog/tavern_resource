import{compare as e}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import{createApp as t,createCommentVNode as s,createElementBlock as n,createElementVNode as o,defineComponent as a,openBlock as i,reactive as l,vModelSelect as r,vModelText as u,watch as c,withDirectives as p}from'https://testingcf.jsdelivr.net/npm/vue/+esm';function f(e,t){return e.length=0,e.push(...t),e}const d=z.object({seperator:z.object({type:z.enum(['space','newline','double newline','custom']).default('double newline'),value:z.string().default('\n\n')}).default({type:'double newline',value:'\n\n'}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),on_chat_history:z.object({type:z.enum(['mixin','seperate','squash']).default('squash'),squash_role:z.enum(['user','assistant','system']).default('assistant'),user_prefix:z.string().default('{{user}}: '),user_suffix:z.string().default(''),assistant_prefix:z.string().default('剧情: '),assistant_suffix:z.string().default(''),system_prefix:z.string().default(''),system_suffix:z.string().default('')}).default({type:'squash',squash_role:'assistant',user_prefix:'{{user}}: ',user_suffix:'',assistant_prefix:'剧情: ',assistant_suffix:'',system_prefix:'',system_suffix:''})});let h;function x(){return h||(h=d.parse(getVariables({type:'script',script_id:getScriptId()})),insertVariables(h,{type:'script',script_id:getScriptId()})),h}function m(e){h=e,insertOrAssignVariables(h,{type:'script',script_id:getScriptId()})}const y={class:'inline-drawer'},v={class:'inline-drawer-content'},w={class:'flex-container flexFlowColumn'},b={key:0,class:'flex-container flexFlowColumn'},g={class:'flex-container flexFlowColumn'},q={key:1,class:'flex-container flexFlowColumn'},V={key:2},F={class:'flex-container flexFlowColumn',title:'用户消息前缀'},A={class:'flex-container flexFlowColumn',title:'用户消息后缀'},C={class:'flex-container flexFlowColumn',title:'助手消息前缀'},E={class:'flex-container flexFlowColumn',title:'助手消息后缀'},M={class:'flex-container flexFlowColumn',title:'系统消息前缀'},j={class:'flex-container flexFlowColumn',title:'系统消息后缀'},U=a({__name:'panel',setup(e){const t=l(x());return c(()=>_.cloneDeep(t),e=>{m(e)},{deep:!0}),(e,a)=>(i(),n('div',y,[a[24]||(a[24]=o('div',{class:'inline-drawer-toggle inline-drawer-header'},[o('b',null,'压缩相邻消息'),o('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),o('div',v,[s(' 分隔符设置 '),o('div',w,[a[11]||(a[11]=o('label',{for:'squash_separator_type'},'消息分隔符',-1)),p(o('select',{'onUpdate:modelValue':a[0]||(a[0]=e=>t.seperator.type=e),id:'squash_separator_type',class:'text_pole'},[...a[10]||(a[10]=[o('option',{value:'space'},'空格',-1),o('option',{value:'newline'},'换行',-1),o('option',{value:'double newline'},'双换行',-1),o('option',{value:'custom'},'自定义',-1)])],512),[[r,t.seperator.type]])]),'custom'===t.seperator.type?(i(),n('div',b,[a[12]||(a[12]=o('label',{for:'squash_separator_value'},'自定义分隔符',-1)),p(o('input',{'onUpdate:modelValue':a[1]||(a[1]=e=>t.seperator.value=e),id:'squash_separator_value',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[u,t.seperator.value]])])):s('v-if',!0),a[23]||(a[23]=o('hr',null,null,-1)),s(' 压缩聊天历史设置 '),o('div',g,[a[14]||(a[14]=o('label',{for:'squash_chat_history_type'},'聊天历史处理方式',-1)),p(o('select',{'onUpdate:modelValue':a[2]||(a[2]=e=>t.on_chat_history.type=e),id:'squash_chat_history_type',class:'text_pole'},[...a[13]||(a[13]=[o('option',{value:'mixin'},'与其他提示词混合',-1),o('option',{value:'seperate'},'与其他提示词隔离',-1),o('option',{value:'squash'},'单独压缩为一条消息',-1)])],512),[[r,t.on_chat_history.type]])]),'squash'===t.on_chat_history.type?(i(),n('div',q,[a[16]||(a[16]=o('label',{for:'squash_role'},'压缩角色',-1)),p(o('select',{'onUpdate:modelValue':a[3]||(a[3]=e=>t.on_chat_history.squash_role=e),id:'squash_role',class:'text_pole'},[...a[15]||(a[15]=[o('option',{value:'system'},'系统',-1),o('option',{value:'user'},'用户',-1),o('option',{value:'assistant'},'助手',-1)])],512),[[r,t.on_chat_history.squash_role]])])):s('v-if',!0),'squash'===t.on_chat_history.type?(i(),n('div',V,[s(' 用户前缀后缀 '),o('div',F,[a[17]||(a[17]=o('label',{for:'user_prefix'},'用户前缀',-1)),p(o('input',{'onUpdate:modelValue':a[4]||(a[4]=e=>t.on_chat_history.user_prefix=e),id:'user_prefix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[u,t.on_chat_history.user_prefix]])]),o('div',A,[a[18]||(a[18]=o('label',{for:'user_suffix'},'用户后缀',-1)),p(o('input',{'onUpdate:modelValue':a[5]||(a[5]=e=>t.on_chat_history.user_suffix=e),id:'user_suffix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[u,t.on_chat_history.user_suffix]])]),s(' 助手前缀后缀 '),o('div',C,[a[19]||(a[19]=o('label',{for:'assistant_prefix'},'助手前缀',-1)),p(o('input',{'onUpdate:modelValue':a[6]||(a[6]=e=>t.on_chat_history.assistant_prefix=e),id:'assistant_prefix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[u,t.on_chat_history.assistant_prefix]])]),o('div',E,[a[20]||(a[20]=o('label',{for:'assistant_suffix'},'助手后缀',-1)),p(o('input',{'onUpdate:modelValue':a[7]||(a[7]=e=>t.on_chat_history.assistant_suffix=e),id:'assistant_suffix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[u,t.on_chat_history.assistant_suffix]])]),s(' 系统前缀后缀 '),o('div',M,[a[21]||(a[21]=o('label',{for:'system_prefix'},'系统前缀',-1)),p(o('input',{'onUpdate:modelValue':a[8]||(a[8]=e=>t.on_chat_history.system_prefix=e),id:'system_prefix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[u,t.on_chat_history.system_prefix]])]),o('div',j,[a[22]||(a[22]=o('label',{for:'system_suffix'},'系统后缀',-1)),p(o('input',{'onUpdate:modelValue':a[9]||(a[9]=e=>t.on_chat_history.system_suffix=e),id:'system_suffix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[u,t.on_chat_history.system_suffix]])])])):s('v-if',!0)])]))}}),k=U;const I='{【{【聊天记录开头】}】}',R='{【{【聊天记录结尾】}】}',T=[{id:'\0压缩相邻消息',position:'in_chat',depth:9999,role:'assistant',content:I},{id:'ÿ压缩相邻消息',position:'in_chat',depth:0,role:'system',content:R}];function N(e){return function(e,t){if(0===e.length)return[];const s=[[e[0]]];for(const[n,o]of _.zip(_.drop(e),_.dropRight(e)))t(n,o)?s[s.length-1].push(n):s.push([n]);return s}(e,(e,t)=>e.role===t.role).map(e=>({role:e[0].role,content:e.map(({content:e})=>e.trim()).join(x().seperator.value)}))}$(()=>{!async function(t,s){e(await getTavernHelperVersion(),t,'<')&&toastr.error(`'${s}' 需要酒馆助手版本 >= '${t}'`,'版本不兼容')}('3.4.15','压缩相邻消息'),async function(e){const t=await fetch(e);if(!t.ok)return!1;const s=await t.text();replaceScriptInfo(s)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/压缩相邻消息/README.md'),$('#extensions_settings2').append('<div id="squash_nearby_same_role_messages_settings"></div>'),t(k).mount($('#squash_nearby_same_role_messages_settings')[0]),eventOn(tavern_events.GENERATION_AFTER_COMMANDS,(e,t,s)=>{s||injectPrompts(T)});let s=!1;eventOn(tavern_events.GENERATION_AFTER_COMMANDS,(e,t,n)=>{s=n}),eventMakeLast(tavern_events.GENERATE_AFTER_DATA,({prompt:e})=>{if(s)return;const t=function(e){const t=e.findIndex(({content:e})=>e.includes(I)),s=e.findIndex(({content:e})=>e.includes(R));if(-1===t||-1===s)return null;const[n,o]=e[t].content.split(I),[a,i]=e[s].content.split(R);return[[...e.slice(0,t),{role:e[t].role,content:n}],[{role:e[t].role,content:o},...e.slice(t+1,s),{role:e[s].role,content:a}],[{role:e[s].role,content:i},...e.slice(s+1)]]}(e);if(null===t)return;const[n,o,a]=_(t).map(e=>function(e){return e.filter(({content:e})=>''!==e.trim())}(e)).map(e=>N(e)).value();switch(x().on_chat_history.type){case'mixin':f(e,N(_.concat(n,o,a)));break;case'seperate':f(e,_.concat(n,o,a));break;case'squash':f(e,_.concat(n,(i=o,{role:x().on_chat_history.squash_role,content:i.map(({role:e,content:t})=>{switch(e){case'system':return substitudeMacros(x().on_chat_history.system_prefix)+t.trim()+substitudeMacros(x().on_chat_history.system_suffix);case'assistant':return substitudeMacros(x().on_chat_history.assistant_prefix)+t.trim()+substitudeMacros(x().on_chat_history.assistant_suffix);case'user':return substitudeMacros(x().on_chat_history.user_prefix)+t.trim()+substitudeMacros(x().on_chat_history.user_suffix)}}).join(x().seperator.value)}),a))}var i})}),$(window).on('pagehide',()=>{$('#extensions_settings2').find('#squash_nearby_same_role_messages_settings').remove(),uninjectPrompts(T.map(({id:e})=>e))});