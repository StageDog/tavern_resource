import{compare as e}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import{createPinia as t,defineStore as s}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';function n(e,t){return e.length=0,e.push(...t),e}const o=Vue,r=z.object({seperator:z.object({type:z.enum(['space','newline','double newline','custom']).default('double newline'),value:z.string().default('\n\n')}).default({type:'double newline',value:'\n\n'}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),on_chat_history:z.object({type:z.enum(['mixin','seperate','squash']).default('squash'),squash_role:z.enum(['user','assistant','system']).default('assistant'),user_prefix:z.string().default('{{user}}: '),user_suffix:z.string().default(''),assistant_prefix:z.string().default('剧情: '),assistant_suffix:z.string().default(''),system_prefix:z.string().default(''),system_suffix:z.string().default('')}).default({type:'squash',squash_role:'assistant',user_prefix:'{{user}}: ',user_suffix:'',assistant_prefix:'剧情: ',assistant_suffix:'',system_prefix:'',system_suffix:''})}),a=s('settings',()=>{const e=(0,o.reactive)(r.parse(getVariables({type:'script',script_id:getScriptId()})));return insertVariables(e,{type:'script',script_id:getScriptId()}),(0,o.watch)(()=>e,e=>{insertOrAssignVariables(e,{type:'script',script_id:getScriptId()})},{deep:!0}),{settings:e}}),l={class:'inline-drawer'},i={class:'inline-drawer-content'},c={class:'flex-container flexFlowColumn'},u={key:0,class:'flex-container flexFlowColumn'},f={class:'flex-container flexFlowColumn'},p={key:1,class:'flex-container flexFlowColumn'},d={key:2},m={class:'flex-container flexFlowColumn',title:'用户消息前缀'},h={class:'flex-container flexFlowColumn',title:'用户消息后缀'},x={class:'flex-container flexFlowColumn',title:'助手消息前缀'},v={class:'flex-container flexFlowColumn',title:'助手消息后缀'},y={class:'flex-container flexFlowColumn',title:'系统消息前缀'},V={class:'flex-container flexFlowColumn',title:'系统消息后缀'},E=(0,o.defineComponent)({__name:'panel',setup(e){const t=a().settings;return(e,s)=>((0,o.openBlock)(),(0,o.createElementBlock)('div',l,[s[24]||(s[24]=(0,o.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,o.createElementVNode)('b',null,'压缩相邻消息'),(0,o.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,o.createElementVNode)('div',i,[(0,o.createCommentVNode)(' 分隔符设置 '),(0,o.createElementVNode)('div',c,[s[11]||(s[11]=(0,o.createElementVNode)('label',{for:'squash_separator_type'},'消息分隔符',-1)),(0,o.withDirectives)((0,o.createElementVNode)('select',{'onUpdate:modelValue':s[0]||(s[0]=e=>(0,o.unref)(t).seperator.type=e),id:'squash_separator_type',class:'text_pole'},[...s[10]||(s[10]=[(0,o.createElementVNode)('option',{value:'space'},'空格',-1),(0,o.createElementVNode)('option',{value:'newline'},'换行',-1),(0,o.createElementVNode)('option',{value:'double newline'},'双换行',-1),(0,o.createElementVNode)('option',{value:'custom'},'自定义',-1)])],512),[[o.vModelSelect,(0,o.unref)(t).seperator.type]])]),'custom'===(0,o.unref)(t).seperator.type?((0,o.openBlock)(),(0,o.createElementBlock)('div',u,[s[12]||(s[12]=(0,o.createElementVNode)('label',{for:'squash_separator_value'},'自定义分隔符',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':s[1]||(s[1]=e=>(0,o.unref)(t).seperator.value=e),id:'squash_separator_value',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[o.vModelText,(0,o.unref)(t).seperator.value]])])):(0,o.createCommentVNode)('v-if',!0),s[23]||(s[23]=(0,o.createElementVNode)('hr',null,null,-1)),(0,o.createCommentVNode)(' 压缩聊天历史设置 '),(0,o.createElementVNode)('div',f,[s[14]||(s[14]=(0,o.createElementVNode)('label',{for:'squash_chat_history_type'},'聊天历史处理方式',-1)),(0,o.withDirectives)((0,o.createElementVNode)('select',{'onUpdate:modelValue':s[2]||(s[2]=e=>(0,o.unref)(t).on_chat_history.type=e),id:'squash_chat_history_type',class:'text_pole'},[...s[13]||(s[13]=[(0,o.createElementVNode)('option',{value:'mixin'},'与其他提示词混合',-1),(0,o.createElementVNode)('option',{value:'seperate'},'与其他提示词隔离',-1),(0,o.createElementVNode)('option',{value:'squash'},'单独压缩为一条消息',-1)])],512),[[o.vModelSelect,(0,o.unref)(t).on_chat_history.type]])]),'squash'===(0,o.unref)(t).on_chat_history.type?((0,o.openBlock)(),(0,o.createElementBlock)('div',p,[s[16]||(s[16]=(0,o.createElementVNode)('label',{for:'squash_role'},'压缩角色',-1)),(0,o.withDirectives)((0,o.createElementVNode)('select',{'onUpdate:modelValue':s[3]||(s[3]=e=>(0,o.unref)(t).on_chat_history.squash_role=e),id:'squash_role',class:'text_pole'},[...s[15]||(s[15]=[(0,o.createElementVNode)('option',{value:'system'},'系统',-1),(0,o.createElementVNode)('option',{value:'user'},'用户',-1),(0,o.createElementVNode)('option',{value:'assistant'},'助手',-1)])],512),[[o.vModelSelect,(0,o.unref)(t).on_chat_history.squash_role]])])):(0,o.createCommentVNode)('v-if',!0),'squash'===(0,o.unref)(t).on_chat_history.type?((0,o.openBlock)(),(0,o.createElementBlock)('div',d,[(0,o.createCommentVNode)(' 用户前缀后缀 '),(0,o.createElementVNode)('div',m,[s[17]||(s[17]=(0,o.createElementVNode)('label',{for:'user_prefix'},'用户前缀',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':s[4]||(s[4]=e=>(0,o.unref)(t).on_chat_history.user_prefix=e),id:'user_prefix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[o.vModelText,(0,o.unref)(t).on_chat_history.user_prefix]])]),(0,o.createElementVNode)('div',h,[s[18]||(s[18]=(0,o.createElementVNode)('label',{for:'user_suffix'},'用户后缀',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':s[5]||(s[5]=e=>(0,o.unref)(t).on_chat_history.user_suffix=e),id:'user_suffix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[o.vModelText,(0,o.unref)(t).on_chat_history.user_suffix]])]),(0,o.createCommentVNode)(' 助手前缀后缀 '),(0,o.createElementVNode)('div',x,[s[19]||(s[19]=(0,o.createElementVNode)('label',{for:'assistant_prefix'},'助手前缀',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':s[6]||(s[6]=e=>(0,o.unref)(t).on_chat_history.assistant_prefix=e),id:'assistant_prefix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[o.vModelText,(0,o.unref)(t).on_chat_history.assistant_prefix]])]),(0,o.createElementVNode)('div',v,[s[20]||(s[20]=(0,o.createElementVNode)('label',{for:'assistant_suffix'},'助手后缀',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':s[7]||(s[7]=e=>(0,o.unref)(t).on_chat_history.assistant_suffix=e),id:'assistant_suffix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[o.vModelText,(0,o.unref)(t).on_chat_history.assistant_suffix]])]),(0,o.createCommentVNode)(' 系统前缀后缀 '),(0,o.createElementVNode)('div',y,[s[21]||(s[21]=(0,o.createElementVNode)('label',{for:'system_prefix'},'系统前缀',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':s[8]||(s[8]=e=>(0,o.unref)(t).on_chat_history.system_prefix=e),id:'system_prefix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[o.vModelText,(0,o.unref)(t).on_chat_history.system_prefix]])]),(0,o.createElementVNode)('div',V,[s[22]||(s[22]=(0,o.createElementVNode)('label',{for:'system_suffix'},'系统后缀',-1)),(0,o.withDirectives)((0,o.createElementVNode)('input',{'onUpdate:modelValue':s[9]||(s[9]=e=>(0,o.unref)(t).on_chat_history.system_suffix=e),id:'system_suffix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[o.vModelText,(0,o.unref)(t).on_chat_history.system_suffix]])])])):(0,o.createCommentVNode)('v-if',!0)])]))}}),N=(0,o.createApp)(E),w=$('<div>').attr('id','input_helper');const b='{【{【聊天记录开头】}】}',g='{【{【聊天记录结尾】}】}',M=[{id:'\0压缩相邻消息',position:'in_chat',depth:9999,role:'assistant',content:b},{id:'ÿ压缩相邻消息',position:'in_chat',depth:0,role:'system',content:g}];function C(e,t){return function(e,t){if(0===e.length)return[];const s=[[e[0]]];for(const[n,o]of _.zip(_.drop(e),_.dropRight(e)))t(n,o)?s[s.length-1].push(n):s.push([n]);return s}(e,(e,t)=>e.role===t.role).map(e=>({role:e[0].role,content:e.map(({content:e})=>e.trim()).join(t.seperator.value)}))}function q(e){let t=!1;eventOn(tavern_events.GENERATION_AFTER_COMMANDS,(e,s,n)=>{t=n}),eventMakeLast(tavern_events.GENERATE_AFTER_DATA,({prompt:s})=>{if(t)return;const o=function(e){const t=e.findIndex(({content:e})=>e.includes(b)),s=e.findIndex(({content:e})=>e.includes(g));if(-1===t||-1===s)return null;const[n,o]=e[t].content.split(b),[r,a]=e[s].content.split(g);return[[...e.slice(0,t),{role:e[t].role,content:n}],[{role:e[t].role,content:o},...e.slice(t+1,s),{role:e[s].role,content:r}],[{role:e[s].role,content:a},...e.slice(s+1)]]}(s);if(null===o)return;const[r,a,l]=_(o).map(e=>function(e){return e.filter(({content:e})=>''!==e.trim())}(e)).map(t=>C(t,e)).value();switch(e.on_chat_history.type){case'mixin':n(s,C(_.concat(r,a,l),e));break;case'seperate':n(s,_.concat(r,a,l));break;case'squash':n(s,_.concat(r,function(e,t){return{role:t.on_chat_history.squash_role,content:e.map(({role:e,content:s})=>{switch(e){case'system':return substitudeMacros(t.on_chat_history.system_prefix)+s.trim()+substitudeMacros(t.on_chat_history.system_suffix);case'assistant':return substitudeMacros(t.on_chat_history.assistant_prefix)+s.trim()+substitudeMacros(t.on_chat_history.assistant_suffix);case'user':return substitudeMacros(t.on_chat_history.user_prefix)+s.trim()+substitudeMacros(t.on_chat_history.user_suffix)}}).join(t.seperator.value)}}(a,e),l))}})}function k(e){eventOn(tavern_events.GENERATION_AFTER_COMMANDS,(e,t,s)=>{s||injectPrompts(M)}),q(e)}function D(){uninjectPrompts(M.map(({id:e})=>e))}$(()=>{!async function(t,s){e(await getTavernHelperVersion(),t,'<')&&toastr.error(`'${s}' 需要酒馆助手版本 >= '${t}'`,'版本不兼容')}('3.4.17','压缩相邻消息'),async function(e){const t=await fetch(e);if(!t.ok)return!1;const s=await t.text();replaceScriptInfo(s)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/压缩相邻消息/README.md'),$('#extensions_settings2').append(w),N.use(t()).mount(w[0]),k(a().settings)}),$(window).on('pagehide',()=>{N.unmount(),w.remove(),D()});