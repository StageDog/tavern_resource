import{compare as e}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import{createPinia as t,defineStore as n,storeToRefs as o}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';function l(e,t){return e.length=0,e.push(...t),e}const s=Vue,a=z,r=a.z.object({seperator:a.z.object({type:a.z.enum(['space','newline','double newline','custom']).default('double newline'),value:a.z.string().default('\n\n')}).prefault({}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),put_system_injection_after_chat_history:a.z.boolean().default(!1),on_chat_history:a.z.object({type:a.z.enum(['mixin','seperate','squash']).default('squash'),squash_role:a.z.enum(['user','assistant','system']).default('assistant'),user_prefix:a.z.string().default('{{user}}: '),user_suffix:a.z.string().default(''),assistant_prefix:a.z.string().default('剧情: '),assistant_suffix:a.z.string().default(''),system_prefix:a.z.string().default(''),system_suffix:a.z.string().default('')}).prefault({})}),i=n('settings',()=>{const e=(0,s.ref)(r.parse(getVariables({type:'script',script_id:getScriptId()})));return(0,s.watchEffect)(()=>{insertOrAssignVariables(_.cloneDeep(e.value),{type:'script',script_id:getScriptId()})}),{settings:e}}),c={class:'inline-drawer'},u={class:'inline-drawer-content'},d={class:'flex-container flexFlowColumn'},p={key:0,class:'flex-container flexFlowColumn'},f={class:'flex-container flexFlowColumn'},m={style:{display:'flex','align-items':'center',gap:'8px'}},h={class:'flex-container flexFlowColumn'},x={key:1,class:'flex-container flexFlowColumn'},v={key:2},y={class:'flex-container flexFlowColumn',title:'用户消息前缀'},E={class:'flex-container flexFlowColumn',title:'用户消息后缀'},V={class:'flex-container flexFlowColumn',title:'助手消息前缀'},N={class:'flex-container flexFlowColumn',title:'助手消息后缀'},w={class:'flex-container flexFlowColumn',title:'系统消息前缀'},g={class:'flex-container flexFlowColumn',title:'系统消息后缀'},b=(0,s.defineComponent)({__name:'Panel',setup(e){const{settings:t}=o(i());function n(){SillyTavern.callGenericPopup('<p>按照<a href="https://discord.com/channels/1134557553011998840/1413538722078785576">一些预设作者和角色卡作者的说法</a>, Gemini 和 Claude 不同, 不必将条目插入聊天记录中, 插入其中反而会干扰聊天记录的连续性, 重要条目应该都插入到 D0.</p>\n     <p>但玩家依旧可能使用 Claude、GPT 等游玩, 而对它们还是需要用 D4 等深度的. 因此这个选项将注入到聊天深度的系统消息按照原有顺序移动到 D0, 而不是保持在原来的深度位置, 而关闭这个选项系统消息将会保持原有深度.</p>\n     <p>这个选项虽然已经不用角色卡作者自行将条目全设置为 D0, 但仍很需要角色卡适配; 如果角色详情等会随剧情发展的设定放在了深度条目, 则勾选这个选项容易使角色固化</p>',SillyTavern.POPUP_TYPE.TEXT,'',{leftAlign:!0})}return(e,o)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',c,[o[27]||(o[27]=(0,s.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,s.createElementVNode)('b',null,'压缩相邻消息'),(0,s.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,s.createElementVNode)('div',u,[(0,s.createElementVNode)('div',d,[o[12]||(o[12]=(0,s.createElementVNode)('label',null,'消息分隔符',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[0]||(o[0]=e=>(0,s.unref)(t).seperator.type=e),class:'text_pole'},[...o[11]||(o[11]=[(0,s.createElementVNode)('option',{value:'space'},'空格',-1),(0,s.createElementVNode)('option',{value:'newline'},'换行',-1),(0,s.createElementVNode)('option',{value:'double newline'},'双换行',-1),(0,s.createElementVNode)('option',{value:'custom'},'自定义',-1)])],512),[[s.vModelSelect,(0,s.unref)(t).seperator.type]])]),'custom'===(0,s.unref)(t).seperator.type?((0,s.openBlock)(),(0,s.createElementBlock)('div',p,[o[13]||(o[13]=(0,s.createElementVNode)('label',null,'自定义分隔符',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{'onUpdate:modelValue':o[1]||(o[1]=e=>(0,s.unref)(t).seperator.value=e),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[s.vModelText,(0,s.unref)(t).seperator.value]])])):(0,s.createCommentVNode)('v-if',!0),o[25]||(o[25]=(0,s.createElementVNode)('hr',null,null,-1)),(0,s.createElementVNode)('div',f,[(0,s.createElementVNode)('div',m,[o[14]||(o[14]=(0,s.createElementVNode)('span',null,'将 D⚙ (系统深度条目) 按序移到聊天记录后',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{'onUpdate:modelValue':o[2]||(o[2]=e=>(0,s.unref)(t).put_system_injection_after_chat_history=e),type:'checkbox',style:{margin:'0 4px 0 0'}},null,512),[[s.vModelCheckbox,(0,s.unref)(t).put_system_injection_after_chat_history]]),(0,s.createElementVNode)('i',{class:'fa-solid fa-circle-question fa-sm note-link-span',style:{cursor:'pointer'},title:'将注入到聊天深度的系统消息按照原有顺序移动到聊天记录的末尾，而不是保持在原来的深度位置。这可以确保系统消息不会干扰聊天记录的连续性。',onClick:n})])]),o[26]||(o[26]=(0,s.createElementVNode)('hr',null,null,-1)),(0,s.createElementVNode)('div',h,[o[16]||(o[16]=(0,s.createElementVNode)('label',null,'聊天历史处理方式',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[3]||(o[3]=e=>(0,s.unref)(t).on_chat_history.type=e),class:'text_pole'},[...o[15]||(o[15]=[(0,s.createElementVNode)('option',{value:'mixin'},'与其他提示词混合',-1),(0,s.createElementVNode)('option',{value:'seperate'},'与其他提示词隔离',-1),(0,s.createElementVNode)('option',{value:'squash'},'单独压缩为一条消息',-1)])],512),[[s.vModelSelect,(0,s.unref)(t).on_chat_history.type]])]),'squash'===(0,s.unref)(t).on_chat_history.type?((0,s.openBlock)(),(0,s.createElementBlock)('div',x,[o[18]||(o[18]=(0,s.createElementVNode)('label',null,'压缩角色',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':o[4]||(o[4]=e=>(0,s.unref)(t).on_chat_history.squash_role=e),class:'text_pole'},[...o[17]||(o[17]=[(0,s.createElementVNode)('option',{value:'system'},'系统',-1),(0,s.createElementVNode)('option',{value:'user'},'用户',-1),(0,s.createElementVNode)('option',{value:'assistant'},'助手',-1)])],512),[[s.vModelSelect,(0,s.unref)(t).on_chat_history.squash_role]])])):(0,s.createCommentVNode)('v-if',!0),'squash'===(0,s.unref)(t).on_chat_history.type?((0,s.openBlock)(),(0,s.createElementBlock)('div',v,[(0,s.createElementVNode)('div',y,[o[19]||(o[19]=(0,s.createElementVNode)('label',null,'用户前缀',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{'onUpdate:modelValue':o[5]||(o[5]=e=>(0,s.unref)(t).on_chat_history.user_prefix=e),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[s.vModelText,(0,s.unref)(t).on_chat_history.user_prefix]])]),(0,s.createElementVNode)('div',E,[o[20]||(o[20]=(0,s.createElementVNode)('label',null,'用户后缀',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{'onUpdate:modelValue':o[6]||(o[6]=e=>(0,s.unref)(t).on_chat_history.user_suffix=e),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[s.vModelText,(0,s.unref)(t).on_chat_history.user_suffix]])]),(0,s.createElementVNode)('div',V,[o[21]||(o[21]=(0,s.createElementVNode)('label',null,'助手前缀',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{'onUpdate:modelValue':o[7]||(o[7]=e=>(0,s.unref)(t).on_chat_history.assistant_prefix=e),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[s.vModelText,(0,s.unref)(t).on_chat_history.assistant_prefix]])]),(0,s.createElementVNode)('div',N,[o[22]||(o[22]=(0,s.createElementVNode)('label',null,'助手后缀',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{'onUpdate:modelValue':o[8]||(o[8]=e=>(0,s.unref)(t).on_chat_history.assistant_suffix=e),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[s.vModelText,(0,s.unref)(t).on_chat_history.assistant_suffix]])]),(0,s.createElementVNode)('div',w,[o[23]||(o[23]=(0,s.createElementVNode)('label',null,'系统前缀',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{'onUpdate:modelValue':o[9]||(o[9]=e=>(0,s.unref)(t).on_chat_history.system_prefix=e),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[s.vModelText,(0,s.unref)(t).on_chat_history.system_prefix]])]),(0,s.createElementVNode)('div',g,[o[24]||(o[24]=(0,s.createElementVNode)('label',null,'系统后缀',-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{'onUpdate:modelValue':o[10]||(o[10]=e=>(0,s.unref)(t).on_chat_history.system_suffix=e),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[s.vModelText,(0,s.unref)(t).on_chat_history.system_suffix]])])])):(0,s.createCommentVNode)('v-if',!0)])]))}}),M=(0,s.createApp)(b);function D(){!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const e=$('<div>').attr('script_id',getScriptId());$('#extensions_settings2').append(e),M.use(t()).mount(e[0])}function T(){M.unmount(),$(`div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}const k='{【{【聊天记录开头】}】}',C='{【{【聊天记录结尾】}】}',S=[{id:'\0压缩相邻消息',position:'in_chat',depth:9999,role:'assistant',content:k},{id:'ÿ压缩相邻消息',position:'in_chat',depth:0,role:'system',content:C}];function j(e,t){return function(e,t){if(0===e.length)return[];const n=[[e[0]]];for(const[o,l]of _.zip(_.drop(e),_.dropRight(e)))t(o,l)?n[n.length-1].push(o):n.push([o]);return n}(e,(e,t)=>e.role===t.role).map(e=>({role:e[0].role,content:e.map(({content:e})=>e.trim()).join(t.seperator.value)}))}function A(e){let t=!1;eventOn(tavern_events.GENERATION_AFTER_COMMANDS,(e,n,o)=>{t=o}),eventMakeLast(tavern_events.GENERATE_AFTER_DATA,({prompt:n})=>{if(t)return;const o=function(e){const t=e.findIndex(({content:e})=>e.includes(k)),n=e.findIndex(({content:e})=>e.includes(C));if(-1===t||-1===n)return null;const[o,l]=e[t].content.split(k),[s,a]=e[n].content.split(C);return[[...e.slice(0,t),{role:e[t].role,content:o}],[{role:e[t].role,content:l},...e.slice(t+1,n),{role:e[n].role,content:s}],[{role:e[n].role,content:a},...e.slice(n+1)]]}(n);if(null===o)return;e.put_system_injection_after_chat_history&&(o[2]=_.concat(_.remove(o[1],({role:e})=>'system'===e),o[2]));const[s,a,r]=_(o).map(e=>function(e){return e.filter(({content:e})=>''!==e.trim())}(e)).map(t=>j(t,e)).value();switch(e.on_chat_history.type){case'mixin':l(n,j(_.concat(s,a,r),e));break;case'seperate':l(n,_.concat(s,a,r));break;case'squash':l(n,_.concat(s,function(e,t){const n=substitudeMacros(t.on_chat_history.system_prefix),o=substitudeMacros(t.on_chat_history.system_suffix),l=substitudeMacros(t.on_chat_history.assistant_prefix),s=substitudeMacros(t.on_chat_history.assistant_suffix),a=substitudeMacros(t.on_chat_history.user_prefix),r=substitudeMacros(t.on_chat_history.user_suffix);return{role:t.on_chat_history.squash_role,content:e.map(({role:e,content:t})=>{switch(e){case'system':return n+t.trim()+o;case'assistant':return l+t.trim()+s;case'user':return a+t.trim()+r}}).join(t.seperator.value)}}(a,e),r))}})}function F(e){eventOn(tavern_events.GENERATION_AFTER_COMMANDS,(e,t,n)=>{n||injectPrompts(S)}),A(e)}function I(){uninjectPrompts(S.map(({id:e})=>e))}$(()=>{!async function(t,n){e(await getTavernHelperVersion(),t,'<')&&toastr.error(`'${n}' 需要酒馆助手版本 >= '${t}'`,'版本不兼容')}('3.4.17','压缩相邻消息'),async function(e){const t=await fetch(e);if(!t.ok)return!1;const n=await t.text();replaceScriptInfo(n)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/压缩相邻消息/README.md'),D(),F(i().settings)}),$(window).on('pagehide',()=>{T(),I()});