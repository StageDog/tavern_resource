import{compare as e}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import{createApp as t,createCommentVNode as s,createElementBlock as a,createElementVNode as n,defineComponent as i,openBlock as l,reactive as o,vModelCheckbox as r,vModelSelect as u,vModelText as c,watch as f,withDirectives as p}from'https://testingcf.jsdelivr.net/npm/vue/+esm';const h=z.object({seperator:z.object({type:z.enum(['space','newline','double newline','custom']).default('double newline'),value:z.string().default('\n\n')}).default({type:'double newline',value:'\n\n'}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),squash_chat_history:z.object({enable:z.boolean().default(!0),squash_role:z.enum(['user','assistant','system']).default('assistant'),user_prefix:z.string().default('{{user}}: '),user_suffix:z.string().default(''),assistant_prefix:z.string().default('剧情: '),assistant_suffix:z.string().default(''),system_prefix:z.string().default(''),system_suffix:z.string().default('')}).default({enable:!0,squash_role:'assistant',user_prefix:'{{user}}: ',user_suffix:'',assistant_prefix:'剧情: ',assistant_suffix:'',system_prefix:'',system_suffix:''})});let d;function x(){return d||(d=h.parse(getVariables({type:'script',script_id:getScriptId()})),insertVariables(d,{type:'script',script_id:getScriptId()})),d}function m(e){d=e,insertOrAssignVariables(d,{type:'script',script_id:getScriptId()})}const y={class:'inline-drawer'},v={class:'inline-drawer-content'},b={class:'flex-container flexFlowColumn'},q={key:0,class:'flex-container flexFlowColumn'},w={class:'flex-container',title:'启用压缩聊天历史'},g={key:1,class:'flex-container flexFlowColumn'},E={key:2},V={class:'flex-container flexFlowColumn',title:'用户消息前缀'},A={class:'flex-container flexFlowColumn',title:'用户消息后缀'},F={class:'flex-container flexFlowColumn',title:'助手消息前缀'},M={class:'flex-container flexFlowColumn',title:'助手消息后缀'},C={class:'flex-container flexFlowColumn',title:'系统消息前缀'},j={class:'flex-container flexFlowColumn',title:'系统消息后缀'},R=i({__name:'panel',setup(e){const t=o(x());return f(()=>_.cloneDeep(t),e=>{m(e)},{deep:!0}),(e,i)=>(l(),a('div',y,[i[23]||(i[23]=n('div',{class:'inline-drawer-toggle inline-drawer-header'},[n('b',null,'压缩相邻消息'),n('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),n('div',v,[s(' 分隔符设置 '),n('div',b,[i[11]||(i[11]=n('label',{for:'squash_separator_type'},'消息分隔符',-1)),p(n('select',{'onUpdate:modelValue':i[0]||(i[0]=e=>t.seperator.type=e),id:'squash_separator_type',class:'text_pole'},[...i[10]||(i[10]=[n('option',{value:'space'},'空格',-1),n('option',{value:'newline'},'换行',-1),n('option',{value:'double newline'},'双换行',-1),n('option',{value:'custom'},'自定义',-1)])],512),[[u,t.seperator.type]])]),'custom'===t.seperator.type?(l(),a('div',q,[i[12]||(i[12]=n('label',{for:'squash_separator_value'},'自定义分隔符',-1)),p(n('input',{'onUpdate:modelValue':i[1]||(i[1]=e=>t.seperator.value=e),id:'squash_separator_value',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,t.seperator.value]])])):s('v-if',!0),i[22]||(i[22]=n('hr',null,null,-1)),s(' 压缩聊天历史设置 '),n('div',w,[p(n('input',{'onUpdate:modelValue':i[2]||(i[2]=e=>t.squash_chat_history.enable=e),type:'checkbox',id:'squash_chat_history_enable'},null,512),[[r,t.squash_chat_history.enable]]),i[13]||(i[13]=n('span',null,'启用压缩聊天历史',-1))]),t.squash_chat_history.enable?(l(),a('div',g,[i[15]||(i[15]=n('label',{for:'squash_role'},'压缩角色',-1)),p(n('select',{'onUpdate:modelValue':i[3]||(i[3]=e=>t.squash_chat_history.squash_role=e),id:'squash_role',class:'text_pole'},[...i[14]||(i[14]=[n('option',{value:'system'},'系统',-1),n('option',{value:'user'},'用户',-1),n('option',{value:'assistant'},'助手',-1)])],512),[[u,t.squash_chat_history.squash_role]])])):s('v-if',!0),t.squash_chat_history.enable?(l(),a('div',E,[s(' 用户前缀后缀 '),n('div',V,[i[16]||(i[16]=n('label',{for:'user_prefix'},'用户前缀',-1)),p(n('input',{'onUpdate:modelValue':i[4]||(i[4]=e=>t.squash_chat_history.user_prefix=e),id:'user_prefix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,t.squash_chat_history.user_prefix]])]),n('div',A,[i[17]||(i[17]=n('label',{for:'user_suffix'},'用户后缀',-1)),p(n('input',{'onUpdate:modelValue':i[5]||(i[5]=e=>t.squash_chat_history.user_suffix=e),id:'user_suffix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,t.squash_chat_history.user_suffix]])]),s(' 助手前缀后缀 '),n('div',F,[i[18]||(i[18]=n('label',{for:'assistant_prefix'},'助手前缀',-1)),p(n('input',{'onUpdate:modelValue':i[6]||(i[6]=e=>t.squash_chat_history.assistant_prefix=e),id:'assistant_prefix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,t.squash_chat_history.assistant_prefix]])]),n('div',M,[i[19]||(i[19]=n('label',{for:'assistant_suffix'},'助手后缀',-1)),p(n('input',{'onUpdate:modelValue':i[7]||(i[7]=e=>t.squash_chat_history.assistant_suffix=e),id:'assistant_suffix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,t.squash_chat_history.assistant_suffix]])]),s(' 系统前缀后缀 '),n('div',C,[i[20]||(i[20]=n('label',{for:'system_prefix'},'系统前缀',-1)),p(n('input',{'onUpdate:modelValue':i[8]||(i[8]=e=>t.squash_chat_history.system_prefix=e),id:'system_prefix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,t.squash_chat_history.system_prefix]])]),n('div',j,[i[21]||(i[21]=n('label',{for:'system_suffix'},'系统后缀',-1)),p(n('input',{'onUpdate:modelValue':i[9]||(i[9]=e=>t.squash_chat_history.system_suffix=e),id:'system_suffix',class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c,t.squash_chat_history.system_suffix]])])])):s('v-if',!0)])]))}}),U=R;const k='{【{【聊天记录开头】}】}',I='{【{【聊天记录结尾】}】}',T=[{id:'\0压缩相邻消息',position:'in_chat',depth:9999,role:'assistant',content:k},{id:'ÿ压缩相邻消息',position:'in_chat',depth:0,role:'assistant',content:I}];function N(e){return e.filter(({content:e})=>''!==e.trim())}function O(e){return function(e,t){if(0===e.length)return[];const s=[[e[0]]];for(const[a,n]of _.zip(_.drop(e),_.dropRight(e)))t(a,n)?s[s.length-1].push(a):s.push([a]);return s}(N(e),(e,t)=>e.role===t.role).map(e=>({role:e[0].role,content:e.map(({content:e})=>e.trim()).join(x().seperator.value)}))}$(()=>{!async function(t,s){e(await getTavernHelperVersion(),t,'<')&&toastr.error(`'${s}' 需要酒馆助手版本 >= '${t}'`,'版本不兼容')}('3.4.15','压缩相邻消息'),async function(e){const t=await fetch(e);if(!t.ok)return!1;const s=await t.text();replaceScriptInfo(s)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/压缩相邻消息/README.md'),$('#extensions_settings2').append('<div id="squash_nearby_same_role_messages_settings"></div>'),t(U).mount($('#squash_nearby_same_role_messages_settings')[0]),eventOn(tavern_events.GENERATION_AFTER_COMMANDS,(e,t,s)=>{s||injectPrompts(T)});let s=!1;eventOn(tavern_events.GENERATION_AFTER_COMMANDS,(e,t,a)=>{s=a}),eventMakeLast(tavern_events.GENERATE_AFTER_DATA,({prompt:e})=>{if(s)return;const t=function(e){const t=e.findIndex(({content:e})=>e.includes(k)),s=e.findIndex(({content:e})=>e.includes(I));return-1===t||-1===s?null:(e[t].content=e[t].content.replace(new RegExp(`${k}\n?`),'').trim(),e[s].content=e[s].content.replace(new RegExp(`\n?${I}`),'').trim(),{head:e.slice(0,t),chat_history:e.slice(t,s+1),tail:e.slice(s+1)})}(e);if(null===t)return;const{head:a,chat_history:n,tail:i}=t,l=O(a),o=x().squash_chat_history.enable?[(r=n,{role:x().squash_chat_history.squash_role,content:_(N(r)).map(({role:e,content:t})=>{switch(e){case'system':return substitudeMacros(x().squash_chat_history.system_prefix)+t.trim()+substitudeMacros(x().squash_chat_history.system_suffix);case'assistant':return substitudeMacros(x().squash_chat_history.assistant_prefix)+t.trim()+substitudeMacros(x().squash_chat_history.assistant_suffix);case'user':return substitudeMacros(x().squash_chat_history.user_prefix)+t.trim()+substitudeMacros(x().squash_chat_history.user_suffix)}}).join(x().seperator.value)})]:[...O(n)];var r;const u=O(i);var c,f;f=[...l,...o,...u],(c=e).length=0,c.push(...f)})}),$(window).on('pagehide',()=>{$('#extensions_settings2').find('#squash_nearby_same_role_messages_settings').remove(),uninjectPrompts(T.map(({id:e})=>e))});