import{compare as e}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';import{createPinia as t,defineStore as n,storeToRefs as l}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as o}from'https://testingcf.jsdelivr.net/npm/klona/+esm';function s(e,t){return e.length=0,e.push(...t),e}function r(e){if(!e)return null;try{const t=e.match(/\/(.+)\/([a-z]*)/i);if(!t)return new RegExp(_.escapeRegExp(e),'gi');if(t[3]&&!/^(?!.*?(.).*?\1)[gmixXsuUAJ]+$/.test(t[3]))return new RegExp(e,'gi');let n=t[3];return-1===n.indexOf('g')&&(n+='g'),-1===n.indexOf('i')&&(n+='i'),new RegExp(t[2],n)}catch{return null}}function a(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const t=16*Math.random()|0;return('x'===e?t:3&t|8).toString(16)})}const i=Vue,c=z,u=c.z.object({name:c.z.string().default('压缩相邻消息'),seperator:c.z.object({type:c.z.enum(['space','newline','double newline','custom']).default('double newline'),value:c.z.string().default('\n\n')}).prefault({}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),put_system_injection_after_chat_history:c.z.boolean().default(!1),on_chat_history:c.z.object({type:c.z.enum(['mixin','seperate','squash']).default('squash'),squash_role:c.z.enum(['user','assistant','system']).default('assistant'),user_prefix:c.z.string().default('[{{user}}]\n'),user_suffix:c.z.string().default('\n[/{{user}}]'),assistant_prefix:c.z.string().default('[剧情]\n'),assistant_suffix:c.z.string().default('\n[/剧情]'),system_prefix:c.z.string().default('[设定]\n'),system_suffix:c.z.string().default('\n[/设定]')}).prefault({}),stop_string:c.z.string().default('<|im_end|>').catch('<|im_end|>')}),p=n('settings',()=>{const e=(0,i.ref)(u.parse(getVariables({type:'script',script_id:getScriptId()})));return(0,i.watchEffect)(()=>{insertOrAssignVariables(o(e.value),{type:'script',script_id:getScriptId()})}),{settings:e}}),d={class:'inline-drawer'},f={class:'inline-drawer-content'},m={class:'flex-container flexFlowColumn'},v={key:0,class:'flex-container flexFlowColumn'},x={class:'flex-container flexFlowColumn'},h={style:{display:'flex','align-items':'center',gap:'8px'}},E={class:'flex-container flexFlowColumn'},y={key:1,class:'flex-container flexFlowColumn'},V={key:2},N={class:'flex-container flexFlowColumn',title:'用户消息前缀'},g={class:'flex-container flexFlowColumn',title:'用户消息后缀'},w={class:'flex-container flexFlowColumn',title:'助手消息前缀'},T={class:'flex-container flexFlowColumn',title:'助手消息后缀'},R={class:'flex-container flexFlowColumn',title:'系统消息前缀'},b={class:'flex-container flexFlowColumn',title:'系统消息后缀'},M={class:'flex-container flexFlowColumn'},S=(0,i.defineComponent)({__name:'Panel',setup(e){const{settings:t}=l(p());function n(e){return(0,i.computed)({get:()=>e.value.replace(/\n/g,'\\n'),set:t=>e.value=t.replace(/\\n/g,'\n')})}const o=n((0,i.toRef)(t.value.on_chat_history,'user_prefix')),s=n((0,i.toRef)(t.value.on_chat_history,'user_suffix')),r=n((0,i.toRef)(t.value.on_chat_history,'assistant_prefix')),a=n((0,i.toRef)(t.value.on_chat_history,'assistant_suffix')),c=n((0,i.toRef)(t.value.on_chat_history,'system_prefix')),u=n((0,i.toRef)(t.value.on_chat_history,'system_suffix'));function S(){SillyTavern.callGenericPopup('<p>按照<a href="https://discord.com/channels/1134557553011998840/1413538722078785576">一些预设作者和角色卡作者的说法</a>, Gemini 和 Claude 不同, 不必将条目插入聊天记录中, 插入其中反而会干扰聊天记录的连续性, 重要条目应该都插入到 D0.</p>\n     <p>但玩家依旧可能使用 Claude、GPT 等游玩, 而对它们还是需要用 D4 等深度的.</p>\n     <p>因此本脚本提供了这个选项: 勾选这个选项, D10 以下的条目将会被移动到 D0 位置, 而 D10 及以上条目将会被移动到 D9999 位置; 而关闭这个选项系统消息将会保持原有深度.</p>\n     <p>这个选项虽然已经不用角色卡作者自行将条目全设置为 D0, 但仍很需要角色卡适配; 如果角色详情等会随剧情发展的设定放在了深度条目, 则勾选这个选项容易使角色固化</p>',SillyTavern.POPUP_TYPE.TEXT,'',{leftAlign:!0})}function C(){SillyTavern.callGenericPopup('<p>如果填入停止字符串, 则 AI 输出了对应文本时将会结束输出</p>\n     <p>停止字符串可以是字符串或正则, 如 <code>User:</code> 或 <code>/User:|System:/</code></p>',SillyTavern.POPUP_TYPE.TEXT,'',{leftAlign:!0})}return(e,n)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',d,[n[30]||(n[30]=(0,i.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,i.createElementVNode)('b',null,'压缩相邻消息'),(0,i.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,i.createElementVNode)('div',f,[(0,i.createElementVNode)('div',m,[n[13]||(n[13]=(0,i.createElementVNode)('label',null,'消息分隔符',-1)),(0,i.withDirectives)((0,i.createElementVNode)('select',{'onUpdate:modelValue':n[0]||(n[0]=e=>(0,i.unref)(t).seperator.type=e),class:'text_pole'},[...n[12]||(n[12]=[(0,i.createElementVNode)('option',{value:'space'},'空格',-1),(0,i.createElementVNode)('option',{value:'newline'},'换行',-1),(0,i.createElementVNode)('option',{value:'double newline'},'双换行',-1),(0,i.createElementVNode)('option',{value:'custom'},'自定义',-1)])],512),[[i.vModelSelect,(0,i.unref)(t).seperator.type]])]),'custom'===(0,i.unref)(t).seperator.type?((0,i.openBlock)(),(0,i.createElementBlock)('div',v,[n[14]||(n[14]=(0,i.createElementVNode)('label',null,'自定义分隔符',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':n[1]||(n[1]=e=>(0,i.unref)(t).seperator.value=e),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[i.vModelText,(0,i.unref)(t).seperator.value]])])):(0,i.createCommentVNode)('v-if',!0),n[27]||(n[27]=(0,i.createElementVNode)('hr',null,null,-1)),(0,i.createElementVNode)('div',x,[(0,i.createElementVNode)('div',h,[n[15]||(n[15]=(0,i.createElementVNode)('span',null,'将 D⚙ (系统深度条目) 按序移到聊天记录后',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':n[2]||(n[2]=e=>(0,i.unref)(t).put_system_injection_after_chat_history=e),type:'checkbox',style:{margin:'0 4px 0 0'}},null,512),[[i.vModelCheckbox,(0,i.unref)(t).put_system_injection_after_chat_history]]),(0,i.createElementVNode)('i',{class:'fa-solid fa-circle-question fa-sm note-link-span',style:{cursor:'pointer'},title:'将注入到聊天深度的系统消息按照原有顺序移动到聊天记录的末尾，而不是保持在原来的深度位置。这可以确保系统消息不会干扰聊天记录的连续性。',onClick:S})])]),n[28]||(n[28]=(0,i.createElementVNode)('hr',null,null,-1)),(0,i.createElementVNode)('div',E,[n[17]||(n[17]=(0,i.createElementVNode)('label',null,'聊天历史处理方式',-1)),(0,i.withDirectives)((0,i.createElementVNode)('select',{'onUpdate:modelValue':n[3]||(n[3]=e=>(0,i.unref)(t).on_chat_history.type=e),class:'text_pole'},[...n[16]||(n[16]=[(0,i.createElementVNode)('option',{value:'mixin'},'与其他提示词混合',-1),(0,i.createElementVNode)('option',{value:'seperate'},'与其他提示词隔离',-1),(0,i.createElementVNode)('option',{value:'squash'},'单独压缩为一条消息',-1)])],512),[[i.vModelSelect,(0,i.unref)(t).on_chat_history.type]])]),'squash'===(0,i.unref)(t).on_chat_history.type?((0,i.openBlock)(),(0,i.createElementBlock)('div',y,[n[19]||(n[19]=(0,i.createElementVNode)('label',null,'压缩角色',-1)),(0,i.withDirectives)((0,i.createElementVNode)('select',{'onUpdate:modelValue':n[4]||(n[4]=e=>(0,i.unref)(t).on_chat_history.squash_role=e),class:'text_pole'},[...n[18]||(n[18]=[(0,i.createElementVNode)('option',{value:'system'},'系统',-1),(0,i.createElementVNode)('option',{value:'user'},'用户',-1),(0,i.createElementVNode)('option',{value:'assistant'},'助手',-1)])],512),[[i.vModelSelect,(0,i.unref)(t).on_chat_history.squash_role]])])):(0,i.createCommentVNode)('v-if',!0),'squash'===(0,i.unref)(t).on_chat_history.type?((0,i.openBlock)(),(0,i.createElementBlock)('div',V,[(0,i.createElementVNode)('div',N,[n[20]||(n[20]=(0,i.createElementVNode)('label',null,'用户前缀',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':n[5]||(n[5]=e=>(0,i.isRef)(o)?o.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[i.vModelText,(0,i.unref)(o)]])]),(0,i.createElementVNode)('div',g,[n[21]||(n[21]=(0,i.createElementVNode)('label',null,'用户后缀',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':n[6]||(n[6]=e=>(0,i.isRef)(s)?s.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[i.vModelText,(0,i.unref)(s)]])]),(0,i.createElementVNode)('div',w,[n[22]||(n[22]=(0,i.createElementVNode)('label',null,'助手前缀',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':n[7]||(n[7]=e=>(0,i.isRef)(r)?r.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[i.vModelText,(0,i.unref)(r)]])]),(0,i.createElementVNode)('div',T,[n[23]||(n[23]=(0,i.createElementVNode)('label',null,'助手后缀',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':n[8]||(n[8]=e=>(0,i.isRef)(a)?a.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[i.vModelText,(0,i.unref)(a)]])]),(0,i.createElementVNode)('div',R,[n[24]||(n[24]=(0,i.createElementVNode)('label',null,'系统前缀',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':n[9]||(n[9]=e=>(0,i.isRef)(c)?c.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[i.vModelText,(0,i.unref)(c)]])]),(0,i.createElementVNode)('div',b,[n[25]||(n[25]=(0,i.createElementVNode)('label',null,'系统后缀',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':n[10]||(n[10]=e=>(0,i.isRef)(u)?u.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[i.vModelText,(0,i.unref)(u)]])])])):(0,i.createCommentVNode)('v-if',!0),n[29]||(n[29]=(0,i.createElementVNode)('hr',null,null,-1)),(0,i.createElementVNode)('div',M,[(0,i.createElementVNode)('label',null,[n[26]||(n[26]=(0,i.createElementVNode)('span',null,'停止字符串',-1)),(0,i.createElementVNode)('i',{class:'fa-solid fa-circle-question fa-sm note-link-span',style:{cursor:'pointer'},title:'当模型输出了对应字符串时将会停止',onClick:C})]),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':n[11]||(n[11]=e=>(0,i.unref)(t).stop_string=e),class:'text_pole flex1 wide100p',type:'text',placeholder:'请输入字符串或 /正则/',autocomplete:'off'},null,512),[[i.vModelText,(0,i.unref)(t).stop_string]])])])]))}}),C=(0,i.createApp)(S);function D(){!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const e=$('<div>').attr('script_id',getScriptId());return $('#extensions_settings2').append(e),C.use(t()).mount(e[0]),{destroy:()=>{C.unmount(),$(`div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}}}function k(e,t){return function(e,t){if(0===e.length)return[];const n=[[e[0]]];for(const[l,o]of _.zip(_.dropRight(e),_.drop(e)))t(l,o)?n[n.length-1].push(o):n.push([o]);return n}(e,(e,t)=>e.role===t.role).map(e=>({role:e[0].role,content:e.map(({content:e})=>e.trim()).join(t.seperator.value)}))}function A(t,n){const l=({prompt:e},l)=>{if(l)return;if(e.some(({content:e})=>'string'!=typeof e))return;const o=function(e,t){const n=e.findIndex(({content:e})=>e.includes(t.head.content)),l=e.findIndex(({content:e})=>e.includes(t.deep.content)),o=e.findIndex(({content:e})=>e.includes(t.tail.content));if(-1===n||-1===l||-1===o)return null;const s=(t,n,l,o)=>{if(n!==l)return e[l].content.split(o);const s=t[1].split(o);return t[1]='',s},r=s(['',''],-1,n,t.head.content),a=s(r,n,l,t.deep.content),i=s(a,l,o,t.tail.content);return[[...e.slice(0,n),{role:e[n].role,content:r[0]}],[{role:e[n].role,content:r[1]},...e.slice(n+1,l),{role:e[l].role,content:a[0]}],[{role:e[l].role,content:a[1]},...e.slice(l+1,o),{role:e[o].role,content:i[0]}],[{role:e[o].role,content:i[1]},...e.slice(o+1)]]}(e,n);if(null===o)return;t.put_system_injection_after_chat_history&&(o[0]=_.concat(o[0],_.remove(o[1],({role:e})=>'system'===e)),o[3]=_.concat(_.remove(o[2],({role:e})=>'system'===e),o[3]));const[r,a,i,c]=_(o).map(e=>function(e){return e.filter(({content:e})=>''!==e.trim())}(e)).map(e=>k(e,t)).value();switch(t.on_chat_history.type){case'mixin':s(e,k(_.concat(r,a,i,c),t));break;case'seperate':s(e,_.concat(r,k(_.concat(a,i),t),c));break;case'squash':s(e,_.concat(r,function(e,t){const n=substitudeMacros(t.on_chat_history.system_prefix),l=substitudeMacros(t.on_chat_history.system_suffix),o=substitudeMacros(t.on_chat_history.assistant_prefix),s=substitudeMacros(t.on_chat_history.assistant_suffix),r=substitudeMacros(t.on_chat_history.user_prefix),a=substitudeMacros(t.on_chat_history.user_suffix);return{role:t.on_chat_history.squash_role,content:e.map(({role:e,content:t})=>{switch(e){case'system':return n+t.trim()+l;case'assistant':return o+t.trim()+s;case'user':return r+t.trim()+a}}).join(t.seperator.value)}}(_.concat(a,i),t),c))}},o=({messages:e})=>{l({prompt:e},!1)};e(getTavernVersion(),'1.13.4','>')?eventMakeFirst(tavern_events.GENERATE_AFTER_DATA,l):eventMakeFirst(tavern_events.CHAT_COMPLETION_SETTINGS_READY,o);const a=e=>{if(!t.stop_string)return;const n=r(t.stop_string);n&&n.test(e)&&SillyTavern.stopGeneration()};eventMakeFirst(tavern_events.STREAM_TOKEN_RECEIVED,a);const i=async e=>{if(!t.stop_string)return;const n=SillyTavern.chat[Number(e)],l=r(t.stop_string);if(!l)return;const o=l.exec(n.mes);o&&(n.mes=n.mes.slice(0,o.index),n.swipes&&_.set(n,['swipes',n.swipe_id],n.mes),SillyTavern.updateMessageBlock(Number(e),n),await SillyTavern.saveChat())};return eventMakeFirst(tavern_events.MESSAGE_RECEIVED,i),{unlisten:()=>{eventRemoveListener(tavern_events.GENERATE_AFTER_DATA,l),eventRemoveListener(tavern_events.CHAT_COMPLETION_SETTINGS_READY,o),eventRemoveListener(tavern_events.STREAM_TOKEN_RECEIVED,a),eventRemoveListener(tavern_events.MESSAGE_RECEIVED,i)}}}function I(e){const{seperators:t,uninject:n}=function(e){const t=Object.freeze({head:{id:`\0${e.name}`,position:'in_chat',depth:9999,role:'assistant',content:a()},deep:{id:`ÿ${e.name}深度分割`,position:'in_chat',depth:10,role:'system',content:a()},tail:{id:`ÿ${e.name}`,position:'in_chat',depth:0,role:'system',content:a()}}),n=(e,n,l)=>{l||injectPrompts(Object.values(t))};return eventOn(tavern_events.GENERATION_AFTER_COMMANDS,n),{seperators:t,uninject:()=>{eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS,n),uninjectPrompts(Object.values(t).map(({id:e})=>e))}}}(e),{unlisten:l}=A(e,t);return{destroy:()=>{n(),l()}}}$(()=>{!async function(t,n){e(await getTavernHelperVersion(),t,'<')&&toastr.error(`'${n}' 需要酒馆助手版本 >= '${t}'`,'版本不兼容')}('3.4.17','压缩相邻消息'),async function(e){const t=await fetch(e);if(!t.ok)return!1;const n=await t.text();replaceScriptInfo(n)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/压缩相邻消息/README.md');const{destroy:t}=D(),{destroy:n}=I(p().settings);$(window).on('pagehide',()=>{t(),n()})});
//# sourceMappingURL=index.js.map