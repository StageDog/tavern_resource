import{compare as e}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/json5/+esm';import'https://testingcf.jsdelivr.net/npm/jsonrepair/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';import{createPinia as t,defineStore as n}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as o}from'https://testingcf.jsdelivr.net/npm/klona/+esm';var l={46(e,t,n){n.r(t),n.d(t,{default:()=>a});var o=n(492),l=n.n(o),r=n(748),s=n.n(r)()(l());s.push([e.id,'.TR-section[data-v-399ec098]{border:1px solid var(--SmartThemeBorderColor,rgba(45,45,45,1));border-radius:10px;padding:0.6rem 0.75rem;gap:0.45rem;background-color:rgba(0,0,0,0.08);background-color:color-mix(in srgb,var(--SmartThemeBlurTintColor,rgba(31,31,31,1)) 75%,transparent)}.TR-section__content[data-v-399ec098]{gap:0.5rem}\n','',{version:3,sources:['webpack://./src/酒馆助手/压缩相邻消息/panel/component/Section.vue'],names:[],mappings:'AAmBA,6BACE,8DAAmE,CACnE,kBAAmB,CACnB,sBAAuB,CACvB,WAAY,CACZ,iCAAqC,CACrC,mGACF,CAEA,sCACE,UACF',sourcesContent:['<template>\n  <div class="TR-section flex-container flexFlowColumn">\n    <div class="TR-section__title">\n      <strong>\n        <span>{{ label }}</span>\n      </strong>\n      <slot name="label-suffix" />\n    </div>\n    <div class="TR-section__content flex-container flexFlowColumn">\n      <slot />\n    </div>\n  </div>\n</template>\n\n<script setup lang="ts">\ndefineProps<{ label: string }>();\n<\/script>\n\n<style scoped>\n.TR-section {\n  border: 1px solid var(--SmartThemeBorderColor, rgba(45, 45, 45, 1));\n  border-radius: 10px;\n  padding: 0.6rem 0.75rem;\n  gap: 0.45rem;\n  background-color: rgba(0, 0, 0, 0.08);\n  background-color: color-mix(in srgb, var(--SmartThemeBlurTintColor, rgba(31, 31, 31, 1)) 75%, transparent);\n}\n\n.TR-section__content {\n  gap: 0.5rem;\n}\n</style>\n'],sourceRoot:''}]);const a=s},92(e,t,n){var o=n(46);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('0ec37c0b',o,!1,{ssrId:!0})},246(e,t,n){n.r(t),n.d(t,{default:()=>a});var o=n(492),l=n.n(o),r=n(748),s=n.n(r)()(l());s.push([e.id,'.TR-help-icon[data-v-43141e14]{cursor:pointer}\n','',{version:3,sources:['webpack://./src/酒馆助手/压缩相邻消息/panel/component/HelpIcon.vue'],names:[],mappings:'AAsBA,+BACE,cACF',sourcesContent:['<template>\n  <i\n    class="fa-solid fa-circle-question fa-sm note-link-span TR-help-icon"\n    role="button"\n    tabindex="0"\n    @click="showHelpPopup(help)"\n  />\n</template>\n\n<script setup lang="ts">\ndefineProps<{ help: string }>();\n\nfunction showHelpPopup(content: string) {\n  SillyTavern.callGenericPopup(content, SillyTavern.POPUP_TYPE.TEXT, \'\', {\n    allowVerticalScrolling: true,\n    leftAlign: true,\n    wide: true,\n  });\n}\n<\/script>\n\n<style scoped>\n.TR-help-icon {\n  cursor: pointer;\n}\n</style>\n'],sourceRoot:''}]);const a=s},424(e,t,n){function o(e,t){for(var n=[],o={},l=0;l<t.length;l++){var r=t[l],s=r[0],a={id:e+':'+l,css:r[1],media:r[2],sourceMap:r[3]};o[s]?o[s].parts.push(a):n.push(o[s]={id:s,parts:[a]})}return n}n.d(t,{A:()=>m});var l='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!l)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var r={},s=l&&(document.head||document.getElementsByTagName('head')[0]),a=null,i=0,c=!1,d=function(){},u=null,p='data-vue-ssr-id',f='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function m(e,t,n,l){c=n,u=l||{};var s=o(e,t);return h(s),function(t){for(var n=[],l=0;l<s.length;l++){var a=s[l];(i=r[a.id]).refs--,n.push(i)}t?h(s=o(e,t)):s=[];for(l=0;l<n.length;l++){var i;if(0===(i=n[l]).refs){for(var c=0;c<i.parts.length;c++)i.parts[c]();delete r[i.id]}}}}function h(e){for(var t=0;t<e.length;t++){var n=e[t],o=r[n.id];if(o){o.refs++;for(var l=0;l<o.parts.length;l++)o.parts[l](n.parts[l]);for(;l<n.parts.length;l++)o.parts.push(g(n.parts[l]));o.parts.length>n.parts.length&&(o.parts.length=n.parts.length)}else{var s=[];for(l=0;l<n.parts.length;l++)s.push(g(n.parts[l]));r[n.id]={id:n.id,refs:1,parts:s}}}}function v(){var e=document.createElement('style');return e.type='text/css',s.appendChild(e),e}function g(e){var t,n,o=document.querySelector('style['+p+'~="'+e.id+'"]');if(o){if(c)return d;o.parentNode.removeChild(o)}if(f){var l=i++;o=a||(a=v()),t=y.bind(null,o,l,!1),n=y.bind(null,o,l,!0)}else o=v(),t=C.bind(null,o),n=function(){o.parentNode.removeChild(o)};return t(e),function(o){if(o){if(o.css===e.css&&o.media===e.media&&o.sourceMap===e.sourceMap)return;t(e=o)}else n()}}var b,x=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join('\n')});function y(e,t,n,o){var l=n?'':o.css;if(e.styleSheet)e.styleSheet.cssText=x(t,l);else{var r=document.createTextNode(l),s=e.childNodes;s[t]&&e.removeChild(s[t]),s.length?e.insertBefore(r,s[t]):e.appendChild(r)}}function C(e,t){var n=t.css,o=t.media,l=t.sourceMap;if(o&&e.setAttribute('media',o),u.ssrId&&e.setAttribute(p,t.id),l&&(n+='\n/*# sourceURL='+l.sources[0]+' */',n+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(l))))+' */'),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},455(e,t){t.A=(e,t)=>{const n=e.__vccOpts||e;for(const[e,o]of t)n[e]=o;return n}},492(e){e.exports=function(e){var t=e[1],n=e[3];if(!n)return t;if('function'==typeof btoa){var o=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),l='sourceMappingURL=data:application/json;charset=utf-8;base64,'.concat(o),r='/*# '.concat(l,' */');return[t].concat([r]).join('\n')}return[t].join('\n')}},599(e,t,n){var o=n(821);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('5b01578f',o,!1,{ssrId:!0})},712(e,t,n){var o=n(246);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,n(424).A)('3208ee98',o,!1,{ssrId:!0})},748(e){e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n='',o=void 0!==t[5];return t[4]&&(n+='@supports ('.concat(t[4],') {')),t[2]&&(n+='@media '.concat(t[2],' {')),o&&(n+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),n+=e(t),o&&(n+='}'),t[2]&&(n+='}'),t[4]&&(n+='}'),n}).join('')},t.i=function(e,n,o,l,r){'string'==typeof e&&(e=[[null,e,void 0]]);var s={};if(o)for(var a=0;a<this.length;a++){var i=this[a][0];null!=i&&(s[i]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);o&&s[d[0]]||(void 0!==r&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=r),n&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=n):d[2]=n),l&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=l):d[4]=''.concat(l)),t.push(d))}},t}},821(e,t,n){n.r(t),n.d(t,{default:()=>a});var o=n(492),l=n.n(o),r=n(748),s=n.n(r)()(l());s.push([e.id,'.TR-field[data-v-75b81b74]{padding:0.45rem 0.6rem;gap:0.25rem;border:1px solid color-mix(in srgb,var(--SmartThemeBorderColor,rgba(45,45,45,1)) 35%,transparent);border-radius:10px;background-color:color-mix(in srgb,var(--SmartThemeBlurTintColor,rgba(31,31,31,1)) 55%,transparent)}.TR-field__label[data-v-75b81b74]{display:inline-flex;align-items:center;gap:0.35rem;font-weight:600;opacity:0.95}\n','',{version:3,sources:['webpack://./src/酒馆助手/压缩相邻消息/panel/component/Field.vue'],names:[],mappings:'AAeA,2BACE,sBAAuB,CACvB,WAAY,CACZ,iGAAwG,CACxG,kBAAmB,CACnB,mGACF,CAEA,kCACE,mBAAoB,CACpB,kBAAmB,CACnB,WAAY,CACZ,eAAgB,CAChB,YACF',sourcesContent:['<template>\n  <div class="TR-field flex-container flexFlowColumn">\n    <label class="TR-field__label">\n      <span>{{ label }}</span>\n      <slot name="label-suffix" />\n    </label>\n    <slot />\n  </div>\n</template>\n\n<script setup lang="ts">\ndefineProps<{ label: string }>();\n<\/script>\n\n<style scoped>\n.TR-field {\n  padding: 0.45rem 0.6rem;\n  gap: 0.25rem;\n  border: 1px solid color-mix(in srgb, var(--SmartThemeBorderColor, rgba(45, 45, 45, 1)) 35%, transparent);\n  border-radius: 10px;\n  background-color: color-mix(in srgb, var(--SmartThemeBlurTintColor, rgba(31, 31, 31, 1)) 55%, transparent);\n}\n\n.TR-field__label {\n  display: inline-flex;\n  align-items: center;\n  gap: 0.35rem;\n  font-weight: 600;\n  opacity: 0.95;\n}\n</style>\n'],sourceRoot:''}]);const a=s}},r={};function s(e){var t=r[e];if(void 0!==t)return t.exports;var n=r[e]={id:e,exports:{}};return l[e](n,n.exports,s),n.exports}function a(e,t){if(!e)return null;const n=(e,n)=>(t&&(e=substitudeMacros(e)),new RegExp(e,n));try{const t=e.match(/\/(.+)\/([a-z]*)/i);if(!t)return n(_.escapeRegExp(e),'i');if(t[2]&&!/^(?!.*?(.).*?\1)[gmixXsuUAJ]+$/.test(t[3]))return n(e,'i');let o=t[2]??'';return _.pull(o,'g'),-1===o.indexOf('i')&&(o+='i'),n(t[1],o)}catch{return null}}function i(e){const t=getScriptId(),n=`th_unique_check.${e}`,o=()=>{const e=_.get(window.parent,n,new Set);return _($('#tavern_helper').find('div[data-script-id]').toArray()).map(e=>String($(e).attr('data-script-id'))).filter(t=>e.has(t)).last()};return _.update(window.parent,n,e=>void 0===e?new Set([t]):(e.add(t),e)),eventEmit(n,o()),{unregister:()=>{_.update(window.parent,n,e=>(void 0!==e&&e.delete(t),e)),eventEmit(n,o())},getPreferredScriptId:o,listenPreferenceState:e=>eventOn(n,e)}}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const c=Vue,d=z,u=d.z.object({name:d.z.string().default('压缩相邻消息'),seperator:d.z.object({type:d.z.enum(['space','newline','double newline','custom']).default('double newline'),value:d.z.string().default('\n\n')}).prefault({}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),put_system_injection_after_chat_history:d.z.boolean().default(!1),on_chat_history:d.z.object({type:d.z.enum(['mixin','seperate','squash']).default('squash'),squash_role:d.z.enum(['user','assistant','system']).default('assistant'),user_prefix:d.z.string().default('[{{user}}]\n'),user_suffix:d.z.string().default('\n[/{{user}}]'),assistant_prefix:d.z.string().default('[剧情]\n'),assistant_suffix:d.z.string().default('\n[/剧情]'),system_prefix:d.z.string().default('[设定]\n'),system_suffix:d.z.string().default('\n[/设定]')}).prefault({}),stop_string:d.z.string().default('<|im_end|>').catch('<|im_end|>')}).transform(e=>p.parse({delimiter:e.seperator,stop_string:e.stop_string,depth_injection:{threshold:10,above:{enabled:e.put_system_injection_after_chat_history,type:'exclude',placeholder:'{{压缩相邻消息::above_dx}}'},below:{enabled:e.put_system_injection_after_chat_history,type:'exclude',placeholder:'{{压缩相邻消息::below_dx}}'}},chat_history:{...e.on_chat_history,type:'squash'===e.on_chat_history.type?'squash_into_one':'squash_nearby'}})),p=d.z.object({delimiter:d.z.object({type:d.z.enum(['space','newline','double newline','custom']).default('double newline'),value:d.z.string().default('\n\n')}).prefault({}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),stop_string:d.z.string().default('<|im_end|>').catch('<|im_end|>'),depth_injection:d.z.object({threshold:d.z.number().int().min(1).default(10).catch(10),above:d.z.object({enabled:d.z.boolean().default(!1),type:d.z.enum(['exclude','placeholder']).default('exclude'),placeholder:d.z.string().default('{{压缩相邻消息::above_dx}}')}).prefault({}),below:d.z.object({enabled:d.z.boolean().default(!1),type:d.z.enum(['exclude','placeholder']).default('exclude'),placeholder:d.z.string().default('{{压缩相邻消息::below_dx}}')}).prefault({})}).prefault({}),chat_history:d.z.object({type:d.z.enum(['squash_nearby','squash_into_one']).default('squash_into_one'),squash_role:d.z.enum(['user','assistant','system']).default('assistant'),user_prefix:d.z.string().default('[{{user}}]\n'),user_suffix:d.z.string().default('\n[/{{user}}]'),assistant_prefix:d.z.string().default('[剧情]\n'),assistant_suffix:d.z.string().default('\n[/剧情]'),system_prefix:d.z.string().default('[设定]\n'),system_suffix:d.z.string().default('\n[/设定]')}).prefault({})}).prefault({}),f=n('settings',()=>{const e=getVariables({type:'script',script_id:getScriptId()}),t=(0,c.ref)((_.has(e,'seperator')?u:p).parse(e)),n=(0,c.ref)(!1);i('压缩相邻消息').listenPreferenceState(e=>{n.value=e===getScriptId()}),(0,c.watchEffect)(()=>{insertOrAssignVariables(o(t.value),{type:'script',script_id:getScriptId()})});return{settings:t,should_enable:n,useEscapedNewline:e=>(0,c.computed)({get:()=>_.get(t.value,e).replace(/\n/g,'\\n'),set:n=>_.set(t.value,e,n.replace(/\\n/g,'\n'))})}}),m={class:'TR-field flex-container flexFlowColumn'},h={class:'TR-field__label'},v=(0,c.defineComponent)({__name:'Field',props:{label:{}},setup:e=>(t,n)=>((0,c.openBlock)(),(0,c.createElementBlock)('div',m,[(0,c.createElementVNode)('label',h,[(0,c.createElementVNode)('span',null,(0,c.toDisplayString)(e.label),1),(0,c.renderSlot)(t.$slots,'label-suffix')]),(0,c.renderSlot)(t.$slots,'default')]))});s(599);var g=s(455);const b=(0,g.A)(v,[['__scopeId','data-v-75b81b74']]),x=(0,c.defineComponent)({__name:'HelpIcon',props:{help:{}},setup:e=>(t,n)=>((0,c.openBlock)(),(0,c.createElementBlock)('i',{class:'fa-solid fa-circle-question fa-sm note-link-span TR-help-icon',role:'button',tabindex:'0',onClick:n[0]||(n[0]=t=>{return n=e.help,void SillyTavern.callGenericPopup(n,SillyTavern.POPUP_TYPE.TEXT,'',{allowVerticalScrolling:!0,leftAlign:!0,wide:!0});var n})}))});s(712);const y=(0,g.A)(x,[['__scopeId','data-v-43141e14']]),C={class:'flex-container alignitemscenter'},w={key:0},A=(0,c.defineComponent)({__name:'Item',props:{label:{}},setup:e=>(t,n)=>((0,c.openBlock)(),(0,c.createElementBlock)('div',C,[e.label?((0,c.openBlock)(),(0,c.createElementBlock)('span',w,(0,c.toDisplayString)(e.label),1)):(0,c.createCommentVNode)('v-if',!0),(0,c.renderSlot)(t.$slots,'default')]))}),E={class:'TR-section flex-container flexFlowColumn'},V={class:'TR-section__title'},T={class:'TR-section__content flex-container flexFlowColumn'},N=(0,c.defineComponent)({__name:'Section',props:{label:{}},setup:e=>(t,n)=>((0,c.openBlock)(),(0,c.createElementBlock)('div',E,[(0,c.createElementVNode)('div',V,[(0,c.createElementVNode)('strong',null,[(0,c.createElementVNode)('span',null,(0,c.toDisplayString)(e.label),1)]),(0,c.renderSlot)(t.$slots,'label-suffix')]),(0,c.createElementVNode)('div',T,[(0,c.renderSlot)(t.$slots,'default')])]))});s(92);const S=(0,g.A)(N,[['__scopeId','data-v-399ec098']]),B=['value'],k=(0,c.defineComponent)({__name:'Select',props:(0,c.mergeModels)({options:{}},{modelValue:{required:!0},modelModifiers:{}}),emits:['update:modelValue'],setup(e){const t=(0,c.useModel)(e,'modelValue'),n=e,o=(0,c.computed)(()=>n.options.map(e=>'string'==typeof e?{label:e,value:e}:e));return(e,n)=>(0,c.withDirectives)(((0,c.openBlock)(),(0,c.createElementBlock)('select',{'onUpdate:modelValue':n[0]||(n[0]=e=>t.value=e),class:'text_pole'},[((0,c.openBlock)(!0),(0,c.createElementBlock)(c.Fragment,null,(0,c.renderList)((0,c.unref)(o),({label:e,value:t})=>((0,c.openBlock)(),(0,c.createElementBlock)('option',{key:t,value:t},(0,c.toDisplayString)(e),9,B))),128))],512)),[[c.vModelSelect,t.value]])}});const j=(0,c.defineComponent)({__name:'ChatHistory',setup(e){const t=f(),n=t.useEscapedNewline('chat_history.user_prefix'),o=t.useEscapedNewline('chat_history.user_suffix'),l=t.useEscapedNewline('chat_history.assistant_prefix'),r=t.useEscapedNewline('chat_history.assistant_suffix'),s=t.useEscapedNewline('chat_history.system_prefix'),a=t.useEscapedNewline('chat_history.system_suffix');return(e,i)=>((0,c.openBlock)(),(0,c.createBlock)(S,{label:'处理聊天历史'},{'label-suffix':(0,c.withCtx)(()=>[(0,c.createVNode)(y,{help:(0,c.unref)('<h1>处理聊天历史</h1> <p>酒馆的聊天历史 (预设中的 Chat History 条目) 记录了玩家和 AI 的每楼层提示词, 也就是实际游玩的内容.</p> <p>聊天记录往往是一问一答的: 一条用户输入、一条 AI 输出、一条用户输入……AI 团队可能针对这种对话进行了一些特殊训练, 而我们游玩酒馆恰因为这些训练出现问题 (出现八股、文风变差之类的).</p> <p>因此本脚本允许你对聊天历史进行额外处理:</p> <ul> <li>仅合并相邻同身份提示词: 将聊天历史中相邻且身份相同的提示词合并, 例如世界书条目 A 和 B 都插入到 D1 作为系统提示词, 则会被合并成一条提示词</li> <li><strong>压缩为单条提示词</strong>: 先合并相邻同身份提示词, 再将整个聊天历史压缩为一条提示词</li> </ul> <p>其中, 压缩为单条提示词就是为了避免受 AI 团队对人机对话的训练影响. 它将原本的一问一答附上相应的身份前后缀, 然后合并成一条提示词, 例如:</p> <pre><code class="language-text">{{user}}:\n我输入了一段话\n\n剧情:\nAI 根据输入的话生成了一段文本\n\n{{user}}:\n我又输入了一段话\n</code></pre> <p>不过, 由于聊天记录被压缩成单条提示词发给 AI, AI 可能误认为它就该输出这样的一长串对话.</p> <p>为了避免它自问自答, 你可以在停止字符串中填入它应该在什么时候中止输出. (对于上面的例子, 我们可以填写 <code>{{user}}:</code> 作为停止字符串.)</p> ')},null,8,['help'])]),default:(0,c.withCtx)(()=>[(0,c.createVNode)(k,{modelValue:(0,c.unref)(t).settings.chat_history.type,'onUpdate:modelValue':i[0]||(i[0]=e=>(0,c.unref)(t).settings.chat_history.type=e),options:[{label:'仅合并相邻同身份提示词',value:'squash_nearby'},{label:'压缩为单条提示词',value:'squash_into_one'}]},null,8,['modelValue']),'squash_into_one'===(0,c.unref)(t).settings.chat_history.type?((0,c.openBlock)(),(0,c.createElementBlock)(c.Fragment,{key:0},[(0,c.createVNode)(b,{label:'压缩后的提示词身份'},{default:(0,c.withCtx)(()=>[(0,c.createVNode)(k,{modelValue:(0,c.unref)(t).settings.chat_history.squash_role,'onUpdate:modelValue':i[1]||(i[1]=e=>(0,c.unref)(t).settings.chat_history.squash_role=e),options:[{label:'用户',value:'user'},{label:'助手',value:'assistant'},{label:'系统',value:'system'}]},null,8,['modelValue'])]),_:1}),(0,c.createVNode)(b,{label:'提示词前后缀'},{default:(0,c.withCtx)(()=>[(0,c.createVNode)(A,{label:'用户前缀'},{default:(0,c.withCtx)(()=>[(0,c.withDirectives)((0,c.createElementVNode)('input',{'onUpdate:modelValue':i[2]||(i[2]=e=>(0,c.isRef)(n)?n.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c.vModelText,(0,c.unref)(n)]])]),_:1}),(0,c.createVNode)(A,{label:'用户后缀'},{default:(0,c.withCtx)(()=>[(0,c.withDirectives)((0,c.createElementVNode)('input',{'onUpdate:modelValue':i[3]||(i[3]=e=>(0,c.isRef)(o)?o.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c.vModelText,(0,c.unref)(o)]])]),_:1}),(0,c.createVNode)(A,{label:'助手前缀'},{default:(0,c.withCtx)(()=>[(0,c.withDirectives)((0,c.createElementVNode)('input',{'onUpdate:modelValue':i[4]||(i[4]=e=>(0,c.isRef)(l)?l.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c.vModelText,(0,c.unref)(l)]])]),_:1}),(0,c.createVNode)(A,{label:'助手后缀'},{default:(0,c.withCtx)(()=>[(0,c.withDirectives)((0,c.createElementVNode)('input',{'onUpdate:modelValue':i[5]||(i[5]=e=>(0,c.isRef)(r)?r.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c.vModelText,(0,c.unref)(r)]])]),_:1}),(0,c.createVNode)(A,{label:'系统前缀'},{default:(0,c.withCtx)(()=>[(0,c.withDirectives)((0,c.createElementVNode)('input',{'onUpdate:modelValue':i[6]||(i[6]=e=>(0,c.isRef)(s)?s.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c.vModelText,(0,c.unref)(s)]])]),_:1}),(0,c.createVNode)(A,{label:'系统后缀'},{default:(0,c.withCtx)(()=>[(0,c.withDirectives)((0,c.createElementVNode)('input',{'onUpdate:modelValue':i[7]||(i[7]=e=>(0,c.isRef)(a)?a.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[c.vModelText,(0,c.unref)(a)]])]),_:1})]),_:1})],64)):(0,c.createCommentVNode)('v-if',!0)]),_:1}))}});const R=(0,c.defineComponent)({__name:'Delimiter',setup(e){const t=f(),n=t.useEscapedNewline('delimiter.value');return(e,o)=>((0,c.openBlock)(),(0,c.createBlock)(S,{label:'合并提示词时的间隔文本'},{'label-suffix':(0,c.withCtx)(()=>[(0,c.createVNode)(y,{help:(0,c.unref)('<h1>合并消息时的间隔文本</h1> <p>当发给 AI 的两条提示词合并时, 两条提示词的文本也会被合并. 但当文本合并时, 它们之间往往需要用额外文本间隔起来.</p> <p>例如, 一条提示词是:</p> <pre><code class="language-text">用户:\n你好, 我是张三.\n</code></pre> <p>另一条提示词是:</p> <pre><code class="language-text">助手:\n你好, 我是李四.\n</code></pre> <p>当这两条提示词合并时, 如果我们什么间隔文本都不加, 将会变成:</p> <pre><code class="language-text">用户:\n你好, 我是张三.助手:\n你好, 我是李四.\n</code></pre> <p>显然这容易让 AI 产生误解, 因此我们需要在它们之间添加间隔文本.</p> <p>一般来说, 双换行是比较好的间隔文本, 因此脚本默认为你选择了双换行.</p> ')},null,8,['help'])]),default:(0,c.withCtx)(()=>[(0,c.createVNode)(k,{modelValue:(0,c.unref)(t).settings.delimiter.type,'onUpdate:modelValue':o[0]||(o[0]=e=>(0,c.unref)(t).settings.delimiter.type=e),options:[{label:'空格',value:'space'},{label:'换行',value:'newline'},{label:'双换行',value:'double newline'},{label:'自定义',value:'custom'}]},null,8,['modelValue']),'custom'===(0,c.unref)(t).settings.delimiter.type?(0,c.withDirectives)(((0,c.openBlock)(),(0,c.createElementBlock)('input',{key:0,'onUpdate:modelValue':o[1]||(o[1]=e=>(0,c.isRef)(n)?n.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512)),[[c.vModelText,(0,c.unref)(n)]]):(0,c.createCommentVNode)('v-if',!0)]),_:1}))}}),D={class:'checkbox_label'},I=(0,c.defineComponent)({__name:'Checkbox',props:{modelValue:{type:Boolean,required:!0},modelModifiers:{}},emits:['update:modelValue'],setup(e){const t=(0,c.useModel)(e,'modelValue');return(e,n)=>((0,c.openBlock)(),(0,c.createElementBlock)('label',D,[(0,c.withDirectives)((0,c.createElementVNode)('input',{'onUpdate:modelValue':n[0]||(n[0]=e=>t.value=e),type:'checkbox'},null,512),[[c.vModelCheckbox,t.value]]),(0,c.renderSlot)(e.$slots,'default')]))}});const M=(0,c.defineComponent)({__name:'DepthInjection',setup(e){const t=f();return(e,n)=>((0,c.openBlock)(),(0,c.createBlock)(S,{label:'处理 D⚙ 条目'},{'label-suffix':(0,c.withCtx)(()=>[(0,c.createVNode)(y,{help:(0,c.unref)('<h1>处理 D⚙ 条目</h1> <p>按照<a href="https://discord.com/channels/1134557553011998840/1413538722078785576">一些预设作者和角色卡作者的说法</a>, Gemini 和 Claude 不同, 不必将条目插入聊天记录中, 插入其中反而会干扰聊天记录的连续性, 重要条目应该都插入到 D0.</p> <p>但玩家依旧可能使用 Claude、GPT 等游玩, 而对它们还是需要用 D4 等深度的.</p> <p>因此本脚本提供了处理深度条目功能, 允许你特殊处理特定深度 (Dx) 以上和以下的系统深度条目 (D⚙ 条目):</p> <ul> <li>将它们按顺序插入到 D9999/D0: 如果说法无误, 几乎所有预设都能从中获得好处, 而不会产生负面影响</li> <li>或将它们合并成一条文本, 并替换到占位符位置: 预设可以赋予这些条目特殊的语义, 就像有的预设为 AI 把 "角色定义之前/之后" 部分定义成 <code>additional_settings</code> 那样</li> </ul> <hr> <p><strong>注意</strong>: 这些选项虽然已经不用角色卡作者自行将条目全设置为 D0，但仍很需要角色卡适配；如果角色详情等会随剧情发展的设定放在了深度条目，则勾选这些选项容易使角色固化。</p> ')},null,8,['help'])]),default:(0,c.withCtx)(()=>[(0,c.withDirectives)((0,c.createElementVNode)('input',{'onUpdate:modelValue':n[0]||(n[0]=e=>(0,c.unref)(t).settings.depth_injection.threshold=e),type:'number',min:'0',class:'text_pole flex1 wide100p'},null,512),[[c.vModelText,(0,c.unref)(t).settings.depth_injection.threshold,void 0,{number:!0}]]),(0,c.createVNode)(I,{modelValue:(0,c.unref)(t).settings.depth_injection.above.enabled,'onUpdate:modelValue':n[1]||(n[1]=e=>(0,c.unref)(t).settings.depth_injection.above.enabled=e)},{default:(0,c.withCtx)(()=>[(0,c.createElementVNode)('span',null,'处理 D'+(0,c.toDisplayString)((0,c.unref)(t).settings.depth_injection.threshold)+' 及以上的 D⚙ 条目',1)]),_:1},8,['modelValue']),(0,c.unref)(t).settings.depth_injection.above.enabled?((0,c.openBlock)(),(0,c.createBlock)(k,{key:0,modelValue:(0,c.unref)(t).settings.depth_injection.above.type,'onUpdate:modelValue':n[2]||(n[2]=e=>(0,c.unref)(t).settings.depth_injection.above.type=e),style:{width:'90%','align-self':'flex-end'},options:[{label:'按顺序插入到 D9999',value:'exclude'},{label:`合并后替换到 ${(0,c.unref)(t).settings.depth_injection.above.placeholder} 宏位置`,value:'placeholder'}]},null,8,['modelValue','options'])):(0,c.createCommentVNode)('v-if',!0),(0,c.createVNode)(I,{modelValue:(0,c.unref)(t).settings.depth_injection.below.enabled,'onUpdate:modelValue':n[3]||(n[3]=e=>(0,c.unref)(t).settings.depth_injection.below.enabled=e)},{default:(0,c.withCtx)(()=>[(0,c.createElementVNode)('span',null,'处理 D'+(0,c.toDisplayString)((0,c.unref)(t).settings.depth_injection.threshold)+' 以下的 D⚙ 条目',1)]),_:1},8,['modelValue']),(0,c.unref)(t).settings.depth_injection.below.enabled?((0,c.openBlock)(),(0,c.createBlock)(k,{key:1,modelValue:(0,c.unref)(t).settings.depth_injection.below.type,'onUpdate:modelValue':n[4]||(n[4]=e=>(0,c.unref)(t).settings.depth_injection.below.type=e),style:{width:'90%','align-self':'flex-end'},options:[{label:'按顺序插入到 D0',value:'exclude'},{label:`合并后替换到 ${(0,c.unref)(t).settings.depth_injection.below.placeholder} 宏位置`,value:'placeholder'}]},null,8,['modelValue','options'])):(0,c.createCommentVNode)('v-if',!0)]),_:1}))}});const U=(0,c.defineComponent)({__name:'Stop',setup(e){const t=f();return(e,n)=>((0,c.openBlock)(),(0,c.createBlock)(S,{label:'停止字符串'},{'label-suffix':(0,c.withCtx)(()=>[(0,c.createVNode)(y,{help:(0,c.unref)('<h1>停止字符串</h1> <p>如果填入停止字符串, 则 AI 输出了对应文本时将会直接停止输出. 停止字符串可以是字符串或正则, 如 <code>User:</code> 或 <code>/User:|System:/</code>.</p> <p>这可以避免 AI 在输出完剧情后自己和自己对话. 例如, AI 直接回复了以下内容:</p> <pre><code class="language-text">&#x3C;|im_start|> assistant\n剧情……\n&#x3C;|im_end|>\n\n&#x3C;|im_start|> user\nAI 自己作为 user 继续发送消息了!\n&#x3C;|im_end|>\n\n&#x3C;|im_start|> assistant\n剧情……\n&#x3C;|im_end|>\n</code></pre> <p>那么可以把 <code>&#x3C;|im_end|></code> 作为停止字符串.</p> <p>这样一来,</p> <ul> <li>对于流式传输: 当 AI 输出完剧情, 输出到 <code>&#x3C;|im_end|></code> 时, 就会直接停止输出</li> <li>对于非流式传输: 当 AI 回复后, 脚本会删去 <code>&#x3C;|im_end|></code> 及以后的所有文本</li> </ul> ')},null,8,['help'])]),default:(0,c.withCtx)(()=>[(0,c.withDirectives)((0,c.createElementVNode)('input',{'onUpdate:modelValue':n[0]||(n[0]=e=>(0,c.unref)(t).settings.stop_string=e),class:'text_pole flex1 wide100p',type:'text',placeholder:'请输入字符串或 /正则/',autocomplete:'off'},null,512),[[c.vModelText,(0,c.unref)(t).settings.stop_string]])]),_:1}))}}),O={key:0,class:'inline-drawer'},P={class:'inline-drawer-content'},q=(0,c.defineComponent)({__name:'Panel',setup(e){const t=f();return(e,n)=>(0,c.unref)(t).should_enable?((0,c.openBlock)(),(0,c.createElementBlock)('div',O,[n[0]||(n[0]=(0,c.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,c.createElementVNode)('b',null,'压缩相邻消息'),(0,c.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,c.createElementVNode)('div',P,[(0,c.createVNode)(R),(0,c.createVNode)(U),(0,c.createVNode)(M),(0,c.createVNode)(j)])])):(0,c.createCommentVNode)('v-if',!0)}});function G(){const e=(0,c.createApp)(q).use(t()),n=$('<div>').attr('script_id',getScriptId()).appendTo('#extensions_settings2');e.mount(n[0]);const{destroy:o}=function(e='head'){const t=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>t.remove()}}();return{destroy:()=>{e.unmount(),n.remove(),o()}}}function F(e){return _(e).split('\n').dropWhile(e=>!e.trim()).dropRightWhile(e=>!e.trim()).join('\n')}function L(e){return e.filter(({content:e})=>''!==e.trim())}function H(e,t){return function(e,t){if(0===e.length)return[];const n=[[e[0]]];for(const[o,l]of _.zip(_.dropRight(e),_.drop(e)))t(o,l)?n[n.length-1].push(l):n.push([l]);return n}(e,(e,t)=>e.role===t.role).map(e=>({role:e[0].role,content:e.map(({content:e})=>F(e)).join(t.delimiter.value)}))}function Y(t,n,o){const l=({prompt:e},l)=>{if(l||!o())return;if(e.some(({content:e})=>'string'!=typeof e))return;const r=function(e,t){const n=e.findIndex(({content:e})=>e.includes(t.head.content)),o=e.findIndex(({content:e})=>e.includes(t.deep.content)),l=e.findIndex(({content:e})=>e.includes(t.tail.content));if(-1===n||-1===o||-1===l)return null;const r=(t,n,o,l)=>{if(n!==o)return e[o].content.split(l);const r=t[1].split(l);return t[1]='',r},s=r(['',''],-1,n,t.head.content),a=r(s,n,o,t.deep.content),i=r(a,o,l,t.tail.content);return[[...e.slice(0,n),{role:e[n].role,content:s[0]}],[{role:e[n].role,content:s[1]},...e.slice(n+1,o),{role:e[o].role,content:a[0]}],[{role:e[o].role,content:a[1]},...e.slice(o+1,l),{role:e[l].role,content:i[0]}],[{role:e[l].role,content:i[1]},...e.slice(l+1)]]}(e,n);if(null===r)return;const{above:s,below:a}=t.depth_injection,i=(e,n,o)=>{if(!e.enabled)return;const l=e=>!('system'!==e.role||s.enabled&&'placeholder'===s.type&&e.content.includes(s.placeholder)||a.enabled&&'placeholder'===a.type&&e.content.includes(a.placeholder)),i='placeholder'===e.type?L(r[n]).filter(l).map(e=>F(e.content)).join(t.delimiter.value):'';if('placeholder'===e.type&&_(r).flatten().some(t=>t.content.includes(e.placeholder)))_.remove(r[n],l);else{const e=_.remove(r[n],e=>'system'===e.role);r[o]=o<n?_.concat(r[o],e):_.concat(e,r[o])}_(r).flatten().filter(t=>t.content.includes(e.placeholder)).forEach(t=>{t.content=t.content.replaceAll(e.placeholder,i)})};i(s,1,0),i(a,2,3);const[c,d,u,p]=_(r).map(e=>L(e)).map(e=>H(e,t)).value();let f;switch(t.chat_history.type){case'squash_nearby':f=H(_.concat(c,d,u,p),t);break;case'squash_into_one':f=_.concat(c,function(e,t){const n=substitudeMacros(t.chat_history.system_prefix),o=substitudeMacros(t.chat_history.system_suffix),l=substitudeMacros(t.chat_history.assistant_prefix),r=substitudeMacros(t.chat_history.assistant_suffix),s=substitudeMacros(t.chat_history.user_prefix),a=substitudeMacros(t.chat_history.user_suffix);return{role:t.chat_history.squash_role,content:e.map(({role:e,content:t})=>{const i=F(t);switch(e){case'system':return n+i+o;case'assistant':return l+i+r;case'user':return s+i+a}}).join(t.delimiter.value)}}(_.concat(d,u),t),p)}var m,h;h=f,(m=e).length=0,m.push(...h)},r=({messages:e})=>{l({prompt:e},!1)};e(getTavernVersion(),'1.13.4','>')?eventOn(tavern_events.GENERATE_AFTER_DATA,l):eventOn(tavern_events.CHAT_COMPLETION_SETTINGS_READY,r);const s=e=>{if(!t.stop_string||!o())return;const n=a(t.stop_string,!0);n&&n.test(e)&&SillyTavern.stopGeneration()};eventOn(tavern_events.STREAM_TOKEN_RECEIVED,s);const i=async e=>{if(!t.stop_string||!o())return;const n=SillyTavern.chat[Number(e)],l=a(t.stop_string,!0);if(!l)return;const r=n.mes.match(l);r&&(n.mes=n.mes.slice(0,r.index),n.swipes&&_.set(n,['swipes',n.swipe_id],n.mes),SillyTavern.updateMessageBlock(Number(e),n),await SillyTavern.saveChat())};return eventOn(tavern_events.MESSAGE_RECEIVED,i),{unlisten:()=>{eventRemoveListener(tavern_events.GENERATE_AFTER_DATA,l),eventRemoveListener(tavern_events.CHAT_COMPLETION_SETTINGS_READY,r),eventRemoveListener(tavern_events.STREAM_TOKEN_RECEIVED,s),eventRemoveListener(tavern_events.MESSAGE_RECEIVED,i)}}}function W(e){const{unregister:t,getPreferredScriptId:n}=i('压缩相邻消息'),{separators:o,uninject:l}=function(e){const t=Object.freeze({head:{id:'\0压缩相邻消息-聊天记录开头',position:'in_chat',depth:9999,role:'assistant',content:'【【压缩相邻消息-聊天记录开头】】'},deep:{id:'ÿ压缩相邻消息-Dx',position:'in_chat',depth:e.depth_injection.threshold,role:'system',content:'【【压缩相邻消息-Dx】】'},tail:{id:'ÿ压缩相邻消息-聊天记录结尾',position:'in_chat',depth:0,role:'system',content:'【【压缩相邻消息-聊天记录结尾】】'}}),n=(e,n,o)=>{o||injectPrompts(Object.values(t))};return eventOn(tavern_events.GENERATION_AFTER_COMMANDS,n),{separators:t,uninject:()=>{eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS,n),uninjectPrompts(Object.values(t).map(({id:e})=>e))}}}(e),{unlisten:r}=Y(e,o,()=>n()===getScriptId());return{destroy:()=>{t(),r(),l()}}}$(()=>{!async function(t,n){e(await getTavernHelperVersion(),t,'<')&&toastr.error(`'${n}' 需要酒馆助手版本 >= '${t}'`,'版本不兼容')}('3.4.17','压缩相邻消息'),async function(e){const t=await fetch(e);if(!t.ok)return!1;const n=await t.text();replaceScriptInfo(n)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/压缩相邻消息/README.md');const{destroy:t}=G();let n;(0,c.watch)(()=>f().settings,e=>{n?.(),n=W(e).destroy},{immediate:!0,deep:!0}),$(window).on('pagehide',()=>{t(),n()})});
//# sourceMappingURL=index.js.map