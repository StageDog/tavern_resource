{"version":3,"file":"index.js","mappings":"AAwBAA,eAAeC,EAAYC,GACzBC,EAAE,yBAAyBC,KAAK,iBAAiBC,KAAK,WAAYH,EACpE,CAEAC,EAAE,KC5BK,IAAwCG,GCExCN,eAA0BO,GAC/B,MAAMC,QAAeC,MAAMF,GAC3B,IAAKC,EAAOE,GACV,OAAO,EAET,MAAMC,QAAoBH,EAAOI,OACjCC,kBAAkBF,EAEpB,CFmBEG,CACE,+FC9B2CR,GDgCd,EC9B/BS,8BAA8BC,cAAe,CAC3C,CACEC,KAAM,gBACNX,aAIJY,cAAc,gBAAiBlB,UAC7B,MAAMmB,EAAYC,eAElB,IAAIC,EAAkC,KACtC,MAAMC,EAAYnB,EAAE,SAASoB,OAC3B,+CACApB,EAAE,SAASoB,OACTpB,EAAE,2DACCoB,OAAOJ,EAAUK,IAAI,CAACC,EAAUC,IAAU,IAAIC,OAAOF,EAAUG,OAAOF,MACtEG,GAAG,SAAU7B,iBACZ,MAAM8B,EAAQF,OAAOzB,EAAE4B,MAAMC,OAC7B,GAAc,KAAVF,EAEF,YADAT,EAAmB,MAGrB,MAAMI,EAAWN,EAAUc,GAAGC,OAAOJ,IACrCT,EAAmBI,GAAY,IACjC,WAIeU,YAAYC,iBAAiBd,EAAU,GAAIa,YAAYE,WAAWC,WACxEH,YAAYI,aAAaC,aAAgBnB,UAIlDoB,0BAA0BpB,EAAkBqB,IAChDA,EAAQC,QAAQC,IACdA,EAAMC,mBAAoB,EAC1BD,EAAME,mBAAoB,IAErBJ,IAETP,YAAYC,iBAAiB,QAAQf,WAA2Bc,YAAYE,WAAWU,SDvC3F/C,iBAkBEgD,oBAjBqD,CACnDC,WAAY,EACZC,mBAAoB,IACpBC,WAAY,EACZC,gBAAiB,EACjBC,UAAW,EACXC,oBAAqB,EAErBC,mBAAoB,kBAEpBC,eAAe,EACfC,WAAW,EACXC,gBAAgB,EAChBC,mBAAmB,EACnBC,mBAAmB,EACnBC,gBAAgB,GAGpB,CAWEC,GACA7D,GAAY,KAGdE,EAAE4D,QAAQlC,GAAG,WAAY,IAAM5B,GAAY","sources":["src://tavern_helper_template/src/酒馆助手/世界书强制用推荐的全局设置/index.ts","src://tavern_helper_template/src/酒馆助手/一键禁用条目递归/button.ts","src://tavern_helper_template/util/script.ts"],"sourcesContent":["import { registerDisableRecursionButton } from '@/酒馆助手/一键禁用条目递归/button';\nimport { loadReadme } from '@util/script';\n\nasync function sync_lorebook_settings() {\n  const EXPECTED_SETTINGS: Partial<LorebookSettings> = {\n    scan_depth: 2,\n    context_percentage: 100,\n    budget_cap: 0,\n    min_activations: 0,\n    max_depth: 0,\n    max_recursion_steps: 0,\n\n    insertion_strategy: 'character_first',\n\n    include_names: false,\n    recursive: true,\n    case_sensitive: false,\n    match_whole_words: false,\n    use_group_scoring: false,\n    overflow_alert: false,\n  };\n  setLorebookSettings(EXPECTED_SETTINGS);\n}\n\nasync function toggle_lock(should_lock: boolean) {\n  $('#wiActivationSettings').find('input, select').prop('disabled', should_lock);\n}\n\n$(() => {\n  loadReadme(\n    'https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/世界书强制用推荐的全局设置/README.md',\n  );\n  registerDisableRecursionButton(false);\n  sync_lorebook_settings();\n  toggle_lock(true);\n});\n\n$(window).on('pagehide', () => toggle_lock(false));\n","export function registerDisableRecursionButton(visible: boolean) {\n  // @ts-expect-error 为了向后兼容性\n  appendInexistentScriptButtons(getScriptId(), [\n    {\n      name: '处理要禁用递归扫描的世界书',\n      visible,\n    },\n  ]);\n\n  eventOnButton('处理要禁用递归扫描的世界书', async () => {\n    const lorebooks = getLorebooks();\n\n    let choosen_lorebook: string | null = null;\n    const $template = $('<div>').append(\n      '<div><h4><span>请选择你要处理的世界书</span></h4></div>',\n      $('<div>').append(\n        $('<select><option value=\"\">--- None ---</option></select>')\n          .append(lorebooks.map((lorebook, index) => new Option(lorebook, String(index))))\n          .on('change', async function () {\n            const value = String($(this).val());\n            if (value === '') {\n              choosen_lorebook = null;\n              return;\n            }\n            const lorebook = lorebooks.at(Number(value));\n            choosen_lorebook = lorebook ?? null;\n          }),\n      ),\n    );\n\n    const result = await SillyTavern.callGenericPopup($template[0], SillyTavern.POPUP_TYPE.CONFIRM);\n    if (result !== SillyTavern.POPUP_RESULT.AFFIRMATIVE || !choosen_lorebook) {\n      return;\n    }\n\n    await updateLorebookEntriesWith(choosen_lorebook, entries => {\n      entries.forEach(entry => {\n        entry.exclude_recursion = true;\n        entry.prevent_recursion = true;\n      });\n      return entries;\n    });\n    SillyTavern.callGenericPopup(`已禁用 '${choosen_lorebook}' 的递归扫描`, SillyTavern.POPUP_TYPE.TEXT);\n  });\n}\n","import iframe_srcdoc from './iframe_srcdoc.html';\n\nexport async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle(\n  append_to: JQuery.Selector | JQuery.htmlString | JQuery.TypeOrArray<Element | DocumentFragment> | JQuery = 'head',\n): { destroy: () => void } {\n  const $div = $(`<div>`)\n    .attr('script_id', getScriptId())\n    .append($(`head > style`, document).clone())\n    .appendTo(append_to);\n\n  return {\n    destroy: () => $div.remove(),\n  };\n}\n\nexport function createScriptIdIframe(): JQuery<HTMLIFrameElement> {\n  return $(`<iframe>`).attr({\n    script_id: getScriptId(),\n    frameborder: 0,\n    srcdoc: iframe_srcdoc,\n  }) as JQuery<HTMLIFrameElement>;\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, new_chat_id => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n"],"names":["async","toggle_lock","should_lock","$","find","prop","visible","url","readme","fetch","ok","readme_text","text","replaceScriptInfo","loadReadme","appendInexistentScriptButtons","getScriptId","name","eventOnButton","lorebooks","getLorebooks","choosen_lorebook","$template","append","map","lorebook","index","Option","String","on","value","this","val","at","Number","SillyTavern","callGenericPopup","POPUP_TYPE","CONFIRM","POPUP_RESULT","AFFIRMATIVE","updateLorebookEntriesWith","entries","forEach","entry","exclude_recursion","prevent_recursion","TEXT","setLorebookSettings","scan_depth","context_percentage","budget_cap","min_activations","max_depth","max_recursion_steps","insertion_strategy","include_names","recursive","case_sensitive","match_whole_words","use_group_scoring","overflow_alert","sync_lorebook_settings","window"],"ignoreList":[],"sourceRoot":""}