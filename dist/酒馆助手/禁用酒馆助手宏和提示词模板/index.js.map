{"version":3,"file":"index.js","mappings":"AAIO,SAASA,EAAkBC,GAEhC,MAAMC,EAAgCC,EAAE,iCACpCD,EAA8BE,OAAS,GAAKF,EAA8BG,KAAK,cAAgBJ,GACjGC,EAA8BG,KAAK,WAAYJ,GAAQ,GAAGK,cAAc,IAAIC,MAAM,UAIpF,MAAMC,EAAqBL,EAAE,yCACzBK,EAAmBJ,OAAS,GAAKI,EAAmBH,KAAK,cAAgBJ,GAC3EO,EAAmBC,QAAQ,SAGzBC,aACFA,YAAYC,YAAY,CACtBC,QAASX,EACTY,kBAAkB,EAClBC,yBAAyB,EACzBC,uBAAuB,EACvBC,gBAAgB,EAChBC,uBAAuB,EACvBC,qBAAqB,EACrBC,gCAAgC,EAChCC,wBAAwB,EACxBC,kBAAkB,EAClBC,2BAA2B,EAC3BC,gBAAgB,EAChBC,iBAAiB,EACjBC,SAAS,GAGf,CChCAtB,EAAE,MCDKuB,eAA0BC,GAC/B,MAAMC,QAAeC,MAAMF,GAC3B,IAAKC,EAAOE,GACV,OAAO,EAET,MAAMC,QAAoBH,EAAOI,OACjCC,kBAAkBF,EAEpB,CDNEG,CACE,+FAEFlC,GAAkB,GAElBmC,QAAQC,eAAe,iBAAkB,KACvCpC,GAAkB,KAEpBmC,QAAQC,eAAe,iBAAkB,KACvCpC,GAAkB,KAGpB,MAAMqC,EAA2BC,EAAEC,SACjC,KACE,MAAMC,EAAUC,mBACVC,EAASF,EAAQG,KACrBD,GAA0B,kBAAhBA,EAAOE,MAA4C,kBAAhBF,EAAOE,MAGtD,IAAKF,EAEH,YADAG,8BAA8B,CAAC,CAAED,KAAM,gBAAiBE,SAAS,KAInE,MAAMC,ID3BF5C,EAAE,wEAAwEE,KAAK,WC6B/E0C,KADkC,kBAAhBL,EAAOE,QAK3BF,EAAOE,KADLG,EACY,gBAEA,gBAEhBC,qBAAqBR,KAEvB,IACA,CAAES,UAAU,IAEdd,QAAQe,cAAcC,iBAAkBd,GACxCA,MAEFlC,EAAEiD,QAAQC,GAAG,WAAY,IAAMrD,GAAkB","sources":["src://tavern_helper_template/src/酒馆助手/禁用酒馆助手宏和提示词模板/toggle.ts","src://tavern_helper_template/src/酒馆助手/禁用酒馆助手宏和提示词模板/index.ts","src://tavern_helper_template/util/script.ts"],"sourcesContent":["export function isEjsAndMacroEnabled(): boolean {\n  return !$('#macro-replace-disable-toggle, #TH-macro-enabled, #TH-macro-disabled').prop('checked');\n}\n\nexport function toggleEjsAndMacro(enable: boolean) {\n  // 酒馆助手 3.0\n  const $macro_replace_disable_toggle = $('#macro-replace-disable-toggle');\n  if ($macro_replace_disable_toggle.length > 0 && $macro_replace_disable_toggle.prop('checked') !== !enable) {\n    $macro_replace_disable_toggle.prop('checked', !enable)[0].dispatchEvent(new Event('click'));\n  }\n\n  // 酒馆助手 4.0\n  const $TH_macro_disabled = $('#TH-macro-enabled, #TH-macro-disabled');\n  if ($TH_macro_disabled.length > 0 && $TH_macro_disabled.prop('checked') !== !enable) {\n    $TH_macro_disabled.trigger('click');\n  }\n\n  if (EjsTemplate) {\n    EjsTemplate.setFeatures({\n      enabled: enable,\n      generate_enabled: true,\n      generate_loader_enabled: true,\n      inject_loader_enabled: true,\n      render_enabled: false,\n      render_loader_enabled: false,\n      code_blocks_enabled: false,\n      raw_message_evaluation_enabled: false,\n      filter_message_enabled: false,\n      autosave_enabled: false,\n      preload_worldinfo_enabled: false,\n      invert_enabled: true,\n      compile_workers: false,\n      sandbox: false,\n    });\n  }\n}\n","import { loadReadme } from '@util/script';\nimport { isEjsAndMacroEnabled, toggleEjsAndMacro } from './toggle';\n\n$(() => {\n  loadReadme(\n    'https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/禁用酒馆助手宏和提示词模板/README.md',\n  );\n  toggleEjsAndMacro(false);\n\n  eventOn(getButtonEvent('禁用酒馆助手宏和提示词模板'), () => {\n    toggleEjsAndMacro(false);\n  });\n  eventOn(getButtonEvent('启用酒馆助手宏和提示词模板'), () => {\n    toggleEjsAndMacro(true);\n  });\n\n  const checkStatusAndSetButtons = _.throttle(\n    () => {\n      const buttons = getScriptButtons();\n      const button = buttons.find(\n        button => button.name === '启用酒馆助手宏和提示词模板' || button.name === '禁用酒馆助手宏和提示词模板',\n      );\n\n      if (!button) {\n        appendInexistentScriptButtons([{ name: '启用酒馆助手宏和提示词模板', visible: true }]);\n        return;\n      }\n\n      const is_disabled = !isEjsAndMacroEnabled();\n      const should_enable = button.name === '启用酒馆助手宏和提示词模板';\n      if (is_disabled === should_enable) {\n        return;\n      }\n      if (is_disabled) {\n        button.name = '启用酒馆助手宏和提示词模板';\n      } else {\n        button.name = '禁用酒馆助手宏和提示词模板';\n      }\n      replaceScriptButtons(buttons);\n    },\n    1000,\n    { trailing: false },\n  );\n  eventOn(tavern_events.SETTINGS_UPDATED, checkStatusAndSetButtons);\n  checkStatusAndSetButtons();\n});\n$(window).on('pagehide', () => toggleEjsAndMacro(true));\n","import iframe_srcdoc from './iframe_srcdoc.html';\n\nexport async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle(\n  append_to: JQuery.Selector | JQuery.htmlString | JQuery.TypeOrArray<Element | DocumentFragment> | JQuery = 'head',\n): { destroy: () => void } {\n  const $div = $(`<div>`)\n    .attr('script_id', getScriptId())\n    .append($(`head > style`, document).clone())\n    .appendTo(append_to);\n\n  return {\n    destroy: () => $div.remove(),\n  };\n}\n\nexport function createScriptIdIframe(): JQuery<HTMLIFrameElement> {\n  return $(`<iframe>`).attr({\n    script_id: getScriptId(),\n    frameborder: 0,\n    srcdoc: iframe_srcdoc,\n  }) as JQuery<HTMLIFrameElement>;\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, new_chat_id => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n\nexport function registerAsUniqueScript(id: string): {\n  unregister: () => void;\n  getPreferredScriptId: () => string | undefined;\n  listenPreferenceState: (callback: (perferred_script_id: string) => void) => EventOnReturn;\n} {\n  const script_id = getScriptId();\n  const path = `th_unique_check.${id}`;\n\n  const getPreferredScriptId = () => {\n    const registered_scripts = _.get(window.parent, path, new Set<string>());\n    return _($('#tavern_helper').find('div[data-script-id]').toArray())\n      .map(element => String($(element).attr('data-script-id')))\n      .filter(element => registered_scripts.has(element))\n      .last();\n  };\n\n  _.update(window.parent, path, (value: Set<string> | undefined) => {\n    if (value === undefined) {\n      return new Set([script_id]);\n    }\n    value.add(script_id);\n    return value;\n  });\n  eventEmit(path, getPreferredScriptId());\n\n  return {\n    unregister: () => {\n      _.update(window.parent, path, (value: Set<string> | undefined) => {\n        if (value !== undefined) {\n          value.delete(script_id);\n        }\n        return value;\n      });\n      eventEmit(path, getPreferredScriptId());\n    },\n    getPreferredScriptId,\n    listenPreferenceState: (callback: (enabled_script_id: string) => void) => eventOn(path, callback),\n  };\n}\n"],"names":["toggleEjsAndMacro","enable","$macro_replace_disable_toggle","$","length","prop","dispatchEvent","Event","$TH_macro_disabled","trigger","EjsTemplate","setFeatures","enabled","generate_enabled","generate_loader_enabled","inject_loader_enabled","render_enabled","render_loader_enabled","code_blocks_enabled","raw_message_evaluation_enabled","filter_message_enabled","autosave_enabled","preload_worldinfo_enabled","invert_enabled","compile_workers","sandbox","async","url","readme","fetch","ok","readme_text","text","replaceScriptInfo","loadReadme","eventOn","getButtonEvent","checkStatusAndSetButtons","_","throttle","buttons","getScriptButtons","button","find","name","appendInexistentScriptButtons","visible","is_disabled","replaceScriptButtons","trailing","tavern_events","SETTINGS_UPDATED","window","on"],"sourceRoot":""}