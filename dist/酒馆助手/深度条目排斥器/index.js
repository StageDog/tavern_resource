import{compare as e}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/json5/+esm';import'https://testingcf.jsdelivr.net/npm/jsonrepair/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';import{defineStore as t}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as n}from'https://testingcf.jsdelivr.net/npm/klona/+esm';function s(e,t){if(!e)return null;const n=(e,n)=>(t&&(e=substitudeMacros(e)),new RegExp(e,n));try{const t=e.match(/\/(.+)\/([a-z]*)/i);if(!t)return n(_.escapeRegExp(e),'i');if(t[2]&&!/^(?!.*?(.).*?\1)[gmixXsuUAJ]+$/.test(t[3]))return n(e,'i');let s=t[2]??'';return _.pull(s,'g'),-1===s.indexOf('i')&&(s+='i'),n(t[1],s)}catch{return null}}function r(e){const t=getScriptId(),n=`th_unique_check.${e}`,s=()=>{const e=_.get(window.parent,n,new Set);return _($('#tavern_helper').find('div[data-script-id]').toArray()).map(e=>String($(e).attr('data-script-id'))).filter(t=>e.has(t)).last()};return _.update(window.parent,n,e=>void 0===e?new Set([t]):(e.add(t),e)),eventEmit(n,s()),{unregister:()=>{_.update(window.parent,n,e=>(void 0!==e&&e.delete(t),e)),eventEmit(n,s())},getPreferredScriptId:s,listenPreferenceState:e=>eventOn(n,e)}}function i(e){return _(e).split('\n').dropWhile(e=>!e.trim()).dropRightWhile(e=>!e.trim()).join('\n')}function a(e){return e.filter(({content:e})=>''!==e.trim())}function o(e,t){return function(e,t){if(0===e.length)return[];const n=[[e[0]]];for(const[s,r]of _.zip(_.dropRight(e),_.drop(e)))t(s,r)?n[n.length-1].push(r):n.push([r]);return n}(e,(e,t)=>e.role===t.role).map(e=>({role:e[0].role,content:e.map(({content:e})=>i(e)).join(t.delimiter.value)}))}function c(t,n,r){const c=({prompt:e},s)=>{if(s||!r())return;if(e.some(({content:e})=>'string'!=typeof e))return;const c=function(e,t){const n=e.findIndex(({content:e})=>e.includes(t.head.content)),s=e.findIndex(({content:e})=>e.includes(t.deep.content)),r=e.findIndex(({content:e})=>e.includes(t.tail.content));if(-1===n||-1===s||-1===r)return null;const i=(t,n,s,r)=>{if(n!==s)return e[s].content.split(r);const i=t[1].split(r);return t[1]='',i},a=i(['',''],-1,n,t.head.content),o=i(a,n,s,t.deep.content),c=i(o,s,r,t.tail.content);return[[...e.slice(0,n),{role:e[n].role,content:a[0]}],[{role:e[n].role,content:a[1]},...e.slice(n+1,s),{role:e[s].role,content:o[0]}],[{role:e[s].role,content:o[1]},...e.slice(s+1,r),{role:e[r].role,content:c[0]}],[{role:e[r].role,content:c[1]},...e.slice(r+1)]]}(e,n);if(null===c)return;const{above:l,below:u}=t.depth_injection,d=(e,n,s)=>{if(!e.enabled)return;const r=e=>!('system'!==e.role||l.enabled&&'placeholder'===l.type&&e.content.includes(l.placeholder)||u.enabled&&'placeholder'===u.type&&e.content.includes(u.placeholder)),o='placeholder'===e.type?a(c[n]).filter(r).map(e=>i(e.content)).join(t.delimiter.value):'';if('placeholder'===e.type&&_(c).flatten().some(t=>t.content.includes(e.placeholder)))_.remove(c[n],r);else{const e=_.remove(c[n],e=>'system'===e.role);c[s]=s<n?_.concat(c[s],e):_.concat(e,c[s])}_(c).flatten().filter(t=>t.content.includes(e.placeholder)).forEach(t=>{t.content=t.content.replaceAll(e.placeholder,o)})};d(l,1,0),d(u,2,3);const[p,f,h,m]=_(c).map(e=>a(e)).map(e=>o(e,t)).value();let v;switch(t.chat_history.type){case'squash_nearby':v=o(_.concat(p,f,h,m),t);break;case'squash_into_one':v=_.concat(p,function(e,t){const n=substitudeMacros(t.chat_history.system_prefix),s=substitudeMacros(t.chat_history.system_suffix),r=substitudeMacros(t.chat_history.assistant_prefix),a=substitudeMacros(t.chat_history.assistant_suffix),o=substitudeMacros(t.chat_history.user_prefix),c=substitudeMacros(t.chat_history.user_suffix);return{role:t.chat_history.squash_role,content:e.map(({role:e,content:t})=>{const l=i(t);switch(e){case'system':return n+l+s;case'assistant':return r+l+a;case'user':return o+l+c}}).join(t.delimiter.value)}}(_.concat(f,h),t),m)}var g,y;y=v,(g=e).length=0,g.push(...y)},l=({messages:e})=>{c({prompt:e},!1)};e(getTavernVersion(),'1.13.4','>')?eventOn(tavern_events.GENERATE_AFTER_DATA,c):eventOn(tavern_events.CHAT_COMPLETION_SETTINGS_READY,l);const u=e=>{if(!t.stop_string||!r())return;const n=s(t.stop_string,!0);n&&n.test(e)&&SillyTavern.stopGeneration()};eventOn(tavern_events.STREAM_TOKEN_RECEIVED,u);const d=async e=>{if(!t.stop_string||!r())return;const n=SillyTavern.chat[Number(e)],i=s(t.stop_string,!0);if(!i)return;const a=n.mes.match(i);a&&(n.mes=n.mes.slice(0,a.index),n.swipes&&_.set(n,['swipes',n.swipe_id],n.mes),SillyTavern.updateMessageBlock(Number(e),n),await SillyTavern.saveChat())};return eventOn(tavern_events.MESSAGE_RECEIVED,d),{unlisten:()=>{eventRemoveListener(tavern_events.GENERATE_AFTER_DATA,c),eventRemoveListener(tavern_events.CHAT_COMPLETION_SETTINGS_READY,l),eventRemoveListener(tavern_events.STREAM_TOKEN_RECEIVED,u),eventRemoveListener(tavern_events.MESSAGE_RECEIVED,d)}}}function l(e){const{unregister:t,getPreferredScriptId:n}=r('压缩相邻消息'),{separators:s,uninject:i}=function(e){const t=Object.freeze({head:{id:'\0压缩相邻消息-聊天记录开头',position:'in_chat',depth:9999,role:'assistant',content:'【【压缩相邻消息-聊天记录开头】】'},deep:{id:'ÿ压缩相邻消息-Dx',position:'in_chat',depth:e.depth_injection.threshold,role:'system',content:'【【压缩相邻消息-Dx】】'},tail:{id:'ÿ压缩相邻消息-聊天记录结尾',position:'in_chat',depth:0,role:'system',content:'【【压缩相邻消息-聊天记录结尾】】'}}),n=(e,n,s)=>{s||injectPrompts(Object.values(t))};return eventOn(tavern_events.GENERATION_AFTER_COMMANDS,n),{separators:t,uninject:()=>{eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS,n),uninjectPrompts(Object.values(t).map(({id:e})=>e))}}}(e),{unlisten:a}=c(e,s,()=>n()===getScriptId());return{destroy:()=>{t(),a(),i()}}}const u=z,d=Vue,p=u.z.object({name:u.z.string().default('压缩相邻消息'),seperator:u.z.object({type:u.z.enum(['space','newline','double newline','custom']).default('double newline'),value:u.z.string().default('\n\n')}).prefault({}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),put_system_injection_after_chat_history:u.z.boolean().default(!1),on_chat_history:u.z.object({type:u.z.enum(['mixin','seperate','squash']).default('squash'),squash_role:u.z.enum(['user','assistant','system']).default('assistant'),user_prefix:u.z.string().default('[{{user}}]\n'),user_suffix:u.z.string().default('\n[/{{user}}]'),assistant_prefix:u.z.string().default('[剧情]\n'),assistant_suffix:u.z.string().default('\n[/剧情]'),system_prefix:u.z.string().default('[设定]\n'),system_suffix:u.z.string().default('\n[/设定]')}).prefault({}),stop_string:u.z.string().default('<|im_end|>').catch('<|im_end|>')}).transform(e=>f.parse({delimiter:e.seperator,stop_string:e.stop_string,depth_injection:{threshold:10,above:{enabled:e.put_system_injection_after_chat_history,type:'exclude',placeholder:'{{压缩相邻消息::above_dx}}'},below:{enabled:e.put_system_injection_after_chat_history,type:'exclude',placeholder:'{{压缩相邻消息::below_dx}}'}},chat_history:{...e.on_chat_history,type:'squash'===e.on_chat_history.type?'squash_into_one':'squash_nearby'}})),f=u.z.object({delimiter:u.z.object({type:u.z.enum(['space','newline','double newline','custom']).default('double newline'),value:u.z.string().default('\n\n')}).prefault({}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),stop_string:u.z.string().default('<|im_end|>').catch('<|im_end|>'),depth_injection:u.z.object({threshold:u.z.number().int().min(1).default(10).catch(10),above:u.z.object({enabled:u.z.boolean().default(!1),type:u.z.enum(['exclude','placeholder']).default('exclude'),placeholder:u.z.string().default('{{压缩相邻消息::above_dx}}')}).prefault({}),below:u.z.object({enabled:u.z.boolean().default(!1),type:u.z.enum(['exclude','placeholder']).default('exclude'),placeholder:u.z.string().default('{{压缩相邻消息::below_dx}}')}).prefault({})}).prefault({}),chat_history:u.z.object({type:u.z.enum(['squash_nearby','squash_into_one']).default('squash_into_one'),squash_role:u.z.enum(['user','assistant','system']).default('assistant'),user_prefix:u.z.string().default('[{{user}}]\n'),user_suffix:u.z.string().default('\n[/{{user}}]'),assistant_prefix:u.z.string().default('[剧情]\n'),assistant_suffix:u.z.string().default('\n[/剧情]'),system_prefix:u.z.string().default('[设定]\n'),system_suffix:u.z.string().default('\n[/设定]')}).prefault({})}).prefault({});t('settings',()=>{const e=getVariables({type:'script',script_id:getScriptId()}),t=(0,d.ref)((_.has(e,'seperator')?p:f).parse(e)),s=(0,d.ref)(!1);r('压缩相邻消息').listenPreferenceState(e=>{s.value=e===getScriptId()}),(0,d.watchEffect)(()=>{insertOrAssignVariables(n(t.value),{type:'script',script_id:getScriptId()})});return{settings:t,should_enable:s,useEscapedNewline:e=>(0,d.computed)({get:()=>_.get(t.value,e).replace(/\n/g,'\\n'),set:n=>_.set(t.value,e,n.replace(/\\n/g,'\n'))})}});$(()=>{!async function(t,n){e(await getTavernHelperVersion(),t,'<')&&toastr.error(`'${n}' 需要酒馆助手版本 >= '${t}'`,'版本不兼容')}('3.4.17','深度条目排斥器'),async function(e){const t=await fetch(e);if(!t.ok)return!1;const n=await t.text();replaceScriptInfo(n)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/深度条目排斥器/README.md');const{destroy:t}=l(f.decode({name:'深度排斥器',depth_injection:{above:{enabled:!0,type:'exclude'},below:{enabled:!0,type:'exclude'}},chat_history:{type:'mixin'}}));$(window).on('pagehide',()=>{t()})});
//# sourceMappingURL=index.js.map