import{compare as e}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';import{defineStore as t}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as n}from'https://testingcf.jsdelivr.net/npm/klona/+esm';function s(e,t){return e.length=0,e.push(...t),e}function r(e){if(!e)return null;try{const t=e.match(/\/(.+)\/([a-z]*)/i);if(!t)return new RegExp(_.escapeRegExp(e),'gi');if(t[3]&&!/^(?!.*?(.).*?\1)[gmixXsuUAJ]+$/.test(t[3]))return new RegExp(e,'gi');let n=t[3];return-1===n.indexOf('g')&&(n+='g'),-1===n.indexOf('i')&&(n+='i'),new RegExp(t[2],n)}catch{return null}}function i(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const t=16*Math.random()|0;return('x'===e?t:3&t|8).toString(16)})}const o=Vue,a=z,c=a.z.object({name:a.z.string().default('压缩相邻消息'),seperator:a.z.object({type:a.z.enum(['space','newline','double newline','custom']).default('double newline'),value:a.z.string().default('\n\n')}).prefault({}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),put_system_injection_after_chat_history:a.z.boolean().default(!1),on_chat_history:a.z.object({type:a.z.enum(['mixin','seperate','squash']).default('squash'),squash_role:a.z.enum(['user','assistant','system']).default('assistant'),user_prefix:a.z.string().default('{{user}}: '),user_suffix:a.z.string().default(''),assistant_prefix:a.z.string().default('剧情: '),assistant_suffix:a.z.string().default(''),system_prefix:a.z.string().default(''),system_suffix:a.z.string().default('')}).prefault({}),stop_string:a.z.string().default('').catch('')});t('settings',()=>{const e=(0,o.ref)(c.parse(getVariables({type:'script',script_id:getScriptId()})));return(0,o.watchEffect)(()=>{insertOrAssignVariables(n(e.value),{type:'script',script_id:getScriptId()})}),{settings:e}});function u(e,t){return function(e,t){if(0===e.length)return[];const n=[[e[0]]];for(const[s,r]of _.zip(_.dropRight(e),_.drop(e)))t(s,r)?n[n.length-1].push(r):n.push([r]);return n}(e,(e,t)=>e.role===t.role).map(e=>({role:e[0].role,content:e.map(({content:e})=>e.trim()).join(t.seperator.value)}))}function l(t,n){const i=({prompt:e},r)=>{if(r)return;if(e.some(({content:e})=>'string'!=typeof e))return;const i=function(e,t){const n=e.findIndex(({content:e})=>e.includes(t.head.content)),s=e.findIndex(({content:e})=>e.includes(t.deep.content)),r=e.findIndex(({content:e})=>e.includes(t.tail.content));if(-1===n||-1===s||-1===r)return null;const[i,o]=e[n].content.split(t.head.content),[a,c]=e[s].content.split(t.deep.content),[u,l]=e[r].content.split(t.tail.content);return[[...e.slice(0,n),{role:e[n].role,content:i}],[{role:e[n].role,content:o},...e.slice(n+1,s),{role:e[s].role,content:a}],[{role:e[s].role,content:c},...e.slice(s+1,r),{role:e[r].role,content:u}],[{role:e[r].role,content:l},...e.slice(r+1)]]}(e,n);if(null===i)return;t.put_system_injection_after_chat_history&&(i[0]=_.concat(i[0],_.remove(i[1],({role:e})=>'system'===e)),i[3]=_.concat(_.remove(i[2],({role:e})=>'system'===e),i[3]));const[o,a,c,l]=_(i).map(e=>function(e){return e.filter(({content:e})=>''!==e.trim())}(e)).map(e=>u(e,t)).value();switch(t.on_chat_history.type){case'mixin':s(e,u(_.concat(o,a,c,l),t));break;case'seperate':s(e,_.concat(o,u(_.concat(a,c),t),l));break;case'squash':s(e,_.concat(o,function(e,t){const n=substitudeMacros(t.on_chat_history.system_prefix),s=substitudeMacros(t.on_chat_history.system_suffix),r=substitudeMacros(t.on_chat_history.assistant_prefix),i=substitudeMacros(t.on_chat_history.assistant_suffix),o=substitudeMacros(t.on_chat_history.user_prefix),a=substitudeMacros(t.on_chat_history.user_suffix);return{role:t.on_chat_history.squash_role,content:e.map(({role:e,content:t})=>{switch(e){case'system':return n+t.trim()+s;case'assistant':return r+t.trim()+i;case'user':return o+t.trim()+a}}).join(t.seperator.value)}}(_.concat(a,c),t),l))}},o=({messages:e})=>{i({prompt:e},!1)};e(getTavernVersion(),'1.13.4','>')?eventMakeFirst(tavern_events.GENERATE_AFTER_DATA,i):eventMakeFirst(tavern_events.CHAT_COMPLETION_SETTINGS_READY,o);const a=e=>{if(!t.stop_string)return;const n=r(t.stop_string);n&&n.test(e)&&SillyTavern.stopGeneration()};eventMakeFirst(tavern_events.STREAM_TOKEN_RECEIVED,a);const c=async e=>{if(!t.stop_string)return;const n=SillyTavern.chat[Number(e)],s=r(t.stop_string);if(!s)return;const i=s.exec(n.mes);i&&(n.mes=n.mes.slice(0,i.index),n.swipes&&_.set(n,['swipes',n.swipe_id],n.mes),SillyTavern.updateMessageBlock(Number(e),n),await SillyTavern.saveChat())};return eventMakeFirst(tavern_events.MESSAGE_RECEIVED,c),{unlisten:()=>{eventRemoveListener(tavern_events.GENERATE_AFTER_DATA,i),eventRemoveListener(tavern_events.CHAT_COMPLETION_SETTINGS_READY,o),eventRemoveListener(tavern_events.STREAM_TOKEN_RECEIVED,a),eventRemoveListener(tavern_events.MESSAGE_RECEIVED,c)}}}function p(e){const{seperators:t,uninject:n}=function(e){const t=Object.freeze({head:{id:`\0${e.name}`,position:'in_chat',depth:9999,role:'assistant',content:i()},deep:{id:`ÿ${e.name}深度分割`,position:'in_chat',depth:10,role:'system',content:i()},tail:{id:`ÿ${e.name}`,position:'in_chat',depth:0,role:'system',content:i()}}),n=(e,n,s)=>{s||injectPrompts(Object.values(t))};return eventOn(tavern_events.GENERATION_AFTER_COMMANDS,n),{seperators:t,uninject:()=>{eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS,n),uninjectPrompts(Object.values(t).map(({id:e})=>e))}}}(e),{unlisten:s}=l(e,t);return{destroy:()=>{n(),s()}}}$(()=>{!async function(t,n){e(await getTavernHelperVersion(),t,'<')&&toastr.error(`'${n}' 需要酒馆助手版本 >= '${t}'`,'版本不兼容')}('3.4.17','深度条目排斥器'),async function(e){const t=await fetch(e);if(!t.ok)return!1;const n=await t.text();replaceScriptInfo(n)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/深度条目排斥器/README.md');const{destroy:t}=p(c.decode({name:'深度排斥器',put_system_injection_after_chat_history:!0,on_chat_history:{type:'mixin'}}));$(window).on('pagehide',()=>{t()})});
//# sourceMappingURL=index.js.map