import{compare as t}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import{defineStore as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as n}from'https://testingcf.jsdelivr.net/npm/klona/+esm';function s(t,e){return t.length=0,t.push(...e),t}function r(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(t){const e=16*Math.random()|0;return('x'===t?e:3&e|8).toString(16)})}const o=Vue,i=z,a=i.z.object({name:i.z.string().default('压缩相邻消息'),seperator:i.z.object({type:i.z.enum(['space','newline','double newline','custom']).default('double newline'),value:i.z.string().default('\n\n')}).prefault({}).transform(t=>{switch(t.type){case'space':t.value=' ';break;case'newline':t.value='\n';break;case'double newline':t.value='\n\n'}return t}),put_system_injection_after_chat_history:i.z.boolean().default(!1),on_chat_history:i.z.object({type:i.z.enum(['mixin','seperate','squash']).default('squash'),squash_role:i.z.enum(['user','assistant','system']).default('assistant'),user_prefix:i.z.string().default('{{user}}: '),user_suffix:i.z.string().default(''),assistant_prefix:i.z.string().default('剧情: '),assistant_suffix:i.z.string().default(''),system_prefix:i.z.string().default(''),system_suffix:i.z.string().default('')}).prefault({})});e('settings',()=>{const t=(0,o.ref)(a.parse(getVariables({type:'script',script_id:getScriptId()})));return(0,o.watchEffect)(()=>{insertOrAssignVariables(n(t.value),{type:'script',script_id:getScriptId()})}),{settings:t}});function c(t,e){return function(t,e){if(0===t.length)return[];const n=[[t[0]]];for(const[s,r]of _.zip(_.dropRight(t),_.drop(t)))e(s,r)?n[n.length-1].push(r):n.push([r]);return n}(t,(t,e)=>t.role===e.role).map(t=>({role:t[0].role,content:t.map(({content:t})=>t.trim()).join(e.seperator.value)}))}function u(t,e){let n=!1;const r=(t,e,s)=>{n=s};eventOn(tavern_events.GENERATION_AFTER_COMMANDS,r);const o=({prompt:r},o)=>{if(o??n)return;if(r.some(({content:t})=>'string'!=typeof t))return;const i=function(t,e){const n=t.findIndex(({content:t})=>t.includes(e.head.content)),s=t.findIndex(({content:t})=>t.includes(e.deep.content)),r=t.findIndex(({content:t})=>t.includes(e.tail.content));if(-1===n||-1===s||-1===r)return null;const[o,i]=t[n].content.split(e.head.content),[a,c]=t[s].content.split(e.deep.content),[u,l]=t[r].content.split(e.tail.content);return[[...t.slice(0,n),{role:t[n].role,content:o}],[{role:t[n].role,content:i},...t.slice(n+1,s),{role:t[s].role,content:a}],[{role:t[s].role,content:c},...t.slice(s+1,r),{role:t[r].role,content:u}],[{role:t[r].role,content:l},...t.slice(r+1)]]}(r,e);if(null===i)return;t.put_system_injection_after_chat_history&&(i[0]=_.concat(i[0],_.remove(i[1],({role:t})=>'system'===t)),i[3]=_.concat(_.remove(i[2],({role:t})=>'system'===t),i[3]));const[a,u,l,p]=_(i).map(t=>function(t){return t.filter(({content:t})=>''!==t.trim())}(t)).map(e=>c(e,t)).value();switch(t.on_chat_history.type){case'mixin':s(r,c(_.concat(a,u,l,p),t));break;case'seperate':s(r,_.concat(a,c(_.concat(u,l),t),p));break;case'squash':s(r,_.concat(a,function(t,e){const n=substitudeMacros(e.on_chat_history.system_prefix),s=substitudeMacros(e.on_chat_history.system_suffix),r=substitudeMacros(e.on_chat_history.assistant_prefix),o=substitudeMacros(e.on_chat_history.assistant_suffix),i=substitudeMacros(e.on_chat_history.user_prefix),a=substitudeMacros(e.on_chat_history.user_suffix);return{role:e.on_chat_history.squash_role,content:t.map(({role:t,content:e})=>{switch(t){case'system':return n+e.trim()+s;case'assistant':return r+e.trim()+o;case'user':return i+e.trim()+a}}).join(e.seperator.value)}}(_.concat(u,l),t),p))}};return eventOn(tavern_events.GENERATE_AFTER_DATA,o),{unlisten:()=>{eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS,r),eventRemoveListener(tavern_events.GENERATE_AFTER_DATA,o)}}}function l(t){const{seperators:e,uninject:n}=function(t){const e=Object.freeze({head:{id:`\0${t.name}`,position:'in_chat',depth:9999,role:'assistant',content:r()},deep:{id:`ÿ${t.name}深度分割`,position:'in_chat',depth:10,role:'system',content:r()},tail:{id:`ÿ${t.name}`,position:'in_chat',depth:0,role:'system',content:r()}}),n=(t,n,s)=>{s||injectPrompts(Object.values(e))};return eventOn(tavern_events.GENERATION_AFTER_COMMANDS,n),{seperators:e,uninject:()=>{eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS,n),uninjectPrompts(Object.values(e).map(({id:t})=>t))}}}(t),{unlisten:s}=u(t,e);return{destroy:()=>{n(),s()}}}$(()=>{!async function(e,n){t(await getTavernHelperVersion(),e,'<')&&toastr.error(`'${n}' 需要酒馆助手版本 >= '${e}'`,'版本不兼容')}('3.4.17','深度条目排斥器'),async function(t){const e=await fetch(t);if(!e.ok)return!1;const n=await e.text();replaceScriptInfo(n)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/深度条目排斥器/README.md');const{destroy:e}=l(a.decode({name:'深度排斥器',put_system_injection_after_chat_history:!0,on_chat_history:{type:'mixin'}}));$(window).on('pagehide',()=>{e()})});
//# sourceMappingURL=index.js.map