import{defineStore as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as t}from'https://testingcf.jsdelivr.net/npm/klona/+esm';import{compare as n}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';const s=Vue,r=z,i=r.z.object({name:r.z.string().default('压缩相邻消息'),seperator:r.z.object({type:r.z.enum(['space','newline','double newline','custom']).default('double newline'),value:r.z.string().default('\n\n')}).prefault({}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),put_system_injection_after_chat_history:r.z.boolean().default(!1),on_chat_history:r.z.object({type:r.z.enum(['mixin','seperate','squash']).default('squash'),squash_role:r.z.enum(['user','assistant','system']).default('assistant'),user_prefix:r.z.string().default('[{{user}}]\n'),user_suffix:r.z.string().default('\n[/{{user}}]'),assistant_prefix:r.z.string().default('[剧情]\n'),assistant_suffix:r.z.string().default('\n[/剧情]'),system_prefix:r.z.string().default('[设定]\n'),system_suffix:r.z.string().default('\n[/设定]')}).prefault({}),stop_string:r.z.string().default('<|im_end|>').catch('<|im_end|>')});e('settings',()=>{const e=(0,s.ref)(i.parse(getVariables({type:'script',script_id:getScriptId()})));return(0,s.watchEffect)(()=>{insertOrAssignVariables(t(e.value),{type:'script',script_id:getScriptId()})}),{settings:e}});function o(e,t){return e.length=0,e.push(...t),e}function a(e){if(!e)return null;try{const t=e.match(/\/(.+)\/([a-z]*)/i);if(!t)return new RegExp(_.escapeRegExp(e),'i');if(t[2]&&!/^(?!.*?(.).*?\1)[gmixXsuUAJ]+$/.test(t[3]))return new RegExp(e,'i');let n=t[2]??'';return _.pull(n,'g'),-1===n.indexOf('i')&&(n+='i'),new RegExp(t[1],n)}catch{return null}}function c(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const t=16*Math.random()|0;return('x'===e?t:3&t|8).toString(16)})}function u(e,t){return function(e,t){if(0===e.length)return[];const n=[[e[0]]];for(const[s,r]of _.zip(_.dropRight(e),_.drop(e)))t(s,r)?n[n.length-1].push(r):n.push([r]);return n}(e,(e,t)=>e.role===t.role).map(e=>({role:e[0].role,content:e.map(({content:e})=>e.trim()).join(t.seperator.value)}))}function l(e,t){const s=({prompt:n},s)=>{if(s)return;if(n.some(({content:e})=>'string'!=typeof e))return;const r=function(e,t){const n=e.findIndex(({content:e})=>e.includes(t.head.content)),s=e.findIndex(({content:e})=>e.includes(t.deep.content)),r=e.findIndex(({content:e})=>e.includes(t.tail.content));if(-1===n||-1===s||-1===r)return null;const i=(t,n,s,r)=>{if(n!==s)return e[s].content.split(r);const i=t[1].split(r);return t[1]='',i},o=i(['',''],-1,n,t.head.content),a=i(o,n,s,t.deep.content),c=i(a,s,r,t.tail.content);return[[...e.slice(0,n),{role:e[n].role,content:o[0]}],[{role:e[n].role,content:o[1]},...e.slice(n+1,s),{role:e[s].role,content:a[0]}],[{role:e[s].role,content:a[1]},...e.slice(s+1,r),{role:e[r].role,content:c[0]}],[{role:e[r].role,content:c[1]},...e.slice(r+1)]]}(n,t);if(null===r)return;e.put_system_injection_after_chat_history&&(r[0]=_.concat(r[0],_.remove(r[1],({role:e})=>'system'===e)),r[3]=_.concat(_.remove(r[2],({role:e})=>'system'===e),r[3]));const[i,a,c,l]=_(r).map(e=>function(e){return e.filter(({content:e})=>''!==e.trim())}(e)).map(t=>u(t,e)).value();switch(e.on_chat_history.type){case'mixin':o(n,u(_.concat(i,a,c,l),e));break;case'seperate':o(n,_.concat(i,u(_.concat(a,c),e),l));break;case'squash':o(n,_.concat(i,function(e,t){const n=substitudeMacros(t.on_chat_history.system_prefix),s=substitudeMacros(t.on_chat_history.system_suffix),r=substitudeMacros(t.on_chat_history.assistant_prefix),i=substitudeMacros(t.on_chat_history.assistant_suffix),o=substitudeMacros(t.on_chat_history.user_prefix),a=substitudeMacros(t.on_chat_history.user_suffix);return{role:t.on_chat_history.squash_role,content:e.map(({role:e,content:t})=>{switch(e){case'system':return n+t.trim()+s;case'assistant':return r+t.trim()+i;case'user':return o+t.trim()+a}}).join(t.seperator.value)}}(_.concat(a,c),e),l))}},r=({messages:e})=>{s({prompt:e},!1)};n(getTavernVersion(),'1.13.4','>')?eventMakeFirst(tavern_events.GENERATE_AFTER_DATA,s):eventMakeFirst(tavern_events.CHAT_COMPLETION_SETTINGS_READY,r);const i=t=>{if(!e.stop_string)return;const n=a(e.stop_string);n&&n.test(t)&&SillyTavern.stopGeneration()};eventMakeFirst(tavern_events.STREAM_TOKEN_RECEIVED,i);const c=async t=>{if(!e.stop_string)return;const n=SillyTavern.chat[Number(t)],s=a(e.stop_string);if(!s)return;const r=n.mes.match(s);r&&(n.mes=n.mes.slice(0,r.index),n.swipes&&_.set(n,['swipes',n.swipe_id],n.mes),SillyTavern.updateMessageBlock(Number(t),n),await SillyTavern.saveChat())};return eventMakeFirst(tavern_events.MESSAGE_RECEIVED,c),{unlisten:()=>{eventRemoveListener(tavern_events.GENERATE_AFTER_DATA,s),eventRemoveListener(tavern_events.CHAT_COMPLETION_SETTINGS_READY,r),eventRemoveListener(tavern_events.STREAM_TOKEN_RECEIVED,i),eventRemoveListener(tavern_events.MESSAGE_RECEIVED,c)}}}function p(e){const{seperators:t,uninject:n}=function(e){const t=Object.freeze({head:{id:`\0${e.name}`,position:'in_chat',depth:9999,role:'assistant',content:c()},deep:{id:`ÿ${e.name}深度分割`,position:'in_chat',depth:10,role:'system',content:c()},tail:{id:`ÿ${e.name}`,position:'in_chat',depth:0,role:'system',content:c()}}),n=(e,n,s)=>{s||injectPrompts(Object.values(t))};return eventOn(tavern_events.GENERATION_AFTER_COMMANDS,n),{seperators:t,uninject:()=>{eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS,n),uninjectPrompts(Object.values(t).map(({id:e})=>e))}}}(e),{unlisten:s}=l(e,t);return{destroy:()=>{n(),s()}}}$(()=>{!async function(e,t){n(await getTavernHelperVersion(),e,'<')&&toastr.error(`'${t}' 需要酒馆助手版本 >= '${e}'`,'版本不兼容')}('3.4.17','深度条目排斥器'),async function(e){const t=await fetch(e);if(!t.ok)return!1;const n=await t.text();replaceScriptInfo(n)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/深度条目排斥器/README.md');const{destroy:e}=p(i.decode({name:'深度排斥器',put_system_injection_after_chat_history:!0,on_chat_history:{type:'mixin'}}));$(window).on('pagehide',()=>{e()})});
//# sourceMappingURL=index.js.map