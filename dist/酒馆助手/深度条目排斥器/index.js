import{compare as e}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/json5/+esm';import'https://testingcf.jsdelivr.net/npm/jsonrepair/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';import{defineStore as t}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as n}from'https://testingcf.jsdelivr.net/npm/klona/+esm';function s(e,t){if(0===e.length)return[];const n=[[e[0]]];for(const[s,r]of _.zip(_.dropRight(e),_.drop(e)))t(s,r)?n[n.length-1].push(r):n.push([r]);return n}function r(e,t){if(!e)return null;const n=(e,n)=>(t&&(e=substitudeMacros(e)),new RegExp(e,n));try{const t=e.match(/\/(.+)\/([a-z]*)/i);if(!t)return n(_.escapeRegExp(e),'i');if(t[2]&&!/^(?!.*?(.).*?\1)[gmixXsuUAJ]+$/.test(t[3]))return n(e,'i');let s=t[2]??'';return _.pull(s,'g'),-1===s.indexOf('i')&&(s+='i'),n(t[1],s)}catch{return null}}function i(e){const t=(new TextEncoder).encode(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=255-t[e];let s='';for(let e=0;e<n.length;e++){s+=n[e].toString(16).padStart(2,'0')}return s}function o(e){const t=getScriptId(),n=`th_unique_check.${e}`,s=()=>{const e=_.get(window.parent,n,new Set);return _($('#tavern_helper').find('div[data-script-id]').toArray()).map(e=>String($(e).attr('data-script-id'))).filter(t=>e.has(t)).last()};return _.update(window.parent,n,e=>void 0===e?new Set([t]):(e.add(t),e)),eventEmit(n,s()),{unregister:()=>{_.update(window.parent,n,e=>(void 0!==e&&e.delete(t),e)),eventEmit(n,s())},getPreferredScriptId:s,listenPreferenceState:e=>eventOn(n,e)}}function a(e,t){return'string'==typeof e.content?e.content:e.content.filter(({type:e})=>'text'===e).map(({text:e})=>e).join(t.delimiter.value)}function c(e,t,n){const s=t({role:e.role,content:a(e,n)});return'string'==typeof e.content?e.content=s:(_.remove(e.content,e=>'text'===e.type),s&&e.content.splice(0,0,{type:'text',text:s})),e}function l(e,t){return s(e,(e,t)=>e.role===t.role&&'string'==typeof e.content&&'string'==typeof t.content).map(e=>({role:e[0].role,content:1===e.length?e[0].content:e.map(({content:e})=>e).join(t.delimiter.value)}))}function u(t,n,i){const o=({prompt:e},r)=>{if(r||!i())return;const o=function(e,t){const n=e.findIndex(({content:e})=>'string'==typeof e&&e.includes(t.head.content)),s=e.findIndex(({content:e})=>'string'==typeof e&&e.includes(t.deep.content)),r=e.findIndex(({content:e})=>'string'==typeof e&&e.includes(t.tail.content));if(-1===n||-1===s||-1===r)return;const i=(t,n,s,r)=>{if(n!==s)return e[s].content.split(r);const i=t[1].split(r);return t[1]='',i},o=i(['',''],-1,n,t.head.content),a=i(o,n,s,t.deep.content),c=i(a,s,r,t.tail.content);return[[...e.slice(0,n),{role:e[n].role,content:o[0]}],[{role:e[n].role,content:o[1]},...e.slice(n+1,s),{role:e[s].role,content:a[0]}],[{role:e[s].role,content:a[1]},...e.slice(s+1,r),{role:e[r].role,content:c[0]}],[{role:e[r].role,content:c[1]},...e.slice(r+1)]]}(e,n)?.map(e=>{return(n=e,_.reject(n,({content:e})=>'string'==typeof e&&''===e.trim())).map(e=>c(e,({content:e})=>_(e).split('\n').dropWhile(e=>!e.trim()).dropRightWhile(e=>!e.trim()).join('\n'),t));var n});if(!o)return;const{above:u,below:p}=t.depth_injection,d=(e,n,s)=>{if(!e.enabled)return;const r=e=>!('system'!==e.role||u.enabled&&'placeholder'===u.type&&a(e,t).includes(u.placeholder)||p.enabled&&'placeholder'===p.type&&a(e,t).includes(p.placeholder)),i='placeholder'===e.type?o[n].filter(r).map(e=>a(e,t)).join(t.delimiter.value):'';if('placeholder'===e.type&&_(o).flatten().some(n=>a(n,t).includes(e.placeholder)))_.remove(o[n],r);else{const e=_.remove(o[n],e=>'system'===e.role);o[s]=s<n?_.concat(o[s],e):_.concat(e,o[s])}_(o).flatten().filter(n=>a(n,t).includes(e.placeholder)).forEach(n=>{c(n,({content:t})=>t.replaceAll(e.placeholder,i),t)})};d(u,1,0),d(p,2,3);const[f,h,m,v]=o;let g;switch(t.chat_history.type){case'squash_nearby':g=l(_.concat(f,h,m,v),t);break;case'squash_into_one':g=l(_.concat(f,function(e,t){const n={system:substitudeMacros(t.chat_history.system_prefix),assistant:substitudeMacros(t.chat_history.assistant_prefix),user:substitudeMacros(t.chat_history.user_prefix)},r={system:substitudeMacros(t.chat_history.system_suffix),assistant:substitudeMacros(t.chat_history.assistant_suffix),user:substitudeMacros(t.chat_history.user_suffix)},i=e=>c(e,({role:e,content:t})=>(t=t.includes(n[e])?t:n[e]+t).includes(r[e])?t:t+r[e],t);return s(e,(e,t)=>'string'==typeof e.content&&'string'==typeof t.content).map(e=>(e.forEach(i),{role:t.chat_history.squash_role,content:1===e.length?e[0].content:e.map(({content:e})=>e).join(t.delimiter.value)}))}(_.concat(h,m),t),v),t)}var y,b;b=g,(y=e).length=0,y.push(...b)},u=({messages:e})=>{o({prompt:e},!1)};e(getTavernVersion(),'1.13.4','>')?eventOn(tavern_events.GENERATE_AFTER_DATA,o):eventOn(tavern_events.CHAT_COMPLETION_SETTINGS_READY,u);const p=e=>{if(!t.stop_string||!i())return;const n=r(t.stop_string,!0);n&&n.test(e)&&SillyTavern.stopGeneration()};eventOn(tavern_events.STREAM_TOKEN_RECEIVED,p);const d=async e=>{if(!t.stop_string||!i())return;const n=SillyTavern.chat[Number(e)],s=r(t.stop_string,!0);if(!s)return;const o=n.mes.match(s);o&&(n.mes=n.mes.slice(0,o.index),n.swipes&&_.set(n,['swipes',n.swipe_id],n.mes),SillyTavern.updateMessageBlock(Number(e),n),await SillyTavern.saveChat())};return eventOn(tavern_events.MESSAGE_RECEIVED,d),{unlisten:()=>{eventRemoveListener(tavern_events.GENERATE_AFTER_DATA,o),eventRemoveListener(tavern_events.CHAT_COMPLETION_SETTINGS_READY,u),eventRemoveListener(tavern_events.STREAM_TOKEN_RECEIVED,p),eventRemoveListener(tavern_events.MESSAGE_RECEIVED,d)}}}function p(e){const{unregister:t,getPreferredScriptId:n}=o('压缩相邻消息'),{separators:s,uninject:r}=function(e){const t=Object.freeze({head:{id:`\0${i('压缩相邻消息-聊天记录开头')}`,position:'in_chat',depth:9999,role:'assistant',content:'【【压缩相邻消息-聊天记录开头】】'},deep:{id:'ÿ压缩相邻消息-Dx',position:'in_chat',depth:e.depth_injection.threshold,role:'system',content:'【【压缩相邻消息-Dx】】'},tail:{id:'ÿ压缩相邻消息-聊天记录结尾',position:'in_chat',depth:0,role:'system',content:'【【压缩相邻消息-聊天记录结尾】】'}}),n=(e,n,s)=>{s||injectPrompts(Object.values(t))};return eventOn(tavern_events.GENERATION_AFTER_COMMANDS,n),{separators:t,uninject:()=>{eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS,n),uninjectPrompts(Object.values(t).map(({id:e})=>e))}}}(e),{unlisten:a}=u(e,s,()=>n()===getScriptId());return{destroy:()=>{t(),a(),r()}}}const d=z,f=Vue,h=d.z.object({name:d.z.string().default('压缩相邻消息'),seperator:d.z.object({type:d.z.enum(['space','newline','double newline','custom']).default('double newline'),value:d.z.string().default('\n\n')}).prefault({}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),put_system_injection_after_chat_history:d.z.boolean().default(!1),on_chat_history:d.z.object({type:d.z.enum(['mixin','seperate','squash']).default('squash'),squash_role:d.z.enum(['user','assistant','system']).default('assistant'),user_prefix:d.z.string().default('<|im_start|> 下段剧情指令\n'),user_suffix:d.z.string().default('\n<|im_end|>'),assistant_prefix:d.z.string().default('<|im_start|> 剧情\n'),assistant_suffix:d.z.string().default('\n<|im_end|>'),system_prefix:d.z.string().default('<|im_start|> 设定\n'),system_suffix:d.z.string().default('\n<|im_end|>')}).prefault({}),stop_string:d.z.string().default('<|im_end|>').catch('<|im_end|>')}).transform(e=>m.parse({delimiter:e.seperator,stop_string:e.stop_string,depth_injection:{threshold:10,above:{enabled:e.put_system_injection_after_chat_history,type:'exclude',placeholder:'{{压缩相邻消息::above_dx}}'},below:{enabled:e.put_system_injection_after_chat_history,type:'exclude',placeholder:'{{压缩相邻消息::below_dx}}'}},chat_history:{...e.on_chat_history,type:'squash'===e.on_chat_history.type?'squash_into_one':'squash_nearby'}})),m=d.z.object({delimiter:d.z.object({type:d.z.enum(['space','newline','double newline','custom']).default('double newline'),value:d.z.string().default('\n\n')}).prefault({}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),stop_string:d.z.string().default('<|im_end|>').catch('<|im_end|>'),depth_injection:d.z.object({threshold:d.z.number().int().min(1).default(10).catch(10),above:d.z.object({enabled:d.z.boolean().default(!1),type:d.z.enum(['exclude','placeholder']).default('exclude'),placeholder:d.z.string().default('{{压缩相邻消息::above_dx}}')}).prefault({}),below:d.z.object({enabled:d.z.boolean().default(!1),type:d.z.enum(['exclude','placeholder']).default('exclude'),placeholder:d.z.string().default('{{压缩相邻消息::below_dx}}')}).prefault({})}).prefault({}),chat_history:d.z.object({type:d.z.enum(['squash_nearby','squash_into_one']).default('squash_into_one'),squash_role:d.z.enum(['user','assistant','system']).default('assistant'),user_prefix:d.z.string().default('<|im_start|> 下段剧情指令\n'),user_suffix:d.z.string().default('\n<|im_end|>'),assistant_prefix:d.z.string().default('<|im_start|> 剧情\n'),assistant_suffix:d.z.string().default('\n<|im_end|>'),system_prefix:d.z.string().default('<|im_start|> 设定\n'),system_suffix:d.z.string().default('\n<|im_end|>')}).prefault({})}).prefault({});t('settings',()=>{const e=getVariables({type:'script',script_id:getScriptId()}),t=(0,f.ref)((_.has(e,'seperator')?h:m).parse(e)),s=(0,f.ref)(!1);o('压缩相邻消息').listenPreferenceState(e=>{s.value=e===getScriptId()}),(0,f.watchEffect)(()=>{replaceVariables(n(t.value),{type:'script',script_id:getScriptId()})});return{settings:t,should_enable:s,useEscapedNewline:e=>(0,f.computed)({get:()=>_.get(t.value,e).replace(/\n/g,'\\n'),set:n=>_.set(t.value,e,n.replace(/\\n/g,'\n'))})}});$(()=>{!async function(t,n){e(await getTavernHelperVersion(),t,'<')&&toastr.error(`'${n}' 需要酒馆助手版本 >= '${t}'`,'版本不兼容')}('3.4.17','深度条目排斥器'),async function(e){const t=await fetch(e);if(!t.ok)return!1;const n=await t.text();replaceScriptInfo(n)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/深度条目排斥器/README.md');const{destroy:t}=p(m.decode({depth_injection:{above:{enabled:!0,type:'exclude'},below:{enabled:!0,type:'exclude'}},chat_history:{type:'squash_nearby'}}));$(window).on('pagehide',()=>{t()})});
//# sourceMappingURL=index.js.map