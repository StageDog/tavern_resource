import{compare as t}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import{defineStore as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as n}from'https://testingcf.jsdelivr.net/npm/klona/+esm';function s(t,e){return t.length=0,t.push(...e),t}function r(t){try{const e=t.match(/(\/?)(.+)\1([a-z]*)/i);if(!e)return null;if(e[3]&&!/^(?!.*?(.).*?\1)[gmixXsuUAJ]+$/.test(e[3]))return new RegExp(t,'gi');let n=e[3];return-1===n.indexOf('g')&&(n+='g'),-1===n.indexOf('i')&&(n+='i'),new RegExp(e[2],n)}catch{return null}}function i(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(t){const e=16*Math.random()|0;return('x'===t?e:3&e|8).toString(16)})}const o=Vue,a=z,c=a.z.object({name:a.z.string().default('压缩相邻消息'),seperator:a.z.object({type:a.z.enum(['space','newline','double newline','custom']).default('double newline'),value:a.z.string().default('\n\n')}).prefault({}).transform(t=>{switch(t.type){case'space':t.value=' ';break;case'newline':t.value='\n';break;case'double newline':t.value='\n\n'}return t}),put_system_injection_after_chat_history:a.z.boolean().default(!1),on_chat_history:a.z.object({type:a.z.enum(['mixin','seperate','squash']).default('squash'),squash_role:a.z.enum(['user','assistant','system']).default('assistant'),user_prefix:a.z.string().default('{{user}}: '),user_suffix:a.z.string().default(''),assistant_prefix:a.z.string().default('剧情: '),assistant_suffix:a.z.string().default(''),system_prefix:a.z.string().default(''),system_suffix:a.z.string().default('')}).prefault({}),stop_string:a.z.string().default('').catch('')});e('settings',()=>{const t=(0,o.ref)(c.parse(getVariables({type:'script',script_id:getScriptId()})));return(0,o.watchEffect)(()=>{insertOrAssignVariables(n(t.value),{type:'script',script_id:getScriptId()})}),{settings:t}});function u(t,e){return function(t,e){if(0===t.length)return[];const n=[[t[0]]];for(const[s,r]of _.zip(_.dropRight(t),_.drop(t)))e(s,r)?n[n.length-1].push(r):n.push([r]);return n}(t,(t,e)=>t.role===e.role).map(t=>({role:t[0].role,content:t.map(({content:t})=>t.trim()).join(e.seperator.value)}))}function l(t,e){let n=!1;const i=(t,e,s)=>{n=s};eventOn(tavern_events.GENERATION_AFTER_COMMANDS,i);const o=({prompt:r},i)=>{if(i??n)return;if(r.some(({content:t})=>'string'!=typeof t))return;const o=function(t,e){const n=t.findIndex(({content:t})=>t.includes(e.head.content)),s=t.findIndex(({content:t})=>t.includes(e.deep.content)),r=t.findIndex(({content:t})=>t.includes(e.tail.content));if(-1===n||-1===s||-1===r)return null;const[i,o]=t[n].content.split(e.head.content),[a,c]=t[s].content.split(e.deep.content),[u,l]=t[r].content.split(e.tail.content);return[[...t.slice(0,n),{role:t[n].role,content:i}],[{role:t[n].role,content:o},...t.slice(n+1,s),{role:t[s].role,content:a}],[{role:t[s].role,content:c},...t.slice(s+1,r),{role:t[r].role,content:u}],[{role:t[r].role,content:l},...t.slice(r+1)]]}(r,e);if(null===o)return;t.put_system_injection_after_chat_history&&(o[0]=_.concat(o[0],_.remove(o[1],({role:t})=>'system'===t)),o[3]=_.concat(_.remove(o[2],({role:t})=>'system'===t),o[3]));const[a,c,l,p]=_(o).map(t=>function(t){return t.filter(({content:t})=>''!==t.trim())}(t)).map(e=>u(e,t)).value();switch(t.on_chat_history.type){case'mixin':s(r,u(_.concat(a,c,l,p),t));break;case'seperate':s(r,_.concat(a,u(_.concat(c,l),t),p));break;case'squash':s(r,_.concat(a,function(t,e){const n=substitudeMacros(e.on_chat_history.system_prefix),s=substitudeMacros(e.on_chat_history.system_suffix),r=substitudeMacros(e.on_chat_history.assistant_prefix),i=substitudeMacros(e.on_chat_history.assistant_suffix),o=substitudeMacros(e.on_chat_history.user_prefix),a=substitudeMacros(e.on_chat_history.user_suffix);return{role:e.on_chat_history.squash_role,content:t.map(({role:t,content:e})=>{switch(t){case'system':return n+e.trim()+s;case'assistant':return r+e.trim()+i;case'user':return o+e.trim()+a}}).join(e.seperator.value)}}(_.concat(c,l),t),p))}};eventOn(tavern_events.GENERATE_AFTER_DATA,o);eventMakeFirst(tavern_events.STREAM_TOKEN_RECEIVED,e=>{if(!t.stop_string)return;const n=r(t.stop_string);n&&n.test(e)&&SillyTavern.stopGeneration()});return eventMakeFirst(tavern_events.MESSAGE_RECEIVED,async e=>{if(!t.stop_string)return;const n=SillyTavern.chat[Number(e)],s=r(t.stop_string);if(!s)return;const i=n.mes.match(s);i&&(n.mes=n.mes.slice(0,i.index),n.swipes&&_.set(n,['swipes',n.swipe_id],n.mes),SillyTavern.updateMessageBlock(Number(e),n),await SillyTavern.saveChat())}),{unlisten:()=>{eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS,i),eventRemoveListener(tavern_events.GENERATE_AFTER_DATA,o)}}}function p(t){const{seperators:e,uninject:n}=function(t){const e=Object.freeze({head:{id:`\0${t.name}`,position:'in_chat',depth:9999,role:'assistant',content:i()},deep:{id:`ÿ${t.name}深度分割`,position:'in_chat',depth:10,role:'system',content:i()},tail:{id:`ÿ${t.name}`,position:'in_chat',depth:0,role:'system',content:i()}}),n=(t,n,s)=>{s||injectPrompts(Object.values(e))};return eventOn(tavern_events.GENERATION_AFTER_COMMANDS,n),{seperators:e,uninject:()=>{eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS,n),uninjectPrompts(Object.values(e).map(({id:t})=>t))}}}(t),{unlisten:s}=l(t,e);return{destroy:()=>{n(),s()}}}$(()=>{!async function(e,n){t(await getTavernHelperVersion(),e,'<')&&toastr.error(`'${n}' 需要酒馆助手版本 >= '${e}'`,'版本不兼容')}('3.4.17','深度条目排斥器'),async function(t){const e=await fetch(t);if(!e.ok)return!1;const n=await e.text();replaceScriptInfo(n)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/深度条目排斥器/README.md');const{destroy:e}=p(c.decode({name:'深度排斥器',put_system_injection_after_chat_history:!0,on_chat_history:{type:'mixin'}}));$(window).on('pagehide',()=>{e()})});
//# sourceMappingURL=index.js.map