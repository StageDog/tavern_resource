{"version":3,"file":"index.js","mappings":"kZAgBO,SAASA,EAAWC,EAAYC,GACrC,GAAqB,IAAjBD,EAAME,OACR,MAAO,GAGT,MAAMC,EAAgB,CAAC,CAACH,EAAM,KAC9B,IAAK,MAAOI,EAAKC,KAAQC,EAAEC,IAAID,EAAEE,UAAUR,GAAQM,EAAEG,KAAKT,IACpDC,EAAUG,EAAMC,GAClBF,EAAOA,EAAOD,OAAS,GAAGQ,KAAKL,GAE/BF,EAAOO,KAAK,CAACL,IAGjB,OAAOF,CACT,CAEO,SAASQ,EAAgBC,EAAeC,GAC7C,IAAKD,EACH,OAAO,KAET,MAAME,EAAY,CAACC,EAAiBC,KAC9BH,IACFE,EAAUE,iBAAiBF,IAEtB,IAAIG,OAAOH,EAASC,IAE7B,IACE,MAAMG,EAAQP,EAAMO,MAAM,qBAC1B,IAAKA,EACH,OAAOL,EAAUR,EAAEc,aAAaR,GAAQ,KAE1C,GAAIO,EAAM,KAAO,iCAAiCE,KAAKF,EAAM,IAC3D,OAAOL,EAAUF,EAAO,KAE1B,IAAII,EAAQG,EAAM,IAAM,GAKxB,OAJAb,EAAEgB,KAAKN,EAAO,MACc,IAAxBA,EAAMO,QAAQ,OAChBP,GAAgB,KAEXF,EAAUK,EAAM,GAAIH,EAC7B,CAAE,MACA,OAAO,IACT,CACF,CAiEO,SAASQ,EAAoBC,GAClC,MACMC,GADU,IAAIC,aACEC,OAAOH,GAEvBI,EAAe,IAAIC,WAAWJ,EAAMxB,QAC1C,IAAK,IAAI6B,EAAI,EAAGA,EAAIL,EAAMxB,OAAQ6B,IAChCF,EAAaE,GAAK,IAAOL,EAAMK,GAGjC,IAAIC,EAAM,GACV,IAAK,IAAID,EAAI,EAAGA,EAAIF,EAAa3B,OAAQ6B,IAAK,CAE5CC,GADUH,EAAaE,GAAGE,SAAS,IAAIC,SAAS,EAAG,IAErD,CACA,OAAOF,CACT,CC5FO,SAASG,EAAuBC,GAKrC,MAAMC,EAAYC,cACZC,EAAO,mBAAmBH,IAE1BI,EAAuB,KAC3B,MAAMC,EAAqBnC,EAAEoC,IAAIC,OAAOC,OAAQL,EAAM,IAAIM,KAC1D,OAAOvC,EAAEwC,EAAE,kBAAkBC,KAAK,uBAAuBC,WACtDC,IAAIC,GAAWC,OAAOL,EAAEI,GAASE,KAAK,oBACtCC,OAAOH,GAAWT,EAAmBa,IAAIJ,IACzCK,QAYL,OATAjD,EAAEkD,OAAOb,OAAOC,OAAQL,EAAOkB,QACfC,IAAVD,EACK,IAAIZ,IAAI,CAACR,KAElBoB,EAAME,IAAItB,GACHoB,IAETG,UAAUrB,EAAMC,KAET,CACLqB,WAAY,KACVvD,EAAEkD,OAAOb,OAAOC,OAAQL,EAAOkB,SACfC,IAAVD,GACFA,EAAMK,OAAOzB,GAERoB,IAETG,UAAUrB,EAAMC,MAElBA,uBACAuB,sBAAwBC,GAAkDC,QAAQ1B,EAAMyB,GAE5F,CChFA,SAASE,EAAiBC,EAAoCC,GAC5D,MAA8B,iBAAnBD,EAAOE,QACTF,EAAOE,QAETF,EAAOE,QACXhB,OAAO,EAAGiB,UAAoB,SAATA,GACrBrB,IAAI,EAAGsB,UAAgBA,GACvBC,KAAKJ,EAASK,UAAUhB,MAC7B,CACA,SAASiB,EACPP,EACAQ,EACAP,GAEA,MAAMC,EAAUM,EAAQ,CAAEC,KAAMT,EAAOS,KAAMP,QAASH,EAAiBC,EAAQC,KAS/E,MAR8B,iBAAnBD,EAAOE,QAChBF,EAAOE,QAAUA,GAEjB/D,EAAEuE,OAAOV,EAAOE,QAASS,GAAsB,SAAdA,EAAKR,MAClCD,GACFF,EAAOE,QAAQU,OAAO,EAAG,EAAG,CAAET,KAAM,OAAQC,KAAMF,KAG/CF,CACT,CAkHA,SAASa,EACPC,EACAb,GAEA,OAAOrE,EACLkF,EACA,CAAC7E,EAAKC,IAAQD,EAAIwE,OAASvE,EAAIuE,MAA+B,iBAAhBxE,EAAIiE,SAA+C,iBAAhBhE,EAAIgE,SACrFpB,IAAIiC,IAAS,CACbN,KAAMM,EAAM,GAAGN,KAEfP,QAA0B,IAAjBa,EAAMhF,OAAegF,EAAM,GAAGb,QAAUa,EAAMjC,IAAI,EAAGoB,aAAcA,GAASG,KAAKJ,EAASK,UAAUhB,SAEjH,CAuCA,SAAS0B,EAAYf,EAAoBgB,EAAwBC,GAC/D,MAAMC,EAAgB,EAAGnB,UAAoDoB,KAC3E,GAAIA,IAAYF,IACd,OAGF,MAAMlF,EAxHV,SACE8E,EACAG,GAEA,MAAMI,EAAaP,EAAQQ,UACzB,EAAGpB,aAAiC,iBAAZA,GAAwBA,EAAQqB,SAASN,EAAWO,KAAKtB,UAE7EuB,EAAaX,EAAQQ,UACzB,EAAGpB,aAAiC,iBAAZA,GAAwBA,EAAQqB,SAASN,EAAWS,KAAKxB,UAE7EyB,EAAab,EAAQQ,UACzB,EAAGpB,aAAiC,iBAAZA,GAAwBA,EAAQqB,SAASN,EAAWW,KAAK1B,UAEnF,IAAoB,IAAhBmB,IAAqC,IAAhBI,IAAqC,IAAhBE,EAC5C,OAGF,MAAME,EAAqB,CACzBC,EACAC,EACAC,EACAC,KAEA,GAAIF,IAAiBC,EACnB,OAAQlB,EAAQkB,GAAe9B,QAAmBgC,MAAMD,GAE1D,MAAME,EAAWL,EAAgB,GAAGI,MAAMD,GAE1C,OADAH,EAAgB,GAAK,GACdK,GAGHC,EAAgBP,EAAmB,CAAC,GAAI,KAAM,EAAGR,EAAYJ,EAAWO,KAAKtB,SAC7EmC,EAAgBR,EAAmBO,EAAef,EAAYI,EAAYR,EAAWS,KAAKxB,SAC1FoC,EAAgBT,EAAmBQ,EAAeZ,EAAYE,EAAYV,EAAWW,KAAK1B,SAEhG,MAAO,CACL,IAAIY,EAAQyB,MAAM,EAAGlB,GAAa,CAAEZ,KAAMK,EAAQO,GAAYZ,KAAMP,QAASkC,EAAc,KAC3F,CACE,CAAE3B,KAAMK,EAAQO,GAAYZ,KAAMP,QAASkC,EAAc,OACtDtB,EAAQyB,MAAMlB,EAAa,EAAGI,GACjC,CAAEhB,KAAMK,EAAQW,GAAYhB,KAAMP,QAASmC,EAAc,KAE3D,CACE,CAAE5B,KAAMK,EAAQW,GAAYhB,KAAMP,QAASmC,EAAc,OACtDvB,EAAQyB,MAAMd,EAAa,EAAGE,GACjC,CAAElB,KAAMK,EAAQa,GAAYlB,KAAMP,QAASoC,EAAc,KAE3D,CAAC,CAAE7B,KAAMK,EAAQa,GAAYlB,KAAMP,QAASoC,EAAc,OAASxB,EAAQyB,MAAMZ,EAAa,IAElG,CAuEmBa,CAAgBxC,EAAQiB,IAAanC,IAAIiC,IACtD0B,OA9DsB3B,EA8DHC,EA7DhB5E,EAAEuG,OAAO5B,EAAS,EAAGZ,aAAiC,iBAAZA,GAA2C,KAAnBA,EAAQyC,SA6DnD7D,IAAIkB,GAC5BO,EAAwBP,EAAQ,EAAGE,aAtElC/D,EAsE+D+D,GArEnEgC,MAAM,MACNU,UAAUC,IAASA,EAAKF,QACxBG,eAAeD,IAASA,EAAKF,QAC7BtC,KAAK,MAkEwEJ,IA/DlF,IAA4Ba,IAkExB,IAAK9E,EACH,OAGF,MAAM,MAAE+G,EAAK,MAAEC,GAAU/C,EAASgD,gBAE5BC,EAAiB,CAACC,EAAkCC,EAAcC,KACtE,IAAKF,EAAmBG,QACtB,OAGF,MAAMC,EAA8BC,KACvB,WAAXA,EAAE/C,MACAsC,EAAMO,SAA0B,gBAAfP,EAAM5C,MAA0BJ,EAAiByD,EAAGvD,GAAUsB,SAASwB,EAAMU,cAC9FT,EAAMM,SAA0B,gBAAfN,EAAM7C,MAA0BJ,EAAiByD,EAAGvD,GAAUsB,SAASyB,EAAMS,cAE5FC,EACwB,gBAA5BP,EAAmBhD,KACfnE,EAAOoH,GACJlE,OAAOqE,GAEPzE,IAAI0E,GAAKzD,EAAiByD,EAAGvD,IAC7BI,KAAKJ,EAASK,UAAUhB,OAC3B,GAEN,GAC8B,gBAA5B6D,EAAmBhD,MACnBhE,EAAEH,GACC2H,UACAC,KAAKJ,GAAKzD,EAAiByD,EAAGvD,GAAUsB,SAAS4B,EAAmBM,cAEvEtH,EAAEuE,OAAO1E,EAAOoH,GAAOG,OAClB,CACL,MAAMM,EAAgB1H,EAAEuE,OAAO1E,EAAOoH,GAAOI,GAAgB,WAAXA,EAAE/C,MACpDzE,EAAOqH,GAAMA,EAAKD,EAAOjH,EAAE2H,OAAO9H,EAAOqH,GAAKQ,GAAiB1H,EAAE2H,OAAOD,EAAe7H,EAAOqH,GAChG,CACAlH,EAAEH,GACC2H,UACAzE,OAAOsE,GAAKzD,EAAiByD,EAAGvD,GAAUsB,SAAS4B,EAAmBM,cACtEM,QAAQP,IACPjD,EACEiD,EACA,EAAGtD,aAAcA,EAAQ8D,WAAWb,EAAmBM,YAAaC,GACpEzD,MAIRiD,EAAeH,EAAO,EAAG,GACzBG,EAAeF,EAAO,EAAG,GAEzB,MAAOxB,EAAMyC,EAAoBC,EAAoBtC,GAAQ5F,EAE7D,IAAImI,EACJ,OAAQlE,EAASmE,aAAajE,MAC5B,IAAK,gBACHgE,EAAStD,EAAsB1E,EAAE2H,OAAOtC,EAAMyC,EAAoBC,EAAoBtC,GAAO3B,GAC7F,MACF,IAAK,kBACHkE,EAAStD,EACP1E,EAAE2H,OAAOtC,EA3GnB,SAA2BV,EAAuCb,GAEhE,MAAMoE,EAAS,CACbC,OAAQxH,iBAAiBmD,EAASmE,aAAaG,eAC/CC,UAAW1H,iBAAiBmD,EAASmE,aAAaK,kBAClDC,KAAM5H,iBAAiBmD,EAASmE,aAAaO,cAEzCC,EAAS,CACbN,OAAQxH,iBAAiBmD,EAASmE,aAAaS,eAC/CL,UAAW1H,iBAAiBmD,EAASmE,aAAaU,kBAClDJ,KAAM5H,iBAAiBmD,EAASmE,aAAaW,cAGzCC,EAAchF,GAClBO,EACEP,EACA,EAAGS,OAAMP,cACPA,EAAUA,EAAQqB,SAAS8C,EAAO5D,IAASP,EAAUmE,EAAO5D,GAAQP,GAClDqB,SAASqD,EAAOnE,IAASP,EAAUA,EAAU0E,EAAOnE,GAGxER,GAGJ,OAAOrE,EAAQkF,EAAS,CAAC7E,EAAKC,IAA+B,iBAAhBD,EAAIiE,SAA+C,iBAAhBhE,EAAIgE,SAAsBpB,IACxGiC,IACEA,EAAMgD,QAAQiB,GAEP,CACLvE,KAAMR,EAASmE,aAAaa,YAC5B/E,QACmB,IAAjBa,EAAMhF,OAAegF,EAAM,GAAGb,QAAUa,EAAMjC,IAAI,EAAGoB,aAAcA,GAASG,KAAKJ,EAASK,UAAUhB,SAI9G,CAwEyB4F,CAAkB/I,EAAE2H,OAAOG,EAAoBC,GAAqBjE,GAAW2B,GAC9F3B,GFpQH,IAA0BkF,EAAkBC,IEyQzBjB,GFzQOgB,EEyQfnF,GFxQJjE,OAAS,EACrBoJ,EAAY5I,QAAQ6I,IEyQdC,EAAiB,EAAGC,eACxBnE,EAAc,CAAEnB,OAAQsF,IAAY,IAGlC,EAAQC,mBAAoB,SAAU,KACxCzF,QAAQ0F,cAAcC,oBAAqBtE,GAE3CrB,QAAQ0F,cAAcE,+BAAgCL,GAGxD,MAAMM,EAA4BvF,IAChC,IAAKH,EAAS2F,cAAgB1E,IAC5B,OAEF,MAAM2E,EAAQrJ,EAAgByD,EAAS2F,aAAa,GAC/CC,GAIDA,EAAM3I,KAAKkD,EAAK0F,YAAYvD,MAAM,KACpCwD,YAAYC,kBAGhBC,eAAeT,cAAcU,sBAAuBP,GAEpD,MAAMQ,EAA6BC,MAAOC,IACxC,IAAKpG,EAAS2F,cAAgB1E,IAC5B,OAGF,MAAMoF,EAAeP,YAAYQ,KAAKC,OAAOH,IAEvCI,EAAwBH,EAAaI,IAAIC,OAAO,MACtD,IAA+B,IAA3BF,EACF,OAGF,MAAMZ,EAAQrJ,EAAgByD,EAAS2F,aAAa,GACpD,IAAKC,EACH,OAIF,MAAMe,EAAiBN,EAAaI,IAAInE,MAAMkE,EAAwB,GAAGE,OAAOd,IACxD,IAApBe,IAIJN,EAAaI,IAAMJ,EAAaI,IAAInE,MAAM,EAAGkE,EAAwBG,EAAiB,GAClFN,EAAaO,QACf1K,EAAE2K,IAAIR,EAAc,CAAC,SAAUA,EAAaS,UAAYT,EAAaI,KAGvEX,YAAYiB,mBAAmBR,OAAOH,GAAaC,SAC7CP,YAAYkB,aAIpB,OAFAhB,eAAeT,cAAc0B,iBAAkBf,GAExC,CACLgB,SAAU,KACRC,oBAAoB5B,cAAcC,oBAAqBtE,GACvDiG,oBAAoB5B,cAAcE,+BAAgCL,GAClE+B,oBAAoB5B,cAAcU,sBAAuBP,GACzDyB,oBAAoB5B,cAAc0B,iBAAkBf,IAG1D,CAEO,SAASkB,EAAuBpH,GACrC,MAAM,WAAEP,EAAU,qBAAErB,GAAyBL,EAAuB,WAC9D,WAAEiD,EAAU,SAAEqG,GAjTf,SAA0BrH,GAC/B,MAAMgB,EAAmCsG,OAAOC,OAAO,CACrDhG,KAAM,CACJvD,GAAI,KAAKZ,EAAoB,mBAC7BoK,SAAU,UACVC,MAAO,KACPjH,KAAM,YACNP,QAAS,qBAEXwB,KAAM,CACJzD,GAAI,aACJwJ,SAAU,UACVC,MAAOzH,EAASgD,gBAAgB0E,UAChClH,KAAM,SACNP,QAAS,iBAEX0B,KAAM,CACJ3D,GAAI,iBACJwJ,SAAU,UACVC,MAAO,EACPjH,KAAM,SACNP,QAAS,uBAIP0H,EAAS,CAACC,EAAeC,EAAiB1G,KAC1CA,GAGJ2G,cAAcR,OAAOS,OAAO/G,KAI9B,OAFAnB,QAAQ0F,cAAcyC,0BAA2BL,GAE1C,CACL3G,aACAqG,SAAU,KACRF,oBAAoB5B,cAAcyC,0BAA2BL,GAC7DM,gBAAgBX,OAAOS,OAAO/G,GAAYnC,IAAI,EAAGb,QAASA,KAGhE,CAyQmCkK,CAAiBlI,IAC5C,SAAEkH,GAAanG,EAAYf,EAAUgB,EAAY,IAAM5C,MAA2BF,eACxF,MAAO,CACLiK,QAAS,KACP1I,IACAyH,IACAG,KAGN,CC/VA,MAAM,EAA+Be,ECA/B,EAA+BC,ICC/BC,EAAc,EAAAF,EACfG,OAAO,CACRC,UAAW,EAAAJ,EACNG,OAAO,CACRrI,KAAM,EAAAkI,EAAEK,KAAK,CAAC,QAAS,UAAW,iBAAkB,WACpDpJ,MAAO,EAAA+I,EAAE/K,WAERqL,UAAUC,IACX,OAAQA,EAAKzI,MACT,IAAK,QACDyI,EAAKtJ,MAAQ,IACb,MACJ,IAAK,UACDsJ,EAAKtJ,MAAQ,KACb,MACJ,IAAK,iBACDsJ,EAAKtJ,MAAQ,OAKrB,OAAOsJ,IAEXC,wCAAyC,EAAAR,EAAES,UAC3CC,gBAAiB,EAAAV,EAAEG,OAAO,CACtBrI,KAAM,EAAAkI,EAAEK,KAAK,CAAC,QAAS,WAAY,WACnCzD,YAAa,EAAAoD,EAAEK,KAAK,CAAC,OAAQ,YAAa,WAC1C/D,YAAa,EAAA0D,EAAE/K,SACfyH,YAAa,EAAAsD,EAAE/K,SACfmH,iBAAkB,EAAA4D,EAAE/K,SACpBwH,iBAAkB,EAAAuD,EAAE/K,SACpBiH,cAAe,EAAA8D,EAAE/K,SACjBuH,cAAe,EAAAwD,EAAE/K,WAErBsI,YAAa,EAAAyC,EAAE/K,WAEdqL,UAAUC,GACJI,EAASC,MAAM,CAClB3I,UAAWsI,EAAKH,UAChB7C,YAAagD,EAAKhD,YAClB3C,gBAAiB,CACb0E,UAAW,GACX5E,MAAO,CACHO,QAASsF,EAAKC,wCACd1I,KAAM,UACNsD,YAAa,wBAEjBT,MAAO,CACHM,QAASsF,EAAKC,wCACd1I,KAAM,UACNsD,YAAa,yBAGrBW,aAAc,IACPwE,EAAKG,gBACR5I,KAAoC,WAA9ByI,EAAKG,gBAAgB5I,KAAoB,kBAAoB,oBAIlE6I,EAAW,EAAAX,EACnBG,OAAO,CACRlI,UAAW,EAAA+H,EACNG,OAAO,CACRrI,KAAM,EAAAkI,EAAEK,KAAK,CAAC,QAAS,UAAW,iBAAkB,WAAWQ,QAAQ,kBACvE5J,MAAO,EAAA+I,EAAE/K,SAAS4L,QAAQ,UAEzBC,SAAS,CAAC,GACVR,UAAUC,IACX,OAAQA,EAAKzI,MACT,IAAK,QACDyI,EAAKtJ,MAAQ,IACb,MACJ,IAAK,UACDsJ,EAAKtJ,MAAQ,KACb,MACJ,IAAK,iBACDsJ,EAAKtJ,MAAQ,OAKrB,OAAOsJ,IAEXhD,YAAa,EAAAyC,EACR/K,SACA4L,QAAQ,yCACRE,MAAM,yCACXnG,gBAAiB,EAAAoF,EACZG,OAAO,CACRb,UAAW,EAAAU,EAAEgB,SAASC,MAAMC,IAAI,GAAGL,QAAQ,IAAIE,MAAM,IACrDrG,MAAO,EAAAsF,EACFG,OAAO,CACRlF,QAAS,EAAA+E,EAAES,UAAUI,SAAQ,GAC7B/I,KAAM,EAAAkI,EAAEK,KAAK,CAAC,UAAW,gBAAgBQ,QAAQ,WACjDzF,YAAa,EAAA4E,EAAE/K,SAAS4L,QAAQ,0BAE/BC,SAAS,CAAC,GACfnG,MAAO,EAAAqF,EACFG,OAAO,CACRlF,QAAS,EAAA+E,EAAES,UAAUI,SAAQ,GAC7B/I,KAAM,EAAAkI,EAAEK,KAAK,CAAC,UAAW,gBAAgBQ,QAAQ,WACjDzF,YAAa,EAAA4E,EAAE/K,SAAS4L,QAAQ,0BAE/BC,SAAS,CAAC,KAEdA,SAAS,CAAC,GACf/E,aAAc,EAAAiE,EACTG,OAAO,CACRrI,KAAM,EAAAkI,EAAEK,KAAK,CAAC,gBAAiB,oBAAoBQ,QAAQ,mBAC3DjE,YAAa,EAAAoD,EAAEK,KAAK,CAAC,OAAQ,YAAa,WAAWQ,QAAQ,aAC7DvE,YAAa,EAAA0D,EAAE/K,SAAS4L,QAAQ,qCAChCnE,YAAa,EAAAsD,EAAE/K,SAAS4L,QAAQ,uBAChCzE,iBAAkB,EAAA4D,EAAE/K,SAAS4L,QAAQ,iCACrCpE,iBAAkB,EAAAuD,EAAE/K,SAAS4L,QAAQ,uBACrC3E,cAAe,EAAA8D,EAAE/K,SAAS4L,QAAQ,iCAClCrE,cAAe,EAAAwD,EAAE/K,SAAS4L,QAAQ,yBAEjCC,SAAS,CAAC,KAEdA,SAAS,CAAC,GACiB,EAAY,SAAU,KAClD,MAAMK,EAAYC,aAAa,CAAEtJ,KAAM,SAAUjC,UAAWC,gBACtD8B,GAAW,IAAAyJ,MAAKvN,EAAEgD,IAAIqK,EAAW,aAAejB,EAAcS,GAAUC,MAAMO,IAC9EG,GAAgB,IAAAD,MAAI,GAC1B1L,EAAuB,UAAU4B,sBAAsBgK,IACnDD,EAAcrK,MAAQsK,IAAwBzL,gBAElD,MAAM0L,GAAY,IAAAH,MAAI,IACtB,IAAAI,aAAY,KACRC,iBAAiB,EAAM9J,EAASX,OAAQ,CAAEa,KAAM,SAAUjC,UAAWC,kBAQzE,MAAO,CAAE8B,WAAU0J,gBAAeE,YAAWG,kBANlB5L,IAChB,IAAA6L,UAAS,CACZ1L,IAAK,IAAMpC,EAAEoC,IAAI0B,EAASX,MAAOlB,GAAM8L,QAAQ,MAAO,OACtDpD,IAAKxH,GAASnD,EAAE2K,IAAI7G,EAASX,MAAOlB,EAAMkB,EAAM4K,QAAQ,OAAQ,YClI5EvL,EAAE,MNgEKyH,eAAmC+D,EAAkBC,GACtD,QAAcC,yBAA0BF,EAAU,MACpDG,OAAOC,MAAM,IAAIH,mBAAuBD,KAAa,QAEzD,CMnEEK,CAAoB,SAAU,WLJzBpE,eAA0BqE,GAC/B,MAAMC,QAAeC,MAAMF,GAC3B,IAAKC,EAAOE,GACV,OAAO,EAET,MAAMC,QAAoBH,EAAOtK,OACjC0K,kBAAkBD,EAEpB,CKHEE,CAAW,yFACX,MAAM,QAAE3C,GAAYf,EAClB2B,EAASgC,OAAO,CACd/H,gBAAiB,CACfF,MAAO,CACLO,SAAS,EACTnD,KAAM,WAER6C,MAAO,CACLM,SAAS,EACTnD,KAAM,YAGViE,aAAc,CACZjE,KAAM,oBAIZxB,EAAEH,QAAQyM,GAAG,WAAY,KACvB7C","sources":["src://tavern_helper_template/util/common.ts","src://tavern_helper_template/util/script.ts","src://tavern_helper_template/src/酒馆助手/压缩相邻消息/squash.ts","src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/external var \"Vue\"","src://tavern_helper_template/src/酒馆助手/压缩相邻消息/store.ts","src://tavern_helper_template/src/酒馆助手/深度条目排斥器/index.ts"],"sourcesContent":["import { compare } from 'compare-versions';\nimport JSON5 from 'json5';\nimport { jsonrepair } from 'jsonrepair';\nimport { toDotPath } from 'zod/v4/core';\n\nexport function assignInplace<T>(destination: T[], new_array: T[]): T[] {\n  destination.length = 0;\n  destination.push(...new_array);\n  return destination;\n}\n\n// 修正 _.merge 对数组的合并逻辑, [1, 2, 3] 和 [4, 5] 合并后变成 [4, 5] 而不是 [4, 5, 3]\nexport function correctlyMerge<TObject, TSource>(lhs: TObject, rhs: TSource): TObject & TSource {\n    return _.mergeWith(lhs, rhs, (_lhs, rhs) => (_.isArray(rhs) ? rhs : undefined));\n}\n\nexport function chunkBy<T>(array: T[], predicate: (lhs: T, rhs: T) => boolean): T[][] {\n  if (array.length === 0) {\n    return [];\n  }\n\n  const chunks: T[][] = [[array[0]]];\n  for (const [lhs, rhs] of _.zip(_.dropRight(array), _.drop(array))) {\n    if (predicate(lhs!, rhs!)) {\n      chunks[chunks.length - 1].push(rhs!);\n    } else {\n      chunks.push([rhs!]);\n    }\n  }\n  return chunks;\n}\n\nexport function regexFromString(input: string, replace_macros?: boolean): RegExp | null {\n  if (!input) {\n    return null;\n  }\n  const makeRegex = (pattern: string, flags: string) => {\n    if (replace_macros) {\n      pattern = substitudeMacros(pattern);\n    }\n    return new RegExp(pattern, flags);\n  };\n  try {\n    const match = input.match(/\\/(.+)\\/([a-z]*)/i);\n    if (!match) {\n      return makeRegex(_.escapeRegExp(input), 'i');\n    }\n    if (match[2] && !/^(?!.*?(.).*?\\1)[gmixXsuUAJ]+$/.test(match[3])) {\n      return makeRegex(input, 'i');\n    }\n    let flags = match[2] ?? '';\n    _.pull(flags, 'g');\n    if (flags.indexOf('i') === -1) {\n      flags = flags + 'i';\n    }\n    return makeRegex(match[1], flags);\n  } catch {\n    return null;\n  }\n}\n\nexport function uuidv4(): string {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nexport async function checkMinimumVersion(expected: string, title: string) {\n  if (compare(await getTavernHelperVersion(), expected, '<')) {\n    toastr.error(`'${title}' 需要酒馆助手版本 >= '${expected}'`, '版本不兼容');\n  }\n}\n\nexport function prettifyErrorWithInput(error: z.ZodError) {\n  return _([...error.issues])\n    .sortBy(issue => issue.path?.length ?? 0)\n    .flatMap(issue => {\n      const lines = [`✖ ${issue.message}`];\n      if (issue.path?.length) {\n        lines.push(`  → 路径: ${toDotPath(issue.path)}`);\n      }\n      if (issue.input !== undefined) {\n        lines.push(`  → 输入: ${JSON.stringify(issue.input)}`);\n      }\n      return lines;\n    })\n    .join('\\n');\n}\n\nexport function literalYamlify(value: any) {\n  return YAML.stringify(value, { blockQuote: 'literal' });\n}\n\nexport function parseString(content: string): any {\n  let parsed: unknown;\n  try {\n    parsed = YAML.parseDocument(content, { merge: true }).toJS();\n  } catch (yaml_error) {\n    try {\n      // eslint-disable-next-line import-x/no-named-as-default-member\n      parsed = JSON5.parse(content);\n    } catch (json5_error) {\n      try {\n        parsed = JSON.parse(jsonrepair(content));\n      } catch (json_error) {\n        const toError = (error: unknown) => (error instanceof Error ? error.message : String(error));\n        throw new Error(\n          literalYamlify({\n            ['要解析的字符串不是有效的 YAML/JSON 格式']: {\n              字符串内容: content,\n              YAML错误信息: toError(yaml_error),\n              JSON5错误信息: toError(json5_error),\n              尝试修复JSON时的错误信息: toError(json_error),\n            },\n          }),\n        );\n      }\n    }\n  }\n  return parsed;\n}\n\nexport function getComplementString(string: string) {\n  const encoder = new TextEncoder();\n  const bytes = encoder.encode(string);\n\n  const complemented = new Uint8Array(bytes.length);\n  for (let i = 0; i < bytes.length; i++) {\n    complemented[i] = 0xff - bytes[i];\n  }\n\n  let hex = '';\n  for (let i = 0; i < complemented.length; i++) {\n    const h = complemented[i].toString(16).padStart(2, '0');\n    hex += h;\n  }\n  return hex;\n}\n\nexport async function checkAndUpdateCharacter(name: string, latest_version: string, png_url: string): Promise<void> {\n  const current_version = (await getCharacter(name)).version.trim() || '0.0.0';\n  if (compare(current_version, latest_version, '>=')) {\n    return;\n  }\n  await importRawCharacter(name, await fetch(png_url).then(response => response.blob()));\n  replaceCharacter(name, { version: latest_version });\n  toastr.success(\n    `角色卡已自动更新到 '${latest_version.startsWith('v') ? latest_version : `v${latest_version}`}'`,\n    name,\n  );\n}\n","import iframe_srcdoc from './iframe_srcdoc.html';\n\nexport async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle(\n  append_to: JQuery.Selector | JQuery.htmlString | JQuery.TypeOrArray<Element | DocumentFragment> | JQuery = 'head',\n): { destroy: () => void } {\n  const $div = $(`<div>`)\n    .attr('script_id', getScriptId())\n    .append($(`head > style`, document).clone())\n    .appendTo(append_to);\n\n  return {\n    destroy: () => $div.remove(),\n  };\n}\n\nexport function createScriptIdIframe(): JQuery<HTMLIFrameElement> {\n  return $(`<iframe>`).attr({\n    script_id: getScriptId(),\n    frameborder: 0,\n    srcdoc: iframe_srcdoc,\n  }) as JQuery<HTMLIFrameElement>;\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, new_chat_id => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n\nexport function registerAsUniqueScript(id: string): {\n  unregister: () => void;\n  getPreferredScriptId: () => string | undefined;\n  listenPreferenceState: (callback: (perferred_script_id: string) => void) => EventOnReturn;\n} {\n  const script_id = getScriptId();\n  const path = `th_unique_check.${id}`;\n\n  const getPreferredScriptId = () => {\n    const registered_scripts = _.get(window.parent, path, new Set<string>());\n    return _($('#tavern_helper').find('div[data-script-id]').toArray())\n      .map(element => String($(element).attr('data-script-id')))\n      .filter(element => registered_scripts.has(element))\n      .last();\n  };\n\n  _.update(window.parent, path, (value: Set<string> | undefined) => {\n    if (value === undefined) {\n      return new Set([script_id]);\n    }\n    value.add(script_id);\n    return value;\n  });\n  eventEmit(path, getPreferredScriptId());\n\n  return {\n    unregister: () => {\n      _.update(window.parent, path, (value: Set<string> | undefined) => {\n        if (value !== undefined) {\n          value.delete(script_id);\n        }\n        return value;\n      });\n      eventEmit(path, getPreferredScriptId());\n    },\n    getPreferredScriptId,\n    listenPreferenceState: (callback: (enabled_script_id: string) => void) => eventOn(path, callback),\n  };\n}\n","import { assignInplace, chunkBy, getComplementString, regexFromString } from '@util/common';\nimport { registerAsUniqueScript } from '@util/script';\nimport { compare } from 'compare-versions';\nimport { Settings } from './store';\n\nfunction getPromptContent(prompt: SillyTavern.SendingMessage, settings: Settings): string {\n  if (typeof prompt.content === 'string') {\n    return prompt.content;\n  }\n  return prompt.content\n    .filter(({ type }) => type === 'text')\n    .map(({ text }: any) => text)\n    .join(settings.delimiter.value);\n}\nfunction updatePromptContentWith(\n  prompt: SillyTavern.SendingMessage,\n  updater: (prompt: { role: 'system' | 'assistant' | 'user'; content: string }) => string,\n  settings: Settings,\n): SillyTavern.SendingMessage {\n  const content = updater({ role: prompt.role, content: getPromptContent(prompt, settings) });\n  if (typeof prompt.content === 'string') {\n    prompt.content = content;\n  } else {\n    _.remove(prompt.content, item => item.type === 'text');\n    if (content) {\n      prompt.content.splice(0, 0, { type: 'text', text: content });\n    }\n  }\n  return prompt;\n}\n\nexport type Separators = {\n  head: InjectionPrompt;\n  deep: InjectionPrompt;\n  tail: InjectionPrompt;\n};\n\nexport function injectSeparators(settings: Settings) {\n  const separators: Readonly<Separators> = Object.freeze({\n    head: {\n      id: `\\0${getComplementString('压缩相邻消息-聊天记录开头')}`,\n      position: 'in_chat',\n      depth: 9999,\n      role: 'assistant',\n      content: `【【压缩相邻消息-聊天记录开头】】`,\n    },\n    deep: {\n      id: `\\xff压缩相邻消息-Dx`,\n      position: 'in_chat',\n      depth: settings.depth_injection.threshold,\n      role: 'system',\n      content: `【【压缩相邻消息-Dx】】`,\n    },\n    tail: {\n      id: `\\xff压缩相邻消息-聊天记录结尾`,\n      position: 'in_chat',\n      depth: 0,\n      role: 'system',\n      content: `【【压缩相邻消息-聊天记录结尾】】`,\n    },\n  } as const);\n\n  const inject = (_type: string, _option: object, dry_run: boolean) => {\n    if (dry_run) {\n      return;\n    }\n    injectPrompts(Object.values(separators));\n  };\n  eventOn(tavern_events.GENERATION_AFTER_COMMANDS, inject);\n\n  return {\n    separators,\n    uninject: () => {\n      eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS, inject);\n      uninjectPrompts(Object.values(separators).map(({ id }) => id));\n    },\n  };\n}\n\n//----------------------------------------------------------------------------------------------------------------------\nfunction seperatePrompts(\n  prompts: SillyTavern.SendingMessage[],\n  separators: Separators,\n): SillyTavern.SendingMessage[][] | undefined {\n  const head_index = prompts.findIndex(\n    ({ content }) => typeof content === 'string' && content.includes(separators.head.content),\n  );\n  const deep_index = prompts.findIndex(\n    ({ content }) => typeof content === 'string' && content.includes(separators.deep.content),\n  );\n  const tail_index = prompts.findIndex(\n    ({ content }) => typeof content === 'string' && content.includes(separators.tail.content),\n  );\n  if (head_index === -1 || deep_index === -1 || tail_index === -1) {\n    return undefined;\n  }\n\n  const split_with_context = (\n    splitted_before: [string, string],\n    before_index: number,\n    current_index: number,\n    splitter: string,\n  ): [string, string] => {\n    if (before_index !== current_index) {\n      return (prompts[current_index].content as string).split(splitter) as [string, string];\n    }\n    const splitted = splitted_before[1].split(splitter) as [string, string];\n    splitted_before[1] = '';\n    return splitted;\n  };\n\n  const splitted_head = split_with_context(['', ''], -1, head_index, separators.head.content);\n  const splitted_deep = split_with_context(splitted_head, head_index, deep_index, separators.deep.content);\n  const splitted_tail = split_with_context(splitted_deep, deep_index, tail_index, separators.tail.content);\n\n  return [\n    [...prompts.slice(0, head_index), { role: prompts[head_index].role, content: splitted_head[0] }],\n    [\n      { role: prompts[head_index].role, content: splitted_head[1] },\n      ...prompts.slice(head_index + 1, deep_index),\n      { role: prompts[deep_index].role, content: splitted_deep[0] },\n    ],\n    [\n      { role: prompts[deep_index].role, content: splitted_deep[1] },\n      ...prompts.slice(deep_index + 1, tail_index),\n      { role: prompts[tail_index].role, content: splitted_tail[0] },\n    ],\n    [{ role: prompts[tail_index].role, content: splitted_tail[1] }, ...prompts.slice(tail_index + 1)],\n  ];\n}\n\nfunction trimEmptyLines(string: string): string {\n  return _(string)\n    .split('\\n')\n    .dropWhile(line => !line.trim())\n    .dropRightWhile(line => !line.trim())\n    .join('\\n');\n}\n\nfunction rejectEmptyPrompts(prompts: SillyTavern.SendingMessage[]): SillyTavern.SendingMessage[] {\n  return _.reject(prompts, ({ content }) => typeof content === 'string' && content.trim() === '');\n}\n\nfunction squashAdjacentMessage(\n  prompts: SillyTavern.SendingMessage[],\n  settings: Settings,\n): SillyTavern.SendingMessage[] {\n  return chunkBy(\n    prompts,\n    (lhs, rhs) => lhs.role === rhs.role && typeof lhs.content === 'string' && typeof rhs.content === 'string',\n  ).map(chunk => ({\n    role: chunk[0].role,\n    // 长度大于 1, 必然 content 为 string\n    content: chunk.length === 1 ? chunk[0].content : chunk.map(({ content }) => content).join(settings.delimiter.value),\n  }));\n}\n\nfunction squashChatHistory(prompts: SillyTavern.SendingMessage[], settings: Settings): SillyTavern.SendingMessage[] {\n  // TODO: zod encode\n  const prefix = {\n    system: substitudeMacros(settings.chat_history.system_prefix),\n    assistant: substitudeMacros(settings.chat_history.assistant_prefix),\n    user: substitudeMacros(settings.chat_history.user_prefix),\n  };\n  const suffix = {\n    system: substitudeMacros(settings.chat_history.system_suffix),\n    assistant: substitudeMacros(settings.chat_history.assistant_suffix),\n    user: substitudeMacros(settings.chat_history.user_suffix),\n  };\n\n  const tagContent = (prompt: SillyTavern.SendingMessage) =>\n    updatePromptContentWith(\n      prompt,\n      ({ role, content }) => {\n        content = content.includes(prefix[role]) ? content : prefix[role] + content;\n        content = content.includes(suffix[role]) ? content : content + suffix[role];\n        return content;\n      },\n      settings,\n    );\n\n  return chunkBy(prompts, (lhs, rhs) => typeof lhs.content === 'string' && typeof rhs.content === 'string').map(\n    chunk => {\n      chunk.forEach(tagContent);\n\n      return {\n        role: settings.chat_history.squash_role,\n        content:\n          chunk.length === 1 ? chunk[0].content : chunk.map(({ content }) => content).join(settings.delimiter.value),\n      };\n    },\n  );\n}\n\nfunction listenEvent(settings: Settings, separators: Separators, shouldEnable: () => boolean) {\n  const handlePrompts = ({ prompt }: { prompt: SillyTavern.SendingMessage[] }, dry_run: boolean) => {\n    if (dry_run || !shouldEnable()) {\n      return;\n    }\n\n    const chunks = seperatePrompts(prompt, separators)?.map(chunk =>\n      rejectEmptyPrompts(chunk).map(prompt =>\n        updatePromptContentWith(prompt, ({ content }) => trimEmptyLines(content), settings),\n      ),\n    );\n    if (!chunks) {\n      return;\n    }\n\n    const { above, below } = settings.depth_injection;\n\n    const applyInjection = (injection_settings: typeof above, from: number, to: number) => {\n      if (!injection_settings.enabled) {\n        return;\n      }\n\n      const isSystemWithoutPlaceholder = (p: SillyTavern.SendingMessage): boolean =>\n        p.role === 'system' &&\n        !(above.enabled && above.type === 'placeholder' && getPromptContent(p, settings).includes(above.placeholder)) &&\n        !(below.enabled && below.type === 'placeholder' && getPromptContent(p, settings).includes(below.placeholder));\n\n      const placeholder_content =\n        injection_settings.type === 'placeholder'\n          ? chunks[from]\n              .filter(isSystemWithoutPlaceholder)\n              // 没有把图片、多媒体也作为内容, 但无所谓, 世界书里不能设置图片或多媒体\n              .map(p => getPromptContent(p, settings))\n              .join(settings.delimiter.value)\n          : '';\n\n      if (\n        injection_settings.type === 'placeholder' &&\n        _(chunks)\n          .flatten()\n          .some(p => getPromptContent(p, settings).includes(injection_settings.placeholder))\n      ) {\n        _.remove(chunks[from], isSystemWithoutPlaceholder);\n      } else {\n        const exclude_chunk = _.remove(chunks[from], p => p.role === 'system');\n        chunks[to] = to < from ? _.concat(chunks[to], exclude_chunk) : _.concat(exclude_chunk, chunks[to]);\n      }\n      _(chunks)\n        .flatten()\n        .filter(p => getPromptContent(p, settings).includes(injection_settings.placeholder))\n        .forEach(p => {\n          updatePromptContentWith(\n            p,\n            ({ content }) => content.replaceAll(injection_settings.placeholder, placeholder_content),\n            settings,\n          );\n        });\n    };\n    applyInjection(above, 1, 0);\n    applyInjection(below, 2, 3);\n\n    const [head, above_chat_history, below_chat_history, tail] = chunks;\n\n    let result: SillyTavern.SendingMessage[];\n    switch (settings.chat_history.type) {\n      case 'squash_nearby':\n        result = squashAdjacentMessage(_.concat(head, above_chat_history, below_chat_history, tail), settings);\n        break;\n      case 'squash_into_one':\n        result = squashAdjacentMessage(\n          _.concat(head, squashChatHistory(_.concat(above_chat_history, below_chat_history), settings), tail),\n          settings,\n        );\n        break;\n    }\n\n    assignInplace(prompt, result);\n  };\n  const handlePrompts2 = ({ messages }: { messages: SillyTavern.SendingMessage[] }) => {\n    handlePrompts({ prompt: messages }, false);\n  };\n\n  if (compare(getTavernVersion(), '1.13.4', '>')) {\n    eventOn(tavern_events.GENERATE_AFTER_DATA, handlePrompts);\n  } else {\n    eventOn(tavern_events.CHAT_COMPLETION_SETTINGS_READY, handlePrompts2);\n  }\n\n  const handleStopStringOnStream = (text: string) => {\n    if (!settings.stop_string || !shouldEnable()) {\n      return;\n    }\n    const regex = regexFromString(settings.stop_string, true);\n    if (!regex) {\n      return;\n    }\n    // slice(1) 来避免 AI 在开头匹配到停止字符串的情况\n    if (regex.test(text.trimStart().slice(1))) {\n      SillyTavern.stopGeneration();\n    }\n  };\n  eventMakeFirst(tavern_events.STREAM_TOKEN_RECEIVED, handleStopStringOnStream);\n\n  const handleStopStringOnReceived = async (message_id: number | string) => {\n    if (!settings.stop_string || !shouldEnable()) {\n      return;\n    }\n\n    const chat_message = SillyTavern.chat[Number(message_id)];\n\n    const first_non_space_index = chat_message.mes.search(/\\S/);\n    if (first_non_space_index === -1) {\n      return;\n    }\n\n    const regex = regexFromString(settings.stop_string, true);\n    if (!regex) {\n      return;\n    }\n\n    // slice(first_non_space_index + 1) 来避免 AI 在开头匹配到停止字符串的情况\n    const searched_index = chat_message.mes.slice(first_non_space_index + 1).search(regex);\n    if (searched_index === -1) {\n      return;\n    }\n\n    chat_message.mes = chat_message.mes.slice(0, first_non_space_index + searched_index + 1);\n    if (chat_message.swipes) {\n      _.set(chat_message, ['swipes', chat_message.swipe_id!], chat_message.mes);\n    }\n    // 与 https://gitgud.io/Monblant/noass 采用相同逻辑而不使用 setChatMessages, 因为 CHARACTER_MESSAGE_RENDERED 将会随后自然触发\n    SillyTavern.updateMessageBlock(Number(message_id), chat_message);\n    await SillyTavern.saveChat();\n  };\n  eventMakeFirst(tavern_events.MESSAGE_RECEIVED, handleStopStringOnReceived);\n\n  return {\n    unlisten: () => {\n      eventRemoveListener(tavern_events.GENERATE_AFTER_DATA, handlePrompts);\n      eventRemoveListener(tavern_events.CHAT_COMPLETION_SETTINGS_READY, handlePrompts2);\n      eventRemoveListener(tavern_events.STREAM_TOKEN_RECEIVED, handleStopStringOnStream);\n      eventRemoveListener(tavern_events.MESSAGE_RECEIVED, handleStopStringOnReceived);\n    },\n  };\n}\n\nexport function initSquashWithoutPanel(settings: Settings) {\n  const { unregister, getPreferredScriptId } = registerAsUniqueScript('压缩相邻消息');\n  const { separators, uninject } = injectSeparators(settings);\n  const { unlisten } = listenEvent(settings, separators, () => getPreferredScriptId() === getScriptId());\n  return {\n    destroy: () => {\n      unregister();\n      unlisten();\n      uninject();\n    },\n  };\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = z;","const __WEBPACK_NAMESPACE_OBJECT__ = Vue;","import { registerAsUniqueScript } from '@util/script';\nconst OldSettings = z\n    .object({\n    seperator: z\n        .object({\n        type: z.enum(['space', 'newline', 'double newline', 'custom']),\n        value: z.string(),\n    })\n        .transform(data => {\n        switch (data.type) {\n            case 'space':\n                data.value = ' ';\n                break;\n            case 'newline':\n                data.value = '\\n';\n                break;\n            case 'double newline':\n                data.value = '\\n\\n';\n                break;\n            case 'custom':\n                break;\n        }\n        return data;\n    }),\n    put_system_injection_after_chat_history: z.boolean(),\n    on_chat_history: z.object({\n        type: z.enum(['mixin', 'seperate', 'squash']),\n        squash_role: z.enum(['user', 'assistant', 'system']),\n        user_prefix: z.string(),\n        user_suffix: z.string(),\n        assistant_prefix: z.string(),\n        assistant_suffix: z.string(),\n        system_prefix: z.string(),\n        system_suffix: z.string(),\n    }),\n    stop_string: z.string(),\n})\n    .transform(data => {\n    return Settings.parse({\n        delimiter: data.seperator,\n        stop_string: data.stop_string,\n        depth_injection: {\n            threshold: 10,\n            above: {\n                enabled: data.put_system_injection_after_chat_history,\n                type: 'exclude',\n                placeholder: `{{压缩相邻消息::above_dx}}`,\n            },\n            below: {\n                enabled: data.put_system_injection_after_chat_history,\n                type: 'exclude',\n                placeholder: `{{压缩相邻消息::below_dx}}`,\n            },\n        },\n        chat_history: {\n            ...data.on_chat_history,\n            type: data.on_chat_history.type === 'squash' ? 'squash_into_one' : 'squash_nearby',\n        },\n    });\n});\nexport const Settings = z\n    .object({\n    delimiter: z\n        .object({\n        type: z.enum(['space', 'newline', 'double newline', 'custom']).default('double newline'),\n        value: z.string().default('\\n\\n'),\n    })\n        .prefault({})\n        .transform(data => {\n        switch (data.type) {\n            case 'space':\n                data.value = ' ';\n                break;\n            case 'newline':\n                data.value = '\\n';\n                break;\n            case 'double newline':\n                data.value = '\\n\\n';\n                break;\n            case 'custom':\n                break;\n        }\n        return data;\n    }),\n    stop_string: z\n        .string()\n        .default('/(?:</observed_pice>|<\\\\|im_end\\\\|>)/')\n        .catch('/(?:</observed_pice>|<\\\\|im_end\\\\|>)/'),\n    depth_injection: z\n        .object({\n        threshold: z.number().int().min(1).default(10).catch(10),\n        above: z\n            .object({\n            enabled: z.boolean().default(false),\n            type: z.enum(['exclude', 'placeholder']).default('exclude'),\n            placeholder: z.string().default('{{压缩相邻消息::above_dx}}'),\n        })\n            .prefault({}),\n        below: z\n            .object({\n            enabled: z.boolean().default(false),\n            type: z.enum(['exclude', 'placeholder']).default('exclude'),\n            placeholder: z.string().default('{{压缩相邻消息::below_dx}}'),\n        })\n            .prefault({}),\n    })\n        .prefault({}),\n    chat_history: z\n        .object({\n        type: z.enum(['squash_nearby', 'squash_into_one']).default('squash_into_one'),\n        squash_role: z.enum(['user', 'assistant', 'system']).default('assistant'),\n        user_prefix: z.string().default('<observed_piece class=\"下段剧情指令\">\\n'),\n        user_suffix: z.string().default('\\n</observed_piece>'),\n        assistant_prefix: z.string().default('<observed_piece class=\"剧情\">\\n'),\n        assistant_suffix: z.string().default('\\n</observed_piece>'),\n        system_prefix: z.string().default('<observed_piece class=\"设定\">\\n'),\n        system_suffix: z.string().default('\\n</observed_piece>'),\n    })\n        .prefault({}),\n})\n    .prefault({});\nexport const useSettingsStore = defineStore('压缩相邻消息', () => {\n    const variables = getVariables({ type: 'script', script_id: getScriptId() });\n    const settings = ref((_.has(variables, 'seperator') ? OldSettings : Settings).parse(variables));\n    const should_enable = ref(false);\n    registerAsUniqueScript('压缩相邻消息').listenPreferenceState(preferred_script_id => {\n        should_enable.value = preferred_script_id === getScriptId();\n    });\n    const locked_as = ref(false);\n    watchEffect(() => {\n        replaceVariables(klona(settings.value), { type: 'script', script_id: getScriptId() });\n    });\n    const useEscapedNewline = (path) => {\n        return computed({\n            get: () => _.get(settings.value, path).replace(/\\n/g, '\\\\n'),\n            set: value => _.set(settings.value, path, value.replace(/\\\\n/g, '\\n')),\n        });\n    };\n    return { settings, should_enable, locked_as, useEscapedNewline };\n});\n","import { initSquashWithoutPanel } from '@/酒馆助手/压缩相邻消息/squash';\nimport { Settings } from '@/酒馆助手/压缩相邻消息/store';\nimport { checkMinimumVersion } from '@util/common';\nimport { loadReadme } from '@util/script';\n\n$(() => {\n  checkMinimumVersion('3.4.17', '深度条目排斥器');\n  loadReadme('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/深度条目排斥器/README.md');\n  const { destroy } = initSquashWithoutPanel(\n    Settings.decode({\n      depth_injection: {\n        above: {\n          enabled: true,\n          type: 'exclude',\n        },\n        below: {\n          enabled: true,\n          type: 'exclude',\n        },\n      },\n      chat_history: {\n        type: 'squash_nearby',\n      },\n    }),\n  );\n  $(window).on('pagehide', () => {\n    destroy();\n  });\n});\n"],"names":["chunkBy","array","predicate","length","chunks","lhs","rhs","_","zip","dropRight","drop","push","regexFromString","input","replace_macros","makeRegex","pattern","flags","substitudeMacros","RegExp","match","escapeRegExp","test","pull","indexOf","getComplementString","string","bytes","TextEncoder","encode","complemented","Uint8Array","i","hex","toString","padStart","registerAsUniqueScript","id","script_id","getScriptId","path","getPreferredScriptId","registered_scripts","get","window","parent","Set","$","find","toArray","map","element","String","attr","filter","has","last","update","value","undefined","add","eventEmit","unregister","delete","listenPreferenceState","callback","eventOn","getPromptContent","prompt","settings","content","type","text","join","delimiter","updatePromptContentWith","updater","role","remove","item","splice","squashAdjacentMessage","prompts","chunk","listenEvent","separators","shouldEnable","handlePrompts","dry_run","head_index","findIndex","includes","head","deep_index","deep","tail_index","tail","split_with_context","splitted_before","before_index","current_index","splitter","split","splitted","splitted_head","splitted_deep","splitted_tail","slice","seperatePrompts","rejectEmptyPrompts","reject","trim","dropWhile","line","dropRightWhile","above","below","depth_injection","applyInjection","injection_settings","from","to","enabled","isSystemWithoutPlaceholder","p","placeholder","placeholder_content","flatten","some","exclude_chunk","concat","forEach","replaceAll","above_chat_history","below_chat_history","result","chat_history","prefix","system","system_prefix","assistant","assistant_prefix","user","user_prefix","suffix","system_suffix","assistant_suffix","user_suffix","tagContent","squash_role","squashChatHistory","destination","new_array","handlePrompts2","messages","getTavernVersion","tavern_events","GENERATE_AFTER_DATA","CHAT_COMPLETION_SETTINGS_READY","handleStopStringOnStream","stop_string","regex","trimStart","SillyTavern","stopGeneration","eventMakeFirst","STREAM_TOKEN_RECEIVED","handleStopStringOnReceived","async","message_id","chat_message","chat","Number","first_non_space_index","mes","search","searched_index","swipes","set","swipe_id","updateMessageBlock","saveChat","MESSAGE_RECEIVED","unlisten","eventRemoveListener","initSquashWithoutPanel","uninject","Object","freeze","position","depth","threshold","inject","_type","_option","injectPrompts","values","GENERATION_AFTER_COMMANDS","uninjectPrompts","injectSeparators","destroy","z","Vue","OldSettings","object","seperator","enum","transform","data","put_system_injection_after_chat_history","boolean","on_chat_history","Settings","parse","default","prefault","catch","number","int","min","variables","getVariables","ref","should_enable","preferred_script_id","locked_as","watchEffect","replaceVariables","useEscapedNewline","computed","replace","expected","title","getTavernHelperVersion","toastr","error","checkMinimumVersion","url","readme","fetch","ok","readme_text","replaceScriptInfo","loadReadme","decode","on"],"sourceRoot":""}