{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/util/common.ts","src://tavern_helper_template/external var \"Vue\"","src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/酒馆助手/压缩相邻消息/settings.ts","src://tavern_helper_template/src/酒馆助手/压缩相邻消息/squash.ts","src://tavern_helper_template/src/酒馆助手/深度条目排斥器/index.ts","src://tavern_helper_template/src/util/script.ts"],"sourcesContent":["import { compare } from 'compare-versions';\n\nexport function assignInplace<T>(destination: T[], new_array: T[]): T[] {\n  destination.length = 0;\n  destination.push(...new_array);\n  return destination;\n}\n\nexport function chunkBy<T>(array: T[], predicate: (lhs: T, rhs: T) => boolean): T[][] {\n  if (array.length === 0) {\n    return [];\n  }\n\n  const chunks: T[][] = [[array[0]]];\n  for (const [lhs, rhs] of _.zip(_.dropRight(array), _.drop(array))) {\n    if (predicate(lhs!, rhs!)) {\n      chunks[chunks.length - 1].push(rhs!);\n    } else {\n      chunks.push([rhs!]);\n    }\n  }\n  return chunks;\n}\n\nexport function regexFromString(input: string): RegExp | null {\n  if (!input) {\n    return null;\n  }\n  try {\n    const match = input.match(/\\/(.+)\\/([a-z]*)/i);\n    if (!match) {\n      return new RegExp(_.escapeRegExp(input), 'gi');\n    }\n    if (match[3] && !/^(?!.*?(.).*?\\1)[gmixXsuUAJ]+$/.test(match[3])) {\n      return new RegExp(input, 'gi');\n    }\n    let flags = match[3];\n    if (flags.indexOf('g') === -1) {\n      flags = flags + 'g';\n    }\n    if (flags.indexOf('i') === -1) {\n      flags = flags + 'i';\n    }\n    return new RegExp(match[2], flags);\n  } catch {\n    return null;\n  }\n}\n\nexport function uuidv4(): string {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nexport async function checkMinimumVersion(expected: string, title: string) {\n  if (compare(await getTavernHelperVersion(), expected, '<')) {\n    toastr.error(`'${title}' 需要酒馆助手版本 >= '${expected}'`, '版本不兼容');\n  }\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = Vue;","const __WEBPACK_NAMESPACE_OBJECT__ = z;","import { defineStore } from 'pinia';\nimport { ref, watchEffect } from 'vue';\nexport const Settings = z.object({\n    name: z.string().default('压缩相邻消息'),\n    seperator: z\n        .object({\n        type: z.enum(['space', 'newline', 'double newline', 'custom']).default('double newline'),\n        value: z.string().default('\\n\\n'),\n    })\n        .prefault({})\n        .transform(data => {\n        switch (data.type) {\n            case 'space':\n                data.value = ' ';\n                break;\n            case 'newline':\n                data.value = '\\n';\n                break;\n            case 'double newline':\n                data.value = '\\n\\n';\n                break;\n            case 'custom':\n                break;\n        }\n        return data;\n    }),\n    put_system_injection_after_chat_history: z.boolean().default(false),\n    on_chat_history: z\n        .object({\n        type: z.enum(['mixin', 'seperate', 'squash']).default('squash'),\n        squash_role: z.enum(['user', 'assistant', 'system']).default('assistant'),\n        user_prefix: z.string().default('{{user}}: '),\n        user_suffix: z.string().default(''),\n        assistant_prefix: z.string().default('剧情: '),\n        assistant_suffix: z.string().default(''),\n        system_prefix: z.string().default(''),\n        system_suffix: z.string().default(''),\n    })\n        .prefault({}),\n    stop_string: z.string().default('').catch(''),\n});\nexport const useSettingsStore = defineStore('settings', () => {\n    const settings = ref(Settings.parse(getVariables({ type: 'script', script_id: getScriptId() })));\n    watchEffect(() => {\n        insertOrAssignVariables(klona(settings.value), { type: 'script', script_id: getScriptId() });\n    });\n    return { settings };\n});\n","import { assignInplace, chunkBy, regexFromString, uuidv4 } from '@/util/common';\nimport { Settings } from './settings';\n\ntype Prompt = {\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n};\n\n//----------------------------------------------------------------------------------------------------------------------\ntype Seperators = {\n  head: InjectionPrompt;\n  deep: InjectionPrompt;\n  tail: InjectionPrompt;\n};\n\nfunction injectSeperators(settings: Settings) {\n  const seperators = Object.freeze({\n    head: {\n      id: `\\0${settings.name}`,\n      position: 'in_chat',\n      depth: 9999,\n      role: 'assistant',\n      content: uuidv4(),\n    },\n    deep: {\n      id: `\\xff${settings.name}深度分割`,\n      position: 'in_chat',\n      depth: 10,\n      role: 'system',\n      content: uuidv4(),\n    },\n    tail: {\n      id: `\\xff${settings.name}`,\n      position: 'in_chat',\n      depth: 0,\n      role: 'system',\n      content: uuidv4(),\n    },\n  } as const);\n\n  const inject = (_type: string, _option: object, dry_run: boolean) => {\n    if (dry_run) {\n      return;\n    }\n    injectPrompts(Object.values(seperators));\n  };\n  eventOn(tavern_events.GENERATION_AFTER_COMMANDS, inject);\n\n  return {\n    seperators,\n    uninject: () => {\n      eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS, inject);\n      uninjectPrompts(Object.values(seperators).map(({ id }) => id));\n    },\n  };\n}\n\n//----------------------------------------------------------------------------------------------------------------------\nfunction seperatePrompts(prompts: Prompt[], seperators: Seperators): Prompt[][] | null {\n  const head_index = prompts.findIndex(({ content }) => content.includes(seperators.head.content));\n  const deep_index = prompts.findIndex(({ content }) => content.includes(seperators.deep.content));\n  const tail_index = prompts.findIndex(({ content }) => content.includes(seperators.tail.content));\n  if (head_index === -1 || deep_index === -1 || tail_index === -1) {\n    return null;\n  }\n\n  const [before_head_prompt_content, after_head_prompt_content] = prompts[head_index].content.split(\n    seperators.head.content,\n  );\n  const [before_deep_prompt_content, after_deep_prompt_content] = prompts[deep_index].content.split(\n    seperators.deep.content,\n  );\n  const [before_tail_prompt_content, after_tail_prompt_content] = prompts[tail_index].content.split(\n    seperators.tail.content,\n  );\n\n  return [\n    [...prompts.slice(0, head_index), { role: prompts[head_index].role, content: before_head_prompt_content }],\n    [\n      { role: prompts[head_index].role, content: after_head_prompt_content },\n      ...prompts.slice(head_index + 1, deep_index),\n      { role: prompts[deep_index].role, content: before_deep_prompt_content },\n    ],\n    [\n      { role: prompts[deep_index].role, content: after_deep_prompt_content },\n      ...prompts.slice(deep_index + 1, tail_index),\n      { role: prompts[tail_index].role, content: before_tail_prompt_content },\n    ],\n    [{ role: prompts[tail_index].role, content: after_tail_prompt_content }, ...prompts.slice(tail_index + 1)],\n  ];\n}\n\nfunction rejectEmptyPrompts(prompts: Prompt[]): Prompt[] {\n  return prompts.filter(({ content }) => content.trim() !== '');\n}\n\nfunction squashMessageByRole(prompts: Prompt[], settings: Settings): Prompt[] {\n  return chunkBy(prompts, (lhs, rhs) => lhs.role === rhs.role).map(chunk => ({\n    role: chunk[0].role,\n    content: chunk.map(({ content }) => content.trim()).join(settings.seperator.value),\n  }));\n}\n\nfunction squashChatHistory(prompts: Prompt[], settings: Settings): Prompt {\n  // TODO: zod encode\n  const system_prefix = substitudeMacros(settings.on_chat_history.system_prefix);\n  const system_suffix = substitudeMacros(settings.on_chat_history.system_suffix);\n  const assistant_prefix = substitudeMacros(settings.on_chat_history.assistant_prefix);\n  const assistant_suffix = substitudeMacros(settings.on_chat_history.assistant_suffix);\n  const user_prefix = substitudeMacros(settings.on_chat_history.user_prefix);\n  const user_suffix = substitudeMacros(settings.on_chat_history.user_suffix);\n  return {\n    role: settings.on_chat_history.squash_role,\n    content: prompts\n      .map(({ role, content }) => {\n        switch (role) {\n          case 'system':\n            return system_prefix + content.trim() + system_suffix;\n          case 'assistant':\n            return assistant_prefix + content.trim() + assistant_suffix;\n          case 'user':\n            return user_prefix + content.trim() + user_suffix;\n        }\n      })\n      .join(settings.seperator.value),\n  };\n}\n\nfunction listenEvent(settings: Settings, seperators: Seperators) {\n  let check_dry_run = false;\n  const checkDryRun = (_type: string, _option: object, dry_run: boolean) => {\n    check_dry_run = dry_run;\n  };\n  eventOn(tavern_events.GENERATION_AFTER_COMMANDS, checkDryRun);\n\n  const handlePrompts = ({ prompt }: { prompt: SillyTavern.SendingMessage[] }, dry_run?: boolean) => {\n    // 1.13.4 及之前 GENERATE_AFTER_DATA 没有 dry_run 参数\n    if (dry_run ?? check_dry_run) {\n      return;\n    }\n\n    if (prompt.some(({ content }) => typeof content !== 'string')) {\n      // TODO: 支持带图片、多媒体的脚本\n      return;\n    }\n\n    // @ts-expect-error 类型正确\n    const chunks = seperatePrompts(prompt, seperators);\n    if (chunks === null) {\n      return;\n    }\n    if (settings.put_system_injection_after_chat_history) {\n      chunks[0] = _.concat(\n        chunks[0],\n        _.remove(chunks[1], ({ role }) => role === 'system'),\n      );\n      chunks[3] = _.concat(\n        _.remove(chunks[2], ({ role }) => role === 'system'),\n        chunks[3],\n      );\n    }\n    const [head, before_chat_history, after_chat_history, tail] = _(chunks)\n      .map(prompts => rejectEmptyPrompts(prompts))\n      .map(prompts => squashMessageByRole(prompts, settings))\n      .value();\n    switch (settings.on_chat_history.type) {\n      case 'mixin':\n        assignInplace(\n          prompt,\n          squashMessageByRole(_.concat(head, before_chat_history, after_chat_history, tail), settings),\n        );\n        break;\n      case 'seperate':\n        assignInplace(\n          prompt,\n          _.concat(head, squashMessageByRole(_.concat(before_chat_history, after_chat_history), settings), tail),\n        );\n        break;\n      case 'squash':\n        assignInplace(\n          prompt,\n          _.concat(head, squashChatHistory(_.concat(before_chat_history, after_chat_history), settings), tail),\n        );\n        break;\n    }\n  };\n  eventOn(tavern_events.GENERATE_AFTER_DATA, handlePrompts);\n\n  const handleStopStringOnStream = (text: string) => {\n    if (!settings.stop_string) {\n      return;\n    }\n    const regex = regexFromString(settings.stop_string);\n    if (!regex) {\n      return;\n    }\n    if (regex.test(text)) {\n      SillyTavern.stopGeneration();\n    }\n  };\n  eventMakeFirst(tavern_events.STREAM_TOKEN_RECEIVED, handleStopStringOnStream);\n\n  const handleStopStringOnReceived = async (message_id: number | string) => {\n    if (!settings.stop_string) {\n      return;\n    }\n\n    const chat_message = SillyTavern.chat[Number(message_id)];\n\n    const regex = regexFromString(settings.stop_string);\n    if (!regex) {\n      return;\n    }\n    const result = regex.exec(chat_message.mes);\n    if (result) {\n      chat_message.mes = chat_message.mes.slice(0, result.index);\n      if (chat_message.swipes) {\n        _.set(chat_message, ['swipes', chat_message.swipe_id!], chat_message.mes);\n      }\n      // 与 https://gitgud.io/Monblant/noass 采用相同逻辑而不使用 setChatMessages, 因为 CHARACTER_MESSAGE_RENDERED 将会随后自然触发\n      SillyTavern.updateMessageBlock(Number(message_id), chat_message);\n      await SillyTavern.saveChat();\n    }\n  };\n  eventMakeFirst(tavern_events.MESSAGE_RECEIVED, handleStopStringOnReceived);\n\n  return {\n    unlisten: () => {\n      eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS, checkDryRun);\n      eventRemoveListener(tavern_events.GENERATE_AFTER_DATA, handlePrompts);\n    },\n  };\n}\n\n//----------------------------------------------------------------------------------------------------------------------\nexport function initSquash(settings: Settings) {\n  const { seperators, uninject } = injectSeperators(settings);\n  const { unlisten } = listenEvent(settings, seperators);\n  return {\n    destroy: () => {\n      uninject();\n      unlisten();\n    },\n  };\n}\n","import { checkMinimumVersion } from '@/util/common';\nimport { loadReadme } from '@/util/script';\nimport { Settings } from '@/酒馆助手/压缩相邻消息/settings';\nimport { initSquash } from '@/酒馆助手/压缩相邻消息/squash';\n\n$(() => {\n  checkMinimumVersion('3.4.17', '深度条目排斥器');\n  loadReadme('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/深度条目排斥器/README.md');\n  const { destroy } = initSquash(\n    Settings.decode({\n      name: '深度排斥器',\n      put_system_injection_after_chat_history: true,\n      on_chat_history: {\n        type: 'mixin',\n      },\n    }),\n  );\n  $(window).on('pagehide', () => {\n    destroy();\n  });\n});\n","export async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle() {\n  if ($(`head > div[script_id=\"${getScriptId()}\"]`).length > 0) {\n    return;\n  }\n  const $div = $(`<div>`).attr('script_id', getScriptId()).append($(`head > style`, document).clone());\n  $('head').append($div);\n}\n\nexport function deteleportStyle() {\n  $(`head > div[script_id=\"${getScriptId()}\"]`).remove();\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function destroyScriptIdDiv(): void {\n  $(`div[script_id=\"${getScriptId()}\"]`).remove();\n}\n\nexport function reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, new_chat_id => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n"],"names":["assignInplace","destination","new_array","length","push","regexFromString","input","match","RegExp","_","escapeRegExp","test","flags","indexOf","uuidv4","replace","c","r","Math","random","toString","Vue","z","Settings","object","name","string","default","seperator","type","enum","value","prefault","transform","data","put_system_injection_after_chat_history","boolean","on_chat_history","squash_role","user_prefix","user_suffix","assistant_prefix","assistant_suffix","system_prefix","system_suffix","stop_string","catch","settings","ref","parse","getVariables","script_id","getScriptId","watchEffect","insertOrAssignVariables","squashMessageByRole","prompts","array","predicate","chunks","lhs","rhs","zip","dropRight","drop","chunkBy","role","map","chunk","content","trim","join","listenEvent","seperators","check_dry_run","checkDryRun","_type","_option","dry_run","eventOn","tavern_events","GENERATION_AFTER_COMMANDS","handlePrompts","prompt","some","head_index","findIndex","includes","head","deep_index","deep","tail_index","tail","before_head_prompt_content","after_head_prompt_content","split","before_deep_prompt_content","after_deep_prompt_content","before_tail_prompt_content","after_tail_prompt_content","slice","seperatePrompts","concat","remove","before_chat_history","after_chat_history","filter","rejectEmptyPrompts","substitudeMacros","squashChatHistory","GENERATE_AFTER_DATA","eventMakeFirst","STREAM_TOKEN_RECEIVED","text","regex","SillyTavern","stopGeneration","MESSAGE_RECEIVED","async","message_id","chat_message","chat","Number","result","exec","mes","index","swipes","set","swipe_id","updateMessageBlock","saveChat","unlisten","eventRemoveListener","initSquash","uninject","Object","freeze","id","position","depth","inject","injectPrompts","values","uninjectPrompts","injectSeperators","destroy","$","expected","title","getTavernHelperVersion","toastr","error","checkMinimumVersion","url","readme","fetch","ok","readme_text","replaceScriptInfo","loadReadme","decode","window","on"],"ignoreList":[],"sourceRoot":""}