{"version":3,"file":"index.js","mappings":"gQAGA,SAASA,EAAwBC,GAC/B,OAAOA,EAAMC,QAAQ,qCAAqCC,KAAK,qBACjE,CAEA,SAASC,IACPC,EAASC,aACT,MAAMC,EAAWC,EACf,8KAEIC,EAAmBF,EAASG,KAAK,mCAEvCH,EAASG,KAAK,iCAAiCC,IAAI,iBAAkB,QACrEF,EAAiBC,KAAK,kEAAkEE,SACxFH,EAAiBI,QACfL,EAAE,qGAAqGM,GACrG,QACAC,iBAEE,UADqBC,YAAYC,iBAAiB,gBAAiBD,YAAYE,WAAWC,SAExF,OAEF,MAAMC,EAAYpB,EAAwBQ,EAAEa,aACtCC,iBACJ,SACAC,IACE,MAAMC,EAAQD,EAAOE,QAAQC,UAAUC,GAAUA,EAAOC,KAAOR,GAC/D,OAAe,IAAXI,GAGJD,EAAOE,QAAQI,OAAOL,EAAO,GAFpBD,GAKX,CAAEO,OAAQ,aAEd,GAEFtB,EAAE,wFAAwFM,GACxF,QACAC,iBACE,MAAMK,EAAYpB,EAAwBQ,EAAEa,aACtCC,iBACJ,SACAC,IACE,MAAMC,EAAQD,EAAOE,QAAQC,UAAUC,GAAUA,EAAOC,KAAOR,GAC/D,OAAe,IAAXI,GAGJD,EAAOE,QAAQI,OAAOL,EAAQ,EAAG,EAAGD,EAAOE,QAAQD,IAF1CD,GAKX,CAAEO,OAAQ,aAEd,IAIJzB,EAAS0B,QAAQvB,EAAE,8BAA8B,GAAI,CACnDwB,WAAW,EACXC,SAAS,GAEb,CACA,MAAMC,EAA4BC,EAAEC,SAAShC,EAAiB,KAExDC,EAAW,IAAIgC,iBAAiBH,GAEtC1B,EAAE,MCJKO,eAAmCuB,EAAkBC,GACtD,QAAcC,yBAA0BF,EAAU,MACpDG,OAAOC,MAAM,IAAIH,mBAAuBD,KAAa,QAEzD,CDCEK,CAAoB,QAAS,YEnExB5B,eAA0B6B,GAC/B,MAAMC,QAAeC,MAAMF,GAC3B,IAAKC,EAAOE,GACV,OAAO,EAET,MAAMC,QAAoBH,EAAOI,OACjCC,kBAAkBF,EAEpB,CF4DEG,CAAW,0FAEX/C,MAGFI,EAAE4C,QAAQtC,GAAG,WAAY,KACvBuC,cAAc,SAAUC,UAAU,WAClCjD,EAASC","sources":["src://tavern_helper_template/src/酒馆助手/预设条目更多按钮/index.ts","src://tavern_helper_template/util/common.ts","src://tavern_helper_template/util/script.ts"],"sourcesContent":["import { checkMinimumVersion } from '@util/common';\nimport { loadReadme } from '@util/script';\n\nfunction get_prompt_id_from_tool($tool: JQuery) {\n  return $tool.closest('.completion_prompt_manager_prompt').attr('data-pm-identifier')!;\n}\n\nfunction replace_toolbox() {\n  observer.disconnect();\n  const $prompts = $(\n    '.completion_prompt_manager_prompt:has(.fa-asterisk), .completion_prompt_manager_prompt:has(.fa-syringe), .completion_prompt_manager_prompt:has(.fa-square-poll-horizontal)',\n  );\n  const $prompt_controls = $prompts.find('.prompt_manager_prompt_controls');\n\n  $prompts.find('.prompt_manager_prompt_tokens').css('pointer-events', 'none');\n  $prompt_controls.find('span[title=\"Remove\"], span[title=\"copy\"], span[title=\"delete\"]').remove();\n  $prompt_controls.prepend(\n    $('<span title=\"delete\" class=\"prompt-manager-remove-action caution fa-solid fa-trash fa-xs\"></span>').on(\n      'click',\n      async function () {\n        const result = await SillyTavern.callGenericPopup('确定要永久删除这个条目吗?', SillyTavern.POPUP_TYPE.CONFIRM);\n        if (!result) {\n          return;\n        }\n        const prompt_id = get_prompt_id_from_tool($(this));\n        await updatePresetWith(\n          'in_use',\n          preset => {\n            const index = preset.prompts.findIndex(prompt => prompt.id === prompt_id);\n            if (index === -1) {\n              return preset;\n            }\n            preset.prompts.splice(index, 1);\n            return preset;\n          },\n          { render: 'immediate' },\n        );\n      },\n    ),\n    $('<span title=\"copy\" class=\"prompt-manager-copy-action fa-solid fa-copy fa-xs\"></span>').on(\n      'click',\n      async function () {\n        const prompt_id = get_prompt_id_from_tool($(this));\n        await updatePresetWith(\n          'in_use',\n          preset => {\n            const index = preset.prompts.findIndex(prompt => prompt.id === prompt_id);\n            if (index === -1) {\n              return preset;\n            }\n            preset.prompts.splice(index + 1, 0, preset.prompts[index]);\n            return preset;\n          },\n          { render: 'immediate' },\n        );\n      },\n    ),\n  );\n\n  observer.observe($('#completion_prompt_manager')[0], {\n    childList: true,\n    subtree: true,\n  });\n}\nconst replace_toolbox_debounced = _.debounce(replace_toolbox, 500);\n\nconst observer = new MutationObserver(replace_toolbox_debounced);\n\n$(() => {\n  checkMinimumVersion('3.4.4', '预设条目更多按钮');\n  loadReadme('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/预设条目更多按钮/README.md');\n\n  replace_toolbox();\n});\n\n$(window).on('pagehide', () => {\n  replacePreset('in_use', getPreset('in_use'));\n  observer.disconnect();\n});\n","import { compare } from 'compare-versions';\nimport JSON5 from 'json5';\nimport { jsonrepair } from 'jsonrepair';\nimport { toDotPath } from 'zod/v4/core';\n\nexport function assignInplace<T>(destination: T[], new_array: T[]): T[] {\n  destination.length = 0;\n  destination.push(...new_array);\n  return destination;\n}\n\nexport function chunkBy<T>(array: T[], predicate: (lhs: T, rhs: T) => boolean): T[][] {\n  if (array.length === 0) {\n    return [];\n  }\n\n  const chunks: T[][] = [[array[0]]];\n  for (const [lhs, rhs] of _.zip(_.dropRight(array), _.drop(array))) {\n    if (predicate(lhs!, rhs!)) {\n      chunks[chunks.length - 1].push(rhs!);\n    } else {\n      chunks.push([rhs!]);\n    }\n  }\n  return chunks;\n}\n\nexport function regexFromString(input: string, replace_macros?: boolean): RegExp | null {\n  if (!input) {\n    return null;\n  }\n  const makeRegex = (pattern: string, flags: string) => {\n    if (replace_macros) {\n      pattern = substitudeMacros(pattern);\n    }\n    return new RegExp(pattern, flags);\n  };\n  try {\n    const match = input.match(/\\/(.+)\\/([a-z]*)/i);\n    if (!match) {\n      return makeRegex(_.escapeRegExp(input), 'i');\n    }\n    if (match[2] && !/^(?!.*?(.).*?\\1)[gmixXsuUAJ]+$/.test(match[3])) {\n      return makeRegex(input, 'i');\n    }\n    let flags = match[2] ?? '';\n    _.pull(flags, 'g');\n    if (flags.indexOf('i') === -1) {\n      flags = flags + 'i';\n    }\n    return makeRegex(match[1], flags);\n  } catch {\n    return null;\n  }\n}\n\nexport function uuidv4(): string {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nexport async function checkMinimumVersion(expected: string, title: string) {\n  if (compare(await getTavernHelperVersion(), expected, '<')) {\n    toastr.error(`'${title}' 需要酒馆助手版本 >= '${expected}'`, '版本不兼容');\n  }\n}\n\nexport function prettifyErrorWithInput(error: z.ZodError) {\n  return _([...error.issues])\n    .sortBy(issue => issue.path?.length ?? 0)\n    .flatMap(issue => {\n      const lines = [`✖ ${issue.message}`];\n      if (issue.path?.length) {\n        lines.push(`  → 路径: ${toDotPath(issue.path)}`);\n      }\n      if (issue.input !== undefined) {\n        lines.push(`  → 输入: ${JSON.stringify(issue.input)}`);\n      }\n      return lines;\n    })\n    .join('\\n');\n}\n\nexport function literalYamlify(value: any) {\n  return YAML.stringify(value, { blockQuote: 'literal' });\n}\n\nexport function parseString(content: string): any {\n  let parsed: unknown;\n  try {\n    parsed = YAML.parseDocument(content, { merge: true }).toJS();\n  } catch (yaml_error) {\n    try {\n      parsed = JSON5.parse(content);\n    } catch (json5_error) {\n      try {\n        parsed = JSON.parse(jsonrepair(content));\n      } catch (json_error) {\n        const toError = (error: unknown) => (error instanceof Error ? error.message : String(error));\n        throw new Error(\n          literalYamlify({\n            ['要解析的字符串不是有效的 YAML/JSON 格式']: {\n              字符串内容: content,\n              YAML错误信息: toError(yaml_error),\n              JSON5错误信息: toError(json5_error),\n              尝试修复JSON时的错误信息: toError(json_error),\n            },\n          }),\n        );\n      }\n    }\n  }\n  return parsed;\n}\n","import iframe_srcdoc from './iframe_srcdoc.html';\n\nexport async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle(\n  append_to: JQuery.Selector | JQuery.htmlString | JQuery.TypeOrArray<Element | DocumentFragment> | JQuery = 'head',\n): { destroy: () => void } {\n  const $div = $(`<div>`)\n    .attr('script_id', getScriptId())\n    .append($(`head > style`, document).clone())\n    .appendTo(append_to);\n\n  return {\n    destroy: () => $div.remove(),\n  };\n}\n\nexport function createScriptIdIframe(): JQuery<HTMLIFrameElement> {\n  return $(`<iframe>`).attr({\n    script_id: getScriptId(),\n    frameborder: 0,\n    srcdoc: iframe_srcdoc,\n  }) as JQuery<HTMLIFrameElement>;\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, new_chat_id => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n\nexport function registerAsUniqueScript(id: string): {\n  unregister: () => void;\n  getPreferredScriptId: () => string | undefined;\n  listenPreferenceState: (callback: (perferred_script_id: string) => void) => EventOnReturn;\n} {\n  const script_id = getScriptId();\n  const path = `th_unique_check.${id}`;\n\n  const getPreferredScriptId = () => {\n    const registered_scripts = _.get(window.parent, path, new Set<string>());\n    return _($('#tavern_helper').find('div[data-script-id]').toArray())\n      .map(element => String($(element).attr('data-script-id')))\n      .filter(element => registered_scripts.has(element))\n      .last();\n  };\n\n  _.update(window.parent, path, (value: Set<string> | undefined) => {\n    if (value === undefined) {\n      return new Set([script_id]);\n    }\n    value.add(script_id);\n    return value;\n  });\n  eventEmit(path, getPreferredScriptId());\n\n  return {\n    unregister: () => {\n      _.update(window.parent, path, (value: Set<string> | undefined) => {\n        if (value !== undefined) {\n          value.delete(script_id);\n        }\n        return value;\n      });\n      eventEmit(path, getPreferredScriptId());\n    },\n    getPreferredScriptId,\n    listenPreferenceState: (callback: (enabled_script_id: string) => void) => eventOn(path, callback),\n  };\n}\n"],"names":["get_prompt_id_from_tool","$tool","closest","attr","replace_toolbox","observer","disconnect","$prompts","$","$prompt_controls","find","css","remove","prepend","on","async","SillyTavern","callGenericPopup","POPUP_TYPE","CONFIRM","prompt_id","this","updatePresetWith","preset","index","prompts","findIndex","prompt","id","splice","render","observe","childList","subtree","replace_toolbox_debounced","_","debounce","MutationObserver","expected","title","getTavernHelperVersion","toastr","error","checkMinimumVersion","url","readme","fetch","ok","readme_text","text","replaceScriptInfo","loadReadme","window","replacePreset","getPreset"],"ignoreList":[],"sourceRoot":""}