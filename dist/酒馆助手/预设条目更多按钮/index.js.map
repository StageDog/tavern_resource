{"version":3,"file":"index.js","mappings":"mFAEA,SAASA,EAAwBC,GAC/B,OAAOA,EAAMC,QAAQ,qCAAqCC,KAAK,qBACjE,CAEA,SAASC,IACPC,EAASC,aACT,MAAMC,EAAWC,EACf,8KAEIC,EAAmBF,EAASG,KAAK,mCAEvCH,EAASG,KAAK,iCAAiCC,IAAI,iBAAkB,QACrEF,EAAiBC,KAAK,kEAAkEE,SACxFH,EAAiBI,QACfL,EAAE,qGAAqGM,GACrG,QACAC,iBAEE,UADqBC,YAAYC,iBAAiB,gBAAiBD,YAAYE,WAAWC,SAExF,OAEF,MAAMC,EAAYpB,EAAwBQ,EAAEa,aACtCC,iBACJ,SACAC,IACE,MAAMC,EAAQD,EAAOE,QAAQC,UAAUC,GAAUA,EAAOC,KAAOR,GAC/D,OAAe,IAAXI,GAGJD,EAAOE,QAAQI,OAAOL,EAAO,GAFpBD,GAKX,CAAEO,OAAQ,aAEd,GAEFtB,EAAE,wFAAwFM,GACxF,QACAC,iBACE,MAAMK,EAAYpB,EAAwBQ,EAAEa,aACtCC,iBACJ,SACAC,IACE,MAAMC,EAAQD,EAAOE,QAAQC,UAAUC,GAAUA,EAAOC,KAAOR,GAC/D,OAAe,IAAXI,GAGJD,EAAOE,QAAQI,OAAOL,EAAQ,EAAG,EAAGD,EAAOE,QAAQD,IAF1CD,GAKX,CAAEO,OAAQ,aAEd,IAIJzB,EAAS0B,QAAQvB,EAAE,8BAA8B,GAAI,CACnDwB,WAAW,EACXC,SAAS,GAEb,CACA,MAAMC,EAA4BC,EAAEC,SAAShC,EAAiB,KAExDC,EAAW,IAAIgC,iBAAiBH,GAEtC1B,EAAE,MC3CKO,eAAmCuB,EAAkBC,GACtD,QAAcC,yBAA0BF,EAAU,MACpDG,OAAOC,MAAM,IAAIH,mBAAuBD,KAAa,QAEzD,CDwCEK,CAAoB,QAAS,YCtCxB5B,eAA0B6B,GAC/B,MAAMC,QAAeC,MAAMF,GAC3B,IAAKC,EAAOE,GACV,OAAO,EAET,MAAMC,QAAoBH,EAAOI,OACjCC,kBAAkBF,EAEpB,CD+BEG,CAAW,0FAEX/C,MAGFI,EAAE4C,QAAQtC,GAAG,WAAY,KACvBuC,cAAc,SAAUC,UAAU,WAClCjD,EAASC","sources":["src://tavern_helper_template/src/酒馆助手/预设条目更多按钮/index.ts","src://tavern_helper_template/src/util/tavern.ts"],"sourcesContent":["import { checkMinimumVersion, loadReadme } from 'util/tavern';\n\nfunction get_prompt_id_from_tool($tool: JQuery) {\n  return $tool.closest('.completion_prompt_manager_prompt').attr('data-pm-identifier')!;\n}\n\nfunction replace_toolbox() {\n  observer.disconnect();\n  const $prompts = $(\n    '.completion_prompt_manager_prompt:has(.fa-asterisk), .completion_prompt_manager_prompt:has(.fa-syringe), .completion_prompt_manager_prompt:has(.fa-square-poll-horizontal)',\n  );\n  const $prompt_controls = $prompts.find('.prompt_manager_prompt_controls');\n\n  $prompts.find('.prompt_manager_prompt_tokens').css('pointer-events', 'none');\n  $prompt_controls.find('span[title=\"Remove\"], span[title=\"copy\"], span[title=\"delete\"]').remove();\n  $prompt_controls.prepend(\n    $('<span title=\"delete\" class=\"prompt-manager-remove-action caution fa-solid fa-trash fa-xs\"></span>').on(\n      'click',\n      async function () {\n        const result = await SillyTavern.callGenericPopup('确定要永久删除这个条目吗?', SillyTavern.POPUP_TYPE.CONFIRM);\n        if (!result) {\n          return;\n        }\n        const prompt_id = get_prompt_id_from_tool($(this));\n        await updatePresetWith(\n          'in_use',\n          preset => {\n            const index = preset.prompts.findIndex(prompt => prompt.id === prompt_id);\n            if (index === -1) {\n              return preset;\n            }\n            preset.prompts.splice(index, 1);\n            return preset;\n          },\n          { render: 'immediate' },\n        );\n      },\n    ),\n    $('<span title=\"copy\" class=\"prompt-manager-copy-action fa-solid fa-copy fa-xs\"></span>').on(\n      'click',\n      async function () {\n        const prompt_id = get_prompt_id_from_tool($(this));\n        await updatePresetWith(\n          'in_use',\n          preset => {\n            const index = preset.prompts.findIndex(prompt => prompt.id === prompt_id);\n            if (index === -1) {\n              return preset;\n            }\n            preset.prompts.splice(index + 1, 0, preset.prompts[index]);\n            return preset;\n          },\n          { render: 'immediate' },\n        );\n      },\n    ),\n  );\n\n  observer.observe($('#completion_prompt_manager')[0], {\n    childList: true,\n    subtree: true,\n  });\n}\nconst replace_toolbox_debounced = _.debounce(replace_toolbox, 500);\n\nconst observer = new MutationObserver(replace_toolbox_debounced);\n\n$(() => {\n  checkMinimumVersion('3.4.4', '预设条目更多按钮');\n  loadReadme('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/预设条目更多按钮/README.md');\n\n  replace_toolbox();\n});\n\n$(window).on('pagehide', () => {\n  replacePreset('in_use', getPreset('in_use'));\n  observer.disconnect();\n});\n","import { compare } from 'compare-versions';\n\nexport function assignInplace<T>(destination: T[], new_array: T[]): T[] {\n  destination.length = 0;\n  destination.push(...new_array);\n  return destination;\n}\n\nexport function chunkBy<T>(array: T[], predicate: (lhs: T, rhs: T) => boolean): T[][] {\n  if (array.length === 0) {\n    return [];\n  }\n\n  const chunks: T[][] = [[array[0]]];\n  for (const [lhs, rhs] of _.zip(_.dropRight(array), _.drop(array))) {\n    if (predicate(lhs!, rhs!)) {\n      chunks[chunks.length - 1].push(rhs!);\n    } else {\n      chunks.push([rhs!]);\n    }\n  }\n  return chunks;\n}\n\nexport async function checkMinimumVersion(expected: string, title: string) {\n  if (compare(await getTavernHelperVersion(), expected, '<')) {\n    toastr.error(`'${title}' 需要酒馆助手版本 >= '${expected}'`, '版本不兼容');\n  }\n}\n\nexport async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle() {\n  if ($(`head > div[script_id=\"${getScriptId()}\"]`).length > 0) {\n    return;\n  }\n  const $div = $(`<div>`).attr('script_id', getScriptId()).append($(`head > style`, document).clone());\n  $('head').append($div);\n}\n\nexport function deteleportStyle() {\n  $(`head > div[script_id=\"${getScriptId()}\"]`).remove();\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function destroyScriptIdDiv(): void {\n  $(`div[script_id=\"${getScriptId()}\"]`).remove();\n}\n"],"names":["get_prompt_id_from_tool","$tool","closest","attr","replace_toolbox","observer","disconnect","$prompts","$","$prompt_controls","find","css","remove","prepend","on","async","SillyTavern","callGenericPopup","POPUP_TYPE","CONFIRM","prompt_id","this","updatePresetWith","preset","index","prompts","findIndex","prompt","id","splice","render","observe","childList","subtree","replace_toolbox_debounced","_","debounce","MutationObserver","expected","title","getTavernHelperVersion","toastr","error","checkMinimumVersion","url","readme","fetch","ok","readme_text","text","replaceScriptInfo","loadReadme","window","replacePreset","getPreset"],"sourceRoot":""}