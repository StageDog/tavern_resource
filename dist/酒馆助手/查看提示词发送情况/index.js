function e(e){e.dryRun||'openai'!==SillyTavern.mainApi||setTimeout((async()=>{const n=await Promise.all(e.chat.map((async({role:e,content:n})=>({role:e,content:n,token:await SillyTavern.getTokenCountAsync(n)}))));localStorage.setItem('prompt_inspector_data',JSON.stringify(n)),localStorage.setItem('prompt_inspector_token',String(await SillyTavern.getTokenCountAsync(n.map((e=>e.content)).join('\n'))))}))}function n(){const e=JSON.parse(localStorage.getItem('prompt_inspector_data')??'[]'),n=localStorage.getItem('prompt_inspector_token')??'',t=$('<div id="completion_prompt_manager_popup">').append($('<h3>提示词发送情况</h3>')).append($('<div class="text_muted">').text(`总提示词数: ${n}`)).append($('<div id="completion_prompt_manager_popup_entry_form_inspect_list">').append(e.map((e=>{const n=$('<div class="inline-drawer completion_prompt_manager_prompt">'),t=$('<div class="inline-drawer-toggle inline-drawer-header">').append($('<span>').text(`身份: ${e.role}, 提示词数: ${e.token}`)).append($('<div class="fa-solid inline-drawer-icon interactable down fa-circle-chevron-down" tabindex="0">')),a=$('<div class="inline-drawer-content monospace">').css('white-space','pre-wrap').css('display','block').text(e.content);return n.append(t,a)}))));new SillyTavern.Popup(t[0],SillyTavern.POPUP_TYPE.TEXT,'',{leftAlign:!0,wide:!0,large:!0,allowVerticalScrolling:!0}).show()}$((()=>{!function(){const e=$('<div class="list-group-item flex-container flexGap5 interactable">').attr('id','prompt_inspector_button').prop('tabIndex',0).append($('<i class="fa-solid fa-bug">')).append($('<span>').text('提示词发送情况')).on('click',n);$('#extensionsMenu').append(e)}(),eventMakeLast(tavern_events.CHAT_COMPLETION_PROMPT_READY,e)})),$(window).on('unload',(()=>{$('#prompt_inspector_button').remove(),eventRemoveListener(tavern_events.CHAT_COMPLETION_PROMPT_READY,e)}));