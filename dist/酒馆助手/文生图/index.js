async function e(e){const t=await triggerSlash(`/sd quiet=true ${e}`);return t||null}function t(t,i,n){const s=$(`<div class="text_to_image_button" id="text_to_image-${t}-${i}">`);return s.append('<style>.text_to_image_button{align-items:center;background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);border-radius:2px;border:none;box-shadow:0 4px 6px rgba(99,102,241,.2);color:#fff;cursor:pointer;display:inline-flex;font-size:13px;font-weight:600;gap:8px;outline:none;padding:3px 4px;transition:all .3s ease;white-space:nowrap}</style>'),s.append($(`<button class="text_to_image_button" data="${_.escape(n.trim())}">生成图片</button>`).on('click',(async function(){$(this).text('生成中...');const r=await e(n);if(!r)return void $(this).text('发生错误, 点击重新生成');const l={index:i,image_urls:[r]},o=getVariables({type:'message',message_id:t});_.set(o,['text_to_image',i],l),await setChatMessages([{message_id:t,data:o}],{refresh:'none'}),s.replaceWith(a(t,i,n,l))}))),s}function a(a,i,n,s){const r=$(`<div class="text_to_image_swipe" id="text_to_image-${a}-${i}">`);r.append('<style>.text_to_image_swipe{margin:auto;width:50%}.text_to_image_swipe_counter{font-weight:600;filter:drop-shadow(black 2px 4px 6px);cursor:default}</style>');const l='fa-fade',o=async()=>{const e=getVariables({type:'message',message_id:a});0===s.image_urls.length?_.unset(e,['text_to_image',i]):_.set(e,['text_to_image',i],s),await setChatMessages([{message_id:a,data:e}],{refresh:'none'}),0!==s.image_urls.length?(r.find('.mes_img').attr('src',s.image_urls[s.index]),r.find('.text_to_image_swipe_counter').text(`${s.index+1}/${s.image_urls.length}`)):r.replaceWith(t(a,i,n))},g=async t=>{if(!r.hasClass(l)){if('left'===t)s.index=0===s.index?s.image_urls.length-1:s.index-1;else if(s.index=s.index===s.image_urls.length-1?s.image_urls.length:s.index+1,s.index===s.image_urls.length){r.addClass(l);let t=null;if(t=await e(n),!t)return void(s.index=s.image_urls.length-1);s.image_urls.push(t),r.removeClass(l)}o()}},c=e=>{if(!e)return;const t=$('<img>').addClass('img_enlarged').attr('src',e).on('click',(function(e){$(this).toggleClass('zoomed'),e.stopPropagation()})),a=$('<div>').addClass('img_enlarged_container').append($('<div>').addClass('img_enlarged_holder').append(t),$('<pre>').append($('<code>').addClass('img_enlarged_title txt').text(n).on('click',(e=>{e.stopPropagation()})).append($('<i>').addClass('fa-solid fa-copy code-copy interactable').attr('title','复制提示词').on('pointerup',(async function(){window.parent.navigator.clipboard.writeText(n),toastr.info('提示词已复制到剪贴板')}))))),i=new SillyTavern.Popup(a[0],SillyTavern.POPUP_TYPE.DISPLAY,'',{large:!0,transparent:!0});return i.dlg.style.width='unset',i.dlg.style.height='unset',i.dlg.addEventListener('click',(()=>{i.completeCancelled()})),i.show(),t};return r.append($('<div class=" mes_img_container img_extra img_swipes">').append($('<div class="mes_img_controls">').append($('<div title="放大" class="right_menu_button fa-lg fa-solid fa-magnifying-glass">').on('click',(()=>{c(r.find('.mes_img').attr('src'))?.trigger('click')})),$('<div title="删除" class="right_menu_button fa-lg fa-solid fa-trash-can">').on('click',(async()=>{await SillyTavern.callGenericPopup('是否要删除本图片? 本操作无法撤销 (删除只影响显示, 图片依旧会保存在 \'存档/user/images\' 目录下)',SillyTavern.POPUP_TYPE.CONFIRM,'',{okButton:'删除',cancelButton:'取消'})&&(s.image_urls.splice(s.index,1),s.index=0,o())}))),$('<div class="mes_img_swipes">').append($('<div title="左滑" class="right_menu_button fa-lg fa-solid fa-chevron-left">').on('click',(()=>g('left'))),$('<div class="text_to_image_swipe_counter"></div>'),$('<div title="右滑" class="right_menu_button fa-lg fa-solid fa-chevron-right">').on('click',(()=>g('right')))),$('<img class="mes_img">').on('click',(function(){c($(this).attr('src'))})))),r.css('text-align','center'),o(),r}async function i(e){const i=[...getChatMessages(e)[0].message.matchAll(/<image_tag>(.*?)<\/image_tag>/gs)].map(((i,n)=>function(e,i,n){const s=_.get(getVariables({type:'message',message_id:e}),['text_to_image',i]);return s?a(e,i,n,s):t(e,i,n)}(e,n,i[1])));retrieveDisplayedMessage(e).find('.text_to_image_button, .text_to_image_swipe, pre:contains("<image_tag>")').each((function(e){$(this).replaceWith(i[e])}))}async function n(){$('#chat').children('.mes[is_user=\'false\'][is_system=\'false\']').each(((e,t)=>{i(Number(t.getAttribute('mesid')))}))}$((async()=>{await errorCatched(n)(),eventOn(tavern_events.CHAT_CHANGED,errorCatched(n)),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,errorCatched(i)),eventOn(tavern_events.MESSAGE_UPDATED,errorCatched(i)),eventOn(tavern_events.MESSAGE_SWIPED,errorCatched(i)),eventOn(tavern_events.MESSAGE_DELETED,(()=>setTimeout(errorCatched(n),1e3)))}));