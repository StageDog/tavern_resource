{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/酒馆助手/文生图/index.ts"],"sourcesContent":["import swipe_style from './分页.scss?raw';\nimport button_style from './按钮.scss?raw';\n\nasync function generate_image(prompt: string): Promise<string | null> {\n  const result = await triggerSlash(`/sd quiet=true ${prompt}`);\n  if (!result) {\n    return null;\n  }\n  return result;\n}\n\ninterface ImageData {\n  index: number;\n  image_urls: string[];\n}\n\nfunction extract_button(message_id: number, index: number, prompt: string): JQuery<HTMLDivElement> {\n  const $div = $(\n    `<div class=\"text_to_image_button\" id=\"text_to_image-${message_id}-${index}\">`,\n  ) as JQuery<HTMLDivElement>;\n  $div.append(`<style>${button_style}</style>`);\n  $div.append(\n    $(`<button class=\"text_to_image_button\" data=\"${_.escape(prompt.trim())}\">生成图片</button>`).on(\n      'click',\n      async function () {\n        $(this).text('生成中...');\n        const result = await generate_image(prompt);\n        if (!result) {\n          $(this).text('发生错误, 点击重新生成');\n          return;\n        }\n        const image_data = {\n          index,\n          image_urls: [result],\n        };\n        const variables = getVariables({ type: 'message', message_id });\n        _.set(variables, ['text_to_image', index], image_data);\n        await setChatMessages([{ message_id, data: variables }], { refresh: 'none' });\n        $div.replaceWith(extract_swipe(message_id, index, prompt, image_data));\n      },\n    ),\n  );\n  return $div;\n}\n\nfunction extract_swipe(\n  message_id: number,\n  index: number,\n  prompt: string,\n  image_data: ImageData,\n): JQuery<HTMLDivElement> {\n  const $div = $(\n    `<div class=\"text_to_image_swipe\" id=\"text_to_image-${message_id}-${index}\">`,\n  ) as JQuery<HTMLDivElement>;\n  $div.append(`<style>${swipe_style}</style>`);\n\n  const animation_class = 'fa-fade';\n\n  const reset_image = async () => {\n    const variables = getVariables({ type: 'message', message_id });\n    if (image_data.image_urls.length === 0) {\n      _.unset(variables, ['text_to_image', index]);\n    } else {\n      _.set(variables, ['text_to_image', index], image_data);\n    }\n    await setChatMessages([{ message_id, data: variables }], { refresh: 'none' });\n\n    if (image_data.image_urls.length === 0) {\n      $div.replaceWith(extract_button(message_id, index, prompt));\n      return;\n    }\n    $div.find('.mes_img').attr('src', image_data.image_urls[image_data.index]);\n    $div.find('.text_to_image_swipe_counter').text(`${image_data.index + 1}/${image_data.image_urls.length}`);\n  };\n\n  const swipe_image = async (direction: 'left' | 'right') => {\n    if ($div.hasClass(animation_class)) {\n      return;\n    }\n\n    if (direction === 'left') {\n      image_data.index = image_data.index === 0 ? image_data.image_urls.length - 1 : image_data.index - 1;\n    } else {\n      image_data.index =\n        image_data.index === image_data.image_urls.length - 1 ? image_data.image_urls.length : image_data.index + 1;\n      if (image_data.index === image_data.image_urls.length) {\n        $div.addClass(animation_class);\n\n        let image_url: string | null = null;\n        image_url = await generate_image(prompt);\n        if (!image_url) {\n          image_data.index = image_data.image_urls.length - 1;\n          return;\n        }\n        image_data.image_urls.push(image_url);\n\n        $div.removeClass(animation_class);\n      }\n    }\n    reset_image();\n  };\n\n  const enlarge_image = (src?: string) => {\n    if (!src) {\n      return;\n    }\n\n    const image = $('<img>')\n      .addClass('img_enlarged')\n      .attr('src', src)\n      .on('click', function (event) {\n        $(this).toggleClass('zoomed');\n        event.stopPropagation();\n      });\n    const $image_container = $('<div>')\n      .addClass('img_enlarged_container')\n      .append(\n        $('<div>').addClass('img_enlarged_holder').append(image),\n        $('<pre>').append(\n          $('<code>')\n            .addClass('img_enlarged_title txt')\n            .text(prompt)\n            .on('click', event => {\n              event.stopPropagation();\n            })\n            .append(\n              $('<i>')\n                .addClass('fa-solid fa-copy code-copy interactable')\n                .attr('title', '复制提示词')\n                .on('pointerup', async function () {\n                  window.parent.navigator.clipboard.writeText(prompt);\n                  toastr.info(`提示词已复制到剪贴板`);\n                }),\n            ),\n        ),\n      );\n    const popup = new SillyTavern.Popup($image_container[0], SillyTavern.POPUP_TYPE.DISPLAY, '', {\n      large: true,\n      transparent: true,\n    });\n    popup.dlg.style.width = 'unset';\n    popup.dlg.style.height = 'unset';\n    popup.dlg.addEventListener('click', () => {\n      popup.completeCancelled();\n    });\n    popup.show();\n    return image;\n  };\n\n  $div.append(\n    $(`<div class=\" mes_img_container img_extra img_swipes\">`).append(\n      $('<div class=\"mes_img_controls\">').append(\n        $(`<div title=\"放大\" class=\"right_menu_button fa-lg fa-solid fa-magnifying-glass\">`).on('click', () => {\n          enlarge_image($div.find('.mes_img').attr('src'))?.trigger('click');\n        }),\n        $(`<div title=\"删除\" class=\"right_menu_button fa-lg fa-solid fa-trash-can\">`).on('click', async () => {\n          const confirm = await SillyTavern.callGenericPopup(\n            `是否要删除本图片? 本操作无法撤销 (删除只影响显示, 图片依旧会保存在 '存档/user/images' 目录下)`,\n            SillyTavern.POPUP_TYPE.CONFIRM,\n            '',\n            { okButton: '删除', cancelButton: '取消' },\n          );\n          if (!confirm) {\n            return;\n          }\n          image_data.image_urls.splice(image_data.index, 1);\n          image_data.index = 0;\n          reset_image();\n        }),\n      ),\n      $('<div class=\"mes_img_swipes\">').append(\n        $(`<div title=\"左滑\" class=\"right_menu_button fa-lg fa-solid fa-chevron-left\">`).on('click', () =>\n          swipe_image('left'),\n        ),\n        $(`<div class=\"text_to_image_swipe_counter\"></div>`),\n        $(`<div title=\"右滑\" class=\"right_menu_button fa-lg fa-solid fa-chevron-right\">`).on('click', () =>\n          swipe_image('right'),\n        ),\n      ),\n      $(`<img class=\"mes_img\">`).on('click', function () {\n        enlarge_image($(this).attr('src'));\n      }),\n    ),\n  );\n  $div.css('text-align', 'center');\n  reset_image();\n  return $div;\n}\n\nfunction extract_element(message_id: number, index: number, prompt: string): JQuery<HTMLDivElement> {\n  const image_data = _.get(getVariables({ type: 'message', message_id }), ['text_to_image', index]) as\n    | ImageData\n    | undefined;\n  return image_data ? extract_swipe(message_id, index, prompt, image_data) : extract_button(message_id, index, prompt);\n}\n\nasync function renderOneMessage(message_id: number) {\n  const message: string = getChatMessages(message_id)[0].message;\n  const $elements = [...message.matchAll(/<image_tag>(.*?)<\\/image_tag>/gs)].map((match, index) =>\n    extract_element(message_id, index, match[1]),\n  );\n\n  retrieveDisplayedMessage(message_id)\n    .find(`.text_to_image_button, .text_to_image_swipe, pre:contains(\"<image_tag>\")`)\n    .each(function (index: number) {\n      $(this).replaceWith($elements[index]);\n    });\n}\n\nasync function renderAllMessage() {\n  $('#chat')\n    .children(\".mes[is_user='false'][is_system='false']\")\n    .each((_index, node) => {\n      renderOneMessage(Number(node.getAttribute('mesid')));\n    });\n}\n\n$(async () => {\n  await errorCatched(renderAllMessage)();\n  eventOn(tavern_events.CHAT_CHANGED, errorCatched(renderAllMessage));\n  eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED, errorCatched(renderOneMessage));\n  eventOn(tavern_events.MESSAGE_UPDATED, errorCatched(renderOneMessage));\n  eventOn(tavern_events.MESSAGE_SWIPED, errorCatched(renderOneMessage));\n  eventOn(tavern_events.MESSAGE_DELETED, () => setTimeout(errorCatched(renderAllMessage), 1000));\n});\n"],"names":["async","generate_image","prompt","result","triggerSlash","extract_button","message_id","index","$div","$","append","_","escape","trim","on","this","text","image_data","image_urls","variables","getVariables","type","set","setChatMessages","data","refresh","replaceWith","extract_swipe","animation_class","reset_image","length","unset","find","attr","swipe_image","direction","hasClass","addClass","image_url","push","removeClass","enlarge_image","src","image","event","toggleClass","stopPropagation","$image_container","window","parent","navigator","clipboard","writeText","toastr","info","popup","SillyTavern","Popup","POPUP_TYPE","DISPLAY","large","transparent","dlg","style","width","height","addEventListener","completeCancelled","show","trigger","callGenericPopup","CONFIRM","okButton","cancelButton","splice","css","renderOneMessage","$elements","getChatMessages","message","matchAll","map","match","get","extract_element","retrieveDisplayedMessage","each","renderAllMessage","children","_index","node","Number","getAttribute","errorCatched","eventOn","tavern_events","CHAT_CHANGED","CHARACTER_MESSAGE_RENDERED","MESSAGE_UPDATED","MESSAGE_SWIPED","MESSAGE_DELETED","setTimeout"],"sourceRoot":""}