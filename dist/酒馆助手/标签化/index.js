import{compare as t}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';function e(t){return[...t.matchAll(/【(.*?)】/g)].map(t=>t[1].toLowerCase())}function n(t,e){return[...t.matchAll(/【(.*?)】/g)].map(t=>t[1]).some(t=>t.split('&').map(t=>t.toLowerCase()).every(t=>e.includes(t)))}let r=!1;const s=_.throttle(async function(){const t=_.sortedUniq(_.sortBy([...e($('#settings_preset_openai').find(':selected').text()),...$('#world_info').find(':selected').toArray().map(t=>$(t).text()).flatMap(e),...e($('#connection_profiles').find(':checked').text())]));!async function(t){const e=getPreset('in_use'),r=structuredClone(e);r.prompts.filter(t=>null!==t.name.match(/【.*?】/)).forEach(e=>{e.enabled=n(e.name,t)}),_.isEqual(e,r)||await replacePreset('in_use',r)}(t),async function(t){const e=getTavernRegexes({scope:'all'}),r=structuredClone(e);r.filter(t=>null!==t.script_name.match(/【.*?】/)).forEach(e=>{e.enabled=n(e.script_name,t)}),_.isEqual(e,r)||await replaceTavernRegexes(r,{scope:'all'})}(t),r?async function(t){const e=$('#tavern_helper').find('[data-script-id]').filter(function(){return null!==$(this).children('div').first().text().match(/【.*?】/)}).toArray().map(e=>{const r=$(e).children('div'),s=n(r.first().text(),t),i=r.last().children('div').first(),a=i.hasClass('enabled');return{button:i,should_toggle:s!==a}}).filter(({should_toggle:t})=>t).map(({button:t})=>t);for(const t of e)t.trigger('click')}(t):async function(t){const e=$('#script-settings-content').find('.script-item').filter(function(){return null!==$(this).find('.script-item-name').text().match(/【.*?】/)}).toArray().map(e=>{const r=$(e),s=n(r.find('.script-item-name').text(),t),i=r.find('.script-toggle'),a=i.hasClass('enabled');return{button:i,should_toggle:s!==a}}).filter(({should_toggle:t})=>t).map(({button:t})=>t);for(const t of e)t.trigger('click')}(t)},1e3,{trailing:!1});$(async()=>{const e=await getTavernHelperVersion();r=t(e,'4.0.0','>='),s(),eventMakeFirst(tavern_events.SETTINGS_UPDATED,s)});