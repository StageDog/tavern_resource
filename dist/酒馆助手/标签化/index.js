function t(t){return[...t.matchAll(/【(.*?)】/g)].map(t=>t[1].toLowerCase())}function e(t,e){return[...t.matchAll(/【(.*?)】/g)].map(t=>t[1]).some(t=>t.split('&').map(t=>t.toLowerCase()).every(t=>e.includes(t)))}const n=_.throttle(async function(){const n=_.sortedUniq(_.sortBy([...t($('#settings_preset_openai').find(':selected').text()),...$('#world_info').find(':selected').toArray().map(t=>$(t).text()).flatMap(t),...t($('#connection_profiles').find(':checked').text())]));!async function(t){const n=getPreset('in_use'),s=structuredClone(n);s.prompts.filter(t=>null!==t.name.match(/【.*?】/)).forEach(n=>{n.enabled=e(n.name,t)}),_.isEqual(n,s)||await replacePreset('in_use',s)}(n),async function(t){const n=getTavernRegexes({scope:'all'}),s=structuredClone(n);s.filter(t=>null!==t.script_name.match(/【.*?】/)).forEach(n=>{n.enabled=e(n.script_name,t)}),_.isEqual(n,s)||await replaceTavernRegexes(s,{scope:'all'})}(n),async function(t){const n=$('#script-settings-content').find('.script-item').filter(function(){return null!==$(this).find('.script-item-name').text().match(/【.*?】/)}).toArray().map(n=>{const s=$(n),r=e(s.find('.script-item-name').text(),t),a=s.find('.script-toggle'),i=a.hasClass('enabled');return{button:a,should_toggle:r!==i}}).filter(({should_toggle:t})=>t).map(({button:t})=>t);for(const t of n)t.trigger('click')}(n)},1e3,{trailing:!1});$(()=>{n(),eventMakeFirst(tavern_events.SETTINGS_UPDATED,n)});