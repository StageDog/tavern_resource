function t(t){return[...t.matchAll(/【(.*?)】/g)].map((t=>t[1].toLowerCase()))}function e(t,e){return[...t.matchAll(/【(.*?)】/g)].map((t=>t[1])).some((t=>t.split("&").map((t=>t.toLowerCase())).every((t=>e.includes(t)))))}const n=_.throttle((async function(){const n=_.sortedUniq(_.sortBy([...t($("#settings_preset_openai").find(":selected").text()),...$("#world_info").find(":selected").toArray().map((t=>$(t).text())).flatMap(t),...t($("#connection_profiles").find(":checked").text())]));!async function(t){const n=$("#completion_prompt_manager").find("a[title]").filter((function(){return null!==$(this).text().match(/【.*?】/)})).toArray().map((n=>{const i=$(n),r=i.closest("li");return{identifier:r.attr("data-pm-identifier"),should_toggle:e(i.attr("title"),t)!==r.find(".prompt-manager-toggle-action").hasClass("fa-toggle-on")}})).filter((({should_toggle:t})=>t)).map((({identifier:t})=>`identifier=${t}`));0!==n.length&&await triggerSlash(`/setpromptentry ${n.join(" ")}`)}(n),async function(t){const n=getTavernRegexes({scope:"all"}),i=structuredClone(n);i.filter((t=>null!==t.script_name.match(/【.*?】/))).forEach((n=>{n.enabled=e(n.script_name,t)})),_.isEqual(n,i)||await replaceTavernRegexes(i,{scope:"all"})}(n),async function(t){const n=$("#script-settings-content").find(".script-item").filter((function(){return null!==$(this).find(".script-item-name").text().match(/【.*?】/)})).toArray().map((n=>{const i=$(n),r=e(i.find(".script-item-name").text(),t),o=i.find(".script-toggle"),a=o.hasClass("enabled");return{button:o,should_toggle:r!==a}})).filter((({should_toggle:t})=>t)).map((({button:t})=>t));for(const t of n)t.trigger("click")}(n)}),1e3,{trailing:!1});$((()=>{n(),eventMakeFirst(tavern_events.SETTINGS_UPDATED,n)}));