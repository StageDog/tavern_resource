function t(t){return[...t.matchAll(/【(.*?)】/g)].map(t=>t[1].toLowerCase())}function e(t,e){return[...t.matchAll(/【(.*?)】/g)].map(t=>t[1]).some(t=>t.split('&').map(t=>t.toLowerCase()).every(t=>e.includes(t)))}const n=_.throttle(async function(){const n=_.sortedUniq(_.sortBy([...t($('#settings_preset_openai').find(':selected').text()),...$('#world_info').find(':selected').toArray().map(t=>$(t).text()).flatMap(t),...t($('#connection_profiles').find(':checked').text())]));await async function(t){const n=getPreset('in_use'),a=structuredClone(n);a.prompts.filter(t=>null!==t.name.match(/【.*?】/)).forEach(n=>{n.enabled=e(n.name,t)}),_.isEqual(n,a)||await replacePreset('in_use',a)}(n),await async function(t){const n=getTavernRegexes({scope:'all'}),a=structuredClone(n);a.filter(t=>null!==t.script_name.match(/【.*?】/)).forEach(n=>{n.enabled=e(n.script_name,t)}),_.isEqual(n,a)||await replaceTavernRegexes(a,{scope:'all'})}(n),await async function(t){const n=$('#script-settings-content').find('.script-item').filter(function(){return null!==$(this).find('.script-item-name').text().match(/【.*?】/)}).toArray().map(n=>{const a=$(n),s=e(a.find('.script-item-name').text(),t),i=a.find('.script-toggle'),r=i.hasClass('enabled');return{button:i,should_toggle:s!==r}}).filter(({should_toggle:t})=>t).map(({button:t})=>t);for(const t of n)t.trigger('click')}(n)},1e3,{trailing:!1});$(()=>{n(),eventMakeFirst(tavern_events.SETTINGS_UPDATED,n)});